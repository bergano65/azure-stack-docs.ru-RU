---
title: Как выполнить развертывание F5 на двух экземплярах Azure Stack Hub | Документация Microsoft
description: Как выполнить развертывание F5 на двух экземплярах Azure Stack Hub
services: azure-stack
author: mattbriggs
ms.service: azure-stack
ms.topic: how-to
ms.date: 11/06/2019
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 11/06/2019
ms.openlocfilehash: 60e6330aa492539a3b4e89a390ddcad5650cac92
ms.sourcegitcommit: b96a0b151b9c0d3eea59e7c2d39119a913782624
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2020
ms.locfileid: "75718425"
---
# <a name="how-to-deploy-f5-across-two-azure-stack-hub-instances"></a>Как выполнить развертывание F5 на двух экземплярах Azure Stack Hub

В этой статье описано, как настроить внешний балансировщик нагрузки в двух средах Azure Stack Hub. Эту конфигурацию можно использовать для управления разными рабочими нагрузками. В этой статье описано, как развернуть F5 в качестве глобального решения для балансировки нагрузки между двумя независимыми экземплярами Azure Stack Hub. Вы также развернете веб-приложение с балансировкой нагрузки на сервере NGINX, распределенном между двумя экземплярами. Перед ними будет размещена пара виртуальных устройств F5 с высоким уровнем доступности и отработкой отказа.

Примеры шаблонов Azure Resource Manager можно найти в репозитории [f5-azurestack-gslb](https://github.com/Mikej81/f5-azurestack-gslb) на GitHub.

## <a name="overview-of-load-balancing-with-f5"></a>Общие сведения о балансировке нагрузки с использованием F5

Оборудование для балансировки нагрузки F5 может располагаться за пределами Azure Stack в центре обработки данных, где размещается Azure Stack. Azure Stack не имеет встроенных функций для распределения рабочих нагрузок между двумя отдельными развертываниями Azure Stack. Виртуальный выпуск BIG-IP для F5 выполняется на обеих платформах. Такая конфигурация обеспечивает соответствие между архитектурами Azure и Azure Stack за счет репликации вспомогательных служб приложений. Вы можете разрабатывать приложение в одной среде, а затем переместить его в другую. Также вы можете создать копию полного развертывания Azure Stack в готовом к эксплуатации виде, включая одни и те же конфигурации BIG-IP, политики и службы приложений. Такой подход позволяет не тратить много времени на рефакторинг и тестирование приложения, а сосредоточиться на написании кода.

Обеспечение защиты приложений и связанных данных часто становится проблемой для разработчиков, которые переносят приложения в общедоступное облако. Но это не должно быть проблемой. Вы можете создавать приложение в среде Azure Stack, а архитектор безопасности будет настраивать необходимые параметры в брандмауэре веб-приложения (WAF) для F5. Тогда вы сможете полностью реплицировать стек в Azure Stack, полагаясь на защиту приложения тем же WAF, который является отраслевым эталоном. Идентичные политики и наборы правил предотвратят появление рисков безопасности или уязвимостей, что характерно при применении разных WAF.

Для Azure Stack используется отдельный Marketplace (не относящийся к Azure). В него добавляются только избранные элементы. В нашем примере вам нужно создать новую группу ресурсов в каждом из экземпляров Azure Stack и развернуть на них уже доступный виртуальный модуль F5. Вы увидите, что для организации сетевого подключения между экземплярами Azure Stack требуется **общедоступный IP-адрес**. Эти экземпляры изолированы от окружающей сети, а **общедоступный IP-адрес** позволит им обмениваться данными.

## <a name="prerequisites-for-big-ip-ve"></a>Требования для виртуального выпуска BIG-IP

-  Скачайте **F5 BIG-IP VE - ALL (BYOL, 2 Boot Locations)** в каждый экземпляр Azure Stack Marketplace. Если вы не видите их на своем портале, обратитесь к оператору облака.

-  Шаблон Azure Resource Manager можно найти в репозитории https://github.com/Mikej81/f5-azurestack-gslb на GitHub.

## <a name="deploy-f5-big-ip-ve-on-each-instance"></a>Развертывание виртуального выпуска F5 BIG-IP в каждом экземпляре

Выполните развертывание в экземплярах Azure Stack A и B.

1. Войдите на портал пользователя Azure Stack Hub.

2. Выберите действие **+ Создать ресурс**.

3. Выполните поиск по запросу `F5` в Marketplace.

4. Выберите вариант **F5 BIG-IP VE – ALL (BYOL, 2 Boot Locations)** .

    ![](./media/network-howto-f5/image1.png)

5. Внизу следующей страницы щелкните **Создать**.

    ![](./media/network-howto-f5/image2.png)

6. Создайте новую группу ресурсов с именем **F5-GSLB**.

7. Укажите следующие значения, чтобы завершить этот пример развертывания:

    ![](./media/network-howto-f5/image3.png)

8. Убедитесь, что развертывание завершилось успешно.

    ![](./media/network-howto-f5/image4.png)

    > [!Note]  
    > Каждое развертывание BIG-IP занимает примерно 20 минут.

## <a name="configure-big-ip-appliances"></a>Настройка устройств BIG-IP

Повторите те же действия для Azure Stack A и B.

1. Войдите на пользовательский портал Azure Stack Hub в экземпляре Azure Stack A, чтобы проверить ресурсы, созданные при развертывании шаблона BIG-IP.

    ![](./media/network-howto-f5/image18.png)

2. Выполните инструкции для [элементов конфигурации BIG-IP](https://clouddocs.f5.com/training/community/dns/html/class1/class1.html) в документации по F5. 

3. Настройте широкий список IP-адресов для BIG-IP, чтобы прослушивать оба устройства, развернутых в экземплярах Azure Stack A и B, согласно [описанию конфигурации BIG-IP GTM](https://techdocs.f5.com/kb/en-us/products/big-ip_gtm/manuals/product/gtm-concepts-11-5-0/4.html).


4. Проверьте отработку отказа для устройств BIG-IP. В тестовой системе настройте следующие параметры для DNS-серверов:
    - экземпляр Azure Stack A — `f5stack1-ext` общедоступный IP-адрес;
    - экземпляр Azure Stack B — `f5stack1-ext` общедоступный IP-адрес.

5. В браузере перейдите по адресу `www.contoso.com` и убедитесь, что отображается стандартная страница NGINX.

## <a name="create-a-dns-sync-group"></a>Создание группы синхронизации DNS

1. Войдя в учетную запись суперпользователя, настройте отношения доверия. См. инструкции по [изменению паролей учетной записи обслуживания системы (11.x–15.x)](https://support.f5.com/csp/article/K13121). Настроив отношения доверия (обмен сертификатами), отключите учетную запись суперпользователя.

1. Войдите в систему BIG-IP и создайте группу синхронизации DNS. См. инструкции по [созданию группы синхронизации DNS для BIG-IP](https://f5-dns-automation-demo-12-1-x.readthedocs.io/en/latest/lab2/sync-group.html).

    > [!Note]  
    > Локальный IP-адрес устройства BIG-IP можно найти в группе ресурсов **F5-GSLB**. Выберите сетевой интерфейс f5stack1-ext и подключитесь к общедоступному или частному IP-адресу (в зависимости от способа получения доступа).

    ![](./media/network-howto-f5/image5.png)
          
    ![](./media/network-howto-f5/image6.png)

1. Выберите новую группу ресурсов **F5-GSLB** и виртуальную машину **f5stack1**, а затем в разделе **Параметры** выберите **Сети**.

## <a name="post-install-configurations"></a>Настройка после установки

По завершении установки вам нужно настроить в Azure Stack группы безопасности сети и заблокировать исходящие IP-адреса.

1. Отключите порт 22 после установки отношений доверия.

2. Если система подключена к сети, заблокируйте группы безопасности сети для источника. Группа безопасности сети для управления должна разрешать только источник для управления, а внешняя группа безопасности сети (4353/TCP) должна разрешать только другой экземпляр для синхронизации. Порт 443 также следует заблокировать до развертывания приложений с виртуальными серверами.

3. Настройте правило GTM_DNS, чтобы разрешить трафик по порту 53 (DNS), и сопоставитель BIG-IP начнет работать. Итак, прослушиватели созданы.

    ![](./media/network-howto-f5/image7.png)

4. Теперь разверните базовую рабочую нагрузку веб-приложения в среде Azure Stack, чтобы выполнять балансировку нагрузки за экземпляром BIG-IP. См. пример использования сервера NGINX в руководстве по [развертыванию NGINX и NGINX Plus в Docker](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-docker/).

    > [!Note]  
    > Разверните экземпляр NGINX в обоих экземплярах Azure Stack (A и B).

5. Развернув NGINX в контейнере Docker на виртуальной машине Ubuntu в каждом из экземпляров Azure Stack, попробуйте открыть стандартную веб-страницу на обоих серверах.

    ![](./media/network-howto-f5/image8.png)

6. Войдите в интерфейс управления для устройства BIG-IP. В нашем примере используйте для этого общедоступный IP-адрес **f5-stack1-ext**.

    ![](./media/network-howto-f5/image9.png)

7. Опубликуйте доступ к NGINX через BIG-IP.
    
    -  В нашем примере описано, как настроить для BIG-IP виртуальный сервер и пул, чтобы разрешить входящий доступ из Интернета к приложению WordPress. Для начала необходимо узнать частный IP-адрес экземпляра NGINX.

8. Войдите на портал пользователя Azure Stack Hub. 

9. Выберите сетевой интерфейс NGINX.

    ![](./media/network-howto-f5/image10.png)

10. В консоли BIG-IP перейдите в раздел **Локальный трафик > Пулы > Список пулов** и щелкните **+** . Настройте пул, используя значения из этой таблицы. Для других полей сохраните значения по умолчанию.

    ![](./media/network-howto-f5/image11.png)
    
    | Клавиши | Значение |
    | --- | --- |
    | Имя | NGINX_Pool |
    | Монитор работоспособности | HTTPS |
    | Имя узла | NGINX |
    | Адрес | \<частный IP-адрес NGINX> |
    | Порт службы | 443 |

11. Щелкните **Готово**. Если все настроено правильно, состояние пула будет отображаться зеленым цветом.

    ![](./media/network-howto-f5/image12.png)

    Теперь осталось настроить виртуальный сервер. Для этого прежде всего найдите частный IP-адрес для BIG-IP в F5.

12. В консоли BIG-IP перейдите в раздел **Сеть > Собственный IP-адрес** и запишите значение IP-адреса.

    ![](./media/network-howto-f5/image13.png)

13. Создайте новый виртуальный сервер. Для этого перейдите в раздел **Локальный трафик** > **Виртуальные серверы** > **Список виртуальных серверов**, а затем щелкните **+** . Настройте пул, используя значения из этой таблицы. Для других полей сохраните значения по умолчанию.

    | Клавиши | Значение |
    | --- | --- |
    |Имя | NGINX |
    |Адрес назначения | \<собственный IP-адрес BIG-IP> |
    |Порт службы | 443 |
    |Профиль SSL (клиент) | clientssl |
    |Преобразование сетевых адресов | Автоматическое сопоставление |
        
    ![](./media/network-howto-f5/image14.png)

    ![](./media/network-howto-f5/image15.png)

14. Итак, вы завершили настройку BIG-IP для приложения NGINX. Чтобы все проверить, откройте сайт в браузере и просмотрите статистику F5.

15. Перейдите в браузере по адресу `https://<F5-public-VIP-IP>` и убедитесь, что отображается стандартная страница NGINX.

    ![](./media/network-howto-f5/image16.png)

16. Теперь в статистике виртуального сервера проверьте поток трафика, перейдя в раздел **Статистика > Статистика модуля > Локальный трафик**.

17. В поле **Тип статистики** выберите значение **Виртуальные серверы**.

    ![](./media/network-howto-f5/image17.png)


## <a name="for-more-information"></a>Дополнительные сведения

Дополнительные справочные материалы по использованию F5:

- [Data Center Availability Services Using BIG-IP DNS](https://clouddocs.f5.com/training/community/dns/html/class3/class3.html) (Использование служб обеспечения доступности центра обработки данных с DNS BIG-IP)
- [Deploying the BIG-IP System with HTTP Applications](https://www.f5.com/content/dam/f5/corp/global/pdf/deployment-guides/iapp-http-dg.pdf) (Развертывание системы BIG-IP с приложениями HTTP)
- [Creating a WIP for GSLB](https://clouddocs.f5.com/training/community/big-iq-cloud-edition/html/class10/module2/lab1.html) (Создание WIP для GSLB)

## <a name="next-steps"></a>Дальнейшие действия

[Сети Azure Stack: различия и рекомендации](azure-stack-network-differences.md) 
