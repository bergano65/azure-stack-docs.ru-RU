---
title: Автоматизация обновления виртуальной машины и управления ею в Azure Stack | Документация Майкрософт
description: Узнайте, как использовать решения Azure Monitor для виртуальных машин, "Управление обновлениями", "Отслеживание изменений" и инвентаризации в службе автоматизации Azure для управления виртуальными машинами Windows и Linux, развернутыми в Azure Stack.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/23/2019
ms.author: mabrigg
ms.reviewer: rtiberiu
ms.lastreviewed: 03/20/2019
ms.openlocfilehash: 3fa6d124722d45d727525820b6a99d408f0d2350
ms.sourcegitcommit: 245a4054a52e54d5989d6148fbbe386e1b2aa49c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2019
ms.locfileid: "70975173"
---
# <a name="vm-update-and-management-automation-in-azure-stack"></a>Автоматизация обновления виртуальной машины и управления ею в Azure Stack
Для управления виртуальными машинами Windows и Linux, развернутыми с помощью Azure Stack, можно использовать следующие функции решения службы автоматизации Azure.

- **[Управление обновлениями](https://docs.microsoft.com/azure/automation/automation-update-management)** . Благодаря решению "Управление обновлениями" можно быстро оценить состояние доступных обновлений на всех компьютерах агентов и управлять установкой необходимых обновлений для виртуальных машин Windows и Linux.

- **[Отслеживание изменений](https://docs.microsoft.com/azure/automation/automation-change-tracking)** . Данные об изменениях установленного ПО, служб, файлов и реестра Windows и управляющих программ Linux на наблюдаемых серверах отправляются в службу Azure Monitor в облаке для обработки. К полученным данным применяется логика и облачная служба записывает данные. С помощью сведений на панели мониторинга "Отслеживание изменений" можно без труда обнаружить изменения, внесенные в инфраструктуру серверов.

- **[Инвентаризация](https://docs.microsoft.com/azure/automation/automation-vm-inventory)** . Отслеживание данных для виртуальной машины Azure Stack предоставляет браузерный пользовательский интерфейс для установки и настройки сбора данных инвентаризации.

- **[Azure Monitor для виртуальных машин](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-overview)** . Azure Monitor для виртуальных машин отслеживают виртуальные машины Azure и Azure Stack и масштабируемые наборы виртуальных машин в соответствующем масштабе. Это решение анализирует производительность и работоспособность виртуальных машин Windows и Linux, отслеживает их процессы и зависимости от других ресурсов и внешних процессов.

> [!IMPORTANT]
> Эти решения идентичны тем, которые используются для управления виртуальными машинами Azure. Управление виртуальными машинами Azure и Azure Stack осуществляется одинаково с помощью одного и того же интерфейса и инструментов. При использовании решений "Управление обновлениями", "Отслеживание изменений", инвентаризации и Azure Monitor для виртуальных машин в Azure Stack для виртуальных машин Azure Stack действует такая же цена, как и для виртуальных машин Azure.

## <a name="prerequisites"></a>Предварительные требования
Прежде чем использовать эти возможности обновления виртуальных машин Azure Stack и управления ими, необходимо выполнить несколько предварительных условий. К ним относятся действия, которые необходимо выполнить на портале Azure, а также на портале администрирования Azure Stack.

### <a name="in-the-azure-portal"></a>На портале Azure
Чтобы использовать такие возможности автоматизации, как Azure Monitor для виртуальных машин, инвентаризацию, "Отслеживание изменений" и "Управление обновлениями" для виртуальных машин Azure Stack, необходимо сначала включить эти решения в Azure.

> [!TIP]
> Если эти возможности уже включены для виртуальных машин Azure, можно использовать учетные данные существующей рабочей области Log Analytics. Если уже существует идентификатор рабочей области и первичный ключ LogAnalytics, которые необходимо использовать, сразу перейдите к [следующему разделу](./vm-update-management.md#in-the-azure-stack-administrator-portal). В противном случае оставайтесь в этом разделе, чтобы создать новую рабочую область LogAnalytics и учетную запись службы автоматизации.

Первый шаг в обеспечении этих решений — [создание рабочей области LogAnalytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-quick-create-workspace) в подписке Azure. Рабочая область Log Analytics — это уникальная среда журналов Azure Monitor с собственным репозиторием данных, источниками данных и решениями. После создания рабочей области запишите идентификатор и ключ рабочей области. Чтобы просмотреть эти сведения, перейдите к колонке "Рабочая область", щелкните **Дополнительные параметры** и просмотрите значения **Идентификатор рабочей области** и **Первичный ключ**. 

Затем нужно [создать учетную запись службы автоматизации](https://docs.microsoft.com/azure/automation/automation-create-standalone-account). Учетная запись автоматизации — это контейнер для ресурсов в службе автоматизации Azure. Он позволяет разделять среды и дополнительно упорядочивать рабочие процессы автоматизации и ресурсы. После создания учетной записи службы автоматизации необходимо включить возможности инвентаризации, отслеживания изменений и управления обновлениями. Чтобы включить эту функцию, сделайте следующее.

1. На портале Azure перейдите к учетной записи службы автоматизации, которую нужно использовать.

2. Выберите решение, которое нужно включить (**Инвентаризация**, **Отслеживание изменений** или **Управление обновлениями**).

3. Используйте раскрывающийся список **Выберите рабочую область...** , чтобы выбрать для использования рабочую область Log Analytics.

4. Проверьте на правильность остальные сведения, а затем щелкните **Включить**, чтобы включить решение.

5. Повторите шаги 2–4, чтобы включить все три решения. 

   [![](media/vm-update-management/1-sm.PNG "Включение возможностей учетной записи службы автоматизации")](media/vm-update-management/1-lg.PNG#lightbox)

### <a name="enable-azure-monitor-for-vms"></a>Включение Azure Monitor для виртуальных машин

Служба "Azure Monitor для виртуальных машин" отслеживает виртуальные машины Azure и масштабируемые наборы виртуальных машин в соответствующем масштабе. Это решение анализирует производительность и работоспособность виртуальных машин Windows и Linux, отслеживает их процессы и зависимости от других ресурсов и внешних процессов.

Решение "Azure Monitor для виртуальных машин" включает в себя поддержку мониторинга производительности и зависимостей приложений для виртуальных машин, размещенных локально или в другом поставщике облачных служб. Подробные аналитические сведения предоставляют три ключевых компонента:

1. Логические компоненты виртуальных машин Azure под управлением Windows и Linux, которые измеряются согласно предварительно настроенным критериям работоспособности, и при выполнении оцениваемого условия отображается оповещение.

2. Предварительно определенные диаграммы тенденций производительности, которые отображают основные метрики производительности из гостевой операционной системы виртуальной машины.

3. Сопоставление зависимостей, которое отображает взаимосвязанные с виртуальной машиной компоненты из различных групп ресурсов и подписок.

После создания рабочей области Log Analytics включите в ней счетчики производительности для сбора данных на виртуальных машинах Windows и Linux. Установите и включите решения ServiceMap и InfrastructureInsights в рабочей области. Этот процесс описан в руководстве [по развертыванию Azure Monitor для виртуальных машин](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-onboard#how-to-enable-azure-monitor-for-vms-preview).

### <a name="in-the-azure-stack-administrator-portal"></a>На портале администратора Azure Stack
После включения решений службы автоматизации на портале Azure необходимо войти на портал администратора Azure Stack с правами администратора облака и скачать из Azure Stack Marketplace расширения **Azure Monitor, Update and Configuration Management** и **Azure Monitor, Update and Configuration Management for Linux**.

   ![Элемент Marketplace расширения "Azure Monitor, Управление конфигурацией и обновлением"](media/vm-update-management/2.PNG) 

Чтобы включить решение для сопоставления Azure Monitor для виртуальных машин и получить полезные сведения о зависимостях сети, скачайте **Azure Monitor Dependency Agent**.

   ![Azure Monitor Dependency Agent](media/vm-update-management/2-dependency.PNG) 

## <a name="enable-update-management-for-azure-stack-vms"></a>Включение Управления обновлениями для виртуальных машин Azure Stack
Чтобы включить управление обновлениями для виртуальных машин в Azure Stack, выполните следующие действия.

1. Войдите на портал пользователя Azure Stack.

2. На пользовательском портале Azure Stack перейдите в колонку "Расширения" виртуальных машин, для которых необходимо включить эти решения, щелкните **+ Добавить**, выберите расширение **Azure Update and Configuration Management** и щелкните **Создать**.

   [![](media/vm-update-management/3-sm.PNG "Колонка расширения виртуальной машины")](media/vm-update-management/3-lg.PNG#lightbox)

3. Укажите созданный ранее идентификатор рабочей области и первичный ключ для связывания агента с рабочей областью LogAnalytics. Щелкните **ОК**, чтобы развернуть расширение.

   [![](media/vm-update-management/4-sm.PNG "Указание идентификатора рабочей области и ключа")](media/vm-update-management/4-lg.PNG#lightbox) 

4. Как описано в [документации по Управлению обновлениями](https://docs.microsoft.com/azure/automation/automation-update-management), необходимо включить решение "Управление обновлениями" для каждой виртуальной машины, которой нужно управлять. Чтобы включить решение для всех виртуальных машин, которые отправляют отчеты в рабочую область, выберите **Управление обновлениями**, щелкните **Управление компьютерами**, а затем выберите параметр **Включить для всех доступных и будущих компьютеров**.

   [![](media/vm-update-management/5-sm.PNG "Включение решения \"Управление обновлениями\" на всех компьютерах")](media/vm-update-management/5-lg.PNG#lightbox) 

   > [!TIP]
   > Повторите этот шаг, чтобы включить каждое решение для виртуальных машин Azure Stack, отправляющих отчетные данные в эту рабочую область. 
  
После включения расширения "Azure Update and Configuration Management" проверка для каждой управляемой виртуальной машины выполняется дважды в день. Каждые 15 минут вызывается API, чтобы запросить время последнего обновления и определить, изменилось ли состояние. Если состояние изменилось, запускается проверка соответствия.

После проверки виртуальные машины будут отображаться в учетной записи службы автоматизации Azure в решении "Управление обновлениями". 

   [![](media/vm-update-management/6-sm.PNG "Учетная запись службы автоматизации Azure в решении \"Управление обновлениями\"")](media/vm-update-management/6-lg.PNG#lightbox) 

> [!IMPORTANT]
> Отображение обновленных данных с управляемых компьютеров на панели мониторинга может занять от 30 минут до 6 часов.

Теперь виртуальные машины Azure Stack можно включить в запланированные развертывания обновлений вместе с виртуальными машинами Azure.

## <a name="enable-azure-monitor-for-vms-running-on-azure-stack"></a>Включение решения "Azure Monitor для виртуальных машин", выполняющегося в Azure Stack
После установки расширений **Azure Monitor, Update and Configuration Management** и **Azure Monitor Dependency Agent** на виртуальной машине она начнет передавать данные в решение [Azure Monitor для виртуальных машин](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-overview). 

> [!TIP]
> Для расширения **Azure Monitor Dependency Agent** не требуются никакие параметры. Dependency Agent в Azure Monitor для виртуальных машин не передает данные и не требует изменений в настройках брандмауэра или портов. Данные сопоставления всегда передаются агентом Log Analytics в службу Azure Monitor либо непосредственно, либо через [шлюз OMS](https://docs.microsoft.com/azure/azure-monitor/platform/gateway), если политики безопасности ИТ не позволяют компьютерам в сети подключаться к Интернету.

Служба Azure Monitor для виртуальных машин включает в себя набор диаграмм производительности, ориентированных на несколько ключевых показателей эффективности (КПЭ), которые помогают определить, насколько эффективно работает виртуальная машина. На этих диаграммах показано использование ресурсов за определенный период времени, что позволяет выявить узкие места и аномалии. Вы можете также переключиться на перспективу со списком всех компьютеров, чтобы просмотреть данные об использовании ресурсов на основе выбранной метрики. Хотя при анализе производительности следует учитывать множество элементов, Azure Monitor для виртуальных машин отслеживает ключевые показатели производительности операционной системы, связанные с использованием процессора, памяти, сетевого адаптера и диска. Диаграммы производительности дополняют функцию мониторинга работоспособности и помогают выявить проблемы, указывающие на возможный сбой компонента системы. Azure Monitor для виртуальных машин также поддерживает планирование ресурсов, настройку и оптимизацию, что позволяет повысить эффективность.

   ![Вкладка данных о производительности виртуальных машин в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/insights/media/vminsights-performance/vminsights-performance-aggview-01.png)

Обнаруженные компоненты приложений на виртуальных машинах Windows и Linux, работающих в Azure Stack, можно просматривать с помощью Azure Monitor для виртуальных машин двумя способами. Первый способ применяется непосредственно из виртуальной машины, а второй — в группах виртуальных машин из Azure Monitor.
Дополнительные сведения об использовании двух перспектив и способах применения функции "Сопоставление" см. в статье [Использовать функцию карты Azure Monitor для виртуальных машин (предварительная версия), чтобы понять компоненты приложения](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-maps).

   ![Вкладка сопоставления виртуальных машин в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/insights/media/vminsights-maps/map-multivm-azure-monitor-01.png)

Если [Azure Monitor для виртуальных машин](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-overview) не отображает данные о производительности, включите их сбор для Windows и Linux в дополнительных параметрах [рабочей области Log Analytics](https://docs.microsoft.com/azure/azure-monitor/platform/data-sources-performance-counters).

## <a name="enable-update-management-using-a-resource-manager-template"></a>Включение Управления обновлениями с помощью шаблона Resource Manager
При наличии большого количества виртуальных машин Azure Stack можно использовать [этот шаблон Azure Resource Manager](https://github.com/Azure/AzureStack-QuickStart-Templates/tree/master/MicrosoftMonitoringAgent-ext-win), чтобы упростить развертывание решения на виртуальных машинах. Шаблон развертывает расширение Microsoft Monitoring Agent на имеющейся виртуальной машине Azure Stack и добавляет его в имеющуюся рабочую область LogAnalytics Azure.
 
## <a name="next-steps"></a>Дополнительная информация
[Оптимизация производительности SQL Server](azure-stack-sql-server-vm-considerations.md)
