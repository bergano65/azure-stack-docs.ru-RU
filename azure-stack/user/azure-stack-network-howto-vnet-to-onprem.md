---
title: Настройка VPN-шлюза для Azure Stack Hub
description: Сведения о настройке VPN-шлюза для Azure Stack Hub.
author: mattbriggs
ms.topic: how-to
ms.date: 10/03/2019
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 10/03/2019
ms.openlocfilehash: 19056b0ad37511e75d462c201190c8e2f3a606e0
ms.sourcegitcommit: fd5d217d3a8adeec2f04b74d4728e709a4a95790
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2020
ms.locfileid: "76883374"
---
# <a name="set-up-vpn-gateway-for-azure-stack-hub-using-fortigate-nva"></a>Настройка VPN-шлюза для Azure Stack Hub с использованием виртуального сетевого модуля FortiGate

В этой статье описывается создание VPN-подключения к Azure Stack Hub. VPN-шлюз — это разновидность шлюза виртуальной сети, который передает зашифрованный трафик между виртуальной сетью в Azure Stack Hub и удаленным VPN-шлюзом. Приведенная ниже процедура развертывает одну виртуальную сеть с виртуальным сетевым модулем (NVA) FortiGate в группе ресурсов. Здесь также приводятся инструкции по настройке VPN-подключения IPSec к виртуальному сетевому модулю FortiGate.

## <a name="prerequisites"></a>Предварительные требования

-  Доступ к интегрированным системам Azure Stack Hub с доступной емкостью для развертывания обязательных ресурсов вычисления, сети и других ресурсов, необходимых для этого решения. 

    > [!Note]  
    > Эти инструкции **не** будут работать с пакетом средств разработки Azure Stack (ASDK) из-за сетевых ограничений в ASDK. Дополнительные сведения см. в статье [Требования и рекомендации для ASDK](https://docs.microsoft.com/azure-stack/asdk/asdk-deploy-considerations).

-  Доступ к VPN-устройству в локальной сети, в которой размещена интегрированная система Azure Stack Hub. Устройству необходимо создать туннель IPSec, который соответствует параметрам, описанным в разделе [Параметры развертывания](#deployment-parameters).

-  Решение виртуального сетевого модуля (NVA), доступное в Azure Stack Hub Marketplace. Виртуальный сетевой модуль используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям. В этой процедуре используется [решение с одной виртуальной машиной с брандмауэром следующего поколения Fortinet FortiGate](https://azuremarketplace.microsoft.com/marketplace/apps/fortinet.fortinet-FortiGate-singlevm).

    > [!Note]  
    > Если в Azure Stack Hub Marketplace нет **виртуальной машины Fortinet FortiGate-VM для Azure BYOL** и **развертывания одной виртуальной машины (BYOL) FortiGate NGFW**, обратитесь к оператору облака.

-  Чтобы активировать NVA FortiGate, потребуется по крайней мере один доступный файл лицензии FortiGate. Сведения о том, как получить эти лицензии, см. в [библиотеке документации Fortinet](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/19071/registering-and-downloading-your-license).

    В этой процедуре используется развертывание [одной виртуальной машины FortiGate-VM](ttps://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/632940/single-FortiGate-vm-deployment). Вы узнаете, как подключить NVA FortiGate к виртуальной сети Azure Stack Hub в вашей локальной сети.

    Дополнительные сведения о развертывании решения FortiGate в режиме "активный — пассивный" (высокий уровень доступности) см. в документации [по высокому уровню доступности FortiGate-VM в Azure](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/983245/ha-for-FortiGate-vm-on-azure).

## <a name="deployment-parameters"></a>Параметры развертывания

В следующей таблице для справки перечислены параметры, которые используются в этих развертываниях.

| Параметр | Значение |
|-----------------------------------|---------------------------|
| Имя экземпляра FortiGate | forti1 |
| Лицензия BYOL, версия | 6.0.3 |
| Имя пользователя с правами администратора FortiGate | fortiadmin |
| Имя группы ресурсов | forti1-rg1 |
| Имя виртуальной сети | forti1vnet1 |
| Адресное пространство виртуальной сети | 172.16.0.0/16* |
| Имя подсети общедоступной виртуальной сети | forti1-PublicFacingSubnet |
| Префикс адреса общедоступной виртуальной сети | 172.16.0.0/24* |
| Имя подсети виртуальной сети | forti1-InsideSubnet |
| Префикс подсети виртуальной сети | 172.16.1.0/24* |
| Размер виртуальной машины NVA FortiGate | Standard F2s_v2 |
| Имя общедоступного IP-адреса | forti1-publicip1 |
| Тип общедоступного IP-адреса | Статические |

> [!Note]
> \* Выберите другое адресное пространство и префиксы подсети, если `172.16.0.0/16` перекрывается локальной сетью или пулом виртуальных IP-адресов из сети Azure Stack Hub.

## <a name="deploy-the-fortigate-ngfw-marketplace-items"></a>Развертывание элементов Marketplace FortiGate NGFW

1. Откройте портал пользователя Azure Stack Hub.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image5.png)

1. Щелкните **Создать ресурс** и выполните поиск по запросу `FortiGate`.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image6.png)

2. Щелкните **FortiGate NGFW** и нажмите кнопку **Создать**.

3. Заполните поля на вкладке **Основные сведения**, используя параметры из таблицы [Параметры развертывания](#deployment-parameters).

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image7.png)

1. Щелкните **ОК**.

2. Укажите виртуальную сеть, подсети и сведения о размере виртуальной машины, используя таблицу [Параметры развертывания](#deployment-parameters).

    > [!Warning] 
    > Если локальная сеть перекрывается диапазоном IP-адресов `172.16.0.0/16`, необходимо выбрать и настроить другой диапазон сети и подсети. Если вы хотите использовать имена и диапазоны, отличные от имен, указанных в таблице [Параметры развертывания](#deployment-parameters), используйте параметры, которые **не** конфликтуют с локальной сетью. Будьте внимательны при настройке диапазона IP-адресов виртуальной сети и диапазонов подсетей в виртуальной сети. Диапазон не должен перекрываться диапазонами IP-адресов, которые существуют в локальной сети.

3. Щелкните **ОК**.

4. Настройте общедоступный IP-адрес для NVA FortiGate:

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image8.png)

5. Щелкните **ОК**. Затем нажмите кнопку **ОК**.

6. Нажмите кнопку **создания**.

    Развертывание займет около 10 минут.

## <a name="configure-routes-udr-for-the-vnet"></a>Настройка маршрутов (UDR) для виртуальной сети

1. Откройте портал пользователя Azure Stack Hub.

2. Выберите "Группы ресурсов". Введите `forti1-rg1` в фильтре и дважды щелкните группу ресурсов forti1-rg1.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image9.png)

2. Выберите ресурс forti1-forti1-InsideSubnet-routes-xxxx.

3. В разделе **Параметры** выберите **Маршруты**.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image10.png)

4. Удалите маршрут **to-Internet**.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image11.png)

5. Выберите *Да*.

6. Нажмите кнопку **Добавить**, чтобы добавить новый маршрут.

7. Присвойте маршруту имя `to-onprem`.

8. Введите диапазон IP-адресов, определяющий диапазон локальной сети, к которой будет подключаться VPN.

9. Выберите **Виртуальный модуль** в поле **Тип следующего прыжка** и укажите `172.16.1.4`. Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image12.png)

10. Щелкните **Сохранить**.

## <a name="activate-the-fortigate-nva"></a>Активация NVA FortiGate

Активируйте NVA FortiGate и настройте VPN-подключение IPSec для каждого NVA.

Чтобы активировать каждый NVA FortiGate потребуется действительный файл лицензии из Fortinet. Модули NVA **не** будут работать до тех пор, пока они все не будут активированы. Дополнительные сведения о том, как получить файл лицензии и шаги по активации NVA, см. в [библиотеке документации по Fortinet](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/19071/registering-and-downloading-your-license).

После активации NVA создайте на нем VPN-туннель IPSec.

1. Откройте портал пользователя Azure Stack Hub.

2. Выберите "Группы ресурсов". Введите `forti1` в фильтре и дважды щелкните группу ресурсов forti1.

3. Дважды щелкните виртуальную машину **forti1** в списке типов ресурсов в колонке группы ресурсов.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image13.png)

4. Скопируйте назначенный IP-адрес, откройте браузер и вставьте адрес в адресную строку. Сайт может отобразить предупреждение о том, что сертификат безопасности не является доверенным. Не обращайте внимание.

5. Введите имя пользователя с правами администратора и пароль FortiGate, указанные во время развертывания.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image14.png)

6. Щелкните **System** (Система) > **Firmware** (Встроенное ПО).

7. Установите флажок напротив последней версии встроенного ПО, например `FortiOS v6.2.0 build0866`.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image15.png)

8. Нажмите кнопку **Backup config and upgrade** (Резервное копирование и обновление) > **Continue** (Продолжить).

9. В NVA встроенное ПО обновляется до последней сборки, а модуль перезагружается. Процесс займет около пяти минут. Снова войдите в веб-консоль FortiGate.

10. Щелкните **VPN** > **IPSec Wizard** (Мастер настройки IPSec).

11. Введите имя VPN, например `conn1`, в **мастере создания VPN**.

12. Щелкните **This site is behind NAT** (Сайт скрыт за NAT).

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image16.png)

13. Выберите **Далее**.

14. Введите удаленный IP-адрес локального VPN-устройства, к которому будет выполнено подключение.

15. Выберите **port1** в качестве **исходящего интерфейса**.

16. Выберите **Pre-shared Key** (Общий ключ) и введите (и сохраните) общий ключ. 

    > [!Note]  
    > Этот ключ потребуется для настройки подключения на локальном VPN-устройстве, то есть ключи должны *полностью* совпадать.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image17.png)

17. Выберите **Далее**.

18. Выберите **port2** в качестве **локального интерфейса**

19. Введите диапазон локальной подсети:
    - forti1: 172.16.0.0/16
    - forti2: 172.17.0.0/16

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

20. Введите соответствующие удаленные подсети, представляющие локальную сеть, к которой вы будете подключаться через локальное VPN-устройство.

    [](./media/azure-stack-network-howto-vnet-to-onprem/image18.png)

21. Нажмите кнопку **Создать**

22. Выберите **Network** (Сеть) > **Interfaces** (Интерфейсы).

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image19.png)

23. Дважды щелкните **port2**.

24. Выберите **LAN** в списке **Role** (Роль) и **DHCP** в качестве режима адресации.

25. Щелкните **ОК**.

## <a name="configure-the-on-premises-vpn"></a>Настройка локального VPN-устройства

На локальном VPN-устройстве следует настроить создание VPN-туннеля IPSec. В следующей таблице приведены параметры, которые потребуется настроить для локального VPN-устройства. Сведения о настройке локального VPN-устройства см. в документации для вашего устройства.

| Параметр | Значение |
| --- | --- |
| IP-адрес удаленного шлюза | Общедоступный IP-адрес, присвоенный forti1, можно найти в разделе [Активация NVA FortiGate](#activate-the-fortigate-nva). |
| Удаленная IP-сеть | 172.16.0.0/16 (при использовании диапазона IP-адресов в этих инструкциях для виртуальной сети). |
| Метод аутентификации — общий ключ (PSK) | Из шага 16.
| Версия IKE | 1 |
| Режим IKE | Главный (защита идентификатора) |
| Алгоритмы предложений первого этапа | AES128-SHA256, AES256-SHA256, AES128-SHA1, AES256-SHA1 |
| Группы Диффи-Хеллмана | 14, 5 |

## <a name="create-the-vpn-tunnel"></a>Создание туннеля VPN

После того как локальное VPN-устройство будет настроено надлежащим образом, можно установить VPN-туннель.

На модуле NVA FortiGate:

1. В веб-консоли forti1 FortiGate щелкните **Monitor** > **IPsec Monitor** (Монитор >Монитор IPSEC).

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image20.png)

2. Выделите **conn1** и выберите **Bring Up** > **All Phase 2 Selectors** (Открыть > Все селекторы этапа 2).

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image21.png)

## <a name="test-and-validate-connectivity"></a>Проверка подключения

Между сетью виртуальной сети и локальной сетью можно осуществлять маршрутизацию с помощью локального VPN-устройства.

Чтобы проверить подключение:

1. Создайте виртуальную машину в виртуальной сети Azure Stack Hub и систему в локальной сети. Инструкции по созданию виртуальной машины см. в статье [Краткое руководство. Создание виртуальной машины Windows Server с помощью портала Azure Stack Hub](https://docs.microsoft.com/azure-stack/user/azure-stack-quick-windows-portal).

2. При создании виртуальной машины Azure Stack Hub и подготовке локальной системы проверьте следующее:

-  Виртуальная машина Azure Stack Hub размещается во **внутренней подсети** виртуальной сети.

-  Локальная система помещается в локальную сеть в пределах заданного диапазона IP-адресов, как определено в конфигурации IPSec. Убедитесь также, что IP-адрес локального интерфейса локального VPN-устройства предоставляется локальной системе в качестве маршрута, который может подключиться к виртуальной сети Azure Stack Hub, например `172.16.0.0/16`.

-  **Не применяйте** группы безопасности сети к виртуальной машине Azure Stack Hub при создании. Может потребоваться удалить группу безопасности сети, которая добавляется по умолчанию при создании виртуальной машины на портале.

-  Убедитесь, что ОС локальной системы и ОС виртуальной машины Azure Stack Hub не использует правила брандмауэра ОС, которые запрещают обмен данными для проверки подключения. В целях тестирования рекомендуется полностью отключить брандмауэр в операционной системе обеих систем.

## <a name="next-steps"></a>Дальнейшие действия

[Сети Azure Stack Hub: различия и рекомендации](azure-stack-network-differences.md)  
[Предложение сетевого решения для Azure Stack Hub с помощью Fortinet FortiGate](../operator/azure-stack-network-solutions-enable.md)  
