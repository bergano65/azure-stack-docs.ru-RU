---
title: Подключение двух экземпляров Azure Stack Hub с помощью пиринга виртуальных сетей
description: Инструкции по подключению двух экземпляров Azure Stack Hub с помощью пиринга виртуальных сетей.
author: mattbriggs
ms.topic: how-to
ms.date: 1/22/2020
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 10/03/2019
ms.openlocfilehash: b1d60037dd86a6de1aac73ff5a607605ceda1614
ms.sourcegitcommit: 4ac711ec37c6653c71b126d09c1f93ec4215a489
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2020
ms.locfileid: "77703882"
---
# <a name="connect-two-vnets-through-peering"></a>Подключение двух виртуальных сетей через пиринг

В этой статье описывается, как создать подключение между двумя виртуальными сетями в одной среде. Во время настройки подключений вы узнаете, как работают VPN-шлюзы в Azure Stack Hub. Вы подключите две виртуальные сети в одной среде Azure Stack Hub с помощью Fortinet FortiGate. Эта процедура развертывает две виртуальные сети с виртуальным сетевым модулем (NVA) FortiGate в каждой виртуальной сети в отдельной группе ресурсов. В ней также подробно описаны изменения, необходимые для настройки VPN-подключения IPSec между двумя виртуальными сетями. Повторите действия, описанные в этой статье, для каждого развертывания виртуальной сети.

## <a name="prerequisites"></a>Предварительные требования

-   Доступ к системе с доступной емкостью для развертывания обязательных ресурсов вычисления, сети и других ресурсов, необходимых для этого решения.

-  Решение виртуального сетевого модуля (NVA), которое скачано и опубликовано в Azure Stack Hub Marketplace. Виртуальный сетевой модуль используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям. В этой процедуре используется [решение с одной виртуальной машиной с брандмауэром следующего поколения Fortinet FortiGate](https://azuremarketplace.microsoft.com/marketplace/apps/fortinet.fortinet-FortiGate-singlevm).

-  Чтобы активировать NVA FortiGate, потребуется по крайней мере один доступный файл лицензии FortiGate. Сведения о том, как получить эти лицензии, см. в [библиотеке документации Fortinet](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/19071/registering-and-downloading-your-license).

    В этой процедуре используется развертывание [одной виртуальной машины FortiGate-VM](ttps://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/632940/single-FortiGate-vm-deployment). Вы узнаете, как подключить NVA FortiGate к виртуальной сети Azure Stack Hub в вашей локальной сети.

    Дополнительные сведения о развертывании решения FortiGate в режиме "активный — пассивный" (высокий уровень доступности) см. в документации [по высокому уровню доступности FortiGate-VM в Azure](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/983245/ha-for-FortiGate-vm-on-azure).

## <a name="deployment-parameters"></a>Параметры развертывания

В следующей таблице для справки перечислены параметры, которые используются в этих развертываниях.

### <a name="deployment-one-forti1"></a>Развертывание 1: Forti1

| Имя экземпляра FortiGate | Forti1 |
|-----------------------------------|---------------------------|
| Лицензия BYOL, версия | 6.0.3 |
| Имя пользователя с правами администратора FortiGate | fortiadmin |
| Имя группы ресурсов | forti1-rg1 |
| Имя виртуальной сети | forti1vnet1 |
| Адресное пространство виртуальной сети | 172.16.0.0/16* |
| Имя подсети общедоступной виртуальной сети | forti1-PublicFacingSubnet |
| Префикс адреса общедоступной виртуальной сети | 172.16.0.0/24* |
| Имя подсети виртуальной сети | forti1-InsideSubnet |
| Префикс подсети виртуальной сети | 172.16.1.0/24* |
| Размер виртуальной машины NVA FortiGate | Standard F2s_v2 |
| Имя общедоступного IP-адреса | forti1-publicip1 |
| Тип общедоступного IP-адреса | Статические |

### <a name="deployment-two-forti2"></a>Развертывание 2: Forti2

| Имя экземпляра FortiGate | Forti2 |
|-----------------------------------|---------------------------|
| Лицензия BYOL, версия | 6.0.3 |
| Имя пользователя с правами администратора FortiGate | fortiadmin |
| Имя группы ресурсов | forti2-rg1 |
| Имя виртуальной сети | forti2vnet1 |
| Адресное пространство виртуальной сети | 172.17.0.0/16* |
| Имя подсети общедоступной виртуальной сети | forti2-PublicFacingSubnet |
| Префикс адреса общедоступной виртуальной сети | 172.17.0.0/24* |
| Имя подсети виртуальной сети | Forti2-InsideSubnet |
| Префикс подсети виртуальной сети | 172.17.1.0/24* |
| Размер виртуальной машины NVA FortiGate | Standard F2s_v2 |
| Имя общедоступного IP-адреса | Forti2-publicip1 |
| Тип общедоступного IP-адреса | Статические |

> [!Note]
> \* Выберите другой набор адресных пространств и префиксов подсети, если указанные выше значения перекрываются в локальной сетевой среде, включая пул виртуальных IP-адресов Azure Stack Hub. Убедитесь также, что диапазоны адресов не перекрывают друг друга.

## <a name="deploy-the-fortigate-ngfw"></a>Развертывание FortiGate NGFW

1.  Откройте портал пользователя Azure Stack Hub.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image5.png)

2.  Щелкните **Создать ресурс** и выполните поиск по запросу `FortiGate`.

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image6.png)

3.  Щелкните **FortiGate NGFW** и нажмите кнопку **Создать**.

4.  Заполните поля на вкладке **Основные сведения**, используя параметры из таблицы [Параметры развертывания](#deployment-parameters).

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image7.png)

5.  Щелкните **ОК**.

6.  Укажите виртуальную сеть, подсети и сведения о размере виртуальной машины, используя таблицу [Параметры развертывания](#deployment-parameters).

    > [!Warning] 
    > Если локальная сеть перекрывается диапазоном IP-адресов `172.16.0.0/16`, необходимо выбрать и настроить другой диапазон сети и подсети. Если вы хотите использовать имена и диапазоны, отличные от имен, указанных в таблице [Параметры развертывания](#deployment-parameters), используйте параметры, которые **не** конфликтуют с локальной сетью. Будьте внимательны при настройке диапазона IP-адресов виртуальной сети и диапазонов подсетей в виртуальной сети. Диапазон не должен перекрываться диапазонами IP-адресов, которые существуют в локальной сети.

7.  Щелкните **ОК**.

8.  Настройте общедоступный IP-адрес для NVA FortiGate:

    ![](./media/azure-stack-network-howto-vnet-to-onprem/image8.png)

9.  Щелкните **ОК**. Затем нажмите кнопку **ОК**.

10.  Нажмите кнопку **создания**.

Развертывание займет около 10 минут.

## <a name="configure-routes-udrs-for-each-vnet"></a>Настройка маршрутов (определяемых пользователем маршрутов) для каждой виртуальной сети

Выполните следующие действия для обоих развертываний: forti1-rg1 и forti2-rg1.

1. Откройте портал пользователя Azure Stack Hub.

2. Выберите "Группы ресурсов". Введите `forti1-rg1` в фильтре и дважды щелкните группу ресурсов forti1-rg1.

    ![resource group](./media/azure-stack-network-howto-vnet-to-onprem/image9.png)

2. Выберите ресурс **forti1-forti1-InsideSubnet-routes-xxxx**.

3. В разделе **Параметры** выберите **Маршруты**.

    ![Маршруты](./media/azure-stack-network-howto-vnet-to-onprem/image10.png)

4. Удалите маршрут **to-Internet**.

    ![В Интернет](./media/azure-stack-network-howto-vnet-to-onprem/image11.png)

5. Выберите *Да*.

6. Нажмите кнопку **Добавить**, чтобы добавить новый маршрут.

7. Присвойте маршруту имя `to-onprem`.

8. Введите диапазон IP-адресов, определяющий диапазон локальной сети, к которой будет подключаться VPN.

9. Выберите **Виртуальный модуль** в поле **Тип следующего прыжка** и укажите `172.16.1.4`. Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

    ![Тип следующего прыжка](./media/azure-stack-network-howto-vnet-to-onprem/image12.png)

10. Щелкните **Сохранить**.

Чтобы активировать каждый NVA FortiGate, потребуется действительный файл лицензии из Fortinet. Модули NVA **не** будут работать до тех пор, пока они все не будут активированы. Дополнительные сведения о том, как получить файл лицензии и шаги по активации NVA, см. в [библиотеке документации по Fortinet](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/19071/registering-and-downloading-your-license).

Необходимо приобрести два файла лицензий — по одному для каждого NVA.

## <a name="create-an-ipsec-vpn-between-the-two-nvas"></a>Создание VPN-подключения IPSec между двумя NVA

После активации NVA выполните следующие действия, чтобы создать VPN-подключение IPSec между двумя NVA.

Выполните следующие действия для виртуальных сетевых модулей forti1 NVA и forti2:

1.  Получите назначенный общедоступный IP-адрес, перейдя на страницу обзора виртуальной машины fortiX:

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image13.png)

2.  Скопируйте назначенный IP-адрес, откройте браузер и вставьте адрес в адресную строку. В браузере может появиться предупреждение о том, что сертификат безопасности не является доверенным. Не обращайте внимание.

4.  Введите имя пользователя с правами администратора и пароль FortiGate, указанные во время развертывания.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image14.png)

5.  Щелкните **System** (Система) > **Firmware** (Встроенное ПО).

6.  Установите флажок напротив последней версии встроенного ПО, например `FortiOS v6.2.0 build0866`.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image15.png)

7.  Нажмите кнопку **Backup config and upgrade** (Резервное копирование и обновление) > **Continue** (Продолжить).

8.  В NVA встроенное ПО обновляется до последней сборки, а модуль перезагружается. Процесс займет около пяти минут. Снова войдите в веб-консоль FortiGate.

10.  Щелкните **VPN** > **IPSec Wizard** (Мастер настройки IPSec).

11. Введите имя VPN, например `conn1`, в **мастере создания VPN**.

12. Щелкните **This site is behind NAT** (Сайт скрыт за NAT).

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image16.png)

13. Выберите **Далее**.

14. Введите удаленный IP-адрес локального VPN-устройства, к которому будет выполнено подключение.

15. Выберите **port1** в качестве **исходящего интерфейса**.

16. Выберите **Pre-shared Key** (Общий ключ) и введите (и сохраните) общий ключ. 

    > [!Note]  
    > Этот ключ потребуется для настройки подключения на локальном VPN-устройстве, то есть ключи должны *полностью* совпадать.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image17.png)

17. Выберите **Далее**.

18. Выберите **port2** в качестве **локального интерфейса**

19. Введите диапазон локальной подсети:
    - forti1: 172.16.0.0/16
    - forti2: 172.17.0.0/16

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

20. Введите соответствующие удаленные подсети, представляющие локальную сеть, к которой вы будете подключаться через локальное VPN-устройство.
    - forti1: 172.16.0.0/16
    - forti2: 172.17.0.0/16

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image18.png)

21. Нажмите кнопку **Создать**

22. Выберите **Network** (Сеть) > **Interfaces** (Интерфейсы).

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image19.png)

23. Дважды щелкните **port2**.

24. Выберите **LAN** в списке **Role** (Роль) и **DHCP** в качестве режима адресации.

25. Щелкните **ОК**.

Повторите эти действия на другом NVA.

## <a name="bring-up-all-phase-2-selectors"></a>Вызов всех селекторов второго этапа 

После завершения приведенной выше процедуры для *обоих* NVA:

1.  В веб-консоли forti2 FortiGate щелкните **Monitor** > **IPsec Monitor** (Монитор >Монитор IPSEC). 

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image20.png)

2.  Выделите `conn1` и выберите **Bring Up** > **All Phase 2 Selectors** (Открыть > Все селекторы этапа 2).

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image21.png)

## <a name="test-and-validate-connectivity"></a>Проверка подключения

Теперь можно выполнять маршрутизацию между виртуальными сетями через NVA FortiGate. Чтобы проверить подключение, создайте виртуальную машину Azure Stack Hub внутри подсети каждой виртуальной сети. Виртуальную машину Azure Stack Hub можно создать с помощью портала, интерфейса командной строки или PowerShell. При создании виртуальных машин:

-   Виртуальная машина Azure Stack Hub размещается во **внутренней подсети** каждой виртуальной сети.

-   **Не** применяйте все группы безопасности сети (NSG) к виртуальной машине при создании (удалите NSG, которая добавляется по умолчанию при создании виртуальной машины на портале).

-   Убедитесь, что правила брандмауэра виртуальной машины разрешают взаимодействие, которое будет использоваться для проверки подключения. В целях тестирования рекомендуется полностью отключить брандмауэр в операционной системе, если это возможно.

## <a name="next-steps"></a>Дальнейшие действия

[Сети Azure Stack Hub: различия и рекомендации](azure-stack-network-differences.md)  
[Предложение сетевого решения для Azure Stack Hub с помощью Fortinet FortiGate](../operator/azure-stack-network-solutions-enable.md)  