---
title: Развертывание кластера Kubernetes в пользовательской виртуальной сети Azure Stack Hub
description: Сведения о том, как развернуть кластер Kubernetes в пользовательской виртуальной сети Azure Stack Hub.
author: mattbriggs
ms.topic: article
ms.date: 3/19/2020
ms.author: mabrigg
ms.reviewer: waltero
ms.lastreviewed: 3/19/2020
ms.openlocfilehash: aac2f9a0991bdae7f15d7fc54517a880ab384785
ms.sourcegitcommit: 17be49181c8ec55e01d7a55c441afe169627d268
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2020
ms.locfileid: "80068942"
---
# <a name="deploy-a-kubernetes-cluster-to-a-custom-virtual-network-on-azure-stack-hub"></a>Развертывание кластера Kubernetes в пользовательской виртуальной сети Azure Stack Hub 

Кластер Kubernetes можно развернуть с помощью подсистемы Azure Kubernetes Service (AKS) в пользовательской виртуальной сети. В этой статье описано, как найти информацию, необходимую для виртуальной сети. Вы можете найти инструкции по определению используемых в кластере IP-адресов, по настройке параметров в модели API и настройке таблицы маршрутизации и группы безопасности сети.

Кластер Kubernetes в Azure Stack Hub, использующий подсистему AKS, работает с подключаемым сетевым модулем kubenet. Подробные сведения о работе подключаемого сетевого модуля kubenet в сети Azure см. в статье [Использование сети kubenet с пользовательскими диапазонами IP-адресов в Службе Azure Kubernetes (AKS)](https://docs.microsoft.com/azure/aks/configure-kubenet).

## <a name="create-custom-virtual-network"></a>Создание пользовательской виртуальной сети

В экземпляре Azure Stack Hub должна быть создана пользовательская виртуальная сеть. Дополнительные сведения см. в [кратком руководстве по созданию виртуальной сети с помощью портала Azure](https://docs.microsoft.com/azure/virtual-network/quick-create-portal).

Создайте новую подсеть в виртуальной сети. Затем вам нужно получить идентификатор ресурса подсети и диапазон IP-адресов. Этот идентификатор ресурса и диапазон вы укажете в модели API при развертывании кластера.

1. Откройте пользовательский портал Azure Stack Hub в своем экземпляре Azure Stack Hub.
2. Щелкните **Все ресурсы**.
3. Введите имя виртуальной сети в поле поиска.
4. Выберите **Подсети** >  **+ Подсети**, чтобы добавить подсеть.
5. Добавьте **имя** и **диапазон адресов** в нотации CIDR. Щелкните **ОК**.
4. Выберите **Свойства** на панели **Виртуальные сети**. Скопируйте **Идентификатор ресурса** и добавьте `/subnets/<nameofyoursubnect>`. Это значение вам пригодится в качестве значения ключа `vnetSubnetId` в модели API для кластера. Идентификатор ресурса для подсети имеет следующий формат:<br>`/subscriptions/SUB_ID/resourceGroups/RG_NAME/providers/Microsoft.Network/virtualNetworks/VNET_NAME/subnets/SUBNET_NAME`

    ![Идентификатор ресурса виртуальной сети](media/kubernetes-aks-engine-custom-vnet/virtual-network-id.png)

5. На панели **Виртуальные сети** выберите **Подсети**. Выберите имя подсети, например default.
    
    ![Блок адресов виртуальной сети в формате CIDR](media/kubernetes-aks-engine-custom-vnet/virtual-network-cidr-block.png)
    
6. В колонке подсети запишите диапазон адресов и блок CIDR для виртуальной сети, например `10.1.0.0 - 10.1.0.255 (256 addresses)` и `10.1.0.0/24`.



## <a name="get-the-ip-address-block"></a>Получение блока IP-адресов

Подсистема AKS поддерживает развертывание в существующей виртуальной сети. При развертывании в существующей подсети кластер будет использовать один блок последовательных IP-адресов для агентов, и второй блок для главных узлов.

Вам потребуется задать два значения. Нужно знать количество IP-адресов, которые необходимо зарезервировать для кластера, а также первый статический IP-адрес для этого последовательного блока в пределах диапазона IP-адресов подсети.

При использовании нескольких главных узлов подсистеме AKS может потребоваться диапазон до шестнадцати неиспользуемых IP-адресов. Кластер будет использовать один IP-адрес для каждого главного узла, которых может быть до пяти экземпляров. Подсистема AKS потребуется зарезервировать еще десять IP-адресов, которые следуют за последним адресом главного узла. И, наконец, для подсистемы балансировки нагрузки выделяется один дополнительный IP-адрес после IP-адресов главных узлов и запасных IP-адресов. В общей сложности это составляет шестнадцать IP-адресов.

При размещении блока IP-адресов подсеть налагает следующие ограничения на распределение IP-адресов:
 - Первые четыре IP-адреса и последний IP-адрес в любой подсети Azure зарезервированы и не могут использоваться.
 - Должен оставаться свободным буфер размером не менее шестнадцати IP-адресов.
 - Значение первого IP-адреса кластера должно находиться ближе к концу адресного пространства, чтобы избежать конфликтов IP-адресов. Если это возможно, присвойте свойству `firstConsecutiveStaticIP` IP-адрес в *конце* доступного пространства IP-адресов подсети.

В следующем примере показано, как заполняется диапазон IP-адресов в подсети с учетом всех этих факторов. В этом примере используются три главных узла. Если вы используете подсеть с 256 адресами (например, 10.1.0.0/24), первым статическим IP-адресом в последовательном диапазоне будет 207. Все эти адреса и рекомендации собраны в следующей таблице.

| Диапазон для подсети /24 | Number | Примечание |
| --- | --- | --- |
| 10.1.0.0–10.1.03 | 4 | Зарезервировано в подсети Azure. |
| **10.1.0.224**–10.1.0.238 | 14 | Число IP-адресов для кластера, определенного подсистемой AKS.<br><br> Три IP-адреса для трех главных узлов<br>Десять IP-адресов в качестве резерва<br>Один IP-адрес для подсистемы балансировки нагрузки |
| 10.1.0.239–10.1.0.255 | 16 | Буфер из шестнадцати IP-адресов. |
| 10.1.0.256 | 1 | Зарезервировано в подсети Azure. |

В нашем примере свойство `firstConsecutiveStaticIP` будет иметь значение `10.1.0.224`.

Для более крупных подсетей, например /16 с более чем 60 000 адресов, часто будет нецелесообразно выделять статические IP-адреса из конца адресного пространства. Но в любом случае при назначении диапазона статических IP-адресов кластера не затрагивайте первые 24 адреса в диапазоне, чтобы сохранить устойчивость кластера для запроса адресов.


## <a name="update-the-api-model"></a>Обновление модели API

Обновите модель API, которая используется для развертывания кластера из подсистемы AKS в пользовательскую виртуальную сеть.

Задайте следующие значения в **masterProfile**:

| Поле | Пример | Описание |
| --- | --- | --- |
| vnetSubnetId | `/subscriptions/77e28b6a-582f-42b0-94d2-93b9eca60845/resourceGroups/MDBN-K8S/providers/Microsoft.Network/virtualNetworks/MDBN-K8S/subnets/default` | Укажите идентификатор ресурса вашей подсети.  |
| firstConsecutiveStaticIP | 10.1.0.224 | Присвойте свойству конфигурации `firstConsecutiveStaticIP` IP-адрес из *конца* доступного диапазона IP-адресов нужной подсети. `firstConsecutiveStaticIP` применяется только к пулу главных узлов. |

Задайте следующие значения в **agentPoolProfiles**.

| Поле | Пример | Описание |
| --- | --- | --- |
| vnetSubnetId | `/subscriptions/77e28b6a-582f-42b0-94d2-93b9eca60845/resourceGroups/MDBN-K8S/providers/Microsoft.Network/virtualNetworks/MDBN-K8S/subnets/default` | Укажите идентификатор пути к нужной подсети в Azure Resource Manager.  |

Пример:

```json
"masterProfile": {
  ...
  "vnetSubnetId": "/subscriptions/77e28b6a-582f-42b0-94d2-93b9eca60845/resourceGroups/MDBN-K8S/providers/Microsoft.Network/virtualNetworks/MDBN-K8S/subnets/default",
  "firstConsecutiveStaticIP": "10.1.0.224",
  ...
},
...
"agentPoolProfiles": [
  {
    ...
    "vnetSubnetId": "/subscriptions/77e28b6a-582f-42b0-94d2-93b9eca60845/resourceGroups/MDBN-K8S/providers/Microsoft.Network/virtualNetworks/MDBN-K8S/subnets/default",
    ...
  },

```

## <a name="deploy-your-cluster"></a>Развертывание кластера

После добавления значений в модель API вы можете развернуть кластер с клиентского компьютера, используя команду `deploy` и подсистему AKS. Следуйте указаниям по развертыванию кластера Kubernetes, приведенным [здесь](azure-stack-kubernetes-aks-engine-deploy-cluster.md#deploy-a-kubernetes-cluster).

## <a name="set-the-route-table-and-network-security-group"></a>Настройка таблицы маршрутизации и группы безопасности сети

После развертывания кластера вернитесь к виртуальной сети на пользовательском портале Azure Stack. В колонке подсети укажите таблицу маршрутов и группу безопасности сети (NSG). Если вы не используете Azure CNI, для `networkPlugin` укажите `kubenet` в объекте конфигурации модели API `kubernetesConfig`. Успешно завершив развертывание кластера в пользовательской виртуальной сети, получите идентификатор ресурса таблицы маршрутов из колонки **Сеть** в группе ресурсов кластера.

1. Откройте пользовательский портал Azure Stack Hub в своем экземпляре Azure Stack Hub.
2. Щелкните **Все ресурсы**.
3. Введите имя виртуальной сети в поле поиска.
4. Выберите **Подсети** а затем выберите имя подсети, которая содержит кластер.
    
    ![Таблица маршрутизации и группа безопасности сети](media/kubernetes-aks-engine-custom-vnet/virtual-network-rt-nsg.png)
    
5. Щелкните **Таблица маршрутизации** и выберите для кластера таблицу маршрутизации.
6. Щелкните **Группа безопасности сети** и выберите для кластера группу безопасности сети.

> [!Note]  
> В пользовательской виртуальной сети для кластера Kubernetes Windows есть [известная проблема](https://github.com/Azure/aks-engine/issues/371).

## <a name="next-steps"></a>Дальнейшие действия

- См. сведения об [обработчике AKS в Azure Stack Hub](azure-stack-kubernetes-aks-engine-overview.md).  
- См. сведения об [использовании службы Azure Monitor для контейнеров](https://docs.microsoft.com/azure/azure-monitor/insights/container-insights-overview).