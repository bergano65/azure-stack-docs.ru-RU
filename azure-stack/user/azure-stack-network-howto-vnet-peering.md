---
title: Подключение двух экземпляров Azure Stack с помощью пиринга виртуальных сетей | Документация Майкрософт
description: Инструкции по подключению двух экземпляров Azure Stack с помощью пиринга виртуальных сетей.
services: azure-stack
author: mattbriggs
ms.service: azure-stack
ms.topic: how-to
ms.date: 10/03/2019
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 10/03/2019
ms.openlocfilehash: 9eb4780a80e5cedd595950813d5cb5029e1b1857
ms.sourcegitcommit: ed44d477b9fd11573d1e0d1ed3a3c0ef4512df53
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73845842"
---
# <a name="vnet-peering-in-azure-stack-with-vms"></a>Пиринг виртуальных сетей в Azure Stack с виртуальными машинами

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Вы можете подключить две виртуальные сети Azure Stack друг к другу в одной среде Azure Stack. В настоящее время невозможно подключить виртуальные сети Azure Stack с помощью встроенного [шлюза виртуальной сети](https://docs.microsoft.com/azure-stack/user/azure-stack-network-differences). Для создания туннеля VPN между двумя виртуальными сетями Azure Stack следует использовать устройства NVA. В этой статье в ссылках на шаблоны, мы рассмотрим установку двух виртуальных машин Windows Server 2016 с установленным RRAS. Для внедрения туннеля S2SVPN по протоколу IKEv2 между двумя виртуальными сетями настроено два сервера RRAS. Соответствующие правила NSG и UDR созданы для обеспечения маршрутизации между подсетями на каждой виртуальной сети, обозначенной как **внутренняя**. 

Такой шаблон развертывания является основой, которая позволит создавать туннели VPN не только в экземпляре Azure Stack, но и между экземплярами Azure Stack и другими ресурсами, такими как локальные сети с использованием VPN туннелей S2S на Windows RRAS. 

Вы можете найти шаблоны в репозитории [шаблонов интеллектуальных границ Azure](https://github.com/Azure-Samples/azure-intelligent-edge-patterns
) на сайте GitHub. Шаблон находится в папке **S2SVPNTunnel**.

![замещающий текст](./media/azure-stack-network-howto-vnet-peering/overview.png)

## <a name="requirements"></a>Требования

- Интегрированная система ASDK или Azure Stack с последними обновлениями. 
- Необходимые элементы Marketplace для Azure Stack:
    -  Windows Server 2016 Datacenter (рекомендуется последняя сборка).
    -  Расширение пользовательских сценариев

## <a name="things-to-consider"></a>Полезная информация

- Группа сетевой безопасности применяется к шаблону "Подсеть туннеля". Рекомендуется закрепить внутреннюю подсеть в каждой виртуальной сети с помощью дополнительной NSG.
- Запрещающее правило RDP применяется к NSG туннеля. Его нужно установить, чтобы разрешить вам доступ к виртуальным машинам через публичный IP-адрес
- Это решение не учитывает разрешение DNS для учетных записей
- Комбинация имени виртуальной сети и vmName должна содержать не более 15 символов
- Этот шаблон предназначен для настройки имен виртуальных машин для VNet1 и VNet2
- Этот шаблон использует BYOL Windows
- При удалении группы ресурсов, включенной в данный момент (1907), вы должны вручную отсоединить NSG от подсети туннеля, чтобы убедиться, что группа ресурсов удалена полностью
- Этот шаблон использует виртуальную машину DS3v2. Служба RRAS устанавливает и запускает внутренний SQL Server Windows. Если размер виртуальной машины слишком мал, это может вызвать проблемы с памятью. Проверьте производительность до уменьшения размера виртуальной машины.
- Это не высокодоступное решение. Если вам требуется более высокоскоростное решение, вы можете добавить вторую виртуальную машину. В этом случае вам придется вручную изменить маршрут в таблице маршрутизации на внутреннем протоколе IP вторичного интерфейса. Вам также потребуется настроить несколько туннелей для перекрестного соединения.

## <a name="options"></a>Параметры

- С помощью параметров_artifactsLocation и _artifactsLocationSasToken вы можете использовать собственную учетную запись хранилища BLOB-объектов и маркер SAS.
- В этом шаблоне есть два вывода INTERNALSUBNETREFVNET1 и INTERNALSUBNETREFVNET2, которые являются идентификаторами ресурса для внутренних подсетей при использовании в шаблоне развертывания в виде конвейера.

Шаблон предоставляет значения по умолчанию для именования и IP-адресации виртуальной сети. Для этого потребуется пароль администратора (rrasadmin). Также есть возможность использования собственного хранилища BLOB-объектов с маркером SAS. Следите за тем, чтобы эти значения оставались в допустимых диапазонах, так как развертывание может завершиться ошибкой. Пакет PowerShell DSC выполняется на каждой виртуальной машине RRAS и устанавливает маршрутизацию и все необходимые службы и функции. При необходимости эту DSC можно настроить дополнительно. Расширение пользовательских сценариев выполняет следующий сценарий и `Add-Site2Site.ps1` настраивает туннель VPNS2S между двумя серверами RRAS с общим ключом. Чтобы увидеть результаты настройки туннеля VPN, можно просмотреть подробный вывод из расширения пользовательских сценариев

![замещающий текст](./media/azure-stack-network-howto-vnet-peering/s2svpntunnels2.png)

## <a name="next-steps"></a>Дополнительная информация

[Сети Azure Stack: различия и рекомендации](azure-stack-network-differences.md)  