---
title: Развертывание высокодоступных виртуальных сетевых модулей в Azure Stack | Документация Майкрософт
description: Узнайте, как развертывать виртуальные сетевые модули высокой доступности в Azure Stack.
services: azure-stack
author: mattbriggs
ms.service: azure-stack
ms.topic: how-to
ms.date: 11/01/2019
ms.author: mabrigg
ms.reviewer: kivenkat
ms.lastreviewed: 11/01/2019
ms.openlocfilehash: f3a590519fcfb6b6214b202920b2756484f51dfc
ms.sourcegitcommit: 5ef433aa6b75cdfb557fab0ef9308ff2118e66e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2019
ms.locfileid: "73595336"
---
# <a name="deploy-highly-available-network-virtual-appliances-on-azure-stack"></a>Развертывание виртуальных сетевых модулей высокой доступности в Azure Stack

В этой статье показано, как развернуть набор виртуальных сетевых модулей (NVA) для обеспечения высокой доступности в Azure Stack. Виртуальный сетевой модуль обычно используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям. Статья включает примеры архитектуры для передачи входящего и исходящего трафика по отдельности и вместе.

В [Azure Stack Marketplace](https://docs.microsoft.com/azure-stack/operator/azure-stack-marketplace-azure-items) доступны NVA от разных поставщиков. Для достижения оптимальной производительности можно использовать один из них.

Архитектура состоит из следующих компонентов.

## <a name="networking-and-load-balancing"></a>Сети и балансировка нагрузки

-   **Виртуальные сети и подсети**. Каждая виртуальная машина Azure развертывается в виртуальной сети, которую можно разделить на подсети. Создайте отдельные подсети для каждого уровня.

-   **Подсистема балансировки нагрузки уровня 7**. Так как в Azure Stack Шлюз приложений пока недоступен, в [Azure Stack Marketplace](https://docs.microsoft.com/azure-stack/operator/azure-stack-marketplace-azure-items) доступны альтернативные варианты, например: [подсистема балансировки нагрузки LoadMaster с переключением контента контроллера доставки приложений](https://azuremarketplace.microsoft.com/marketplace/apps/kemptech.vlm-azure)/ [F5 Big-IP Virtual Edition](https://azuremarketplace.microsoft.com/marketplace/apps/f5-networks.f5-big-ip-best) или [A10 vThunder ADC](https://azuremarketplace.microsoft.com/marketplace/apps/a10networks.vthunder-414-gr1).

-   **Подсистемы балансировки нагрузки.** [Azure Load Balancer](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview) позволяет распределять трафик с уровня Web на уровень Business, а также с уровня Business к SQL Server.

-   **Группы безопасности сети** (NSG). NSG позволяют ограничить трафик в виртуальной сети. Например, в приведенной здесь трехуровневой архитектуре уровень базы данных не принимает трафик из веб-интерфейса, а только с уровня Business и из подсети управления.

-   **Определяемые пользователем маршруты**. Маршрутизируйте трафик в конкретную подсистему балансировки нагрузки с помощью [*определяемых пользователем маршрутов*](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview/).

Для работы с этой статьей необходимо иметь общее представление о работе с сетями Azure Stack.

## <a name="architecture-diagrams"></a>Схемы архитектуры

Виртуальные сетевые модули можно развернуть в сети периметра с разными архитектурами. На следующем рисунке показан пример использования одного виртуального сетевого модуля для входящего трафика.

![Снимок экрана с автоматически созданным описанием публикации в социальных сетях](./media/iaas-architecture-nva-architecture/image1.png)

В этой архитектуре виртуальный сетевой модуль позволяет установить границу в виде безопасной сети путем проверки всего входящего и исходящего сетевого трафика и передачи трафика, соответствующего правилам безопасности сети. Тот факт, что весь сетевой трафик проходит через NVA, означает, что NVA является единой точкой отказа в сети. При сбое в работе NVA путь для сетевого трафика и все внутренние подсети недоступны.

Для обеспечения высокой доступности для NVA разверните несколько модулей в группе доступности.

В следующих примерах архитектур описаны ресурсы и конфигурации, необходимые для обеспечения высокой доступности для NVA:

| Решение | Преимущества | Рекомендации |
| --- | --- | --- |
| Входящий трафик с NVA уровня 7 | Все узлы NVA активны. | Требуется NVA, который может завершать соединения и использовать SNAT.<br>Требуется отдельный набор NVA для трафика, поступающего из корпоративной сети или Интернета и Azure Stack.<br>Может использоваться только для трафика, внешнего по отношению к среде Azure Stack.  |
| Исходящий трафик с NVA уровня 7 | Все узлы NVA активны. | Требуется NVA, который может завершить соединения и реализует преобразование адресов исходной сети (SNAT). |
| Входящий и исходящий трафик с NVA уровня 7 | Все узлы активны.<br>Возможность обработки трафика, созданного в Azure Stack. | Требуется NVA, который может завершать соединения и использовать SNAT.<br>Требуется отдельный набор NVA для трафика, поступающего из корпоративной сети или Интернета и Azure Stack. |

## <a name="ingress-with-layer-7-nvas"></a>Входящий трафик с NVA уровня 7

На следующем рисунке показана архитектура высокой доступности, реализующая входящий трафик сети периметра за пределами подсистемы балансировки нагрузки, доступной в Интернете. Эта архитектура предназначена для подключения к рабочим нагрузкам Azure Stack для трафика уровня 7, например HTTP или HTTPS:

![Снимок экрана автоматически созданного описания карты](./media/iaas-architecture-nva-architecture/image2.png)

Преимущество этой архитектуры состоит в том, что NVA активны и в случае сбоя одного подсистема балансировки нагрузки направляет сетевой трафик на другой. Оба NVA направляют трафик на внутреннюю подсистему балансировки нагрузки, и пока один из них активен, трафик по-прежнему передается. Виртуальные сетевые модули необходимы для завершения передачи SSL-трафика, предназначенного для виртуальных машин веб-уровня. Их невозможно расширить для обработки трафика корпоративной сети, так как для этого требуется другой набор NVA с собственными сетевыми маршрутами.

## <a name="egress-with-layer-7-nvas"></a>Исходящий трафик с NVA уровня 7

Чтобы предоставить исходящий трафик сети периметра для исходящих запросов рабочей нагрузки Azure Stack, можно развернуть архитектуру входящего трафика с NVA уровня 7. Следующая архитектура предназначена для обеспечения высокого уровня доступности NVA в сети периметра для трафика уровня 7, например HTTP или HTTPS:

![Снимок экрана с автоматически созданным описанием сотового телефона](./media/iaas-architecture-nva-architecture/image3.png)

В этой архитектуре весь исходящий трафик в Azure Stack направляется во внутреннюю подсистему балансировки нагрузки. Подсистема балансировки нагрузки распределяет исходящие запросы между набором виртуальных сетевых модулей. Эти модули направляют трафик в Интернет по отдельным общедоступным IP-адресам.

## <a name="ingress-egress-with-layer-7--nvas"></a>Входящий и исходящий трафик с NVA уровня 7

В двух архитектурах входящего и исходящего трафика существовала отдельная сеть периметра для входящего и исходящего трафика. На схеме следующей архитектуры представлены сведения о том, как создать сеть периметра, которая может использоваться для входящего и исходящего трафика уровня 7, например HTTP или HTTPS:

![Снимок экрана с автоматически созданным описанием публикации в социальных сетях](./media/iaas-architecture-nva-architecture/image4.png)

В архитектуре входящего и исходящего трафика с NVA уровня 7 NVA обрабатывают входящие запросы от Load Balancer уровня 7. Кроме того, они обрабатывают исходящие запросы из рабочей нагрузки виртуальных машин в пуле внутренней подсистемы балансировки нагрузки. Так как входящий трафик направляется подсистемой балансировки нагрузки уровня 7, а исходящий — SLB (подсистемой балансировки нагрузки уровня "Базовый" Azure Stack), NVA отвечают за обеспечение сходства сеансов. То есть подсистема балансировки нагрузки уровня 7 поддерживает сопоставление входящих и исходящих запросов. Благодаря этому она может перенаправлять правильный ответ запросившей стороне. Но внутренняя подсистема балансировки нагрузки не имеет доступа к сопоставлениям подсистемы балансировки нагрузки уровня 7 и использует собственную логику для отправки ответов на NVA. Подсистема балансировки нагрузки может отправить ответ на NVA, который изначально не получил запрос из подсистемы балансировки нагрузки уровня 7. В этом случае модули должны взаимодействовать и передавать ответ между собой, чтобы правильный модуль переслал ответ подсистеме балансировки нагрузки уровня 7.

> [!Note]  
> Вы также можете решить проблему асимметричной маршрутизации, настроив виртуальные системные модули таким образом, чтобы они выполняли преобразование адресов исходной сети (SNAT). При этом исходный IP-адрес источника запросившей стороны заменяется на один из IP-адресов входящего потока NVA. Теперь вы можете использовать несколько виртуальных системных модулей одновременно, сохраняя симметрию маршрута.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о виртуальных машинах Azure Stack см. в [этой статье](azure-stack-vm-considerations.md).  
- Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns).
