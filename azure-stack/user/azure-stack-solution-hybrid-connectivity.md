---
title: Настройка подключения к гибридному облаку в Azure и Azure Stack | Документация Майкрософт
description: Сведения о настройке подключения к гибридному облаку в Azure и Azure Stack.
services: azure-stack
documentationcenter: ''
author: bryanla
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 01/14/2019
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 01/14/2019
ms.openlocfilehash: 94554162cc91ddc4e9be7f24f9c7fafc32051e3c
ms.sourcegitcommit: eccbd0098ef652919f357ef6dba62b68abde1090
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2019
ms.locfileid: "67492395"
---
# <a name="tutorial-configure-hybrid-cloud-connectivity-with-azure-and-azure-stack"></a>Руководство по Настройка подключения к гибридному облаку в Azure и Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Доступ к ресурсам безопасности в глобальных Azure и Azure Stack можно получить, используя модель гибридного подключения.

В этом руководстве показано, как создать среду, после чего вы выполните в ней следующие действия:

> [!div class="checklist"]
> - Сохранять данные локально в соответствии с требованиями конфиденциальности или нормативными требованиями, обеспечивая доступ к глобальным ресурсам Azure.
> - Сохранять устаревшую систему при использовании ресурсов и развертывании приложения в масштабе облака, а также хранить ресурсы в глобальной среде Azure.

> [!Tip]  
> ![hybrid-pillars.png](./media/azure-stack-solution-cloud-burst/hybrid-pillars.png)  
> Microsoft Azure Stack — это расширение Azure.re. Azure Stack обеспечивает гибкость и высокую скорость внедрения инноваций облачных вычислений в локальной среде. Только это гибридное облако позволяет создавать и развертывать гибридные приложения в любой точке мира.  
> 
> В [рекомендациях по проектированию гибридных приложений](https://aka.ms/hybrid-cloud-applications-pillars) описаны характеристики качественного программного обеспечения (размещение, масштабируемость, доступность, устойчивость, управляемость и безопасность), которых следует придерживаться при разработке, развертывании и использовании гибридных приложений. Эти рекомендации помогут оптимизировать разработку гибридных приложений и предотвратить появление проблем с рабочими средами.


## <a name="prerequisites"></a>Предварительные требования

Для развертывания гибридного подключения требуется несколько компонентов. Подготовка некоторых из них требует определенного времени, и это необходимо учитывать при планировании.

**Azure Stack**

Партнер-поставщик OEM или оборудования может развернуть рабочую среду Azure Stack, а все пользователи могут развернуть Пакет средств разработки Azure Stack (ASDK).

**Компоненты Azure Stack**

Оператор Azure Stack должен развернуть службу приложений, создать планы и предложения, создать подписку клиента и добавить образ Windows Server 2016. Если у вас уже есть эти компоненты, перед началом работы с руководством убедитесь, что они отвечают требованиям.

В этом руководстве также предполагается, что вы знакомы с Azure и Azure Stack. Перед началом работы прочтите следующие статьи:

 - [Введение в Azure](https://azure.microsoft.com/overview/what-is-azure/).
 - [Основные понятия Azure Stack](../operator/azure-stack-overview.md).

### <a name="azure"></a>Azure

 - Если у вас еще нет подписки Azure,  [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) , прежде чем начинать работу.
 - Создайте  [веб-приложение](https://docs.microsoft.com/vsts/build-release/apps/cd/azure/aspnet-core-to-azure-webapp?view=vsts&tabs=vsts) в Azure. Запишите URL-адрес веб-приложения для дальнейшего использования.

### <a name="azure-stack"></a>Azure Stack

 - Используйте рабочую среду Azure Stack или разверните пакет средств разработки Azure Stack отсюда: https://github.com/mattmcspirit/azurestack/blob/master/deployment/ConfigASDK.ps1.
   >[!Note]
   >Развертывание ASDK может занять 7 часов. Учитывайте это при планировании.

 - Разверните службы PaaS  [Службы приложений](../operator/azure-stack-app-service-deploy.md)  в Azure Stack.
 - [Создание планов и предложений](../operator/azure-stack-plan-offer-quota-overview.md) в среде Azure Stack.
 - Создайте [подписку клиента](../operator/azure-stack-subscribe-plan-provision-vm.md) в рамках среды Azure Stack.

### <a name="before-you-begin"></a>Перед началом работы

Перед началом настройки гибридного облачного подключения убедитесь, что выполняются следующие условия:

 - У вас есть внешний общедоступный IPV4-адрес для VPN-устройства. Этот IP-адрес не может быть за устройством NAT.
 - Все ресурсы должны быть развернуты в одном регионе и (или) расположении.

#### <a name="tutorial-example-values"></a>Примеры значений для руководства

В примерах этого руководства мы используем следующие значения. Вы можете создать на их основе тестовую среду или просто изучить для лучшего понимания примеров. Подробные сведения о параметрах VPN-шлюза см. в  [этой статье](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings).

Спецификации подключения:

 - **Тип VPN**: на основе маршрутов.
 - **Тип подключения**: "сеть — сеть" (IPsec).
 - **Тип шлюза.**  Виртуальная частная сеть
 - **Имя подключения Azure**. Azure-Gateway-AzureStack-S2SGateway (портал заполнит это значение автоматически).
 - **Имя подключения Azure Stack**. AzureStack-Gateway-Azure-S2SGateway (портал заполнит это значение автоматически).
 - **Общий ключ**: все совместимые с оборудованием VPN с соответствующими значениями на обеих сторонах подключения.
 - **Подписка**: любая подписка.
 - **Группа ресурсов.** Тест Infra.

IP-адреса сетей и подсетей:

| Подключение Azure или Azure Stack | ИМЯ | Подсеть | IP-адрес |
|-------------------------------------|---------------------------------------------|---------------------------------------|-----------------------------|
| Виртуальная сеть Azure | ApplicationvNet<br>10.100.102.9/23 | ApplicationSubnet<br>10.100.102.0/24 |  |
|  |  | Подсеть шлюза<br>10.100.103.0/24 |  |
| Виртуальная сеть Azure Stack | ApplicationvNet<br>10.100.100.0/23 | ApplicationSubnet <br>10.100.100.0/24 |  |
|  |  | Подсеть шлюза <br>10.100101.0/24 |  |
| Шлюз виртуальной сети Azure | Azure-Gateway |  |  |
| Шлюз виртуальной сети Azure Stack | AzureStack-Gateway |  |  |
| Общедоступный IP-адрес Azure | Azure-GatewayPublicIP |  | Определяется в момент создания |
| Общедоступный IP-адрес Azure Stack | AzureStack-GatewayPublicIP |  | Определяется в момент создания |
| Шлюз локальной сети Azure | AzureStack-S2SGateway<br>   10.100.100.0/23 |  | Значение общедоступного IP-адреса Azure Stack |
| Шлюз локальной сети Azure Stack | Azure-S2SGateway<br>10.100.102.0/23 |  | Значение общедоступного IP-адреса Azure |

## <a name="create-a-virtual-network-in-global-azure-and-azure-stack"></a>Создание виртуальной сети в глобальных Azure и Azure Stack

Чтобы создать виртуальную сеть с помощью портала, сделайте следующее. Если вы используете это руководство только для обучения, примените эти  [примеры значений](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal#values) . Если вы настраиваете реальную рабочую среду, замените эти примеры соответствующими значениями.

> [!IMPORTANT]
> Следите за тем, чтобы IP-адреса в адресных пространствах виртуальной сети Azure и (или) Azure Stack не перекрывались.

Чтобы создать виртуальную сеть в Azure, сделайте следующее:

1. В браузере перейдите на [портал Azure](https://portal.azure.com/)  и войдите, используя учетную запись Azure.
2. Выберите  **Создать ресурс**. В поле  **Поиск по Marketplace**  введите "виртуальная сеть". Выберите **Виртуальная сеть** в результатах.
3. В списке **Выбор модели развертывания**  выберите  **Диспетчер ресурсов**,  **Создать**.
4. На странице **Создание виртуальной сети** настройте параметры виртуальной сети. Красной звездочкой здесь отмечены обязательные для заполнения поля.  Когда вы введете в такое поле допустимое значение, звездочка сменится зеленым флажком.

Чтобы создать виртуальную сеть в Azure Stack, сделайте следующее:

* Повторите предыдущие шаги (1–4) на **портале клиента** Azure Stack.

## <a name="add-a-gateway-subnet"></a>Добавление подсети шлюза

Прежде чем подключать шлюз к виртуальной сети, следует создать подсеть шлюза для виртуальной сети, к которой вы хотите его подключить. Службы шлюза используют IP-адреса, указанные для подсети шлюза.

На  [портале Azure](https://portal.azure.com/) перейдите к виртуальной сети Resource Manager, в которой вы хотите создать шлюз виртуальной сети.

1. Выберите виртуальную сеть, чтобы открыть страницу **Виртуальная сеть**.
2. На панели  **Параметры** выберите  **Подсети**.
3. Чтобы открыть страницу  **Добавить подсеть**, на странице  **Подсети**  выберите  **+ Подсеть шлюза** .

    ![Добавление подсети шлюза](media/azure-stack-solution-hybrid-connectivity/image4.png)

4. Поле  **Имя**  для подсети автоматически заполнится значением "GatewaySubnet". По этому имени Azure идентифицирует подсеть как подсеть шлюза.
5. Измените предоставленные значения **Диапазон адресов**, чтобы они соответствовали требованиям к конфигурации, а затем выберите  **ОК**.

## <a name="create-a-virtual-network-gateway-in-azure-and-azure-stack"></a>Создание шлюза виртуальной сети в Azure и Azure Stack

Чтобы создать виртуальную сеть в Azure, сделайте следующее:

1. На странице портала слева выберите **+**   и введите "шлюз виртуальной сети" в поле поиска.
2. В разделе  **Результаты** выберите  **Шлюз виртуальной сети**.
3. На странице **Шлюз виртуальной сети** выберите  **Создать**, чтобы открыть страницу  **Создание шлюза виртуальной сети** .
4. На странице **Создание шлюза виртуальной сети** укажите для шлюза сети значения, которые предложены в **примере значений для руководства** и следующие дополнительные значения:

   - **Номер SKU**. Базовый.
   - **Виртуальная сеть**. Выберите созданную ранее виртуальную сеть. Автоматически выберется созданная ранее подсеть шлюза.
   - **Первая IP-конфигурация**.  Это общедоступный IP-адрес вашего шлюза.
     - Щелкните **Создать IP-конфигурацию шлюза**, чтобы перейти на страницу **Выбор общедоступного IP-адреса**.
     - Выберите **+Создать**, чтобы открыть страницу **Создание общедоступного IP-адреса**.
     - Укажите **имя** для общедоступного IP-адреса. Сохраните для номера SKU значение **Базовый**, а затем нажмите кнопку **ОК**, чтобы сохранить изменения.

       > [!Note]
       > Сейчас VPN-шлюз поддерживает только динамическое выделение общедоступных IP-адресов. Но это не означает, что IP-адрес изменится после того, как он будет назначен VPN-шлюзу. Общедоступный IP-адрес изменяется только после удаления и повторного создания шлюза. IP-адрес VPN-шлюза не изменяется при изменении размера, сбросе или других внутренних операциях обслуживания или обновления.

4. Проверьте параметры шлюза.
5. Выберите  **Создать** , чтобы создать VPN-шлюз. Будут проверены параметры шлюза и на панели мониторинга появится плитка "Развертывание шлюза виртуальной сети".

   >[!Note]
   >Создание шлюза может занять до 45 минут. Вам понадобится обновить страницу портала, чтобы увидеть готовое состояние.

    После создания шлюза можно узнать назначенный ему IP-адрес, просмотрев виртуальную сеть на портале. Шлюз будет отображаться как подключенное устройство. Чтобы просмотреть дополнительные сведения о шлюзе, выберите устройство.

6. Повторите описанные выше шаги (1–5) для развертывания Azure Stack.

## <a name="create-the-local-network-gateway-in-azure-and-azure-stack"></a>Создание шлюза локальной сети в Azure и Azure Stack

Обычно термин "шлюз локальной сети" означает локальное расположение. Присвойте сайту имя, которое могут использовать Azure и (или) Azure Stack, а затем укажите следующие данные:

- IP-адрес локального VPN-устройства, для которого вы создаете подключение.
- Префиксы IP-адресов, которые будут направляться через VPN-шлюз к VPN-устройству. Указываемые префиксы адресов расположены в локальной сети.

  >[!Note]
  >Если изменятся параметры локальной сети или потребуется изменить общедоступный IP-адрес для VPN-устройства, эти значения можно легко обновить позже.

1. На портале выберите  **+ Создать ресурс**.
2. В поле поиска введите  **Локальный сетевой шлюз**, а затем нажмите  **ВВОД** , чтобы начать поиск. Будет возвращен список результатов.
3. Выберите  **Локальный сетевой шлюз**, а затем выберите **Создать** , чтобы открыть страницу  **Создание шлюза локальной сети** .
4. На странице **Создание шлюза локальной сети** укажите значения для локального сетевого шлюза, представленные в **примере значений для руководства**. Включите следующие дополнительные значения.

    - **IP-адрес**. Это общедоступный IP-адрес VPN-устройства, к которому вы хотите подключить Azure или Azure Stack. Укажите допустимый общедоступный IP-адрес, не расположенный за устройством NAT, чтобы обеспечить к нему доступ для Azure. Если у вас еще нет IP-адреса, вы можете временно использовать значения из примера, а позже вернуться к этому разделу и заменить временное значение IP-адреса общедоступным IP-адресом конкретного VPN-устройства. Azure не сможет подключиться к устройству, пока вы не предоставите правильный адрес.
    - **Адресное пространство**. Это диапазон адресов для сети, которую представляет эта локальная сеть. Можно добавить несколько диапазонов пространства адресов. Убедитесь, что указанные диапазоны не перекрывают диапазоны других сетей, к которым вы хотите подключиться. Azure будет маршрутизировать указанный диапазон адресов на IP-адрес локального VPN-устройства. Чтобы подключиться к локальному сайту, используйте здесь значения для локального сайта, а не значения из примера.
    - **Настроить параметры BGP**. Используйте только при настройке BGP. В противном случае не выбирайте этот параметр.
    - **Подписка**: Убедитесь, что указана правильная подписка.
    - **Группа ресурсов**. Выберите группу ресурсов, которую нужно использовать. Вы можете создать новую группу ресурсов или выбрать уже существующую.
    - **Расположение.**  Укажите расположение, в котором будет создан этот объект. Вы можете выбрать расположение, в котором размещена виртуальная сеть, но это не обязательно.
5. Завершив ввод необходимых значений, выберите **Создать** , чтобы создать локальный сетевой шлюз.
6. Повторите эти шаги (1–5) для развертывания Azure Stack.

## <a name="configure-your-connection"></a>Настройка подключения

Для подключения "сеть — сеть" к локальной сети требуется VPN-устройство. Настроенное VPN-устройство здесь обозначается как "Подключение". Для настройки подключения вам потребуется следующее:

- Общий ключ. Это тот же общий ключ, который указывается при создании VPN-подключения "сеть — сеть". В наших примерах мы используем простые общие ключи. Для практического использования рекомендуется создавать более сложные ключи.
- Общедоступный IP-адрес шлюза виртуальной сети. Общедоступный IP-адрес можно просмотреть с помощью портала Azure, PowerShell или CLI. Чтобы найти общедоступный IP-адрес VPN-шлюза с помощью портала Azure, перейдите к разделу "Шлюзы виртуальной сети" и выберите имя шлюза.

Чтобы создать VPN-подключение "сеть — сеть" между шлюзом виртуальной сети и локальным VPN-устройством, сделайте следующее:

1. На портале Azure выберите  **+ Создать ресурс**.
2. Выполните поиск по строке **подключения**.
3. В поле **Результаты** выберите  **Подключения**.
4. На странице **Подключение** выберите **Создать**.
5. На странице **Создание подключения** настройте следующие параметры:

    - **Тип подключения**. Выберите подключение "сеть — сеть" (IPsec).
    - **Группа ресурсов**. Выберите тестовую группу ресурсов.
    - **Шлюз виртуальной сети**. Выберите созданный шлюз виртуальной сети.
    - **Локальный сетевой шлюз**. Выберите созданный шлюз локальной сети.
    - **Имя подключения**. Это имя заполняется автоматически с использованием значений для двух шлюзов.
    - **Общий ключ**. Это значение должно соответствовать значению, используемому для локального VPN-устройства. В этом руководстве используется значение abc123, но вам нужно создать и использовать что-нибудь посложнее. Здесь важно, чтобы заданное значение совпадало со значением, указанным при настройке VPN-устройства.
    - Значения для **подписки**, **группы ресурсов** и **расположения** являются фиксированными.

6. Щелкните **ОК** для создания подключения.

Подключение появится на странице  **Подключения**  для шлюза виртуальной сети. Состояние изменится с  *Неизвестно*  на  *Подключение*, а затем —на  *Успешно*.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns).
