---
title: Защита виртуальных машин, развернутых в Azure Stack | Документация Майкрософт
description: Сведения о создании плана восстановления для защиты развернутых в Azure Stack виртуальных машин от потери данных и внепланового простоя.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.assetid: 4e5833cf-4790-4146-82d6-737975fb06ba
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/06/2019
ms.author: mabrigg
ms.reviewer: hectorl
ms.lastreviewed: 3/19/2018
ms.openlocfilehash: 9f8fe959ca200b7000df65b6826a103535aac92a
ms.sourcegitcommit: eccbd0098ef652919f357ef6dba62b68abde1090
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2019
ms.locfileid: "67492408"
---
# <a name="protect-vms-deployed-on-azure-stack"></a>Защита виртуальных машин, развернутых в Azure Stack

Эту статью можно использовать как руководство по разработке плана для защиты виртуальных машин,которые ваши пользователи развертывают в Azure Stack.


Чтобы избежать потери данных и незапланированных простоев, необходимо реализовать план резервного копирования и восстановления или план аварийного восстановления для пользовательских приложений и данных. Этот план может быть уникален для каждого приложения, но должен соответствовать схеме, установленной стратегией обеспечения непрерывности бизнес-процессов и аварийного восстановления вашей организации (BC/DR). Хорошей отправной точкой является технический документ [Azure Stack: Considerations for business continuity and disaster recovery](https://aka.ms/azurestackbcdrconsiderationswp) (Рекомендации по обеспечению непрерывности бизнес-процессов и аварийного восстановления в Azure Stack).

## <a name="azure-stack-infrastructure-recovery"></a>Восстановление инфраструктуры Azure Stack

Пользователи ответственны за защиту своих виртуальных машин отдельно от служб инфраструктуры Azure Stack.

План восстановления служб инфраструктуры Azure Stack **не включает** восстановление пользовательских виртуальных машин, учетных записей хранения или баз данных. Как владелец приложения, вы отвечаете за реализацию плана восстановления приложений и данных.

Если облако Azure Stack находится в автономном режиме в течение длительного периода времени или его невозможно восстановить, необходимо иметь план, который:

* обеспечивает минимальное время простоя;
* поддерживает работу критически важных виртуальных машин, таких как серверы баз данных;
* позволяет приложениям продолжать обслуживать запросы пользователей.

Оператор облака Azure Stack отвечает за создание плана восстановления базовой инфраструктуры и служб Azure Stack. Дополнительные сведения см. в статье [Восстановление после катастрофической потери данных](../operator/azure-stack-backup-recover-data.md).

## <a name="considerations-for-iaas-vms"></a>Рекомендации для виртуальных машин IaaS
Операционная система, установленная на виртуальной машине IaaS, ограничивает количество продуктов, которые можно использовать для защиты содержащихся в ней данных. Для виртуальных машин IaaS на платформе Windows можно использовать продукты для защиты данных, предоставленные корпорацией Майкрософт и ее партнерами. Для виртуальных машин IaaS на платформе Linux можно использовать только партнерские продукты. Список всех партнеров, предоставляющих проверенные продукты для обеспечения непрерывности бизнес-процессов и аварийного восстановления в Azure Stack, см. в техническом документе, [перейдя по этой ссылке](https://aka.ms/azurestackbcdrpartners).

## <a name="sourcetarget-combinations"></a>Комбинации исходного и целевого объектов

Каждое облако Azure Stack развертывается в одном центре обработки данных. Для восстановления приложений требуется отдельная среда. Средой восстановления может быть другое облако Azure Stack в другом центре обработки данных или общедоступное облако Azure. Требования к независимости и конфиденциальности данных определяют среду восстановления для приложения. При включении защиты для каждого приложения есть возможность выбрать определенный режим восстановления для каждого из них. В одной подписке могут быть приложения, выполняющие архивацию данных в другой центр обработки данных. В другой подписке можно реплицировать данные в общедоступное облако Azure.

Спланируйте стратегии резервного копирования и восстановления, а также аварийного восстановления для каждого приложения, чтобы определить для них целевой объект. План восстановления поможет организации правильно определить объем хранилища, необходимый для локальной среды и использования проектом в общедоступном облаке.

|  | Глобальная среда Azure | Azure Stack, развернутый в центре обработки данных CSP и управляемый CSP | Azure Stack, развернутый в центре обработки данных клиента и управляемый клиентом |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **Azure Stack, развернутый в центре обработки данных CSP и управляемый CSP** | Пользовательские виртуальные машины развертываются в Azure Stack, управляемой CSP.<br><br>Пользовательские виртуальные машины восстанавливаются из файла резервной копии, или для них выполняется отработка отказа напрямую в Azure. | CSP управляет основным и дополнительным экземплярами Azure Stack в собственных центрах обработки данных.<br><br>Пользовательские виртуальные машины восстанавливаются, или для них выполняется отработка отказа между двумя экземплярами Azure Stack. | CSP управляет Azure Stack в основном расположении.<br><br>Центр обработки данных клиента является целью восстановления или отработки отказа. |
| **Azure Stack, развернутый в центре обработки данных клиента и управляемый клиентом** | Пользовательские виртуальные машины развертываются в Azure Stack, которым управляет клиент.<br><br>Пользовательские виртуальные машины восстанавливаются из файла резервной копии, или для них выполняется отработка отказа напрямую в Azure. | Клиент управляет Azure Stack в основном расположении.<br><br>Центр обработки данных CSP является целью восстановления или отработки отказа. | Клиент управляет основным и дополнительным экземплярами Azure Stack в собственных центрах обработки данных.<br><br>Пользовательские виртуальные машины восстанавливаются, или для них выполняется отработка отказа между двумя экземплярами Azure Stack. |

![Сочетания исходного и целевого объектов](media/azure-stack-manage-vm-backup/vm_backupdataflow_01.png)

## <a name="app-recovery-objectives"></a>Целевые показатели восстановления приложения

Определите, какую длительность простоя и объем потерянных данных организация может допустить для каждого приложения. Так вы сможете разработать план восстановления, который сводит к минимуму влияние сбоя в вашей организации. Для каждого приложения рассмотрите следующее:

 - **Целевое время восстановления (RTO)**  
Это максимально допустимое время, в течение которого приложение может быть недоступно после инцидента. Например, если RTO составляет 90 минут, это значит, вы должны иметь возможность восстановить приложение в рабочем состоянии в течение 90 минут с момента начала сбоя. Если у вас низкое RTO, вы можете оставить второе развертывание, постоянно работающее в режиме ожидания, для защиты от регионального сбоя.
 - **Целевая точка восстановления (RPO)**  
Это максимальная продолжительность потери данных, которая является приемлемой во время аварии. Например, если вы храните данные в отдельной базе данных без репликации в другие базы данных и ежечасно выполняете резервное копирование, вы можете потерять до часа данных.

RTO и RPO являются бизнес-требованиями. Проведите оценку риска, чтобы определить RTO и RPO для приложения.

Еще одной метрикой является **среднее время восстановления** (MTTR). Это среднее время, которое требуется для восстановления приложения после сбоя. MTTR является эмпирическим значением для системы. Если MTTR превышает RTO, то сбой в системе приведет к недопустимому сбою бизнес-процессов, поскольку восстановить систему в пределах определенного RTO невозможно.

### <a name="backup-restore"></a>Резервное копирование и восстановление

Наиболее распространенная схема защиты приложений, расположенных на виртуальной машине, — использовать программное обеспечение резервного копирования. Резервное копирование виртуальной машины обычно включает операционную систему, конфигурацию операционной системы, двоичные файлы приложения и данные приложения. Резервные копии создаются путем создания моментального снимка томов, дисков или всей виртуальной машины. С Azure Stack у вас есть возможность выполнять резервное копирование из гостевой ОС или из хранилища Azure Stack и API вычисления. Azure Stack не поддерживает создание резервных копий на уровне низкоуровневой оболочки.
 
![Резервное копирование и восстановление](media/azure-stack-manage-vm-backup/vm_backupdataflow_03.png)

Восстановление приложения требует восстановления одной или нескольких виртуальных машин в том же облаке или в новом. Можно использовать облако в центре обработки данных или общедоступное облако. Выбор облака полностью зависит от вас и основан на требованиях к конфиденциальности и независимости данных.

 - RTO: время простоя в часах.
 - RPO: разные показатели потери данных (в зависимости от частоты резервного копирования).
 - Топология развертывания: "активное — пассивное".

#### <a name="planning-your-backup-strategy"></a>Планирование стратегии резервного копирования

Планирование стратегии резервного копирования и определение требований к масштабу начинается с определения количества экземпляров виртуальной машины, которые необходимо защитить. Резервное копирование всех виртуальных машин на всех серверах в среде — это распространенная стратегия. Однако в Azure Stack есть некоторые виртуальные машины, не требующие резервного копирования. Например, виртуальные машины в масштабируемом наборе считаются временными ресурсами, которые появляются и исчезают, иногда без предупреждения. Любые надежные данные, которые необходимо защитить, хранятся в отдельном репозитории, таком как база данных или хранилище объектов.

Ниже приведены важные рекомендации по резервному копированию виртуальных машин в Azure Stack.

 - **Классификация**
    - Рассмотрите модель, в которой пользователи явно соглашаются на резервное копирование виртуальной машины.
    - Определите соглашение об уровне обслуживания (SLA) для восстановления на основе приоритетов приложений или влияния на бизнес.
 - **Масштабирование**
    - Рассмотрите поочередное резервное копирование при подключении большого количества новых виртуальных машин (если резервное копирование требуется).
    - Оцените решения резервного копирования, которые могут эффективно собирать и передавать данные резервного копирования, чтобы свести к минимуму содержимое ресурса в решении.
    - Оцените решения резервного копирования, которые эффективно хранят данные архивации, используя добавочные или разностные резервные копии, чтобы свести к минимуму необходимость полных резервных копий во всех виртуальных машинах среды.
 - **Восстановление**
    - Решения резервного копирования могут восстанавливать виртуальные диски, данные приложения в имеющейся виртуальной машине или весь ресурс виртуальной машины и связанные виртуальные диски. Нужная схема восстановления зависит от того, как вы планируете восстанавливать приложение. Например, проще повторно развернуть сервер SQL из шаблона, а затем восстановить базы данные вместо восстановления всей виртуальной машины или их набора.

### <a name="replicationmanual-failover"></a>Репликация и переход на другой ресурс вручную

Альтернативный подход к поддержанию высокой доступности заключается в репликации виртуальных машин приложения в другое облако и в использовании перехода на другой ресурс вручную. Репликацию операционной системы, двоичных файлов и данных приложений можно выполнить на уровне виртуальной машины или на уровне гостевой ОС. Отработка отказа управляется с помощью дополнительного программного обеспечения, которое не является частью приложения.

При таком подходе приложение развертывается в одном облаке, а его виртуальная машина реплицируется в другое облако. Если активируется отработка отказа, во втором облаке требуется включить дополнительные виртуальные машины. В некоторых сценариях отработка отказа создает виртуальные машины и присоединяет к ним диски. Выполнение этого процесса может занять длительное время, особенно при использовании многоуровневого приложения, которое требует определенной последовательности запуска. Чтобы приложение могло начать обрабатывать запросы, может потребоваться выполнить дополнительные шаги.

![Репликация и переход на другой ресурс вручную](media/azure-stack-manage-vm-backup/vm_backupdataflow_02.png)

 - RTO: время простоя в минутах.
 - RPO: разные показатели потери данных (в зависимости от частоты репликации).
 - Топология развертывания: ожидание "активное — пассивное".
 
### <a name="high-availabilityautomatic-failover"></a>Высокий уровень доступности и автоматический переход на другой ресурс

Для приложений, в которых допускается только несколько секунд или минут простоя и минимальная потеря данных, необходимо настроить конфигурацию высокой доступности. Приложения высокого уровня доступности предназначены для быстрого и автоматического восстановления после ошибок. Для локальных сбоев оборудования инфраструктура Azure Stack реализует высокую доступность в физической сети с помощью двух стоечных коммутаторов. Для сбоев на уровне вычисления Azure Stack использует несколько узлов в единице масштабирования. На уровне виртуальной машины можно использовать масштабируемые наборы в сочетании с доменами сбоя, чтобы сбои узла не приводили к выводу приложения из строя.

В сочетании с масштабируемыми наборами приложению потребуется встроенная поддержка высокого уровня доступности или использование кластерного программного обеспечения. Например, в Microsoft SQL Server есть встроенная поддержка высокого уровня доступности для баз данных. Она обеспечивается за счет использования режима синхронной фиксации. Однако, если вы можете поддерживать только асинхронную репликацию, некоторые данные будут потеряны. Приложения также можно развернуть в отказоустойчивом кластере, в котором кластерное программное обеспечение будет обрабатывать автоматический переход на другой ресурс приложения.

При таком подходе приложение будет активно только в одном облаке, но программное обеспечение развертывается в нескольких облаках. Другие облака находятся в режиме ожидания и готовы запустить приложение после активации отработки отказа.

 - RTO: время простоя в секундах.
 - RPO: минимальная потеря данных.
 - Топология развертывания: ожидание "активное — активное".

### <a name="fault-tolerance"></a>Отказоустойчивость

Физическая избыточность Azure Stack и доступность инфраструктуры обеспечивают защиту только от сбоев/ошибок аппаратного уровня, таких как неисправный диск, источник питания, сетевой порт или узел. Однако, если ваше приложение должно быть доступно всегда и не может терять данные, в нем необходимо реализовать встроенную отказоустойчивость или использовать дополнительное программное обеспечение, чтобы обеспечить отказоустойчивость.

Сначала нужно убедиться, что виртуальные машины с приложением развернуты с использованием масштабируемых наборов для защиты от сбоев на уровне узла. Чтобы обеспечить защиту от перехода облака в автономный режим, то же приложение должно быть развернуто в другом облаке, чтобы оно могло продолжать непрерывное обслуживание запросов. Эта модель обычно называется развертыванием в режиме "активный — активный".

Имейте в виду, что все облака Azure Stack независимы друг от друга, поэтому они всегда являются активными с точки зрения инфраструктуры. В этом случае множество активных экземпляров приложения развертываются в одно или несколько активных облаков.

 - RTO: время простоя отсутствует.
 - RPO: Без потери данных
 - Топология развертывания: "активное — активное".

### <a name="no-recovery"></a>Без восстановления

Некоторым приложениям в среде защита от незапланированных простоев или потери данных не требуется. Например, виртуальные машины, используемые для разработки и тестирования, не требуют восстановления. Это ваше решение — не защищать приложение или определенную виртуальную машину. Azure Stack не предлагает резервное копирование или репликацию виртуальных машин из базовой инфраструктуры. Как и в Azure, необходимо будет явно согласиться на защиту для каждой виртуальной машины в каждой из подписок.

 - RTO: восстановление не происходит.
 - RPO: полная потеря данных.

## <a name="recommended-topologies"></a>Рекомендуемые топологии

Важные рекомендации по развертыванию Azure Stack:

|     | Рекомендации | Комментарии |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Резервное копирование и восстановление виртуальных машин на внешний целевой объект резервного копирования, уже развернутый в центре обработки данных | Рекомендуется | Воспользуйтесь преимуществами имеющейся инфраструктуры резервного копирования и операционными навыками. Инфраструктура резервного копирования должна иметь соответствующий размер, чтобы она была готова защитить дополнительные экземпляры виртуальных машин. Убедитесь, что инфраструктура резервного копирования не в непосредственной близости от источника. Виртуальные машины можно восстановить в источник Azure Stack, дополнительный экземпляр Azure Stack или в Azure. |
| Резервное копирование или восстановление виртуальных машин во внешний целевой объект резервного копирования, выделенный для Azure Stack | Рекомендуется | Для Azure Stack можно приобрести новую инфраструктуру резервного копирования или подготовить выделенную инфраструктуру. Убедитесь, что инфраструктура резервного копирования не в непосредственной близости от источника. Виртуальные машины можно восстановить в источник Azure Stack, дополнительный экземпляр Azure Stack или в Azure. |
| Резервное копирование и восстановление виртуальных машин напрямую в глобальную сеть Azure или доверенный поставщик служб | Рекомендуется | До тех пор, пока вы можете соответствовать требованиям к конфиденциальности данных и нормативным требованиям, резервные копии можно хранить в глобальной среде Azure или в доверенном поставщике служб. В идеале поставщик служб также запускает Azure Stack, поэтому при восстановлении вы получаете согласованность в работе. |
| Репликация и отработка отказов виртуальных машин в отдельный экземпляр Azure Stack | Рекомендуется | В случае отработки отказа вам потребуется второе полностью рабочее облако Azure Stack, чтобы избежать увеличения простоя приложения. |
| Репликация и отработка отказа виртуальных машин напрямую в Azure или доверенный поставщик служб | Рекомендуется | До тех пор, пока вы сможете соответствовать требованиям к конфиденциальности данных и нормативным требованиям, можно реплицировать данные в глобальную среду Azure или доверенный поставщик служб. В идеале поставщик служб также запускает Azure Stack, поэтому при отработке отказа вы получаете согласованность в работе. |
| Развертывание целевого объекта резервного копирования в одном облаке Azure Stack с данными приложения | Не рекомендуется | Избегайте хранения резервных копий в том же облаке Azure Stack. Из-за незапланированного простоя облака у вас может вовсе не быть доступа к данным: ни к исходным данным, ни к их резервным копиям. Если в качестве целевого объекта резервного копирования развертывается виртуальный модуль (в целях оптимизации резервного копирования и восстановления), необходимо обеспечить, чтобы все данные постоянно копировались во внешнее расположение резервного копирования. |
| Развертывание физического устройства резервного копирования в той же стойке, в которой установлено решение Azure Stack | Не поддерживается | Сейчас невозможно подключить к стоечным коммутаторам какие-либо другие устройства, которые не являются частью исходного решения. |

## <a name="next-steps"></a>Дополнительная информация

В этой статье представлены общие рекомендации для защиты пользовательских виртуальных машин, развернутых в Azure Stack. Дополнительные сведения о защите виртуальных машин пользователей с помощью служб Azure см. в следующих статьях:

 - [Архивация файлов в Azure Stack](https://docs.microsoft.com/azure/backup/backup-mabs-files-applications-azure-stack)
 - [Документация по Azure Backup](https://docs.microsoft.com/azure/backup/ ) 
 - [Документация по Site Recovery](https://docs.microsoft.com/azure/site-recovery/)  

Дополнительные сведения о продуктах партнеров, обеспечивающих защиту виртуальной машины в Azure Stack, см. в записи блога [Protecting applications and data on Azure Stack](https://azure.microsoft.com/blog/protecting-applications-and-data-on-azure-stack/) (Защита приложений и данных в Azure Stack).
