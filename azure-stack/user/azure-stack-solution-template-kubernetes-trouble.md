---
title: Устранение неполадок с развертыванием Kubernetes в Azure Stack | Документация Майкрософт
description: Из этой статьи вы узнаете, как устранять неполадки с развертыванием Kubernetes в Azure Stack.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.author: mabrigg
ms.date: 04/02/2019
ms.reviewer: waltero
ms.lastreviewed: 03/20/2019
ms.openlocfilehash: 33eed0b574ad28c5fc0d1fb44f1c9b5a1ad37bb7
ms.sourcegitcommit: 797dbacd1c6b8479d8c9189a939a13709228d816
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/28/2019
ms.locfileid: "66269392"
---
# <a name="troubleshoot-kubernetes-deployment-to-azure-stack"></a>Устранение неполадок с развертыванием Kubernetes в Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

> [!Note]  
> Система Kubernetes доступна в Azure Stack в предварительной версии. Сейчас в предварительной версии не поддерживаются сценарии работы с Azure Stack в автономном режиме.

В этой статье рассматриваются способы устранения неполадок с кластером Kubernetes. Чтобы начать устранение неполадок, просмотрите элементы, которые требуются для развертывания. Вам может потребоваться сбор журналов из Azure Stack или виртуальных машин Linux, которые размещены в Kubernetes. Чтобы получить журналы из конечной точки администрирования, обратитесь к администратору Azure Stack.

## <a name="overview-of-kubernetes-deployment"></a>Общие сведения о развертывании Kubernetes

Прежде чем приступать к устранению неполадок в кластере, рассмотрите процесс развертывания кластера Azure Stack Kubernetes. Развертывание использует шаблон решения Azure Resource Manager для создания виртуальных машин и установки обработчика AKS для кластера.

### <a name="kubernetes-deployment-workflow"></a>Рабочий процесс развертывания Kubernetes

В примере ниже показан общий процесс для развертывания кластера.

![Процесс развертывания кластера](media/azure-stack-solution-template-kubernetes-trouble/002-Kubernetes-Deploy-Flow.png)

### <a name="deployment-steps"></a>Шаги по развертыванию

1. Выполните сбор данных о количестве входных параметров из элемента marketplace.

    Введите значения, которые необходимо настроить в кластере Kubernetes, в том числе:
    -  **Имя пользователя**. Это имя пользователя для виртуальных машин Linux, которые являются частью кластера Kubernetes и динамического административного представления.
    -  **Открытый ключ SSH**. Это ключ, используемый для авторизации на всех виртуальных машинах Linux, созданных как часть кластера Kubernetes и динамического административного представления.
    -  **Субъект-служба**. Это идентификатор, используемый поставщиком облачных служб Azure Kubernetes. Идентификатор клиента определяется как идентификатор приложения во время создания субъекта-службы. 
    -  **Секрет клиента**. Это ключ, полученный при создании субъекта-службы.

2. Создайте виртуальную машину развертывания и расширение пользовательских скриптов.
    -  Создайте развертывание виртуальной машины Linux с помощью образа Linux Marketplace, **Ubuntu Server 16.04-LTS**.
    -  Скачайте и запустите расширение для пользовательских сценариев из Marketplace. Скрипт — это **настраиваемый скрипт для Linux 2.0**.
    -  Выполните пользовательский скрипт DVM. Скрипт выполняет следующие задачи:
        1. Получает конечную точку коллекции из конечной точки метаданных Azure Resource Manager.
        2. Получает идентификатор ресурса Active Directory из конечной точки метаданных Azure Resource Manager.
        3. Загружает модель API для обработчика AKS.
        4. Развертывает обработчик AKS для кластера Kubernetes и сохраняет профиль облака Azure Stack в файле `/etc/kubernetes/azurestackcloud.json`.
3. Создайте главные виртуальные машины.

4. Скачайте и запустите расширения для пользовательских сценариев.

5. Выполнение главного скрипта.

    Скрипт выполняет следующие задачи:
    - Устанавливает такие ресурсы etcd, Docker и Kubernetes, как kubelet. Etcd — это хранилище распределенных значений ключа, которое предоставляет способ хранения данных в кластере виртуальных машин. Docker поддерживает минималистские уровни виртуализации операционной системы, которая известна как контейнеры. Kubelet — агент узла, который выполняется на каждом узле Kubernetes.
    - Настраивает службу **etcd**.
    - Настраивает службу **kubelet**.
    - Запускает kubelet. Эта задача предусматривает указанные ниже действия.
        1. Запуск службы API.
        2. Запуск службы контроллера.
        3. Запуск службы Планировщика.
6. Создайте виртуальные машины агента.

7. Скачивание и запуск расширения для пользовательских сценариев.

7. Выполнение сценария агента. Пользовательский сценарий агента выполняет следующие задачи:
    - Устанавливает **etcd**.
    - Настраивает службу **kubelet**.
    - Соединяет кластер Kubernetes.

## <a name="steps-to-troubleshoot-kubernetes"></a>Шаги по устранению неполадок с Kubernetes

Вы можете собирать и анализировать журналы развертывания на виртуальных машинах, поддерживающих кластер Kubernetes. Обратитесь к администратору Azure Stack для проверки версии Azure Stack, которую необходимо использовать, а также получите журналы из Azure Stack, связанные с развертыванием.

1. Проверьте [состояние развертывания](#review-deployment-status) и извлеките журналы из главного узла в кластере Kubernetes.
2. Убедитесь, что у вас установлена последняя версия Azure Stack. Если вы не уверены, какая версия используется, обратитесь к администратору Azure Stack.
3.  Просмотрите файлы создания виртуальной машины. Возможно были следующие проблемы:  
    - Открытый ключ может быть недопустимым. Проверьте ключ, который вы создали.  
    - Создание виртуальной машины может вызывать внутреннюю ошибку или активировать ошибку создания. Ряд факторов могут быть причиной ошибок, включая ограничения емкости подписки Azure Stack.
    - Убедитесь, что полное доменное имя виртуальной машины начинается с повторяющегося префикса.
4.  Если состояние виртуальной машины — **ОК**, оцените DVM. Если DVM содержит сообщение об ошибке:

    - Открытый ключ может быть недопустимым. Проверьте ключ, который вы создали.  
    - Обратитесь к администратору Azure Stack, чтобы получить журналы Azure Stack с помощью привилегированных конечных точек. Дополнительные сведения см. в статье о [средствах диагностики Azure Stack](../operator/azure-stack-diagnostics.md).
5. Если у вас есть вопрос о развертывании, вы можете разместить его или поискать ответы на вопрос на [форуме Azure Stack](https://social.msdn.microsoft.com/Forums/azure/home?forum=azurestack). 

## <a name="review-deployment-status"></a>Проверка состояния развертывания

Состояние развертывания можно проверить при развертывании кластера Kubernetes для проверки любых проблем.

1. Откройте [портал Azure Stack](https://portal.local.azurestack.external).
2. Выберите **Группы ресурсов**, а затем выберите имя группы ресурсов, используемое при развертывании кластера Kubernetes.
3. Выберите **Развертывания**, а затем **Имя развертывания**.

    ![Устранение неполадок с Kubernetes: выбор развертывания](media/azure-stack-solution-template-kubernetes-trouble/azure-stack-kub-trouble-report.png)

4.  Изучите информацию в окне устранения неполадок. Каждый развернутый шаблон предоставляет следующие сведения.
    
    | Свойство | ОПИСАНИЕ |
    | ----     | ----        |
    | Ресурс | Имя ресурса. |
    | type | Поставщик ресурсов и тип ресурса. |
    | Status | Состояние элемента. |
    | TimeStamp | Метка времени в формате UTC. |
    | Сведения об операции | Сведения об операции, такие как вовлеченный в операцию поставщик ресурсов, конечная точка ресурса и имя ресурса. |

    Каждый элемент содержит зеленый или красный значок состояния.

## <a name="review-deployment-logs"></a>Проверка журналов развертывания

Если портал Azure Stack не предоставляет достаточно сведений для устранения неполадок или сбоя развертывания, изучите журналы кластера. Чтобы вручную извлечь журналы развертывания, обычно необходимо подключиться к одной из главных виртуальных машин кластера. Более простой альтернативный подход заключается в загрузке и запуске приведенного ниже [сценария Bash](https://aka.ms/AzsK8sLogCollectorScript), предоставленного командой Azure Stack. Этот скрипт подключается к виртуальным машинам кластера и DVM, собирает соответствующие журналы системы и кластера и загружает их обратно на рабочую станцию.

### <a name="prerequisites"></a>Предварительные требования

Вам нужна строка Bash на компьютере, используемом для управления Azure Stack. На компьютере с Windows строку Bash можно получить, установив [Git для Windows](https://git-scm.com/downloads). После установки найдите _Git Bash_ в меню "Пуск".

### <a name="retrieving-the-logs"></a>Получение журналов

Выполните следующие действия, чтобы собрать и загрузить журналы кластера:

1. Откройте строку Bash. На компьютере с Windows откройте _Git Bash_ или выполните файл, расположенный по следующему пути `C:\Program Files\Git\git-bash.exe`.

2. Скачайте сценарий сборщика журналируемых данных, выполнив в командной строке Bash следующие команды:

    ```Bash  
    mkdir -p $HOME/kuberneteslogs
    cd $HOME/kuberneteslogs
    curl -O https://raw.githubusercontent.com/msazurestackworkloads/azurestack-gallery/master/diagnosis/getkuberneteslogs.sh
    chmod 744 getkuberneteslogs.sh
    ```

3. Найдите и укажите сведения, необходимые для сценария, а затем запустите его:

    | Параметр           | ОПИСАНИЕ                                                                                                      | Пример                                                                       |
    |---------------------|------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------|
    | -d, --vmd-host      | Общедоступный IP-адрес или полное доменное имя (FQDN) DVM. Имя виртуальной машины начинается с `vmd-`. | IP-адрес: 192.168.102.38<br>DNS: vmd-myk8s.local.cloudapp.azurestack.external |
    | -h, --help  | Отображение сведений об использовании команд. | |
    | -i, --identity-file | Файл закрытого ключа RSA, переданный элементу marketplace при создании кластера Kubernetes. Требуется для удаленного доступа к узлам Kubernetes. | C:\data\id_rsa.pem (Putty)<br>~/.ssh/id_rsa (SSH)
    | -m, --master-host   | Общедоступный IP-адрес или полное доменное имя (FQDN) главного узла Kubernetes. Имя виртуальной машины начинается с `k8s-master-`. | IP-адрес: 192.168.102.37<br>Полное доменное имя: k8s-12345.local.cloudapp.azurestack.external      |
    | -u, --user          | Имя пользователя, переданное элементу marketplace при создании кластера Kubernetes. Требуется для удаленного доступа к узлам Kubernetes. | azureuser (значение по умолчанию) |


   При добавлении значений параметров ваша команда может выглядеть следующим образом:

    ```Bash  
    ./getkuberneteslogs.sh --identity-file "C:\id_rsa.pem" --user azureuser --vmd-host 192.168.102.37
     ```

4. Через несколько минут сценарий выведет собранные журналы в каталог с именем `KubernetesLogs_{{time-stamp}}`. Там вы найдете каталог для каждой виртуальной машины, которая принадлежит кластеру.

    Скрипт сборщика журналируемых данных также будет искать ошибки в файлах журналов и выполнять шаги по устранению неполадок в случае обнаружения известной проблемы. Убедитесь, что вы используете последнюю версию скрипта, чтобы повысить вероятность обнаружения известных проблем.

> [!Note]  
> Чтобы получить дополнительные сведения о сценарии сборщика журналируемых данных, перейдите в [репозиторий GitHub](https://github.com/msazurestackworkloads/azurestack-gallery/tree/master/diagnosis).

## <a name="next-steps"></a>Дополнительная информация

[Развертывание Kubernetes в Azure Stack](azure-stack-solution-template-kubernetes-deploy.md)

[Добавление Kubernetes в Azure Stack Marketplace](../operator/azure-stack-solution-template-kubernetes-cluster-add.md)

[Kubernetes в Azure](https://docs.microsoft.com/azure/container-service/kubernetes/container-service-kubernetes-walkthrough)
