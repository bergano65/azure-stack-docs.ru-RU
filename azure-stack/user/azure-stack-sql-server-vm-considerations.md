---
title: Рекомендации по оптимизации производительности SQL Server в Azure Stack | Документация Майкрософт
description: Эта статья содержит рекомендации по работе с SQL Server для повышения производительности и оптимизации использования SQL Server на виртуальных машинах Azure Stack.
services: azure-stack
documentationcenter: ''
author: bryanla
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/02/2019
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 01/14/2019
ms.openlocfilehash: 96dbca8c3b834565d2fafb73aa02b870cb2bc9a6
ms.sourcegitcommit: 6bb20ed3dcbd64231331a8e807ba69eff8b7439b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/09/2019
ms.locfileid: "74946824"
---
# <a name="sql-server-best-practices-to-optimize-performance-in-azure-stack"></a>Рекомендации по оптимизации производительности SQL Server в Azure Stack

Эта статья содержит рекомендации по работе с SQL Server для повышения производительности и оптимизации использования SQL Server на виртуальных машинах Azure Stack. При выполнении SQL Server на виртуальных машинах Azure Stack используйте те же средства настройки производительности базы данных, которые применяются для SQL Server в локальной серверной среде. Производительность реляционной базы данных в облаке Azure Stack зависит от многих факторов, таких как размер виртуальной машины и конфигурация дисков данных.

При создании образов SQL Server [рекомендуется подготовить виртуальные машины на портале Azure Stack](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision). Скачайте расширение IaaS SQL в интерфейсе управления Marketplace на портале администратора Azure Stack и необходимые образы виртуальной машины SQL Server. К ним относятся SQL Server 2016 с пакетом обновления 1, SQL Server 2016 с пакетом обновления 2 и SQL Server 2017.

> [!NOTE]  
> Хотя в статье описано, как подготовить виртуальную машину SQL Server с помощью глобального портала Azure, это руководство также применимо к Azure Stack. Но есть и некоторые различия: SSD недоступен для диска операционной системы. Кроме того, есть незначительные различия в конфигурации хранилища.

Из этой статьи вы узнаете, как обеспечить *максимальную* производительность для SQL Server на виртуальных машинах Azure Stack. Если рабочая нагрузка не так велика, могут потребоваться не все рекомендуемые варианты оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности и характер рабочих нагрузок.

> [!NOTE]  
> См. [рекомендации по оптимизации производительности SQL Server на виртуальных машинах Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-performance).

## <a name="checklist-for-sql-server-best-practices"></a>Контрольный список для рекомендации по работе с SQL Server

Ниже приведен контрольный список по обеспечению оптимальной производительности SQL Server на виртуальных машинах Azure Stack.


|Область|Оптимизация|
|-----|-----|
|Размер виртуальной машины |[DS3](azure-stack-vm-sizes.md) или выше для выпуска SQL Server Enterprise.<br><br>[DS2](azure-stack-vm-sizes.md) или выше для выпусков SQL Server Standard и Web.|
|Хранилище |Используйте семейство виртуальных машин с поддержкой [хранилища класса Premium](azure-stack-acs-differences.md).|
|Диски |Используйте по крайней мере два диска с данными (один для файлов журнала и один для файла данных и TempDB) и выберите размер диска в соответствии с потребностями в емкости. Задайте стандартные расположения файлов данных для этих дисков во время установки SQL Server.<br><br>Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br>Обеспечьте чередование нескольких дисков данных Azure для увеличения пропускной способности ввода-вывода, используя дисковые пространства.<br><br>Выполняйте форматирование с использованием задокументированных размеров кластеров.|
|ВВОД-ВЫВОД|Включите быструю инициализацию для файлов данных.<br><br>Ограничьте автоматическое увеличение в базах данных с фиксированным небольшим шагом приращения (64–256 МБ).<br><br>Отключите автосжатие базы данных.<br><br>Настройте расположения по умолчанию для резервного копирования и файлов базы данных на дисках с данными, а не на диске операционной системы.<br><br>Включите заблокированные страницы.<br><br>Применяйте накопительные обновления и пакеты обновления SQL Server.|
|Характерные особенности|Выполняйте резервное копирование непосредственно в хранилище BLOB-объектов (если поддерживается используемой версией SQL Server).|
|||

Подробные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в подробных сведениях и руководствах, представленных в следующих разделах.

## <a name="vm-size-guidance"></a>Рекомендации по выбору размеров виртуальных машин

Для приложений, чувствительных к уровню производительности, рекомендуется использовать следующие [размеры виртуальных машин](azure-stack-vm-sizes.md):

- **SQL Server Enterprise Edition**. DS3 или выше

- **Выпуски SQL Server Standard и Web**. DS2 или выше

В Azure Stack различия в производительности между сериями семейства виртуальных машин DS и DS_v2 отсутствуют.

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Виртуальные машины серии DS (наряду с серией DSv2) в Azure Stack предоставляют максимальную пропускную способность (операции ввода-вывода в секунду) диска с данными и диска операционной системы. Виртуальная машина серии DS или DSv2 обеспечивает до 1000 операций ввода-вывода в секунду для диска операционной системы и до 2300 операций ввода-вывода в секунду для диска данных независимо от типа или размера выбранного диска.

Пропускная способность диска с данными определяется с учетом серии семейства виртуальных машин. См. дополнительные сведения об [определении пропускной способности диска с данными каждой серии семейства виртуальных машин](azure-stack-vm-sizes.md).

> [!NOTE]  
> В рабочей среде рекомендуем использовать виртуальную машину серии DSv2 или DS. Так вы обеспечите максимальное количество операций ввода-вывода в секунду на диске операционной системы и дисках данных.

Так как георепликация недоступна в Azure Stack, при создании учетной записи хранения эта функция бесполезна.

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

Виртуальная машина Azure Stack поддерживает три основных типа дисков:

- **Диск операционной системы**. При создании виртуальной машины Azure Stack платформа подключает к ней минимум один диск (обозначенный буквой **C**), который используется в качестве диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.

- **Временный диск**. Виртуальные машины Azure Stack содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.

- **Диски данных**. К виртуальной машине можно подключить дополнительные диски с данными, которые будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой, данный диск имеет метку **C:** .

### <a name="temporary-disk"></a>Временный диск

Диск временного хранилища с меткой **D** не сохраняется. Не храните на диске **D** данные, которые вы не хотите потерять. К ним относятся файлы баз данных и файлы журналов транзакций пользователей.

TempDB рекомендуется хранить на диске с данными, так как каждый диск с данными обеспечивает более 2300 операций ввода-вывода в секунду.

### <a name="data-disks"></a>Диски данных

- **Храните файлы данных и журналов на дисках с данными.** Если вы не применяете чередование дисков, используйте два диска с данными на виртуальной машине с поддержкой хранилища класса Premium, где один диск содержит файлы журнала, а другой — файлы данных и TempDB. Каждый диск с данными обеспечивает определенное количество операций ввода-вывода в секунду в зависимости от семейства виртуальных машин. См. дополнительные сведения о [поддерживаемых размерах виртуальных машин в Azure Stack](azure-stack-vm-sizes.md). При использовании чередования дисков, например в службе дисковых пространств, рекомендуется размещать файлы журналов и данных на одном диске (включая TempDB). Эта конфигурация предоставляет максимальное количество операций ввода-вывода в секунду, доступных для использования в SQL Server, независимо от файла, для которого это необходимо в определенный момент.

> [!NOTE]  
> При подготовке виртуальной машины SQL Server на портале у вас есть возможность изменить конфигурацию хранилища. В зависимости от конфигурации Azure Stack настраивает один или несколько дисков. Несколько дисков объединяются в единый пул хранилищ. Файлы данных и журналов совместно размещаются в этой конфигурации.

- **Чередование дисков**. Для повышения пропускной способности можно добавить дополнительные диски с данными и использовать чередование дисков. Чтобы определить количество дисков с данными, необходимо проанализировать количество операций ввода-вывода в секунду для файлов журналов, файлов данных и файлов TempDB. Обратите внимание, что ограничения на операции ввода-вывода в секунду устанавливаются для каждого диска данных с учетом серии виртуальных машин, а не их размера. При этом ограничения пропускной способности сети устанавливаются с учетом размера виртуальной машины. См. дополнительные сведения о [поддерживаемых размерах виртуальных машин в Azure Stack](azure-stack-vm-sizes.md). Придерживайтесь приведенных ниже рекомендаций.

  - Для Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://technet.microsoft.com/library/hh831739.aspx), придерживаясь приведенных ниже рекомендаций.

    1. Задайте чередование (размер блока чередования) в 64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262 144 байт) для рабочих нагрузок хранилища данных, чтобы избежать снижения производительности из-за рассогласования разделов. Это следует сделать в PowerShell.

    2. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более восьми дисков.

       Например, следующая команда PowerShell создает пул хранилища с установленным размером чередования 64 КБ и числом столбцов, равным 2:

       ```powershell  
       $PoolCount = Get-PhysicalDisk -CanPool $True
       $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}

       New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" -PhysicalDisks $PhysicalDisks | New-VirtualDisk -FriendlyName "DataFiles" -Interleave 65536 -NumberOfColumns 2 -ResiliencySettingName simple -UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" -AllocationUnitSize 65536 -Confirm:$false
       ```

- Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. См. дополнительные сведения о [поддерживаемых размерах виртуальных машин в Azure Stack](azure-stack-vm-sizes.md).
- Чтобы обеспечить максимальное количество операций ввода-вывода в секунду для дисков данных, рекомендуется добавить максимальное количество дисков с данными, поддерживаемое для выбранного [размера виртуальной машины](azure-stack-vm-sizes.md), и применить чередование дисков.
- **Размер единицы размещения NTFS**. При форматировании диска с данными мы советуем использовать размер единицы размещения 64 КБ для файлов данных и журналов, а также TempDB.
- **Рекомендации по управлению дисками**. При удалении диска с данными остановите службу SQL Server. Кроме того, не меняйте параметры кэша на дисках, так как это никак не влияет на улучшение производительности.

> [!WARNING]  
> Если не останавливать службы SQL на время таких операций, это может привести к повреждению базы данных.

## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

- Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте **SE_MANAGE_VOLUME_NAME** учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, учетная запись службы по умолчанию (**NT Service\MSSQLSERVER**) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов у образа платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в статье [Мгновенная инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).
- **Автоматическое расширение** используется в случае непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании автоматического расширения предварительно увеличьте размер файла с помощью параметра **Размер**.
- Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.
- Настройка расположений по умолчанию для файлов резервных копий и базы данных. Следуйте рекомендациям в этой статье и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журнала (среда SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). На следующем снимке экрана показано, где нужно внести необходимые изменения:

    > ![Просмотр или изменение расположений по умолчанию](./media/sql-server-vm-considerations/image1.png)

- Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра «Блокировка страниц в памяти» (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

- Рекомендуется сжимать файлы данных при их передаче в среду Azure Stack и из нее, включая файлы резервного копирования.

## <a name="feature-specific-guidance"></a>Обзор конкретных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

- **Создание резервной копии** **в хранилище Azure**. Вы можете выполнять на виртуальных машинах Azure Stack резервное копирование данных SQL Server на URL-адрес. Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных.

    При выполнении резервного копирования или восстановления с использованием службы хранилища Azure следуйте рекомендациям из статей [Резервное копирование SQL Server на URL-адрес — рекомендации и устранение неполадок](https://msdn.microsoft.com/library/jj919149.aspx) и [Восстановление из резервных копий в Microsoft Azure](https://docs.microsoft.com/sql/relational-databases/backup-restore/restoring-from-backups-stored-in-microsoft-azure?view=sql-server-2017). Кроме того, можно автоматизировать эти процессы резервного копирования с помощью [автоматического резервного копирования SQL Server на виртуальных машинах Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-automated-backup).

-   **Резервное копирование в хранилище Azure Stack.** Вы можете выполнять резервное копирование в хранилище Azure Stack таким же образом, как и в службу хранилища Azure. При создании резервной копии в SQL Server Management Studio (SSMS) необходимо вручную ввести сведения о конфигурации. SSMS нельзя использовать для создания контейнера хранилища или подписанного URL-адреса. SSMS позволяет подключаться только к подпискам Azure, а не Azure Stack. Вместо этого необходимо создать учетную запись хранения, контейнер и подписанный URL-адрес на портале Azure Stack или с помощью PowerShell.


    ![Резервное копирование SQL Server](./media/sql-server-vm-considerations/image3.png)

    > [!NOTE]  
    > Подписанный URL-адрес — это токен SAS на портале Azure Stack без начального знака "?" в строке. Если вы используете функцию копирования с портала, вам необходимо удалить начальный знак "?", чтобы токен работал в SQL Server.

    После указания и настройки назначения резервного копирования в SQL Server можно осуществлять резервное копирование в хранилище BLOB-объектов Azure Stack.

## <a name="next-steps"></a>Дополнительная информация

[Важные аспекты использования служб и создания приложений в Azure Stack](azure-stack-considerations.md)
