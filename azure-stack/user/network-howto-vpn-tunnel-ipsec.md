---
title: Создание VPN-туннеля с помощью IPSEC в Azure Stack Hub | Документация Майкрософт
description: Узнайте как создавать VPN-туннель с помощью IPSEC в Azure Stack Hub.
services: azure-stack
author: mattbriggs
ms.service: azure-stack
ms.topic: how-to
ms.date: 09/19/2019
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 09/19/2019
ms.openlocfilehash: a0716d4997a49c2146d64c23defdd6b2f36c0b95
ms.sourcegitcommit: d450dcf5ab9e2b22b8145319dca7098065af563b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2020
ms.locfileid: "75878464"
---
# <a name="how-to-create-a-vpn-tunnel-using-ipsec--in-azure-stack-hub"></a>Создание VPN-туннеля с помощью IPSEC в Azure Stack Hub

В этом решении шаблон Resource Manager Azure Stack Hub можно использовать для подключения двух виртуальных сетей Azure Stack Hub в одной среде Azure Stack Hub. Вы [не можете подключить виртуальные сети Azure Stack Hub](https://docs.microsoft.com/azure-stack/user/azure-stack-network-differences) с помощью встроенного шлюза виртуальной сети. Сейчас для создания VPN-туннеля между двумя виртуальными сетями Azure Stack Hub следует использовать сетевые виртуальные устройства (NVA). Шаблон решения развертывает две виртуальные машины Windows Server 2016 с установленным RRAS. Решение настраивает два сервера RRAS для использования туннеля S2SVPN IKEv2 между двумя виртуальными сетями. Соответствующие правила NSG и UDR созданы для обеспечения маршрутизации между подсетями на каждой виртуальной сети, обозначенной как **внутренняя** 

Такое решение является основой, которая позволит создавать туннели VPN не только в экземпляре Azure Stack Hub, но и между экземплярами Azure Stack Hub и другими ресурсами, такими как локальные сети с использованием VPN туннелей типа "сеть — сеть" на Windows RRAS.

Вы можете найти шаблоны в разделе [Шаблоны интеллектуальных границ Azure](https://github.com/Azure-Samples/azure-intelligent-edge-patterns) репозитория GitHub. Шаблон находится в папке**rras-gre-vnet-vnet**. 

![замещающий текст](./media/azure-stack-network-howto-vpn-tunnel-ipsec/overview.png)

## <a name="requirements"></a>Требования

- Система, развернутая с применением последних обновлений. 
- Необходимые элементы Marketplace для Azure Stack Hub:
    -  Windows Server 2016 Datacenter или Windows Server 2019 Datacenter (рекомендуется последняя сборка)
    -  Расширение пользовательских сценариев

## <a name="things-to-consider"></a>Полезная информация

- Группа сетевой безопасности применяется к шаблону "Подсеть туннеля".  Рекомендуется закрепить внутреннюю подсеть в каждой виртуальной сети с помощью дополнительной NSG.
- Запрещающее правило RDP применяется к NSG туннеля. Его нужно установить, чтобы разрешить вам доступ к виртуальным машинам через публичный IP-адрес
- Это решение не учитывает разрешение DNS для учетных записей
- Комбинация имени виртуальной сети и vmName должна содержать не более 15 символов
- Этот шаблон предназначен для настройки имен виртуальных машин для VNet1 и VNet2
- Этот шаблон использует BYOL Windows
- При удалении группы ресурсов, включенной в данный момент (1907), вы должны вручную отсоединить NSG от подсети туннеля, чтобы убедиться, что группа ресурсов удалена полностью
- Этот шаблон использует виртуальную машину DS3v2.  Служба RRAS устанавливает и запускает внутренний SQL Server Windows.  Если размер виртуальной машины слишком мал, это может вызвать проблемы с памятью.  Проверьте производительность до уменьшения размера виртуальной машины.
- Это не высокодоступное решение.  Если вам требуется более высокоскоростное решение, вы можете добавить вторую виртуальную машину. В этом случае вам придется вручную изменить маршрут в таблице маршрутизации на внутреннем протоколе IP вторичного интерфейса.  Вам также потребуется настроить несколько туннелей для перекрестного соединения.

## <a name="optional"></a>Необязательно

- С помощью параметров_artifactsLocation и _artifactsLocationSasToken вы можете использовать собственную учетную запись хранилища BLOB-объектов и маркер SAS.
- В этом шаблоне есть два вывода INTERNALSUBNETREFVNET1 и INTERNALSUBNETREFVNET2, которые являются идентификаторами ресурса для внутренних подсетей при использовании в шаблоне развертывания в виде конвейера.

Шаблон предоставляет значения по умолчанию для именования и IP-адресации виртуальной сети.  Для этого потребуется пароль администратора (rrasadmin). Также есть возможность использования собственного хранилища BLOB-объектов с маркером SAS.  Следите за тем, чтобы эти значения оставались в допустимых диапазонах, так как развертывание может завершиться ошибкой.  Пакет powershell DSC выполняется на каждой виртуальной машине RRAS и устанавливает маршрутизацию и все необходимые службы и функции.  При необходимости эту DSC можно настроить дополнительно.  Расширение пользовательских сценариев выполняет следующий сценарий и "Add-Site2SiteIKE.ps1" настраивает туннель Site2SiteIKE между двумя серверами RRAS с общим ключом.  Чтобы увидеть результаты настройки туннеля VPN, можно просмотреть подробный вывод из расширения пользовательских сценариев

![замещающий текст](./media/azure-stack-network-howto-vpn-tunnel-ipsec/s2svpntunnel.png)

## <a name="next-steps"></a>Дальнейшие действия

[Сети Azure Stack Hub: различия и рекомендации](azure-stack-network-differences.md)  
[Сведения о настройке нескольких VPN-туннелей типа "сеть — сеть"](network-howto-vpn-tunnel.md)  
[How to create a VPN tunnel using GRE](network-howto-vpn-tunnel-gre.md) (Создание VPN-туннеля с помощью GRE)