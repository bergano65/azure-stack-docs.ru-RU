---
title: Развертывание приложения в Azure и Azure Stack | Документация Майкрософт
description: Узнайте, как развертывать приложения в Azure и Azure Stack с помощью гибридного конвейера CI/CD.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 03/11/2019
ms.author: mabrigg
ms.reviewer: anajod
ms.lastreviewed: 11/07/2018
ms.openlocfilehash: 44a510b8110bacbb51b987a0393f1bc04c594fcd
ms.sourcegitcommit: 85c3acd316fd61b4e94c991a9cd68aa97702073b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2019
ms.locfileid: "64985767"
---
# <a name="tutorial-deploy-apps-to-azure-and-azure-stack"></a>Руководство. Развертывание приложений в Azure и Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Сведения о развертывании приложения в Azure и Azure Stack с помощью гибридного конвейера гибридной непрерывной интеграции и непрерывной поставки (CI/CD).

В рамках этого руководства вы создадите пример среды, чтобы выполнить в ней следующее:

> [!div class="checklist"]
> * Запустить новую сборку на основе зафиксированного кода из репозитория Azure DevOps Services.
> * Автоматически развернуть приложение в глобальный Azure для пользовательского приемочного тестирования.
> * После того, как ваш код прошел тестирование, автоматически развернуть его в Azure Stack.

## <a name="benefits-of-the-hybrid-delivery-build-pipe"></a>Преимущества конвейера сборки гибридной поставки

Непрерывность, безопасность и надежность являются ключевыми элементами развертывания приложений. Они ценные для организации и критически важные для команды разработчиков. Конвейер непрерывной интеграции и непрерывной поставки позволяет консолидировать созданные конвейеры сборки в локальной среде и общедоступном облаке. Кроме того, гибридная модель поставки позволяет менять расположения развертывания без изменения приложения.

Дополнительные преимущества использования гибридного подхода:

* Вы можете поддерживать согласованный набор средств разработки в локальной среде Azure Stack и общедоступном облаке Azure.  Общий набор средств упрощает реализацию шаблонов и методов непрерывной интеграции и непрерывной поставки.
* Приложения и службы, развертываемые в Azure или Azure Stack, взаимозаменяемы, и тот же код можно выполнять в любом расположении. Вы можете воспользоваться функциями и возможностями локальной среды и общедоступного облака.

Дополнительные сведения о непрерывной интеграции и непрерывной поставке:

* [Что такое непрерывная интеграция](https://www.visualstudio.com/learn/what-is-continuous-integration/)
* [Что такое непрерывная поставка](https://www.visualstudio.com/learn/what-is-continuous-delivery/)

> [!Tip]  
> ![hybrid-pillars.png](./media/azure-stack-solution-cloud-burst/hybrid-pillars.png)  
> Microsoft Azure Stack — это расширение Azure.re. Azure Stack позволяет использовать гибкие и инновационные функции облачных вычислений в локальной среде, а также предоставляет единое гибридное облако для создания и развертывания гибридных приложений в любом расположении.  
> 
> В [рекомендациях по проектированию гибридных приложений](https://aka.ms/hybrid-cloud-applications-pillars) описаны характеристики качественного программного обеспечения (размещение, масштабируемость, доступность, устойчивость, управляемость и безопасность), которых следует придерживаться при разработке, развертывании и использовании гибридных приложений. Рекомендации помогут оптимизировать разработку гибридных приложений и свести к минимуму проблемы в рабочих средах.

## <a name="prerequisites"></a>Предварительные требования

Вам потребуются компоненты, чтобы создать гибридный конвейер непрерывной интеграции и непрерывной поставки. Подготовка следующих компонентов может занять некоторое время:

* Поставщик вычислительной техники или партнер-поставщик оборудования Azure может развернуть рабочую среду Azure Stack. Все пользователи могут развернуть Пакет средств разработки Azure Stack (ASDK).
* Оператор Azure Stack также должен развернуть службу приложений, создать планы и предложения, создать подписку клиента и добавить образ Windows Server 2016.

>[!NOTE]
>Если у вас уже развернуты некоторые из этих компонентов, перед началом работы с руководством убедитесь, что они отвечают всем требованиям.

В этом руководстве также предполагается, что вы знакомы с Azure и Azure Stack. Перед началом работы прочтите следующие статьи:

* [Введение в Azure](https://azure.microsoft.com/overview/what-is-azure/).
* [Основные понятия Azure Stack](../operator/azure-stack-overview.md).

### <a name="azure-requirements"></a>Требования Azure

* Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.
* Создайте [веб-приложение](https://docs.microsoft.com/azure/app-service/overview) в Azure. Запишите URL-адрес веб-приложения. Он понадобится вам дальше при работе с этим руководством.

### <a name="azure-stack-requirements"></a>Требования к Azure Stack

* Используйте систему с Azure Stack или разверните Пакет средств разработки Azure Stack (ASDK). Чтобы развернуть пакет ASDK, сделайте следующее:
  * Выполните подробные инструкции в статье [Установка Пакета средств разработки Azure Stack (ASDK)](../asdk/asdk-install.md).
  * Автоматизируйте шаги после развертывания ASDK с помощью следующего скрипта PowerShell: [ConfigASDK.ps1](https://github.com/mattmcspirit/azurestack/blob/master/deployment/ConfigASDK.ps1 ).

    > [!Note]
    > Установка ASDK занимает приблизительно семь часов, поэтому планируйте ее соответствующим образом.

  * Разверните службы PaaS [службы приложений](../operator/azure-stack-app-service-deploy.md) в Azure Stack.
  * Создайте [план и предложения](../operator/azure-stack-plan-offer-quota-overview.md) в Azure Stack.
  * Создайте [подписку клиента](../operator/azure-stack-subscribe-plan-provision-vm.md) в Azure Stack.
  * Создайте веб-приложение в подписке клиента. Запишите новый URL-адрес веб-приложения для дальнейшего использования.
  * Разверните виртуальную машину Windows Server 2012 в подписке клиента. Этот сервер будет использоваться как сервер сборки, а также для запуска Azure DevOps Services.
* Укажите образ Windows Server 2016 с .NET 3.5 для виртуальной машины. Эта виртуальная машина будет создана в Azure Stack в качестве частного агента сборки.

### <a name="developer-tool-requirements"></a>Требования к инструментам для разработчиков

* Создайте [рабочую область Azure DevOps Services](https://docs.microsoft.com/azure/devops/repos/tfvc/create-work-workspaces). Во время процесса регистрации создается проект с именем **MyFirstProject**.
* [Установите Visual Studio 2017](https://docs.microsoft.com/visualstudio/install/install-visual-studio) и [войдите в Azure DevOps Services](https://www.visualstudio.com/docs/setup-admin/team-services/connect-to-visual-studio-team-services).
* Подключитесь к проекту и [локально клонируйте его](https://www.visualstudio.com/docs/git/gitquickstart).

  > [!Note]
  > Среде Azure Stack необходимы подходящие образы, объединенные для запуска Windows Server и SQL. В ней также должна быть развернутая служба приложений.

## <a name="prepare-the-private-azure-pipelines-agent-for-azure-devops-services-integration"></a>Подготовка частного агента Azure Pipelines для интеграции Azure DevOps Services

### <a name="prerequisites"></a>Предварительные требования

Azure DevOps Services выполняет аутентификацию в Azure Resource Manager с помощью субъекта-службы. Чтобы подготавливать ресурсы в подписке Azure Stack, у Azure DevOps Services должна быть роль **участника**.

Ниже приведены действия, необходимые для настройки проверки подлинности:

1. Создайте субъект-службу или используйте уже имеющуюся.
2. Создайте ключи проверки подлинности для субъекта-службы.
3. Проверьте подписку Azure Stack в механизме управления доступом на основе ролей, чтобы разрешить имени субъекта-службы быть частью роли "Участник".
4. Создайте новое определение службы в Azure DevOps Services с помощью конечных точек Azure Stack и информации об имени субъекта-службы.

### <a name="create-a-service-principal"></a>Создание субъекта-службы

Ознакомьтесь с инструкциями по [созданию субъекта-службы](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications). Выберите **Веб-приложение или API** в качестве типа приложения или [используйте скрипт PowerShell](https://github.com/Microsoft/vsts-rm-extensions/blob/master/TaskModules/powershell/Azure/SPNCreation.ps1#L5), как описано в разделе [Create an Azure Resource Manager service connection with an existing service principal](https://docs.microsoft.com/vsts/pipelines/library/connect-to-azure?view=vsts#create-an-azure-resource-manager-service-connection-with-an-existing-service-principal) (Создание подключения службы Azure Resource Manager с существующим субъектом-службой).

 > [!Note]  
 > Если для создания конечной точки Azure Resource Manager в Azure Stack используется скрипт, нужно передать параметр **-azureStackManagementURL** и параметр **-environmentName**. Например:   
> `-azureStackManagementURL https://management.local.azurestack.external -environmentName AzureStack`

### <a name="create-an-access-key"></a>Создание ключа доступа

Субъекту-службе требуется ключ для проверки подлинности. Создайте ключ, выполнив следующие действия.

1. В Azure Active Directory в разделе **Регистрация приложений** выберите нужное приложение.

    ![Выбор приложения](media/azure-stack-solution-hybrid-pipeline/000_01.png)

2. Запишите значение **идентификатора приложения**. Это значение будет использовано при настройке конечной точки службы в Azure DevOps Services.

    ![Идентификатор приложения](media/azure-stack-solution-hybrid-pipeline/000_02.png)

3. Чтобы создать ключ проверки подлинности, щелкните **Параметры**.

    ![Изменение параметров приложения](media/azure-stack-solution-hybrid-pipeline/000_03.png)

4. Чтобы создать ключ проверки подлинности, щелкните **Ключи**.

    ![Настройка параметров ключей](media/azure-stack-solution-hybrid-pipeline/000_04.png)

5. Введите описание и срок действия ключа. Затем нажмите кнопку **Сохранить**.

    ![Описание и срок действия ключа](media/azure-stack-solution-hybrid-pipeline/000_05.png)

    После сохранения ключа отображается **значение** ключа. Скопируйте это значение, так как позже вы не сможете получить его снова. **Значение ключа** необходимо предоставить вместе с идентификатором приложения для входа от имени приложения. Сохраните значение ключа, чтобы приложение могло получить к нему доступ.

    ![Значение ключа](media/azure-stack-solution-hybrid-pipeline/000_06.png)

### <a name="get-the-tenant-id"></a>Получение идентификатора клиента

Как часть конфигурации конечной точки службы, Azure DevOps Services требует **идентификатор клиента**, который соответствует каталогу Azure Active Directory, в который развернута метка Azure Stack. Выполните следующие действия, чтобы получить идентификатор клиента.

1. Выберите **Azure Active Directory**.

    ![Azure Active Directory для клиента](media/azure-stack-solution-hybrid-pipeline/000_07.png)

2. Чтобы получить идентификатор клиента, щелкните **Свойства** для клиента Azure AD.

    ![Просмотр свойств клиента](media/azure-stack-solution-hybrid-pipeline/000_08.png)

3. Скопируйте **идентификатор каталога**. Это и есть ваш идентификатор клиента.

    ![Идентификатор каталога](media/azure-stack-solution-hybrid-pipeline/000_09.png)

### <a name="grant-the-service-principal-rights-to-deploy-resources-in-the-azure-stack-subscription"></a>Предоставление прав субъекта-службы, чтобы развернуть ресурсы в подписке Azure Stack

Чтобы обеспечить доступ к ресурсам в подписке, необходимо назначить приложению роль. Укажите, какая роль предоставит приложению лучшие разрешения. Дополнительные сведения о доступных ролях см. в статье [RBAC: встроенные роли](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles).

Вы можете задать область действия на уровне подписки, группы ресурсов или ресурса. Разрешения наследуют более низкие уровни области действия. Например, добавление приложения в роль читателя для группы ресурсов означает, что оно может считывать группу ресурсов и все ее ресурсы.

1. Перейдите на уровень области действия, которому вы хотите назначить приложение. Например, чтобы назначить роль в области действия подписки выберите **Подписки**.

    ![Выбор пункта "Подписки"](media/azure-stack-solution-hybrid-pipeline/000_10.png)

2. В разделе **Подписки** выберите Visual Studio Enterprise.

    ![Visual Studio Enterprise](media/azure-stack-solution-hybrid-pipeline/000_11.png)

3. В колонке Visual Studio Enterprise выберите **Управление доступом (IAM)**.

4. Выберите **Добавить назначение ролей**.

    ![Добавить](media/azure-stack-solution-hybrid-pipeline/000_13.png)

5. В разделе **Добавление разрешений** выберите роль, которая будет присвоена приложению. В этом примере указана роль **Владелец**.

    ![Роль "Владелец"](media/azure-stack-solution-hybrid-pipeline/000_14.png)

6. По умолчанию приложения Azure Active Directory не отображаются среди доступных вариантов. Чтобы найти приложение, укажите его имя в поле **Выбрать**. Выберите приложение.

    ![Результат поиска приложения](media/azure-stack-solution-hybrid-pipeline/000_16.png)

7. Выберите **Сохранить**, чтобы завершить назначение роли. Вы увидите свое приложение в списке пользователей, назначенных выбранной роли для выбранной области действия.

### <a name="role-based-access-control"></a>Управление доступом на основе ролей

‎Управление доступом на основе ролей Azure (RBAC) обеспечивает точное управление доступом к Azure. С помощью RBAC можно управлять уровнем доступа, который нужен пользователям для выполнения поставленных перед ними задач. Дополнительные сведения об управлении доступом на основе ролей см. в статье [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal?toc=%252fazure%252factive-directory%252ftoc.json).

### <a name="azure-devops-services-agent-pools"></a>Пулы агентов Azure DevOps Services

Вместо управления каждым агентом по отдельности, вы можете упорядочить агенты в пулы. Пул агентов определяет общую границу для всех агентов в этом пуле. В Azure DevOps Services пулы агентов собираются в области в организации Azure DevOps Services, что означает, что пул агентов можно передавать между проектами. Дополнительные сведения о пулах агентов см. в статье [Agent pools and queues](https://docs.microsoft.com/azure/devops/pipelines/agents/pools-queues?view=vsts) (Очереди и пулы агентов).

### <a name="add-a-personal-access-token-pat-for-azure-stack"></a>Добавление личного маркера доступа для Azure Stack

Создайте личный маркер доступа к Azure DevOps Services.

1. Войдите в вашу организацию Azure DevOps Services и выберите название профиля вашей организации.

2. Выберите **Управление безопасностью**, чтобы получить доступ к странице создания маркера.

    ![Вход пользователя](media/azure-stack-solution-hybrid-pipeline/000_17.png)

    ![Выберите проект](media/azure-stack-solution-hybrid-pipeline/000_18.png)

    ![Добавление личного маркера доступа](media/azure-stack-solution-hybrid-pipeline/000_18a.png)

    ![Создание маркера](media/azure-stack-solution-hybrid-pipeline/000_18b.png)

3. Скопируйте маркер.

    > [!Note]
    > Сохраните сведения о маркере. Они не сохранятся и не появятся снова, когда вы перейдете с этой веб-страницы.

    ![Личный маркер доступа](media/azure-stack-solution-hybrid-pipeline/000_19.png)

### <a name="install-the-azure-devops-services-build-agent-on-the-azure-stack-hosted-build-server"></a>Установка агента сборки Azure DevOps Services на сервере сборки, размещенном в Azure Stack

1. Подключитесь к серверу сборки, развернутом на узле Azure Stack.
2. Скачайте, а затем разверните агент сборки в качестве службы, используя личный маркер доступа, и запустите его от имени учетной записи администратора виртуальной машины.

    ![Скачивание агента сборки](media/azure-stack-solution-hybrid-pipeline/010_downloadagent.png)

3. Перейдите в папку для извлеченного агента сборки. Запустите файл **config.cmd** из командной строки с повышенными привилегиями.

    ![Извлеченный агент сборки](media/azure-stack-solution-hybrid-pipeline/000_20.png)

    ![Регистрация агента сборки](media/azure-stack-solution-hybrid-pipeline/000_21.png)

4. После выполнения файла config.cmd папка агента сборки обновляется: в нее добавляются дополнительные файлы. Папка с извлеченным содержимым должна выглядеть следующим образом:

    ![Обновление папки агента сборки](media/azure-stack-solution-hybrid-pipeline/009_token_file.png)

    Как видите, агент находится в папке Azure DevOps Services.

## <a name="endpoint-creation-permissions"></a>Разрешения на создание конечной точки

Создавая конечные точки, сборка VSTO может развертывать приложения службы приложений в Azure Stack. Azure DevOps Services подключается к агенту сборки, который, в свою очередь, подключается к Azure Stack.

![Пример приложения NorthwindCloud в VSTO](media/azure-stack-solution-hybrid-pipeline/012_securityendpoints.png)

1. Войдите в VSTO и перейдите на страницу параметров приложения.
2. В разделе **Параметры** выберите **Безопасность**.
3. В списке **Группы Azure DevOps Services** выберите **Создатели конечных точек**.

    ![Создатели конечных точек NorthwindCloud](media/azure-stack-solution-hybrid-pipeline/013_endpoint_creators.png)

4. На вкладке **Члены** выберите **Добавить**.

    ![Добавление элементов](media/azure-stack-solution-hybrid-pipeline/014_members_tab.png)

5. В разделе **Add users and groups** (Добавление пользователей и групп) введите имя пользователя и выберите этого пользователя из списка.
6. Щелкните **Save changes** (Сохранить изменения).
7. В списке **Группы Azure DevOps Services** выберите **Администраторы конечных точек**.

    ![Администраторы конечной точки NorthwindCloud](media/azure-stack-solution-hybrid-pipeline/015_save_endpoint.png)

8. На вкладке **Члены** выберите **Добавить**.
9. В разделе **Add users and groups** (Добавление пользователей и групп) введите имя пользователя и выберите этого пользователя из списка.
10. Щелкните **Save changes** (Сохранить изменения).

Теперь, когда сведения о конечной точке существуют, подключение Azure DevOps Services к Azure Stack готово к использованию. Агент сборки в Azure Stack получает инструкции от Azure DevOps Services, а затем передает сведения о конечной точке для взаимодействия с Azure Stack.

## <a name="create-an-azure-stack-endpoint"></a>Создание конечной точки Azure Stack

### <a name="create-an-endpoint-for-azure-ad-deployments"></a>Создание конечной точки для развертываний Azure Active Directory

Вы можете следовать инструкциям из раздела [Create an Azure Resource Manager service connection with an existing service principal](https://docs.microsoft.com/vsts/pipelines/library/connect-to-azure?view=vsts#create-an-azure-resource-manager-service-connection-with-an-existing-service-principal) (Создание подключения службы Azure Resource Manager с существующим субъектом-службой), чтобы создать подключение службы с существующим субъектом-службой и использовать следующее сопоставление:

Вы можете создать подключение к службе, используя следующие значения параметров:

| ИМЯ | Пример | ОПИСАНИЕ |
| --- | --- | --- |
| Имя подключения | Azure Stack в Azure Active Directory | Имя подключения. |
| Среда | AzureStack | Имя вашей среды. |
| Environment URL (URL-адрес среды) | `https://management.local.azurestack.external` | Конечная точка управления. |
| Уровень области | Подписка | Область подключения. |
| Идентификатор подписки | 65710926-XXXX-4F2A-8FB2-64C63CD2FAE9 | Идентификатор подписки пользователя Azure Stack. |
| Имя подписки | name@contoso.com | Имя подписки пользователя Azure Stack. |
| Идентификатор клиента для субъекта-службы | FF74AACF-XXXX-4776-93FC-C63E6E021D59 | Идентификатор субъекта-службы из [этого](azure-stack-solution-pipeline.md#create-a-service-principal) раздела статьи. |
| Ключ субъекта-службы | THESCRETGOESHERE= | Ключ из этой же статьи (или пароль, если вы использовали скрипт). |
| Tenant ID | D073C21E-XXXX-4AD0-B77E-8364FCA78A94 | Идентификатор клиента, полученный по инструкции из раздела [Получение идентификатора клиента](azure-stack-solution-pipeline.md#get-the-tenant-id).  |
| Подключение: | Не проверено | Проверьте параметры подключения к субъекту-службе. |

После создания конечной точки можно использовать подключение DevOps к Azure Stack. Агент сборки в Azure Stack получает инструкции от DevOps, а затем передает сведения о конечной точке для взаимодействия с Azure Stack.

![Azure Active Directory агента сборки](media/azure-stack-solution-hybrid-pipeline/016_save_changes.png)

### <a name="create-an-endpoint-for-ad-fs"></a>Создание конечной точки для служб федерации Active Directory (AD FS)

Последнее обновление Azure DevOps позволяет создавать подключения к службе с помощью субъекта-службы, используя сертификат для проверки подлинности. Это необходимо, если в качестве поставщика удостоверений при развертывании Azure Stack используются службы AD FS. 

![AD FS агента сборки](media/azure-stack-solution-hybrid-pipeline/image06.png)

Вы можете создать подключение к службе, используя следующие значения параметров:

| ИМЯ | Пример | ОПИСАНИЕ |
| --- | --- | --- |
| Имя подключения | ADFS Azure Stack | Имя подключения. |
| Среда | AzureStack | Имя вашей среды. |
| Environment URL (URL-адрес среды) | `https://management.local.azurestack.external` | Конечная точка управления. |
| Уровень области | Подписка | Область подключения. |
| Идентификатор подписки | 65710926-XXXX-4F2A-8FB2-64C63CD2FAE9 | Идентификатор подписки пользователя Azure Stack. |
| Имя подписки | name@contoso.com | Имя подписки пользователя Azure Stack. |
| Идентификатор клиента для субъекта-службы | FF74AACF-XXXX-4776-93FC-C63E6E021D59 | Идентификатор клиента из субъекта-службы, созданного для служб AD FS. |
| Сертификат | `<certificate>` |  Преобразование файла сертификата PFX в формат PEM. Вставьте содержимое файла сертификата PEM в это поле. <br> Преобразование PFX в формат PEM:<br>`openssl pkcs12 -in file.pfx -out file.pem -nodes -password pass:<password_here>` |
| Tenant ID | D073C21E-XXXX-4AD0-B77E-8364FCA78A94 | Идентификатор клиента, полученный по инструкции из раздела [Получение идентификатора клиента](azure-stack-solution-pipeline.md#get-the-tenant-id). |
| Подключение: | Не проверено | Проверьте параметры подключения к субъекту-службе. |

После создания конечной точки можно использовать подключение Azure DevOps к Azure Stack. Агент сборки в Azure Stack получает инструкции от Azure DevOps, а затем передает сведения о конечной точке для взаимодействия с Azure Stack.

> [!Note]
> Если конечная точка пользователя ARM Azure Stack недоступна через Интернет, проверка подключения завершится сбоем. Это ожидаемое поведение. Вы можете проверить подключение, создав конвейер выпуска с простой задачей. 

## <a name="develop-your-application-build"></a>Разработка сборки приложения

В этой части руководства вы выполните следующее:

* Добавьте код в проект Azure DevOps Services.
* создадите автономное развертывание веб-приложения;
* настроите процесс непрерывного развертывания.

> [!Note]
 > Среде Azure Stack необходимы подходящие образы, объединенные для запуска Windows Server и SQL. В ней также должна быть развернутая служба приложений. Просмотрите раздел "Предварительные требования" в документации о службе приложений, чтобы узнать требования к оператору Azure Stack.

Гибридные процессы непрерывной интеграции и непрерывной поставки применимы и к коду приложения, и к коду инфраструктуры. Используйте [такие шаблоны Azure Resource Manager, как](https://azure.microsoft.com/resources/templates/) код веб-приложения из Azure DevOps Services, для развертывания в обоих облаках.

### <a name="add-code-to-an-azure-devops-services-project"></a>Добавление кода в проект Azure DevOps Services

1. Войдите в Azure DevOps Services через организацию, у которой есть права на создание проекта в Azure Stack. На следующем снимке экрана показано, как подключиться к проекту HybridCICD.

    ![Подключение к проекту](media/azure-stack-solution-hybrid-pipeline/017_connect_to_project.png)

2. **Клонируйте репозиторий** путем создания и открытия веб-приложения по умолчанию.

    ![Клонирование репозитория](media/azure-stack-solution-hybrid-pipeline/018_link_arm.png)

### <a name="create-self-contained-web-app-deployment-for-app-services-in-both-clouds"></a>Создание автономного развертывания веб-приложения для служб приложений в обоих облаках

1. Измените файл **WebApplication.csproj**. Выберите **Runtimeidentifier** и добавьте `win10-x64.`. Дополнительные сведения см. в разделе [Автономные развертывания](https://docs.microsoft.com/dotnet/core/deploying/#self-contained-deployments-scd).

    ![Настройка Runtimeidentifier](media/azure-stack-solution-hybrid-pipeline/019_runtimeidentifer.png)

2. Добавьте код в Azure DevOps Services с помощью Team Explorer.

3. Подтвердите, что код приложения был добавлен в Azure DevOps Services.

### <a name="create-the-build-pipeline"></a>Создание конвейера сборки

1. Войдите в Azure DevOps Services через организацию, которая может создать конвейер сборки.

2. Перейдите на страницу **Build Web Application** (Сборка веб-приложения) для проекта.

3. Добавьте код **-r win10-x64** в поле **Аргумент**. Это необходимо, чтобы активировать автономное развертывание с .NET Core.

    ![Добавление конвейера сборки в поле аргумента](media/azure-stack-solution-hybrid-pipeline/020_publish_additions.png)

4. Запустите сборку. Процесс [сборки автономного развертывания](https://docs.microsoft.com/dotnet/core/deploying/#self-contained-deployments-scd) будет публиковать артефакты, которые могут выполняться в Azure и Azure Stack.

### <a name="use-an-azure-hosted-build-agent"></a>Использование агента сборки, размещенного в Azure

Использование размещенного агента сборки в Azure DevOps Services является удобной функцией для создания и развертывания веб-приложений. Обновление и обслуживание агента, включая постоянный, непрерывный цикл разработки, автоматически выполняются Microsoft Azure.

### <a name="configure-the-continuous-deployment-cd-process"></a>Настройка процесса непрерывного развертывания

Azure DevOps Services и Team Foundation Server предоставляют конвейер с широкими возможностями настройки и управления для выпусков в различные среды, такие как среда разработки, промежуточная среда, среда для контроля качества и рабочая среда. Этот процесс может охватывать требование утверждений на определенных стадиях жизненного цикла приложения.

### <a name="create-release-pipeline"></a>Создание конвейера выпуска

Создание конвейера выпуска — это последний шаг в процессе сборки приложения. Конвейер выпуска используется для создания выпуска и развертывания сборки.

1. Войдите в Azure DevOps Services и перейдите к **Azure Pipelines** в вашем проекте.
2. На вкладке **Выпуски** выберите **\[ + ]**, а затем — **Создать определение выпуска**.

   ![Создание конвейера выпуска](media/azure-stack-solution-hybrid-pipeline/021a_releasedef.png)

3. В разделе **Select a Template** (Выбор шаблона) выберите **Развертывание службы приложений Azure**, а затем — **Применить**.

    ![Применение шаблона](media/azure-stack-solution-hybrid-pipeline/102.png)

4. В разделе **Добавление артефакта** из раскрывающегося меню **Source (Build definition)** (Источник (определение сборки)) выберите приложение сборки облака Azure.

    ![Добавление артефакта](media/azure-stack-solution-hybrid-pipeline/103.png)

5. На вкладке **Конвейер** выберите ссылку **Фаза 1**, **Задача 1**, чтобы **просмотреть задачи среды**.

    ![Задачи представления конвейера](media/azure-stack-solution-hybrid-pipeline/104.png)

6. На вкладке **Задачи** укажите Azure в качестве **имени среды** и выберите подписку AzureCloud Traders-Web EP из раскрывающегося списка **Подписка Azure**.

    ![Настройка переменных среды](media/azure-stack-solution-hybrid-pipeline/105.png)

7. Введите **имя службы приложений Azure**. На следующем снимке экрана указано имя northwindtraders.

    ![Имя службы приложений](media/azure-stack-solution-hybrid-pipeline/106.png)

8. Для фазы агента выберите **Размещается в VS2017** из раскрывающегося списка **Очередь агентов**.

    ![Размещенный агент](media/azure-stack-solution-hybrid-pipeline/107.png)

9. В разделе **Развертывание службы приложений Azure** выберите допустимый для среды **пакет или папку**.

    ![Выбор пакета или папки](media/azure-stack-solution-hybrid-pipeline/108.png)

10. В разделе **Select File or Folder** (Выбор файла или папки) нажмите кнопку **ОК**, чтобы выбрать **расположение**.

    ![Альтернативный текст](media/azure-stack-solution-hybrid-pipeline/109.png)

11. Сохраните все изменения и вернитесь к **конвейеру**.

    ![Альтернативный текст](media/azure-stack-solution-hybrid-pipeline/110.png)

12. На вкладке **Конвейер** щелкните **Добавить артефакт**, а затем из раскрывающегося списка **Source (Build definition)** (Источник (определение сборки)) выберите **NorthwindCloud Traders-Vessel**.

    ![Добавление нового артефакта](media/azure-stack-solution-hybrid-pipeline/111.png)

13. В разделе **Select a Template** (Выбор шаблона) добавьте другую среду. Выберите **Развертывание службы приложений Azure**, а затем щелкните **Применить**.

    ![Выбор шаблона](media/azure-stack-solution-hybrid-pipeline/112.png)

14. Введите Azure Stack в качестве **имени среды**.

    ![Имя среды](media/azure-stack-solution-hybrid-pipeline/113.png)

15. На вкладке **Задачи** найдите и выберите Azure Stack.

    ![Среда Azure Stack](media/azure-stack-solution-hybrid-pipeline/114.png)

16. В раскрывающемся списке **Подписка Azure** выберите AzureStack Traders-Vessel EP для конечной точки Azure Stack.

    ![Альтернативный текст](media/azure-stack-solution-hybrid-pipeline/115.png)

17. Введите имя веб-приложения Azure Stack в качестве **имени службы приложений**.

    ![Имя службы приложений](media/azure-stack-solution-hybrid-pipeline/116.png)

18. В разделе **Выбор агента** выберите AzureStack - bDouglas Fir из раскрывающегося списка **Очередь агента**.

    ![Выбор агента](media/azure-stack-solution-hybrid-pipeline/117.png)

19. В разделе **Развертывание службы приложений Azure** выберите допустимый для среды **пакет или папку**. В разделе **Select File Or Folder** (Выбор файла или папки) нажмите кнопку **OК**, чтобы выбрать **расположение** папки.

    ![Выбор пакета или папки](media/azure-stack-solution-hybrid-pipeline/118.png)

    ![Подтверждение расположения](media/azure-stack-solution-hybrid-pipeline/119.png)

20. На вкладке **Переменная** найдите переменную с именем **VSTS_ARM_REST_IGNORE_SSL_ERRORS**. Задайте для переменной значение **true**, а для области — **Azure Stack**.

    ![Настройка переменной](media/azure-stack-solution-hybrid-pipeline/120.png)

21. На вкладке **Конвейер** выберите значок **триггера непрерывного развертывания** для артефакта NorthwindCloud Traders-Web, а для **триггера непрерывного развертывания** задайте значение **Включено**.  То же самое сделайте для артефакта NorthwindCloud Traders-Vessel.

    ![Установка триггера непрерывного развертывания](media/azure-stack-solution-hybrid-pipeline/121.png)

22. В среде Azure Stack выберите значок **Условия перед развертыванием** и задайте триггеру значение **После выпуска**.

    ![Установка триггера условий перед развертыванием](media/azure-stack-solution-hybrid-pipeline/122.png)

23. Сохраните изменения.

> [!Note]
> Некоторые параметры для задач выпуска могли быть автоматически определены как [переменные среды](https://docs.microsoft.com/azure/devops/pipelines/release/variables?view=vsts#custom-variables) при создании конвейера выпуска на основе шаблона. Эти параметры невозможно изменить в параметрах задачи. Однако их можно изменить в родительских элементах среды.

## <a name="create-a-release"></a>Создание выпуска

Когда все изменения в конвейере выпуска уже внесены, можно начинать развертывание. Чтобы начать развертывание, создайте выпуск с помощью конвейера выпуска. Выпуск может создаваться автоматически, например, если в конвейере выпуска задан триггер непрерывного развертывания. Это означает, что изменение исходного кода запустит новую сборку и, таким образом, новый выпуск. Однако в этом разделе вы создадите новый выпуск вручную.

1. На вкладке **Конвейер** откройте раскрывающийся список **Выпуск** и выберите **Создать выпуск**.

    ![Создание выпуска](media/azure-stack-solution-hybrid-pipeline/200.png)

2. Введите описание выпуска, проверьте, выбраны ли правильные артефакты, а затем щелкните **Создать**. Через несколько секунд появится баннер, который покажет, что новый выпуск был создан, а также в качестве ссылки отобразится имя выпуска. Щелкните ссылку, чтобы просмотреть страницу сводных данных о выпуске.

    ![Баннер создания выпуска](media/azure-stack-solution-hybrid-pipeline/201.png)

3. Откроется страница со сводными данными о выпуске. На следующем снимке экрана для выпуска 2 в разделе **среды** для **состояния развертывания** для Azure отображается значение "Выполняется", а для Azure Stack — "Успешно". Когда состояние развертывания для среды Azure изменится на "Успешно", появится баннер, указывающий, что выпуск готов к утверждению. Если развертывание находится в состоянии ожидания или завершилось с ошибкой, отобразится синий значок информации **(i)**. Наведите на него курсор, чтобы увидеть всплывающий элемент со сведениями о причине задержки или сбоя.

    ![Страница со сводкой по выпуску](media/azure-stack-solution-hybrid-pipeline/202.png)

Другие представления, такие как список выпусков, также отображают значок, который указывает, что ожидается утверждение. Всплывающий элемент этого значка содержит имя среды и дополнительные сведения о развертывании. Администратор может легко увидеть общий ход выполнения выпусков, а также какие выпуски ожидают утверждения.

### <a name="monitor-and-track-deployments"></a>Мониторинг и отслеживание развертываний

В этом разделе показано, как можно выполнять мониторинг и отслеживать развертывания. Хорошим примером является выпуск для развертывания двух веб-сайтов Служб приложений Azure.

1. На странице сводных данных о выпуске 2 выберите ссылку **Журналы**. Во время развертывания на этой странице отображается динамический журнал агента. На панели слева отображается состояние каждой операции в развертывании для каждой среды.

    Выберите значок пользователя в столбце **Действие** для утверждения до развертывания (или после), чтобы просмотреть, кто одобрил (или отклонил) развертывание, и сообщение от пользователя.

2. После завершения развертывания в области справа отображается весь файл журнала. Выберите любой из **шагов** в левой области, чтобы отобразить файл журнала для отдельного шага, например "Инициализация задания". Возможность просмотра отдельных журналов упрощает трассировку и отладку частей общего развертывания. Кроме того, вы можете **сохранить** файлы журнала для этого шага или выбрать **Download all logs as zip** (Скачать все журналы как ZIP-файлы).

    ![Журналы выпуска](media/azure-stack-solution-hybrid-pipeline/203.png)

3. Откройте вкладку **Сводка**, чтобы увидеть общие сведения о выпуске. В этом представлении отображаются сведения о сборке, средах, в которые она была развернута, состояние развертывания и другая информация о выпуске.

4. Выберите ссылку среды (**Azure** или **Azure Stack**), чтобы получить дополнительные сведения об имеющихся развертываниях и развертываниях в состоянии ожидания для определенной среды. Эти представления можно использовать, чтобы быстро убедиться, что та же сборка была развернута в обеих средах.

5. Откройте **развернутое рабочее приложение** в своем браузере. Например, для веб-сайта Службы приложений Azure откройте следующий URL-адрес: `https://[your-app-name].azurewebsites.net`.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns).
