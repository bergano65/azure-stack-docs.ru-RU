---
title: Развертывание приложений в Azure и Azure Stack
description: Узнайте, как развертывать приложения в Azure и Azure Stack с помощью гибридного конвейера CI/CD.
services: azure-stack
documentationcenter: ''
author: bryanla
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.date: 07/23/2019
ms.topic: conceptual
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 11/07/2018
ms.openlocfilehash: 5357fcf548971e0962bec41ad9238bf88290531c
ms.sourcegitcommit: 35b13ea6dc0221a15cd0840be796f4af5370ddaf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2019
ms.locfileid: "68603104"
---
# <a name="deploy-apps-to-azure-and-azure-stack"></a>Развертывание приложений в Azure и Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Это решение демонстрирует, как развертывать приложения в Azure и Azure Stack с помощью гибридной непрерывной интеграции и непрерывной поставки (CI/CD) Azure Pipelines.

После настройки Azure Stack, Azure DevOps и веб-приложений в соответствии [с предварительными требованиями](#prerequisites) вы можете сделать следующее:

> [!div class="checklist"]
> - зарегистрировать веб-приложение и настроить доступ Azure Pipelines в Azure Active Directory (Azure AD); 
> - создать конечные точки Azure Pipelines для Azure AD и служб федерации Active Directory (AD FS); 
> - установить агент сборки Azure Pipelines на сервере сборки Azure Stack; 
> - настроить автономное развертывание приложения в Azure и Azure Stack;
> - создать конвейер сборки, запускающий автоматическую сборку после фиксации кода в проекте;
> - создать конвейер выпуска, который автоматически развертывает сборки в Azure AD и Azure Stack; 
> - вручную создавать и развертывать выпуски, а также просматривать сводки и журналы выпуска. 

Чтобы узнать больше о CI/CD, ознакомьтесь со следующими статьями:

* [Что такое непрерывная интеграция](https://www.visualstudio.com/learn/what-is-continuous-integration/)
* [Что такое непрерывная поставка](https://www.visualstudio.com/learn/what-is-continuous-delivery/)

## <a name="azure-stack-and-hybrid-cicd"></a>Azure Stack и гибридная CI/CD

Microsoft Azure Stack — это расширение Azure, которое обеспечивает гибкость и ускоряет внедрение инновационных облачных вычислительных решений в локальную среду. Это единственное гибридное облако, которое позволяет создавать и развертывать гибридные приложения как в локальной среде, так и в общедоступных облачных средах. Можно создать приложение в Azure Stack и развернуть его в Azure Stack, Azure или гибридное облако Azure. 

Непрерывность, безопасность и надежность развертывания приложений являются ключевыми факторами для организации и команды разработчиков. Модель поставки Azure Pipelines с гибридной непрерывной интеграцией и непрерывной поставкой (CI/CD) позволяет консолидировать конвейеры сборки в локальной среде и общедоступном облаке, а также изменять расположение развертываний без изменения приложения. Дополнительные преимущества гибридного подхода:

- Вы можете поддерживать согласованный набор средств разработки в локальной среде Azure Stack и общедоступном облаке Azure.  Общий набор средств упрощает реализацию шаблонов и методов непрерывной интеграции и непрерывной поставки.
- Приложения и службы, развертываемые в Azure или Azure Stack, взаимозаменяемы, и тот же код можно выполнять в любом расположении. Вы можете воспользоваться функциями и возможностями локальной среды и общедоступного облака.

> [!TIP]
> ![hybrid-pillars.png](./media/azure-stack-solution-pipeline/hybrid-pillars.png)  
> В статье [Конструктивные шаблоны гибридного облака для Azure Stack](azure-stack-edge-pattern-overview.md) рассматриваются основные аспекты качества программного обеспечения, касающиеся разработки, развертывания и эксплуатации гибридных приложений. К критериям качества относятся размещение, масштабируемость, доступность, устойчивость, управляемость и безопасность. Эти рекомендации помогут оптимизировать разработку гибридных приложений и предотвратить проблемы в рабочих средах.

## <a name="prerequisites"></a>Предварительные требования

- Знание основных сведений об Azure и Azure Stack. Чтобы узнать больше, перед развертыванием решения прочитайте следующие статьи:
  
  - [Введение в Azure](https://azure.microsoft.com/overview/what-is-azure/).
  - [Общие сведения о хранилище Azure Stack](../operator/azure-stack-overview.md)
  
- Подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начать работу.
  
- Веб-приложение, созданное в Azure. Используйте шаблон [Azure Resource Manager](https://azure.microsoft.com/resources/templates/) для создания веб-приложения, которое можно развернуть как локально, так и в общедоступном облаке. Запишите универсальный код ресурса (URI) приложения для последующего использования. 
  
- [Установленная](/visualstudio/install/install-visual-studio) среда Visual Studio 2019.
  
- Права администратора для организации [Azure DevOps](https://www.visualstudio.com/docs/setup-admin/team-services/connect-to-visual-studio-team-services), которая позволяет создавать конвейеры, а также [проект](/azure/devops/organizations/projects/create-project) или [рабочая область](/azure/devops/repos/tfvc/create-work-workspaces) DevOps. 
  
- Образ Windows Server 2016 с .NET 3.5 для частной виртуальной машины агента сборки, создаваемой Azure Pipelines в Azure Stack.
  
- Интегрированная система Azure Stack или Пакет средств разработки Azure Stack (ASDK), развернутые и настроенные в соответствии со следующими инструкциями. 
  
  
  Пакет средств разработки Azure Stack (ASDK) — это развертывание Azure Stack для одного узла, которое можно скачать и использовать бесплатно. ASDK позволяет оценивать Azure Stack и использовать интерфейсы API и инструментарий Azure в непроизводственной среде.
  
  Любой пользователь с учетными данными администратора Azure AD или служб федерации Active Directory (AD FS) может развернуть ASDK. Поставщик вычислительной техники или партнер-поставщик оборудования Azure может развернуть рабочую среду Azure Stack. Для выполнения следующих задач настройки Azure Stack необходимо иметь права оператора Azure Stack. 
  
  - развертывание Службы приложений Azure;
  - разработка планов и предложений.
  - создание подписки клиента;
  - применение образа Windows Server 2016.
  
  > [!Note]
  > Установка ASDK занимает приблизительно семь часов, поэтому планируйте ее соответствующим образом.
    
  Вот как можно развернуть и настроить ASDK.
  
  1. В разделе [Установка Пакета средств разработки Azure Stack (ASDK)](../asdk/asdk-install.md) приведены подробные инструкции по развертыванию.
     
  1. Автоматизируйте шаги после развертывания ASDK с помощью следующего скрипта PowerShell: [ConfigASDK.ps1](https://github.com/mattmcspirit/azurestack/blob/master/deployment/ConfigASDK.ps1).
     
  1. Разверните службы PaaS [Службы приложений Azure](../operator/azure-stack-app-service-deploy.md) в Azure Stack.
     
  1. Создайте [план или предложение](../operator/azure-stack-plan-offer-quota-overview.md) в Azure Stack.
     
  1. Создайте [подписку клиента](../operator/azure-stack-subscribe-plan-provision-vm.md) на предложение в Azure Stack. 
     
  1. Создайте веб-приложение в подписке клиента. Запишите новый URL-адрес веб-приложения для дальнейшего использования.
     
  1. Разверните виртуальную машину Windows Server 2016 с .NET 3.5 в подписке клиента, чтобы использовать ее в качестве сервера сборки, на котором выполняется Azure Pipelines.
  
  > [!Note]
  > Среде Azure Stack необходимы подходящие образы для запуска Windows Server и SQL. В ней также должна быть развернутая служба приложений.

## <a name="register-your-web-app-and-give-it-access-to-resources"></a>Регистрация веб-приложения и предоставление ему доступа к ресурсам 

В Azure Active Directory (Azure AD) предложение Azure Pipelines выполняет аутентификацию в Azure Resource Manager с помощью *субъекта-службы*. Для подготовки ресурсов для Azure Pipelines субъекту-службе должна быть назначена роль **Участник** в подписке Azure. 

Настроить аутентификацию для своего приложения можно на портале Azure. 

1. Зарегистрируйте свое приложение, чтобы создать субъект-службу.
1. Используйте *управление доступом на основе ролей (RBAC)* , чтобы назначить для имени участника-службы (SPN) роль **Участник**.
1. Скопируйте и сохраните значения идентификатора приложения и идентификатора клиента, необходимые для создания конечных точек для Azure Pipelines. 
1. Создайте и сохраните значение секретного ключа приложения.

Для создания субъекта-службы и конечных точек можно также [использовать сценарий PowerShell](https://github.com/Microsoft/vsts-rm-extensions/blob/master/TaskModules/powershell/Azure/SPNCreation.ps1#L5). Этот процесс описывается в статье [Create an Azure Resource Manager service connection with an existing service principal](/vsts/pipelines/library/connect-to-azure?view=vsts#create-an-azure-resource-manager-service-connection-with-an-existing-service-principal) (Создание подключения к службе Azure Resource Manager с помощью имеющегося субъекта-службы).

 > [!Note]  
 > Если для создания конечной точки Azure Resource Manager в Azure Stack используется сценарий PowerShell, нужно передать параметр **-azureStackManagementURL** и параметр **-environmentName**. Например:  
 > `-azureStackManagementURL https://management.local.azurestack.external -environmentName AzureStack`

### <a name="register-your-app-in-azure-ad"></a>Регистрация приложения в Azure AD 

1. Войдите на [портал Azure](https://portal.azure.com) и выберите **Azure Active Directory**, а затем в области навигации слева выберите **Регистрация приложений**.
   
1. Выберите **Новая регистрация**.
   
1. На странице **Регистрация приложения**
   1. Введите имя веб-приложения.
   1. Выберите поддерживаемый тип учетной записи. 
   1. В разделе **URI перенаправления** в качестве типа создаваемого приложения выберите **Веб** и введите универсальный код ресурса (URI) веб-приложения. 
   1. Выберите **Зарегистрировать**.
      
      ![Регистрация приложения](./media/azure-stack-solution-pipeline/create-app.png) 

### <a name="assign-the-app-to-a-role"></a>Назначьте роль для приложения

Чтобы обеспечить доступ к ресурсам в подписке, необходимо назначить приложению роль. С помощью управления доступом на основе ролей Azure можно управлять уровнем доступа, который нужен пользователям для выполнения своих обязанностей. Дополнительные сведения об управлении доступом на основе ролей см. в статье [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](/azure/role-based-access-control/role-assignments-portal?toc=%252fazure%252factive-directory%252ftoc.json). Дополнительные сведения о доступных ролях см. в статье [RBAC: для управления доступом на основе ролей в Azure](/azure/role-based-access-control/built-in-roles).

Для подготовки ресурсов в подписке Azure Stack предложению Azure Pipelines должна быть назначена роль **Участник**. 

Вы можете задать область роли на уровне подписки, группы ресурсов или ресурса. Разрешения наследуют более низкие уровни области действия. Например, добавление приложения в роль **Читатель** для группы ресурсов означает, что оно может обращаться к группе ресурсов и всем ее ресурсам.

Чтобы назначить приложению роль **Участник**, выполните следующие действия.

1. На портале Azure перейдите к требуемому уровню области. Например, чтобы назначить роль в области действия подписки, выберите **Все службы** и **Подписки**.
   
   ![Назначение роли на уровне подписки](./media/azure-stack-solution-pipeline/select-subscription.png)
   
1. Выберите подписку, для которой хотите назначить приложение.
   
1. В области навигации слева выберите **Управление доступом (IAM)** .
   
1. Выберите **Добавление назначения роли**.
   
1. В диалоговом окне **Добавить назначение ролей** выберите роль **Участник**. По умолчанию приложения Azure Active Directory не отображаются среди доступных вариантов. Чтобы найти приложение, выполните поиск по его имени и выберите его.
   
   ![Выберите роль и приложение.](./media/azure-stack-solution-pipeline/select-role.png)
   
1. Выберите **Сохранить**, чтобы завершить назначение роли. Вы увидите свое приложение в списке пользователей, назначенных выбранной роли для этой области действия.

Субъект-служба настроен. В следующем разделе показано, как получить значения, которые требуются Azure Pipelines, чтобы программно выполнить вход.

### <a name="get-values-for-signing-in"></a>Получение значений для входа

При создании конечных точек для Azure Pipelines нужно ввести идентификатор клиента и идентификатор приложения. Вот как можно получить эти значения.

1. На портале Azure выберите **Azure Active Directory**.
   
1. В области навигации слева выберите **Регистрация приложений**, а затем выберите свое приложение.
   
1. Скопируйте и сохраните **идентификатор каталога (клиента)** и **идентификатор приложения (клиента)** , которые будут использоваться для создания конечных точек.
   
   ![Копирование идентификаторов каталога (идентификатора клиента) и приложения (клиента)](./media/azure-stack-solution-pipeline/copy-app-id.png)

### <a name="create-a-new-application-secret"></a>Создание секрета приложения

При создании конечных точек для Azure Pipelines требуется настроить аутентификацию для приложения. Оно может [использовать сертификат](/azure/active-directory/develop/howto-create-service-principal-portal#certificates-and-secrets) или секрет приложения. Если вы развернули Azure Stack со службами федерации Active Directory (AD FS) в качестве поставщика удостоверений, то необходимо использовать сертификат.

Выполните действия, описанные в разделе [Сертификаты и секреты](/azure/active-directory/develop/howto-create-service-principal-portal#certificates-and-secrets), чтобы создать сертификат и передать его. 

Можно также создать секрет приложения.

1. На портале Azure выберите **Azure Active Directory**.
   
1. В области навигации слева выберите **Регистрация приложений**, а затем выберите свое приложение.
   
1. В области навигации слева щелкните **Сертификаты и секреты**.
   
1. В разделе **Секреты клиента** выберите **Новый секрет клиента**.
   
1. На странице **Добавить секрет клиента** введите описание, выберите срок действия и нажмите кнопку **Добавить**.
   
1. Скопируйте значение **VALUE** нового секрета. Его необходимо будет указать для входа в качестве приложения. Важно сохранить это значение сейчас, так как оно больше не будет отображаться после ухода с этой страницы.
   
   ![Скопируйте значение секрета, так как вы не сможете получить его позже.](./media/azure-stack-solution-pipeline/copy-secret.png)

## <a name="create-endpoints"></a>Создание конечных точек

Создавая конечные точки, Azure Pipelines получает возможность выполнять сборку, а затем развертывать приложения Azure AD в Azure Stack. Azure Pipelines подключается к агенту сборки, который подключается к Azure Stack.

После настройки разрешений для создания конечных точек можно создать конечные точки для Azure AD или AD FS. 

- Если вы развернули Azure Stack с Azure AD в качестве поставщика удостоверений, то можно использовать сертификат или секрет приложения, чтобы создать подключение к службе Azure Resource Manager для развертываний Azure. 
  
- Если вы использовали службы федерации Active Directory (AD FS) (AD FS) в качестве поставщика удостоверений для Azure Stack, то необходимо создать подключение к службе, используя для аутентификации сертификат, а не секрет клиента. 

### <a name="set-endpoint-creation-permissions"></a>Настройка разрешений для создание конечных точек

1. В организации Azure DevOps выберите проект Azure DevOps и щелкните **Параметры проекта**. 
   
1. Выберите **Безопасность** и в разделе **Группы Azure DevOps** выберите **Администраторы конечной точки**.
   
1. На вкладке **Члены** выберите **Добавить**.
   
1. На странице **Добавление пользователей и групп** выберите из списка имена пользователей, включая себя, а затем нажмите кнопку **Сохранить изменения**.
   
   ![Добавление элементов](./media/azure-stack-solution-pipeline/endpoint-permissions.png)
   
1. Из списка **Группы Azure DevOps** выберите **Создатели конечных точек** и повторите предыдущие шаги, чтобы добавить пользователей в группу **Создатели конечных точек**. 

### <a name="create-an-endpoint-for-azure-ad-or-ad-fs-deployments"></a>Создание конечной точки для развертываний Azure AD или AD FS

Следуйте инструкциям из раздела [Create an Azure Resource Manager service connection with an existing service principal](/azure/devops/pipelines/library/connect-to-azure#create-an-azure-resource-manager-service-connection-with-an-existing-service-principal) (Создание подключения к службе Azure Resource Manager с помощью имеющегося субъекта-службы), чтобы создать конечную точку подключения к службе.  

Заполните форму, указав следующие значения. 

- **Имя подключения**. Введите понятное имя, обозначающее это подключение к службе.
  
- **Среда**. Выберите имя среды, например **AzureCloud** или **AzureStack**. Если вы не видите пункт "AzureStack" в раскрывающемся списке, обратитесь к статье [Подключение к Azure Stack](/azure/devops/pipelines/library/connect-to-azure?view=azure-devops#connect-to-azure-stack).
  
- **URL-адрес среды**. Если вы не выбрали **AzureCloud**, введите URL-адрес среды, например *https:\//management.local.azurestack.external*.
  
- **Уровень области**. Выберите необходимый уровень области, например **Подписка**. 
  
- **Идентификатор подписки**: Введите идентификатор подписки.
  
- **Имя подписки**. Введите имя пользователя из Azure Stack.
  
- **Идентификатор клиента субъекта-службы**. Введите **идентификатор приложения (клиента)** , сохраненный ранее. 
  
- **Ключ субъекта-службы** или **Сертификат**. Выберите один из параметров. 
  
  > [!NOTE]
  > Чтобы создать конечную точку AD FS, необходимо использовать сертификат для аутентификации. 
  
  - В поле **Ключ субъекта-службы** введите значение секрета клиента, сохраненное ранее.
  - Если вы выбрали **Сертификат**, введите содержимое разделов сертификата и закрытого ключа из *PEM*-файла сертификата. 
    
    > [!NOTE]
    > Чтобы преобразовать *PFX*-файла сертификата в *PEM*-файл, выполните команду `openssl pkcs12 -in file.pfx -out file.pem -nodes -password pass:<password_here>`.
  
- **Идентификатор арендатора**: Введите **идентификатор каталога (клиента)** , сохраненный ранее.
  
- **Подключение: не проверено**. Выберите **Проверить подключение**, чтобы проверить параметры подключения к субъекту-службе.
  
  > [!NOTE]
  > Если конечная точка Azure Resource Manager недоступна через Интернет, проверка подключения завершится сбоем. Это ожидаемое поведение. Вы можете проверить подключение, создав конвейер выпуска с простой задачей.

## <a name="install-and-configure-the-build-agent"></a>Установка и настройка агента сборки 

Использование размещенного агента сборки в Azure Pipelines является удобной функцией для создания и развертывания веб-приложений. Azure автоматически выполняет обновление и обслуживание агента, что обеспечивает постоянный и непрерывный цикл разработки.

В Azure DevOps создайте личный маркер доступа (PAT), который будет использоваться для Azure Stack. Затем используйте этот личный маркер доступа для развертывания и настройки агента сборки на виртуальной машине сервера сборки Azure Stack. 
   
### <a name="create-a-personal-access-token"></a>Создание личного маркера доступа

1. Войдите в Azure DevOps и выберите **Мой профиль** в правом верхнем углу. 
   
1. На странице профиля разверните раскрывающийся список рядом с именем своей организации Azure Stack и выберите **Управление безопасностью**. 
   
   ![Управление безопасностью](media/azure-stack-solution-pipeline/managesecurity.png)
   
1. На странице **Личные маркеры доступа** выберите **Новый маркер**.
   
   ![Личные маркеры доступа](media/azure-stack-solution-pipeline/pats.png)
   
1. На странице **Создать личный маркер доступа** введите данные маркера и нажмите кнопку **Создать**. 
   
   ![Создание личного маркера доступа](media/azure-stack-solution-pipeline/createpat.png)
   
1. Скопируйте и сохраните маркер. После ухода с этой веб-страницы он больше не отобразится.
   
   ![Предупреждение о личном маркере доступа](media/azure-stack-solution-pipeline/patwarning.png)
   
### <a name="install-and-configure-the-agent-on-the-build-server"></a>Установка и настройка агента на сервере сборки

1. Подключитесь к виртуальной машине сервера сборки, развернутой на узле Azure Stack.
   
1. Скачайте образ агента сборки. 
   
1. В командной строке с правами администратора разверните агент как службу с помощью личного маркера доступа, а затем запустите его.
   
1. Перейдите в папку с извлеченным агентом сборки и выполните файл *config.cmd*. Файл *config.cmd* обновит папку агента сборки, добавив в нее дополнительные файлы.
   
   ![Установка и настройка агента сборки](media/azure-stack-solution-pipeline/buildagent.png)

Теперь, когда вы создали конечную точку и установили агент сборки Azure Pipelines на сервере сборки, подключение Azure Pipelines к Azure Stack готово к использованию. Агент сборки в Azure Stack получает инструкции от Azure Pipelines, а затем передает сведения о конечной точке для взаимодействия с Azure Stack.

Вместо управления каждым агентом по отдельности вы можете упорядочить *агенты в пулы*. Пул агентов определяет общую границу для всех агентов в этом пуле. Пулы агентов создаются на уровне организации Azure DevOps. Это означает, что пул агентов можно совместно использовать для нескольких проектов. Чтобы узнать больше о пулах агентов, ознакомьтесь с разделом [Agent pools](/azure/devops/pipelines/agents/pools-queues) (Пулы агентов).

## <a name="create-build-and-release-pipelines"></a>Создание конвейеров сборки и выпуска 

Azure Pipelines предоставляют конвейер с широкими возможностями настройки и управления для выпуска в различные среды, такие как среда разработки, промежуточная среда, среда для контроля качества и рабочая среда. В этом процессе выпуска могут требоваться утверждения на определенных этапах жизненного цикла приложения.

В этой части решения вы:

- клонируете проект Azure DevOps, подключитесь к нему и добавите в него код в Visual Studio;
- создадите автономное развертывание веб-приложения;
- настроите конвейеры сборки и выпуска CI/CD.

Гибридные процессы CI/CD применимы и к коду приложения, и к коду инфраструктуры. Вы можете использовать [гибридные шаблоны Azure Resource Manager](https://azure.microsoft.com/resources/templates/) для развертывания кода веб-приложения Azure в локальных средах и общедоступных облаках.

### <a name="clone-your-project"></a>Клонирование проекта

1. В **Team Explorer** Visual Studio щелкните значок **Подключение** и войдите в свою организацию Azure DevOps. 
   
1. Выберите **Управление подключениями** > **Подключиться к проекту**. 
   
   ![Подключение к проекту из Team Explorer](media/azure-stack-solution-pipeline/connecttoprojectteamexp.png)

1. В диалоговом окне **Подключение к проекту** выберите проект веб-приложения, задайте локальный путь, а затем выберите **Клонировать**, чтобы клонировать репозиторий локально.
   
   ![Клонирование репозитория в диалоговом окне "Подключение к проекту"](media/azure-stack-solution-pipeline/cloneproject.png)

### <a name="create-a-self-contained-web-app-deployment-for-app-services-in-both-clouds"></a>Создание автономного развертывания веб-приложения для служб приложений в обоих облаках

1. В **обозревателе решений** Visual Studio откройте файл *WebApplication.csproj* и добавьте в него `<RuntimeIdentifier>win10-x64</RuntimeIdentifier>`. Дополнительные сведения о этом шаге приведены в разделе [Автономные развертывания](/dotnet/core/deploying/#self-contained-deployments-scd).
   
   ![Настройка Runtimeidentifier](media/azure-stack-solution-pipeline/runtimeidentifier.png)
   
1. Сохраните результаты работы и используйте **Team Explorer**, чтобы проверить код в проекте.

### <a name="create-a-build-pipeline-and-run-a-build"></a>Создание конвейера сборки и выполнение сборки

1. В веб-браузере откройте организацию Azure DevOps и выберите проект.
   
1. В области навигации слева выберите **Конвейеры** > **Сборки**, затем выберите **Новый конвейер**. 
   
1. В разделе **Выбор шаблона** выберите шаблон **ASP.NET Core** и нажмите кнопку **Применить**. 
   
1. На странице настройки в области слева выберите **Опубликовать**.
   
1. В области справа в разделе **Аргументы** добавьте `-r win10-x64` в конфигурацию. 
   
   ![Добавление аргумента конвейера сборки](media/azure-stack-solution-pipeline/buildargument.png)
   
1. Щелкните **Сохранить и поместить в очередь** в верхней части страницы.
   
1. В диалоговом окне **Запустить конвейер** выберите **Сохранить и запустить**. 
   
Процесс [сборки автономного развертывания](https://docs.microsoft.com/dotnet/core/deploying/#self-contained-deployments-scd) публикует артефакты, которые могут выполняться в Azure и Azure Stack.

### <a name="create-a-release-pipeline"></a>Создание конвейера выпуска

Создание конвейера выпуска — это последний шаг в процессе настройки гибридного процесса CI/CD. Конвейер выпуска используется для создания выпуска и развертывания сборки.

1. В проекте Azure DevOps в левой области навигации выберите **Конвейеры** > **Выпуски**, а затем выберите **Новый конвейер**. 
   
1. На странице **Выбор шаблона** выберите **Развертывание Службы приложений Azure**, а затем нажмите кнопку **Применить**.
   
   ![Выбор шаблона выпуска](media/azure-stack-solution-pipeline/releasetemplate.png)
   
1. На вкладке **Конвейер** в области слева выберите **Добавить артефакт**. В области справа из раскрывающегося меню **Источник (конвейер сборки)** выберите только что созданную сборку веб-приложения и нажмите кнопку **Добавить**.
   
   ![Добавление артефакта сборки](media/azure-stack-solution-pipeline/addartifact.png)
   
1. На вкладке **Конвейер** в разделе **Этапы** выберите гиперссылку в области **Этап 1**, чтобы **просмотреть задачи этапа**.
   
   ![Просмотр задач этапа](media/azure-stack-solution-pipeline/viewstagetasks.png)
   
1. На вкладке **Задачи** в поле *Имя этапа* введите **Azure**. 
   
1. В разделе **Параметры** из раскрывающегося списка **Подписка Azure** выберите подписку и введите **имя службы приложений**.
   
   ![Выбор подписки и ввод имени службы приложений](media/azure-stack-solution-pipeline/stage1.png)
   
1. В области слева выберите **Запуск в агенте**. В области справа из раскрывающегося списка **Пул агентов** выберите агент **Hosted VS2017**, если он еще не выбран.
   
   ![Выбор размещенного агента](media/azure-stack-solution-pipeline/agentjob.png)
   
1. В области слева выберите **Развертывание службы приложений Azure**, а затем в области справа перейдите к **пакету или папке** для сборки веб-приложения Azure.
   
   ![Выбор пакета или папки](media/azure-stack-solution-pipeline/packageorfolder.png)
   
1. В диалоговом окне **Выберите файл или папку** нажмите кнопку **ОК**.
   
1. Нажмите кнопку **Сохранить** в правом верхнем углу на странице **Создать конвейер выпуска**.
   
   ![Сохранение изменений](media/azure-stack-solution-pipeline/save-devops-icon.png)
   
1. На вкладке **Конвейер** выберите **Добавить артефакт**. Выберите свой проект и выберите сборку Azure Stack из раскрывающегося меню **Источник (конвейер сборки)** . Выберите **Добавить**. 
   
1. На вкладке **Конвейер** в разделе **Этапы** выберите **Добавить**.
   
1. В новом этапе выберите гиперссылку, чтобы **просмотреть задачи этапа**. Введите Azure Stack в качестве *имени этапа*. 
   
   ![Просмотр нового этапа](media/azure-stack-solution-pipeline/newstage.png)
   
1. В разделе **Параметры** выберите конечную точку Azure Stack и введите имя веб-приложения Azure Stack в качестве **имени службы приложений**.
   
1. В разделе **Запуск в агенте** выберите агент сервера сборки Azure Stack из раскрывающегося списка **Пул агентов**.
   
1. Чтобы **развернуть службу приложений Azure**, выберите **Пакет или папка**, чтобы выбрать сборку Azure Stack. Нажмите кнопку **ОК** в диалоговом окне **Выбор файла или папки**.
   
1. На вкладке **Переменные** найдите переменную с именем **VSTS_ARM_REST_IGNORE_SSL_ERRORS**. Задайте для переменной значение **true**, а для области — **Azure Stack**.
   
   ![Настройка переменной](media/azure-stack-solution-pipeline/setvariable.png)
   
1. На вкладке **Конвейер** выберите значок **Триггер непрерывного развертывания** для каждого артефакта и установите для него значение **Включено**.  
   
   ![Установка триггера непрерывного развертывания](media/azure-stack-solution-pipeline/contindeploymentenabled.png)
   
1. Выберите значок **Условия перед развертыванием** для этапа Azure Stack и задайте для триггера значение **После выпуска**.
   
   ![Установка триггера условий перед развертыванием](media/azure-stack-solution-pipeline/predeployafterrelease.png)
   
1. Нажмите кнопку **Сохранить** в правом верхнем углу страницы **Создать конвейер выпуска**, чтобы сохранить конвейер выпуска.

> [!Note]
> Некоторые параметры для задач выпуска могли быть автоматически определены как [настраиваемые переменные](/azure/devops/pipelines/release/variables?view=vsts#custom-variables) при создании конвейера выпуска на основе шаблона. Эти параметры невозможно изменить в настройках задачи, но их можно изменить в элементах родительского этапа.

## <a name="release-the-app"></a>Выпуск приложения

Теперь, когда у вас есть конвейер выпуска, его можно использовать для создания выпуска и развертывания приложения. 

Так как в конвейере выпуска задан триггер непрерывного развертывания, изменение исходного кода автоматически инициирует новую сборку и создание нового выпуска. Однако сейчас вы создадите и запустите новый выпуск вручную.

Вот как можно создать и развернуть выпуск.

1. На странице "Создать конвейер выпуска" в верхнем правом углу выберите **Создать выпуск**. 
   
   ![Создание выпуска ](media/azure-stack-solution-pipeline/createreleaseicon.png)
   
1. На странице **Создание нового выпуска** сделайте следующее.
   1. В разделе **Конвейер** щелкните этап **Azure**, чтобы изменить его триггер с автоматического на ручной. 
   1. В разделе **Артефакты** убедитесь, что выбраны правильные артефакты.
   1. Введите **описание выпуска** и нажмите кнопку **Создать**. 
   
   Баннер указывает, что новый выпуск создан. Можно выбрать ссылку с именем выпуска, чтобы просмотреть страницу сводки по выпуску, на которой отображаются сведения о выпуске, например состояние развертывания.
   
1. Чтобы развернуть выпуск вручную, выберите этап **Azure**, щелкните **Развернуть**, а затем выберите **Развернуть** в диалоговом окне этапа. 
   
1. После успешного завершения развертывания откройте развернутое приложение в браузере. Например, для веб-сайта Службы приложений Azure откройте следующий URL-адрес: `https://<your-app-name>.azurewebsites.net`.

### <a name="monitor-and-track-releases"></a>Мониторинг и отслеживание выпусков

Можно выбрать гиперссылку состояния в этапе выпуска, чтобы получить дополнительные сведения о развертывании. 

![Страница со сводкой по выпуску](media/azure-stack-solution-pipeline/releasesummary.png)

Администратор может легко наблюдать за ходом выполнения выпусков, а также видеть, какие выпуски ожидают утверждения.

![Страница сводки по выпуску, отображающая ожидание утверждения](media/azure-stack-solution-pipeline/releasepending.png)

Можно просмотреть журналы выпусков из всех развертываний. 

1. В проекте Azure DevOps в левой области навигации выберите **Конвейеры** > **Выпуски**, а затем выберите выпуск. 
   
1. На странице сводки по выпуску наведите указатель мыши на этап или выберите его, затем щелкните **Журналы**. 
   
   В журнале выпуска в области слева отображается состояние каждой операции на каждом этапе. Во время развертывания в области справа отображается текущий журнал агента. После завершения развертывания в области справа отображается весь файл журнала. 
   
1. Выберите любой из шагов в области слева, чтобы просмотреть его файл журнала, например **Утверждения перед развертыванием**. 
   
1. Чтобы просмотреть утверждения, в области справа выберите **Просмотреть утверждение**. Это позволит узнать, кто утвердил или отклонил выпуск, а также другие сведения. 
   
Просмотр журналов для отдельных шагов упрощает трассировку и отладку частей общего развертывания. Можно также **скачать все журналы** в виде *ZIP*-файла.
   
![Журнал выпуска](media/azure-stack-solution-pipeline/releaselog.png)

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](/azure/architecture/patterns).
