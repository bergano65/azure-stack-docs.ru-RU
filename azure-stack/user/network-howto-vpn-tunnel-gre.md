---
title: Создание VPN-туннеля с помощью протокола GRE в Azure Stack | Документация Майкрософт
description: Узнайте как создавать VPN-туннель с помощью протокола GRE в Azure Stack.
services: azure-stack
author: mattbriggs
ms.service: azure-stack
ms.topic: how-to
ms.date: 09/19/2019
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 09/19/2019
ms.openlocfilehash: c9c599a7547b2000eb146a7e3b7783ba057d23b3
ms.sourcegitcommit: cc3534e09ad916bb693215d21ac13aed1d8a0dde
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73168303"
---
# <a name="how-to-create-a-vpn-tunnel-using-gre-in-azure-stack"></a>Создание VPN-туннеля с помощью протокола GRE в Azure Stack.

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

В этом решении шаблон Resource Manager Azure Stack можно использовать для подключения двух виртуальных сетей Azure Stack в одной среде Azure Stack. Вы [не можете подключить виртуальные сети Azure Stack](https://docs.microsoft.com/azure-stack/user/azure-stack-network-differences) с помощью встроенного шлюза виртуальной сети. Сейчас для создания VPN-туннеля между двумя виртуальными сетями Azure Stack следует использовать сетевые виртуальные устройства (NVA). Шаблон решения развертывает две виртуальные машины Windows Server 2016 с установленным RRAS. Решение настраивает два сервера RRAS для использования туннеля S2SVPN IKEv2 между двумя виртуальными сетями. Соответствующие правила NSG и UDR созданы для обеспечения маршрутизации между подсетями на каждой виртуальной сети, обозначенной как **внутренняя** 

Такой шаблон развертывания является основой, которая позволит создавать туннели VPN не только в экземпляре Azure Stack, но и между экземплярами Azure Stack и другими ресурсами, такими как локальные сети с использованием VPN туннелей S2S на Windows RRAS.

Вы можете найти шаблоны в разделе [Шаблоны интеллектуальных границ Azure](https://github.com/Azure-Samples/azure-intelligent-edge-patterns) репозитория GitHub. Шаблон находится в папке**rras-gre-vnet-vnet**. 

![замещающий текст](./media/azure-stack-network-howto-vpn-tunnel-gre/overview.png)

## <a name="requirements"></a>Требования

- Интегрированная система ASDK или Azure Stack с последними обновлениями. 
- Необходимые элементы Marketplace для Azure Stack:
    -  Windows Server 2016 Datacenter (рекомендуется последняя сборка).
    -  Расширение пользовательских сценариев

## <a name="things-to-consider"></a>Полезная информация

- Группа сетевой безопасности применяется к шаблону "Подсеть туннеля". Защитите внутреннюю подсеть в каждой виртуальной сети с помощью дополнительной NSG.
- Запрещающее правило RDP применяется к NSG туннеля. Его нужно установить, чтобы разрешить вам доступ к виртуальным машинам через публичный IP-адрес
- Это решение не учитывает разрешение DNS для учетных записей
- Комбинация имени виртуальной сети и vmName должна содержать не более 15 символов
- Этот шаблон предназначен для настройки имен виртуальных машин для VNet1 и VNet2
- Этот шаблон использует BYOL Windows
- При удалении группы ресурсов, включенной в данный момент (1907), вы должны вручную отсоединить NSG от подсети туннеля, чтобы убедиться, что группа ресурсов удалена полностью
- Этот шаблон использует виртуальную машину DS3v2. Служба RRAS устанавливает и запускает внутренний SQL Server Windows. Если размер виртуальной машины слишком мал, это может вызвать проблемы с памятью. Проверьте производительность до уменьшения размера виртуальной машины.
- Это не высокодоступное решение. Если вам требуется более высокоскоростное решение, вы можете добавить вторую виртуальную машину. В этом случае вам придется вручную изменить маршрут в таблице маршрутизации на внутреннем протоколе IP вторичного интерфейса. Вам также потребуется настроить несколько туннелей для перекрестного соединения.

## <a name="options"></a>Параметры

- С помощью параметров_artifactsLocation и _artifactsLocationSasToken вы можете использовать собственную учетную запись хранилища BLOB-объектов и маркер SAS.
- В этом шаблоне есть два вывода INTERNALSUBNETREFVNET1 и INTERNALSUBNETREFVNET2, которые являются идентификаторами ресурса для внутренних подсетей при использовании в шаблоне развертывания в виде конвейера.

Шаблон предоставляет значения по умолчанию для именования и IP-адресации виртуальной сети. Для этого потребуется пароль администратора (rrasadmin). Также есть возможность использования собственного хранилища BLOB-объектов с маркером SAS. Следите за тем, чтобы эти значения оставались в допустимых диапазонах, так как развертывание может завершиться ошибкой. Пакет powershell DSC выполняется на каждой виртуальной машине RRAS и устанавливает маршрутизацию и все необходимые службы и функции. При необходимости эту DSC можно настроить дополнительно. Расширение пользовательских сценариев выполняет следующий сценарий и "Add-Site2SiteGRE.ps1" настраивает туннель Site2SiteIKE между двумя серверами RRAS с общим ключом. Чтобы увидеть результаты настройки туннеля VPN, можно просмотреть подробный вывод из расширения пользовательских сценариев

![замещающий текст](./media/azure-stack-network-howto-vpn-tunnel-gre/s2svpntunnel.png)

## <a name="next-steps"></a>Дополнительная информация

[Сети Azure Stack: различия и рекомендации](azure-stack-network-differences.md)  
[Сведения о настройке нескольких VPN-туннелей типа "сеть — сеть"](network-howto-vpn-tunnel.md)