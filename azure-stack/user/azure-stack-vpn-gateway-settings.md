---
title: Настройка параметров VPN-шлюза для Azure Stack Hub
description: Узнайте о VPN-шлюзах, используемых для Azure Stack Hub, и настройке их параметров.
author: sethmanheim
ms.topic: conceptual
ms.date: 01/23/2020
ms.author: sethm
ms.lastreviewed: 12/27/2018
ms.openlocfilehash: 2f0b520b4c615e56fea7575422b306c226188eb0
ms.sourcegitcommit: 23861d659c89c2d36390085fe9532b2bcba2100d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "77075222"
---
# <a name="configure-vpn-gateway-settings-for-azure-stack-hub"></a>Настройка параметров VPN-шлюза для Azure Stack Hub

VPN-шлюз — это разновидность шлюза виртуальной сети, который передает зашифрованный трафик между виртуальной сетью в Azure Stack Hub и удаленным VPN-шлюзом. Удаленный VPN-шлюз может быть шлюзом Azure, устройством в центре обработки данных или устройством в другом расположении. Если есть возможность сетевого подключения между двумя конечными точками, вы можете установить между двумя сетями VPN-подключение "сеть — сеть".

Подключение VPN-шлюза зависит от конфигурации нескольких ресурсов, каждый из которых содержит настраиваемые параметры. В этой статье описываются ресурсы и параметры, относящиеся к VPN-шлюзу для виртуальной сети, созданной на основе модели развертывания с помощью Resource Manager. Описания и схемы топологий для каждого варианта подключения можно найти в статье [Создание VPN-шлюзов для Azure Stack Hub](azure-stack-vpn-gateway-about-vpn-gateways.md).

## <a name="vpn-gateway-settings"></a>Параметры VPN-шлюза

### <a name="gateway-types"></a>Типы шлюзов

Каждая виртуальная сеть Azure Stack Hub поддерживает один шлюз виртуальной сети, который должен относиться к типу **VPN**, в отличие от Azure, где поддерживаются дополнительные типы.

При создании шлюза виртуальной сети необходимо убедиться, что в конфигурации указан правильный тип шлюза. Для VPN-шлюза требуется отметить `-GatewayType Vpn`, например:

```powershell
New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg `
-Location 'West US' -IpConfigurations $gwipconfig -GatewayType Vpn `
-VpnType RouteBased
```

### <a name="gateway-skus"></a>Артикулы шлюзов

Во время создания шлюза виртуальной сети укажите номер SKU шлюза, который вы хотите использовать. Выберите номера SKU, которые соответствуют требованиям, в зависимости от типов рабочих нагрузок, пропускной способности, функций и соглашений об уровне обслуживания.

Azure Stack Hub предлагает номера SKU VPN-шлюзов, показанные в следующей таблице.

| | Пропускная способность VPN-шлюза |Максимальное число туннелей IPsec для VPN-шлюза |
|-------|-------|-------|
|**SKU "Базовый"**  | 100 Мбит/с  | 20    |
|**SKU "Стандартный"**   | 100 Мбит/с  | 20 |
|**SKU "Высокопроизводительный"** | 200 Мбит/с | 10 |

### <a name="resizing-gateway-skus"></a>Изменение размеров SKU шлюза

Azure Stack Hub не поддерживает изменение размеров SKU между поддерживаемыми прежними версиями SKU.

Аналогичным образом Azure Stack Hub не поддерживает изменение размера SKU с поддерживаемых устаревших уровней (**Базовый**, **Стандартный** и **HighPerformance**) на новые уровни, которые поддерживаются в Azure (**VpnGw1**, **VpnGw2** и **VpnGw3**).

### <a name="configure-the-gateway-sku"></a>Настройка номера SKU шлюза

#### <a name="azure-stack-hub-portal"></a>Портал Azure Stack Hub

Если для создания шлюза виртуальной сети Resource Manager используется портал Azure Stack Hub, выбрать SKU шлюза можно в раскрывающемся списке. Параметры соответствуют выбранным типу шлюза и типу VPN.

#### <a name="powershell"></a>PowerShell

В следующем примере PowerShell используется параметр `-GatewaySku` со значением **Standard**:

```powershell
New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg `
-Location 'West US' -IpConfigurations $gwipconfig -GatewaySku Standard `
-GatewayType Vpn -VpnType RouteBased
```

### <a name="connection-types"></a>Типы подключений

В модели развертывания с помощью Resource Manager каждой конфигурации необходим определенный тип подключения шлюза виртуальной сети. При развертывании Resource Manager для `-ConnectionType` в PowerShell можно указать значения **IPsec**.

В следующем примере PowerShell создается подключение "сеть — сеть", для которого требуется тип IPsec.

```powershell
New-AzureRmVirtualNetworkGatewayConnection -Name localtovon -ResourceGroupName testrg `
-Location 'West US' -VirtualNetworkGateway1 $gateway1 -LocalNetworkGateway2 $local `
-ConnectionType IPsec -RoutingWeight 10 -SharedKey 'abc123'
```

### <a name="vpn-types"></a>Типы VPN

При создании шлюза виртуальной сети для конфигурации VPN-шлюза необходимо указать тип VPN. Выбор типа VPN зависит от топологии подключений, которую вы хотите создать. Тип VPN может также зависеть от используемого оборудования. Для конфигураций "сеть — сеть" требуется VPN-устройство. Некоторые VPN-устройства поддерживают только определенный тип VPN.

> [!IMPORTANT]  
> Сейчас Azure Stack Hub поддерживает только VPN на основе маршрутов. Если устройство поддерживает только VPN на основе политики, подключения к этим устройствам из Azure Stack Hub не поддерживаются.  
>
> Кроме того, сейчас в Azure Stack Hub не используются селекторы трафика на основе политик для шлюзов на основе маршрутов, так как не поддерживаются пользовательские конфигурации политики IPSec/IKE.

* **PolicyBased**. Сети VPN на основе политик шифруют и направляют пакеты через туннели IPsec на основе политик IPsec, настроенных с помощью комбинаций префиксов адресов, между локальной сетью и виртуальной сетью Azure Stack Hub. Политика (или селектор трафика) обычно представляет собой список доступа в конфигурации VPN-устройства.

  >[!NOTE]
  >**PolicyBased** поддерживается в Azure, но не в Azure Stack Hub.

* **RouteBased**. Сети VPN на основе маршрутов используют маршруты, которые настроены в таблице IP-пересылки (маршрутизации) для направления пакетов в соответствующие интерфейсы туннелей. Затем интерфейсы туннелей шифруют пакеты в туннели или расшифровывают их из туннелей. Политика (или селектор трафика) для VPN типа **RouteBased** настроена по схеме "любой к любому" (или использует подстановочные знаки). По умолчанию их нельзя изменить. Значение для VPN типа **RouteBased** — **RouteBased**.

В следующем примере PowerShell используется `-VpnType` со значением **RouteBased**. При создании шлюза необходимо убедиться, что в конфигурации указано правильное значение `-VpnType`.

```powershell
New-AzureRmVirtualNetworkGateway -Name vnetgw1 -ResourceGroupName testrg `
-Location 'West US' -IpConfigurations $gwipconfig `
-GatewayType Vpn -VpnType RouteBased
```

### <a name="gateway-requirements"></a>Требования к шлюзу

В таблице ниже перечислены требования к VPN-шлюзам.

| |VPN-шлюз с маршрутизацией на основе политик (цен. категория "Базовый") | VPN-шлюз с маршрутизацией на основе маршрутов (цен. категория "Базовый") | VPN-шлюз с маршрутизацией на основе маршрутов (цен. категория "Стандартный") | VPN-шлюз с маршрутизацией на основе маршрутов (цен. категория "HighPerformance")|
|--|--|--|--|--|
| **Подключение "сеть — сеть" (S2S)** | Не поддерживается | Конфигурация VPN на основе маршрутов | Конфигурация VPN на основе маршрутов | Конфигурация VPN на основе маршрутов |
| **метод проверки подлинности**  | Не поддерживается | Общий ключ для подключения "сеть —сеть"  | Общий ключ для подключения "сеть —сеть"  | Общий ключ для подключения "сеть —сеть"  |
| **максимальное число подключений «сеть —сеть»**  | Не поддерживается | 20 | 20| 10|
|**активная поддержка маршрутизации (BGP)** | Не поддерживается | Не поддерживается | Поддерживается | Поддерживается |

### <a name="gateway-subnet"></a>Подсеть шлюза

Прежде чем создать VPN-шлюз, необходимо создать подсеть для него. Подсеть шлюза имеет IP-адреса, которые используют виртуальные машины и службы шлюза виртуальной сети. При создании шлюза виртуальной сети его виртуальные машины развертываются в подсети шлюза и на них настраиваются необходимые параметры VPN-шлюза. Не развертывайте в подсети шлюза что-либо еще (например, дополнительные виртуальные машины).

>[!IMPORTANT]
>Чтобы подсети шлюзов работали правильно, каждую подсеть нужно назвать **GatewaySubnet** . Azure Stack Hub использует это имя, чтобы определить подсеть для развертывания виртуальных машин и служб шлюза виртуальной сети.

При создании подсети шлюза указывается количество IP-адресов, которое содержит подсеть. IP-адреса в подсети шлюза выделяются виртуальным машинам и службам шлюза. Некоторым конфигурациям требуется больше IP-адресов, чем прочим. Просмотрите инструкции к конфигурации, которую требуется создать, и убедитесь, что создаваемая подсеть шлюза соответствует указанным требованиям.

Кроме того, следует убедиться, что подсеть шлюза содержит достаточно IP-адресов для обработки дополнительных конфигураций в будущем. Хотя можно создать подсеть шлюза всего лишь с размером /29, мы советуем создавать подсети с размером /28 или больше (/28, /27, /26 и т. д.). Таким образом, если в будущем вы добавите какие-либо функции, вам не придется разделять шлюз и удалять, а затем повторно создавать подсеть шлюза, чтобы получить больше IP-адресов.

В примере PowerShell для Resource Manager ниже показана подсеть шлюза **GatewaySubnet**. Здесь приведена нотация CIDR, указывающая размер /27, при котором можно использовать достаточно IP-адресов для большинства существующих конфигураций.

```powershell
Add-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix 10.0.3.0/27
```

> [!IMPORTANT]
> При работе с подсетями шлюза не связывайте группу безопасности сети (NSG) с подсетью шлюза. Связывание группы безопасности сети (NSG) с этой подсетью приведет к тому, что VPN-шлюз перестанет правильно функционировать. Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](/azure/virtual-network/virtual-networks-nsg).

### <a name="local-network-gateways"></a>Локальные сетевые шлюзы

При создании конфигурации VPN-шлюза в Azure шлюз локальной сети нередко представляет ваше локальное расположение. В Azure Stack Hub шлюз представляет любое удаленное VPN-устройство, находящееся за пределами Azure Stack Hub. Это может быть VPN-устройство в вашем или удаленном центре обработки данных либо VPN-шлюз в Azure.

Для локального сетевого шлюза следует задать имя и общедоступный IP-адрес VPN-устройства, а также указать префиксы адресов, которые относятся к локальному расположению. Azure проверяет наличие сетевого трафика по префиксам адресов назначения, учитывает конфигурацию, указанную для шлюза локальной сети, и соответствующим образом направляет пакеты.

Этот пример PowerShell создает шлюз локальной сети:

```powershell
New-AzureRmLocalNetworkGateway -Name LocalSite -ResourceGroupName testrg `
-Location 'West US' -GatewayIpAddress '23.99.221.164' -AddressPrefix '10.5.51.0/24'
```

Иногда возникает необходимость изменить параметры шлюза локальной сети, например, при добавлении или изменении диапазона адресов либо при изменении IP-адреса VPN-устройства. Дополнительные сведения см. в разделе [Изменение параметров шлюза локальной сети с помощью PowerShell](/azure/vpn-gateway/vpn-gateway-modify-local-network-gateway).

## <a name="ipsecike-parameters"></a>Параметры IPsec/IKE

При настройке VPN-подключения в Azure Stack Hub оно должно быть настроено на обеих сторонах. Возможно, при настройке VPN-подключения между Azure Stack Hub и устройством, например коммутатором или маршрутизатором, выполняющем функции VPN-шлюза, вам потребуется настроить дополнительные параметры для устройства.

В отличие от Azure, где поддерживается несколько предложений (как инициатора, так и отвечающего устройства), Azure Stack Hub по умолчанию поддерживает только одно предложение. Если вам нужно использовать разные параметры IPSec/IKE для работы с VPN-устройством, доступны дополнительные параметры для настройки подключения вручную. См. сведения о [настройке политики IPsec/IKE для VPN-подключений типа "сеть — сеть" или "виртуальная сеть — виртуальная сеть"](azure-stack-vpn-s2s.md).

### <a name="ike-phase-1-main-mode-parameters"></a>Параметры этапа 1 IKE (главный режим)

| Свойство              | Значение|
|-|-|
| Версия IKE           | IKEv2 |
|Группа Диффи-Хелмана*   | ECP384 |
| Метод проверки подлинности | Общий ключ |
|Алгоритмы шифрования и хэширования* | AES256, SHA384 |
|Срок действия SA (время)     | 28 800 сек|

### <a name="ike-phase-2-quick-mode-parameters"></a>Параметры этапа 2 IKE (быстрый режим)

| Свойство| Значение|
|-|-|
|Версия IKE |IKEv2 |
|Алгоритмы шифрования и хэширования (шифрование)     | GCMAES256|
|Алгоритмы шифрования и хэширования (аутентификация) | GCMAES256|
|Срок действия SA (время)  | 27 000 секунд  |
|Срок действия SA (килобайты) | 33 553 408     |
|Полная безопасность пересылки (PFS)* | ECP384 |
|Обнаружение неиспользуемых одноранговых узлов | Поддерживается| 

>[!NOTE]
>Значения по умолчанию для группы Диффи-Хелмана, алгоритма хеширования и полной безопасности пересылки были изменены для сборки 1910 и более поздних версий. Если в Azure Stack Hub используется версия сборки ниже 1910, укажите приведенные ниже значения для описанных выше параметров.

>| Свойство| Значение|
>|-|-|
>|Группа Диффи — Хелмана   | DHGroup2 |
>|Алгоритмы хеширования | SHA256 |
>|Полная безопасность пересылки (PFS) | None |

\* Новый или измененный параметр.

## <a name="next-steps"></a>Дальнейшие действия

* [Подключение Azure Stack к Azure с помощью Azure ExpressRoute](../operator/azure-stack-connect-expressroute.md)
