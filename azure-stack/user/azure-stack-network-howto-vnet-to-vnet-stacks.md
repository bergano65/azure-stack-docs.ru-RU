---
title: Установка подключения между виртуальными сетями в Azure Stack Hub с помощью NVA Fortinet FortiGate | Документация Майкрософт
description: Узнайте, как выполнить подключение между виртуальными сетями в Azure Stack Hub с помощью NVA Fortinet FortiGate
services: azure-stack
author: mattbriggs
ms.service: azure-stack
ms.topic: how-to
ms.date: 1/22/2020
ms.author: mabrigg
ms.reviewer: sijuman
ms.lastreviewed: 10/03/2019
ms.openlocfilehash: 51fd6ffa23cff44967c31e5d66716bd5634861e0
ms.sourcegitcommit: a1abc27a31f04b703666de02ab39ffdc79a632f6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2020
ms.locfileid: "76536102"
---
# <a name="establish-a-vnet-to-vnet-connection-in-azure-stack-hub-with-fortinet-fortigate-nva"></a>Установка подключения между виртуальными сетями в Azure Stack Hub с помощью NVA Fortinet FortiGate

В этой статье показано, как подключить виртуальную сеть в одном экземпляре Azure Stack Hub к виртуальной сети в другом экземпляре Azure Stack Hub с помощью виртуального сетевого модуля (NVA) Fortinet FortiGate.

В этой статье рассматривается текущее ограничение Azure Stack Hub, позволяющее клиентам настраивать только одно VPN-подключение между двумя средами. Пользователи узнают, как настроить на виртуальной машине Linux пользовательский шлюз, который позволит использовать несколько VPN-подключений между разными средами Azure Stack Hub. Процедура, описанная в этой статье, развертывает две виртуальные сети с NVA FortiGate в каждой: по одному развертыванию для каждой среды Azure Stack Hub. В ней также подробно описаны изменения, необходимые для настройки VPN-подключения IPSec между двумя виртуальными сетями. Действия, описанные в этой статье, следует повторить для каждой виртуальной сети в каждом экземпляре Azure Stack Hub. 

## <a name="prerequisites"></a>Предварительные требования

-  Доступ к интегрированным системам Azure Stack Hub с доступной емкостью для развертывания обязательных ресурсов вычисления, сети и других ресурсов, необходимых для этого решения. 

    > [!Note]  
    > Эти инструкции **не** будут работать с пакетом средств разработки Azure Stack (ASDK) из-за сетевых ограничений в ASDK. Дополнительные сведения см. в статье [Требования и рекомендации для ASDK](https://docs.microsoft.com/azure-stack/asdk/asdk-deploy-considerations).

-  Решение виртуального сетевого модуля (NVA), которое скачано и опубликовано в Azure Stack Hub Marketplace. Виртуальный сетевой модуль используется для управления передачей сетевого трафика из сети периметра к другим сетям и подсетям. В этой процедуре используется [решение с одной виртуальной машиной с брандмауэром следующего поколения Fortinet FortiGate](https://azuremarketplace.microsoft.com/marketplace/apps/fortinet.fortinet-FortiGate-singlevm).

-  Чтобы активировать NVA FortiGate, потребуется по крайней мере один доступный файл лицензии FortiGate. Сведения о том, как получить эти лицензии, см. в [библиотеке документации Fortinet](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/19071/registering-and-downloading-your-license).

    В этой процедуре используется развертывание [одной виртуальной машины FortiGate-VM](ttps://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/632940/single-FortiGate-vm-deployment). Вы узнаете, как подключить NVA FortiGate к виртуальной сети Azure Stack Hub в вашей локальной сети.

    Дополнительные сведения о развертывании решения FortiGate в режиме "активный — пассивный" (высокий уровень доступность) см. в документации [по высокому уровню доступности FortiGate-VM в Azure](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/983245/ha-for-FortiGate-vm-on-azure).

## <a name="deployment-parameters"></a>Параметры развертывания

В следующей таблице для справки перечислены параметры, которые используются в этих развертываниях.

### <a name="deployment-one-forti1"></a>Развертывание 1: Forti1

| Имя экземпляра FortiGate | Forti1 |
|-----------------------------------|---------------------------|
| Лицензия BYOL, версия | 6.0.3 |
| Имя пользователя с правами администратора FortiGate | fortiadmin |
| Имя группы ресурсов | forti1-rg1 |
| Имя виртуальной сети | forti1vnet1 |
| Адресное пространство виртуальной сети | 172.16.0.0/16* |
| Имя подсети общедоступной виртуальной сети | forti1-PublicFacingSubnet |
| Префикс адреса общедоступной виртуальной сети | 172.16.0.0/24* |
| Имя подсети виртуальной сети | forti1-InsideSubnet |
| Префикс подсети виртуальной сети | 172.16.1.0/24* |
| Размер виртуальной машины NVA FortiGate | Standard F2s_v2 |
| Имя общедоступного IP-адреса | forti1-publicip1 |
| Тип общедоступного IP-адреса | Статические |

### <a name="deployment-two-forti2"></a>Развертывание 2: Forti2

| Имя экземпляра FortiGate | Forti2 |
|-----------------------------------|---------------------------|
| Лицензия BYOL, версия | 6.0.3 |
| Имя пользователя с правами администратора FortiGate | fortiadmin |
| Имя группы ресурсов | forti2-rg1 |
| Имя виртуальной сети | forti2vnet1 |
| Адресное пространство виртуальной сети | 172.17.0.0/16* |
| Имя подсети общедоступной виртуальной сети | forti2-PublicFacingSubnet |
| Префикс адреса общедоступной виртуальной сети | 172.17.0.0/24* |
| Имя подсети виртуальной сети | Forti2-InsideSubnet |
| Префикс подсети виртуальной сети | 172.17.1.0/24* |
| Размер виртуальной машины NVA FortiGate | Standard F2s_v2 |
| Имя общедоступного IP-адреса | Forti2-publicip1 |
| Тип общедоступного IP-адреса | Статические |

> [!Note]
> \* Выберите другой набор адресных пространств и префиксов подсети, если указанные выше значения перекрываются в локальной сетевой среде, включая пул виртуальных IP-адресов Azure Stack Hub. Убедитесь также, что диапазоны адресов не перекрывают друг друга**.

## <a name="deploy-the-fortigate-ngfw-marketplace-items"></a>Развертывание элементов Marketplace FortiGate NGFW

Повторите эти действия для обеих сред Azure Stack Hub. 

1. Откройте портал пользователя Azure Stack Hub. Обязательно используйте учетные данные, имеющие по крайней мере права участника для подписки.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image5.png)

1. Щелкните **Создать ресурс** и выполните поиск по запросу `FortiGate`.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image6.png)

2. Щелкните **FortiGate NGFW** и нажмите кнопку **Создать**.

3. Заполните поля на вкладке **Основные сведения**, используя параметры из таблицы [Параметры развертывания](#deployment-parameters).

    Форма должна содержать указанные ниже сведения.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image7.png)

4. Щелкните **ОК**.

5. Укажите виртуальную сеть, подсети и сведения о размере виртуальной машины, используя таблицу [Параметры развертывания](#deployment-parameters).

    Если вы хотите указать другие имена и диапазоны, не используйте параметры, которые конфликтуют с другими ресурсами виртуальной сети и FortiGate в другой среде Azure Stack Hub. Будьте особенно внимательны при настройке диапазона IP-адресов виртуальной сети и диапазонов подсетей в виртуальной сети. Убедитесь, что они не перекрывают диапазоны IP-адресов для другой создаваемой виртуальной сети.

6. Щелкните **ОК**.

7. Настройте общедоступный IP-адрес для NVA FortiGate:

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image8.png)

8. Нажмите кнопку **ОК**, а затем еще раз нажмите кнопку **ОК**.

9. Нажмите кнопку **создания**.

Развертывание займет около 10 минут. Теперь можно повторить шаги, чтобы создать другое развертывание NVA FortiGate и виртуальной сети в другой среде Azure Stack Hub.

## <a name="configure-routes-udrs-for-each-vnet"></a>Настройка маршрутов (определяемых пользователем маршрутов) для каждой виртуальной сети

Выполните следующие действия для обоих развертываний: forti1-rg1 и forti2-rg1.

1. Перейдите в группу ресурсов forti1-rg1 на портале Azure Stack Hub.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image9.png)

2. Выберите ресурс forti1-forti1-InsideSubnet-routes-xxxx.

3. В разделе **Параметры** выберите **Маршруты**.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image10.png)

4. Удалите маршрут **to-Internet**.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image11.png)

5. Выберите **Да**.

6. Выберите **Добавить**.

7. Присвойте **маршруту** имя `to-forti1` или `to-forti2`. Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

8. Введите:
    - forti1: `172.17.0.0/16`  
    - forti2: `172.16.0.0/16`  

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

9. Выберите **Виртуальный модуль** в поле **Тип следующего прыжка**.
    - forti1: `172.16.1.4`  
    - forti2: `172.17.0.4`  

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

    ![](./media/azure-stack-network-howto-vnet-to-vnet-stacks/image12.png)

10. Щелкните **Сохранить**.

Повторите шаги для каждого маршрута **во внутренней подсети** для каждой группы ресурсов.

## <a name="activate-the-fortigate-nvas-and-configure-an-ipsec-vpn-connection-on-each-nva"></a>Активация NVA FortiGate и настройка VPN-подключения IPSec для каждого NVA

 Чтобы активировать каждый NVA FortiGate, потребуется действительный файл лицензии из Fortinet. Модули NVA **не** будут работать до тех пор, пока они все не будут активированы. Дополнительные сведения о том, как получить файл лицензии и шаги по активации NVA, см. в [библиотеке документации по Fortinet](https://docs2.fortinet.com/vm/azure/FortiGate/6.2/azure-cookbook/6.2.0/19071/registering-and-downloading-your-license).

Необходимо приобрести два файла лицензий — по одному для каждого NVA.

## <a name="create-an-ipsec-vpn-between-the-two-nvas"></a>Создание VPN-подключения IPSec между двумя NVA

После активации NVA выполните следующие действия, чтобы создать VPN-подключение IPSec между двумя NVA.

Выполните следующие действия для виртуальных сетевых модулей forti1 NVA и forti2:

1.  Получите назначенный общедоступный IP-адрес, перейдя на страницу обзора виртуальной машины fortiX:

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image13.png)

2.  Скопируйте назначенный IP-адрес, откройте браузер и вставьте адрес в адресную строку. В браузере может появиться предупреждение о том, что сертификат безопасности не является доверенным. Не обращайте внимание.

4.  Введите имя пользователя с правами администратора и пароль FortiGate, указанные во время развертывания.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image14.png)

5.  Щелкните **System** (Система) > **Firmware** (Встроенное ПО).

6.  Установите флажок напротив последней версии встроенного ПО, например `FortiOS v6.2.0 build0866`.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image15.png)

7.  Нажмите кнопку **Backup config and upgrade** (Резервное копирование конфигурации и обновление) и кнопку Continue (Продолжить) при появлении соответствующего запроса.

8.  В NVA встроенное ПО обновляется до последней сборки, а модуль перезагружается. Процесс займет около пяти минут. Снова войдите в веб-консоль FortiGate.

10.  Щелкните **VPN** > **IPSec Wizard** (Мастер настройки IPSec).

11. Введите имя VPN, например `conn1`, в **мастере создания VPN**.

12. Щелкните **This site is behind NAT** (Сайт скрыт за NAT).

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image16.png)

13. Выберите **Далее**.

14. Введите удаленный IP-адрес локального VPN-устройства, к которому будет выполнено подключение.

15. Выберите **port1** в качестве **исходящего интерфейса**.

16. Выберите **Pre-shared Key** (Общий ключ) и введите (и сохраните) общий ключ. 

    > [!Note]  
    > Этот ключ потребуется для настройки подключения на локальном VPN-устройстве, то есть ключи должны *полностью* совпадать.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image17.png)

17. Выберите **Далее**.

18. Выберите **port2** в качестве **локального интерфейса**

19. Введите диапазон локальной подсети:
    - forti1: 172.16.0.0/16
    - forti2: 172.17.0.0/16

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

20. Введите соответствующие удаленные подсети, представляющие локальную сеть, к которой вы будете подключаться через локальное VPN-устройство.
    - forti1: 172.16.0.0/16
    - forti2: 172.17.0.0/16

    Укажите собственный диапазон IP-адресов, если вы используете другой диапазон.

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image18.png)

21. Нажмите кнопку **Создать**

22. Выберите **Network** (Сеть) > **Interfaces** (Интерфейсы).

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image19.png)

23. Дважды щелкните **port2**.

24. Выберите **LAN** в списке **Role** (Роль) и **DHCP** в качестве режима адресации.

25. Щелкните **ОК**.

Повторите эти действия на другом NVA.


## <a name="bring-up-all-phase-2-selectors"></a>Вызов всех селекторов второго этапа 

После завершения приведенной выше процедуры для **обоих** NVA:

1.  В веб-консоли forti2 FortiGate щелкните **Monitor** > **IPsec Monitor** (Монитор >Монитор IPSEC). 

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image20.png)

2.  Выделите `conn1` и выберите **Bring Up** > **All Phase 2 Selectors** (Открыть > Все селекторы этапа 2).

    ![](./media/azure-stack-network-howto-vnet-to-vnet/image21.png)


## <a name="test-and-validate-connectivity"></a>Проверка подключения

Теперь можно выполнять маршрутизацию между виртуальными сетями через NVA FortiGate. Чтобы проверить подключение, создайте виртуальную машину Azure Stack Hub внутри подсети каждой виртуальной сети. Виртуальную машину Azure Stack Hub можно создать с помощью портала, интерфейса командной строки или PowerShell. При создании виртуальных машин:

-   Виртуальная машина Azure Stack Hub размещается во **внутренней подсети** каждой виртуальной сети.

-   **Не** применяйте все группы безопасности сети (NSG) к виртуальной машине при создании (удалите NSG, которая добавляется по умолчанию при создании виртуальной машины на портале).

-   Убедитесь, что правила брандмауэра виртуальной машины разрешают взаимодействие, которое будет использоваться для проверки подключения. В целях тестирования рекомендуется полностью отключить брандмауэр в операционной системе, если это возможно.

## <a name="next-steps"></a>Дальнейшие действия

[Сети Azure Stack Hub: различия и рекомендации](azure-stack-network-differences.md)  
[Предложение сетевого решения для Azure Stack Hub с помощью Fortinet FortiGate](../operator/azure-stack-network-solutions-enable.md)  