---
title: Перенаправление трафика с помощью географически распределенного приложения, созданного с использованием Azure и Azure Stack Hub
description: Из этой статьи вы узнаете, как создать с помощью Azure и Azure Stack Hub географически распределенное приложение, которое перенаправляет трафик в определенные конечные точки.
author: BryanLa
ms.topic: article
ms.date: 11/05/2019
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 11/05/2019
ms.openlocfilehash: cc17789485bc4c1d0676d54751f4d5bc820c3a5e
ms.sourcegitcommit: 1fa0140481a483e5c27f602386fe1fae77ad29f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78366285"
---
# <a name="create-a-geo-distributed-app-solution-to-direct-traffic-with-azure-and-azure-stack-hub"></a>Создание географически распределенного приложения для перенаправления трафика с использованием Azure и Azure Stack Hub

Узнайте, как в шаблоне географически распределенного приложения направлять трафик к определенным конечным точкам на основе различных метрик. Создав профиль диспетчера трафика с маршрутизацией по географическим данным и конфигурацией конечных точек, можно направлять данные к определенным конечным точкам с учетом региональных требований, корпоративных и международных стандартов и ваших потребностей по обработке данных.

В этом решении показано, как создать среду, после чего вы выполните в ней следующие действия:

> [!div class="checklist"]
> - создание географически распределенного приложения;
> - использование диспетчера трафика для приложения.

## <a name="use-the-geo-distributed-apps-pattern"></a>Использование шаблона географически распределенных приложений

Шаблон географически распределенного приложения позволяет использовать приложение в нескольких регионах. Вы можете по умолчанию использовать общедоступное облако, но некоторым пользователям может потребоваться хранить данные в домашнем регионе. Также можно направлять пользователей в подходящее облако на основании их требований.

### <a name="issues-and-considerations"></a>Проблемы и рекомендации

#### <a name="scalability-considerations"></a>Вопросы масштабируемости

Создаваемое с помощью этой статьи решение не включает в себя механизмы масштабирования. Но его можно сочетать с другими локальными или облачными и решениями Azure, чтобы удовлетворить требования к масштабируемости. Сведения о создании гибридного решения для автоматического масштабирования в нескольких облаках в Azure с помощью диспетчера трафика см. в статье [Развертывание приложения, которое выполняет масштабирование в нескольких облаках с помощью Azure и Azure Stack Hub](solution-deployment-guide-cross-cloud-scaling.md).

#### <a name="availability-considerations"></a>Вопросы доступности

Как и в отношении масштабируемости, это решение не ориентировано непосредственно на обеспечение доступности. Но локальные решения и решения Azure можно реализовать, чтобы обеспечить высокий уровень доступности всех используемых компонентов.

### <a name="when-to-use-this-pattern"></a>Когда следует использовать этот шаблон

- У вашей организации есть международные филиалы, для которых применяются региональные политики безопасности и распространения.

- Каждый из офисов организации собирает данные о сотрудниках, бизнесе и предприятии. Для этого нужно создавать отчеты с соблюдением местных требований (в том числе к срокам подачи).

- Высокий уровень масштабируемости можно обеспечить за счет горизонтального масштабирования, при котором несколько приложений развертываются в одном или нескольких регионах.

### <a name="planning-the-topology"></a>Планирование топологии

Прежде чем создавать распределенную топологию, следует собрать следующие сведения:

-   **Личный домен приложения.** Какое имя личного домена клиенты будут использовать для доступа к приложению? В нашем примере используется имя личного домена *www\.scalableasedemo.com*.

-   **Домен диспетчера трафика.** При создании [профиля диспетчера трафика Azure](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-manage-profiles) нужно выбрать доменное имя. При регистрации записи домена, используемой диспетчером трафика, к этому имени будет добавлен суффикс *trafficmanager.net*. В нашем примере приложения используется имя *scalable-ase-demo*, поэтому полное имя домена, управляемое диспетчером трафика, имеет вид *scalable-ase-demo.trafficmanager.net*.

-   **Стратегия масштабирования приложения.** Определите, будет ли нагрузка распределяться между несколькими Средами службы приложений в одном регионе, в нескольких регионах или же и там, и там. Решение должно учитывать предполагаемые источники клиентского трафика и возможности масштабируемости серверной инфраструктуры приложения. Например, приложение, работающее без отслеживания состояния, можно масштабировать, развернув конфигурацию из нескольких Сред службы приложений в одном регионе, а также в нескольких регионах Azure. Сейчас доступно более 15 глобальных регионов Azure. Поэтому клиенты могут создавать по-настоящему глобальные гипермасштабируемые приложения. Для нашего примера приложения создано три Среды службы приложений в одном регионе Azure ("Центрально-южная часть США").

-   **Соглашение об именовании для Сред службы приложений.** Имя каждой Среды службы приложений должно быть уникальным. Если используется больше двух сред Службы приложений, для их идентификации желательно использовать определенное соглашение об именовании. В нашем примере используется простое соглашение об именовании. Среды службы приложений называются *fe1ase*, *fe2ase* и *fe3ase*.

-   **Соглашение об именовании приложений.** Так как предполагается развертывание нескольких экземпляров приложения, каждому из них необходимо присвоить уникальное имя. В разных Средах службы приложений можно использовать одни и те же имена. Так как у каждой среды Службы приложений есть уникальный доменный суффикс, разработчики могут использовать одно и то же имя приложения во всех средах. Например, разработчик может назвать приложения так: *myapp.foo1.p.azurewebsites.net*, *myapp.foo2.p.azurewebsites.net*, *myapp.foo3.p.azurewebsites.net* и т. д. В нашем примере каждый экземпляр приложения имеет уникальное имя. *webfrontend1*, *webfrontend2* и *webfrontend3*.

> [!Tip]  
> ![hybrid-pillars.png](./media/solution-deployment-guide-cross-cloud-scaling/hybrid-pillars.png)  
> Microsoft Azure Stack Hub — это расширение Azure. Azure Stack Hub обеспечивает гибкость и высокую скорость внедрения инноваций облачных вычислений в локальной среде. Это решение позволяет использовать единственное гибридное облако, с помощью которого можно создавать и развертывать гибридные приложения в любой точке мира.  
> 
> В статье [Hybrid cloud design patterns for Azure Stack](overview-app-design-considerations.md) (Рекомендации по проектированию гибридных приложений) описаны основные аспекты качественного программного обеспечения (размещение, масштабируемость, доступность, устойчивость, управляемость и безопасность), которые следует учитывать при разработке, развертывании и использовании гибридных приложений. Эти рекомендации помогут оптимизировать разработку гибридных приложений и предотвратить появление проблем с рабочими средами.

## <a name="part-1-create-a-geo-distributed-app"></a>Часть 1. Создание географически распределенного приложения

В этом раздел описано, как создать веб-приложение.

> [!div class="checklist"]
> - Создайте и опубликуйте веб-приложение.
> - Добавьте код в Azure Repos.
> - Настройте сборку приложения на несколько целевых объектов в облаке.
> - Организуйте и настройте процесс непрерывного развертывания.

### <a name="prerequisites"></a>Предварительные требования

Требуются подписка Azure и установка Azure Stack Hub.

### <a name="geo-distributed-app-steps"></a>Шаги по созданию географически распределенного приложения

### <a name="obtain-a-custom-domain-and-configure-dns"></a>Получение личного домена и настройка DNS

Обновите файл зоны DNS для домена. Azure AD сможет проверить принадлежность имени личного домена. Вы можете использовать [Azure DNS](https://docs.microsoft.com/azure/dns/dns-getstarted-portal) для записей Azure, Office 365 и внешних записей DNS в Azure или добавить запись DNS [в другой регистратор DNS](https://support.office.com/article/Create-DNS-records-for-Office-365-when-you-manage-your-DNS-records-b0f3fdca-8a80-4e8e-9ef3-61e8a2a9ab23/).

1. Зарегистрируйте личный домен у уполномоченного регистратора.

2. Войдите в соответствующий регистратор доменных имен. Для обновления DNS могут потребоваться права администратора.

3. Обновите файл зоны DNS для соответствующего домена, добавив предоставленную службой Azure AD DNS-запись. Эта DNS-запись не влияет на поведение работающих систем, например на маршрутизацию почты или веб-хостинг.

### <a name="create-web-apps-and-publish"></a>Создание и публикация веб-приложения

Настройте гибридный конвейер непрерывной интеграции и непрерывного развертывания (CI/CD), чтобы развернуть веб-приложение в Azure и Azure Stack Hub и включить автоматическую отправку изменений в оба облака.

> [!Note]  
> Вам необходим Azure Stack Hub с подходящими образами, объединенными для запуска (Windows Server и SQL), и развернутой Службой приложений. Дополнительные сведения см. в статье [Предварительные условия для развертывания Службы приложений в Azure Stack](../operator/azure-stack-app-service-before-you-get-started.md).

#### <a name="add-code-to-azure-repos"></a>Добавление кода в Azure Repos

1. Войдите в Visual Studio, используя **учетную запись, которая обладает правами на создание проекта** в Azure Repos.

    Процессы CI/CD применимы и к коду приложения, и к коду инфраструктуры. Используйте [шаблоны Azure Resource Manager](https://azure.microsoft.com/resources/templates/) для частной и облачной разработки.

    ![Подключение к проекту в Visual Studio](media/solution-deployment-guide-geo-distributed/image1.JPG)

2. **Клонируйте репозиторий** путем создания и открытия веб-приложения по умолчанию.

    ![Клонирование репозитория в Visual Studio](media/solution-deployment-guide-geo-distributed/image2.png)

### <a name="create-web-app-deployment-in-both-clouds"></a>Создание развертывания веб-приложений в обоих облаках

1.  Измените файл **WebApplication.csproj**. Выберите `Runtimeidentifier` и добавьте `win10-x64`. (См. документацию по [автономному развертыванию](https://docs.microsoft.com/dotnet/core/deploying/deploy-with-vs#simpleSelf)).

    ![Изменение файла проекта веб-приложения в Visual Studio](media/solution-deployment-guide-geo-distributed/image3.png)

1.  **Добавьте код в Azure Repos** с помощью Team Explorer.

2.  Подтвердите, что **код приложения** был добавлен в Azure Repos.

### <a name="create-the-build-definition"></a>Создание определения сборки

1. **Войдите в Azure Pipelines**, чтобы подтвердить возможность создания определений сборки.

2. Добавьте код `-r win10-x64`. Это необходимо, чтобы активировать автономное развертывание с использованием .NET Core.

    ![Добавление кода в определение сборки](media/solution-deployment-guide-geo-distributed/image4.png)

3. **Запустите сборку**. Процесс [сборки автономного развертывания](https://docs.microsoft.com/dotnet/core/deploying/deploy-with-vs#simpleSelf) будет публиковать артефакты, которые могут выполняться в Azure и Azure Stack Hub.

**Использование агента, размещенного в Azure**

Использование размещенного агента в Azure Pipelines удобно для создания и развертывания веб-приложений. Обновление и обслуживание, включая постоянную, непрерывную разработку, тестирование и развертывание, автоматически выполняет Microsoft Azure.

### <a name="manage-and-configure-the-cd-process"></a>Настройка процесса непрерывного развертывания и управление им

Azure DevOps Services предоставляет конвейер с широкими возможностями настройки и управления для выпусков в различные среды, такие как среда развертывания, промежуточная среда, среда для контроля качества и рабочая среда, включая получение утверждений на определенных стадиях.

## <a name="create-release-definition"></a>Создание определения выпуска

1.  Нажмите кнопку со знаком **плюса**, чтобы добавить новый выпуск на вкладке **Выпуски** в разделе **Сборка и выпуск** VSO.

    ![Создание определения выпуска](media/solution-deployment-guide-geo-distributed/image5.png)

2. Примените шаблон развертывания службы приложений Azure.

   ![Применение шаблона развертывания для Службы приложений Azure](meDia/solution-deployment-guide-geo-distributed/image6.png)

3. В разделе **Добавление артефакта** добавьте артефакт для приложения сборки облака Azure.

   ![Добавление артефакта в сборку облака Azure](media/solution-deployment-guide-geo-distributed/image7.png)

4. На вкладке "Конвейер" щелкните ссылку **Фаза, задача** для используемой среды и задайте значения облачной среды Azure.

   ![Настройка значений среды облака Azure](media/solution-deployment-guide-geo-distributed/image8.png)

5. Задайте **имя среды** и выберите **подписку Azure** для конечной точки облака Azure.

      ![Выбор подписки Azure для конечной точки облака Azure](media/solution-deployment-guide-geo-distributed/image9.png)

6. В разделе **Имя Службы приложений** укажите требуемое имя.

      ![Выбор имени Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image10.png)

7. Введите "Размещенная среда VS2017" в разделе **Очередь агента** для среды, размещенной в облаке Azure.

      ![Настройка очереди агента для среды, размещенной в облаке Azure](media/solution-deployment-guide-geo-distributed/image11.png)

8. В меню развертывания службы приложений Azure выберите допустимый для среды **пакет или папку**. Нажмите кнопку **ОК**, чтобы выбрать **расположение папки**.
  
      ![Выбор пакета или папки для среды Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image12.png)

      ![Выбор пакета или папки для среды Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image13.png)

9. Сохраните все изменения и вернитесь к **конвейеру выпуска**.

    ![Сохранение изменений в конвейере выпуска](media/solution-deployment-guide-geo-distributed/image14.png)

10. Добавьте новый артефакт, выбрав сборку для приложения Azure Stack Hub.
    
    ![Добавление нового артефакта для приложения Azure Stack Hub](media/solution-deployment-guide-geo-distributed/image15.png)


11. Добавьте еще одну среду, применив развертывание Службы приложений Azure.
    
    ![Добавление среды в развертывание Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image16.png)

12. Назовите новую среду Azure Stack Hub.
    
    ![Присвоение имени среде в развертывании Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image17.png)

13. Найдите среду Azure Stack Hub на вкладке **Задача**.
    
    ![Среда Azure Stack Hub](media/solution-deployment-guide-geo-distributed/image18.png)

14. Выберите подписку для конечной точки Azure Stack Hub.
    
    ![Выбор подписки для конечной точки Azure Stack Hub](media/solution-deployment-guide-geo-distributed/image19.png)

15. Задайте имя веб-приложения Azure Stack Hub в качестве имени службы приложений.

    ![Присвоение имени веб-приложению Azure Stack Hub](media/solution-deployment-guide-geo-distributed/image20.png)

16. Выберите агент Azure Stack Hub.
    
    ![Выбор агента Azure Stack Hub](media/solution-deployment-guide-geo-distributed/image21.png)

17. В разделе "Развертывание Службы приложений Azure" выберите допустимый **пакет или папку** для среды. Нажмите кнопку **ОК**, чтобы выбрать расположение папки.

    ![Выбор папки для развертывания Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image22.png)

    ![Выбор папки для развертывания Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image23.png)

18. На вкладке "Переменная" добавьте переменную `VSTS\_ARM\_REST\_IGNORE\_SSL\_ERRORS`, задайте для нее значение **true** и область Azure Stack Hub.
    
    ![Добавление переменной в развертывание Службы приложений Azure](media/solution-deployment-guide-geo-distributed/image24.png)

19. Выберите значок триггера **непрерывного** развертывания в обоих артефактах и включите триггер **непрерывного** развертывания.
    
    ![Выбор триггера непрерывного развертывания](media/solution-deployment-guide-geo-distributed/image25.png)

20. Выберите значок условий **перед развертыванием** в среде Azure Stack Hub и задайте триггеру значение **После выпуска**.
    
    ![Выбор условий, выполняемых перед развертыванием](media/solution-deployment-guide-geo-distributed/image26.png)

21. Сохраните все изменения.

> [!Note]  
> Некоторые параметры для задач могли быть автоматически определены как [переменные среды](https://docs.microsoft.com/azure/devops/pipelines/release/variables?view=vsts&tabs=batch#custom-variables) при создании определения выпуска на основе шаблона. Эти параметры нельзя изменить в параметрах задачи. Для этого нужно выбрать родительский элемент среды.

## <a name="part-2-update-web-app-options"></a>Часть 2. Методы обновления веб-приложения

[Служба приложений Azure](https://docs.microsoft.com/azure/app-service/overview) — это служба веб-размещения с самостоятельной установкой исправлений и высоким уровнем масштабируемости. 

![Служба приложений Azure](media/solution-deployment-guide-geo-distributed/image27.png)

> [!div class="checklist"]
> - Сопоставьте существующее настраиваемое DNS-имя с веб-приложениями Azure.
> - Для этого используйте **запись CNAME** или **запись A**.

### <a name="map-an-existing-custom-dns-name-to-azure-web-apps"></a>Сопоставление существующего настраиваемого DNS-имени с веб-приложениями Azure

> [!Note]  
>  Используйте CNAME для всех настраиваемых DNS-имен, кроме корневого домена (например, northwind.com).

Сведения о том, как перенести активный веб-сайт и его DNS-имя домена в службу приложений, см. в статье [Перенос активного DNS-имени в службу приложений Azure](https://docs.microsoft.com/azure/app-service/manage-custom-dns-migrate-domain).

### <a name="prerequisites"></a>Предварительные требования

Для работы с этим решением:

-   [Создайте приложение службы приложений](https://docs.microsoft.com/azure/app-service/) или используйте приложение, созданное для работы с другим решением.

-   Приобретите доменное имя и предоставьте поставщику домена доступ к реестру DNS.

Обновите файл зоны DNS для домена. Azure AD проверит принадлежность имени личного домена. Вы можете использовать [Azure DNS](https://docs.microsoft.com/azure/dns/dns-getstarted-portal) для записей Azure, Office 365 и внешних записей DNS в Azure или добавить запись DNS [в другой регистратор DNS](https://support.office.com/article/Create-DNS-records-for-Office-365-when-you-manage-your-DNS-records-b0f3fdca-8a80-4e8e-9ef3-61e8a2a9ab23/).

-   Зарегистрируйте личный домен у уполномоченного регистратора.

-   Войдите в соответствующий регистратор доменных имен. (Для обновления DNS могут потребоваться права администратора.)

-   Обновите файл зоны DNS для соответствующего домена, добавив предоставленную службой Azure AD DNS-запись.

Например, чтобы добавить записи DNS для northwindcloud.com и www\.northwindcloud.com, настройте параметры DNS для корневого домена northwindcloud.com.

> [!Note]  
>  Доменное имя можно приобрести через [портал Azure](https://docs.microsoft.com/azure/app-service/manage-custom-dns-buy-domain). Чтобы сопоставить настраиваемое DNS-имя с веб-приложением, его уровень [плана службы приложений](https://azure.microsoft.com/pricing/details/app-service/) должен быть платным (**Общий**, **Базовый**, **Стандартный** или **Премиум**).



### <a name="create-and-map-cname-and-a-records"></a>Создание и сопоставление записей CNAME и A

#### <a name="access-dns-records-with-domain-provider"></a>Доступ к записям DNS с помощью поставщика домена

> [!Note]  
>  С помощью Azure DNS настройте пользовательское DNS-имя для веб-приложений Azure. Дополнительные сведения см. в статье [Использование Azure DNS для указания параметров личного домена для службы Azure](https://docs.microsoft.com/azure/dns/dns-custom-domain).

1.  Войдите на веб-сайт основного поставщика домена.

2.  Найдите страницу управления записями DNS. Каждый поставщик доменов имеет собственный интерфейс для записей DNS. Найдите области сайта, обозначенные как **Имя домена**, **DNS** или **Name Server Management** (Управление сервером доменных имен).

Страницу управления записями DNS можно открыть из раздела **Мои домены**. Воспользуйтесь ссылкой **Файл зоны**, **Записи DNS** или **Расширенная конфигурация**.

На снимке экрана ниже показан пример страницы с записями DNS:

![Пример страницы с записями DNS](media/solution-deployment-guide-geo-distributed/image28.png)

1. На странице регистратора доменных имен выберите команду **"Добавить" или "Создать"** , чтобы создать запись. Некоторые поставщики имеют разные ссылки для добавления записей различных типов. Обратитесь к документации поставщика.

2. Добавьте запись CNAME, чтобы сопоставить поддомен с именем узла по умолчанию для приложения.

   Например, для домена www\.northwindcloud.com добавьте запись CNAME, которая сопоставляет имя с <app\_name>.azurewebsites.net.

После добавления этой записи CNAME страница управления записями DNS выглядит так:

![Переход к приложению Azure на портале](media/solution-deployment-guide-geo-distributed/image29.png)

### <a name="enable-the-cname-record-mapping-in-azure"></a>Включение сопоставления записи CNAME в приложении Azure

1. В новой вкладке войдите на портал Azure.

2. Перейдите к веб-службам.

3. Выберите веб-приложение.

4. В левой области навигации страницы приложения на портале Azure выберите **Личные домены**.

5. Щелкните значок **+** рядом с параметром **Добавить имя узла**.

6. Введите полное доменное имя, например `www.northwindcloud.com`.

7. Выберите **Проверить**.

8. Если это указано отдельно, добавьте в DNS-записи регистратора доменных имен дополнительные записи других типов (обычно `A` или `TXT`). Azure предоставит значения и типы для этих записей:

   а.  Запись **A** для сопоставления с IP-адресом приложения.

   b.  Запись типа **TXT** для сопоставления с именем узла по умолчанию для приложения: hostname <app_name>.azurewebsites.net. Служба приложений использует эту запись только во время настройки для проверки того, что вы являетесь владельцем личного домена. После проверки удалите запись типа TXT.

9. Выполните эту задачу на вкладке регистратора домена и повторите проверку, чтобы активировать кнопку **Добавить имя узла**.

10. Убедитесь, что для **типа записи имени узла** выбрано значение **CNAME** (www.example.com или любой поддомен).

11. Выберите **Добавить имя узла**.

12. Введите полное доменное имя, например `northwindcloud.com`.

13. Выберите **Проверить**. Теперь активируется **кнопка добавления**.

14. Убедитесь, что для **типа записи имени узла** выбрано значение **Запись А** (example.com).

15. **Добавление имени узла**.

    Возможно, потребуется некоторое время, чтобы новое имя узла отобразилось на странице **Личные домены** вашего приложения. Попробуйте обновить браузер, чтобы обновить данные.
  
    ![Личные домены](media/solution-deployment-guide-geo-distributed/image31.png) 
  
    В случае ошибки проверки в нижней части страницы появится соответствующее уведомление. ![Ошибка проверки](media/solution-deployment-guide-geo-distributed/image32.png)

> [!Note]  
>  Описанные выше действия можно повторить для сопоставления доменного имени с подстановочным знаком (\*.northwindcloud.com). Это позволяет добавлять любые поддомены к этой службе приложений, не создавая для каждого из них отдельную запись CNAME. Следуйте инструкциям регистратора по настройке этого параметра.

#### <a name="test-in-a-browser"></a>Проверка в браузере

Откройте в браузере DNS-имена, которые вы настроили ранее (например, `northwindcloud.com` или www.northwindcloud.com).

## <a name="part-3-bind-a-custom-ssl-cert"></a>Часть 3. Привязка настраиваемого SSL-сертификата

В этой части будут рассматриваться такие темы:

> [!div class="checklist"]
> - привязывание пользовательского SSL-сертификата к Службе приложений;
> - принудительное использование HTTPS для приложения;
> - автоматизация привязки SSL-сертификата с помощью скриптов.

> [!Note]  
> Если потребуется, получите SSL-сертификат для клиента на портале Azure и привяжите его к веб-приложению. Подробные сведения см. в статье о [сертификатах службы приложений](https://docs.microsoft.com/azure/app-service/web-sites-purchase-ssl-web-site).

### <a name="prerequisites"></a>Предварительные требования

Для работы с этим решением:

-   [Создайте приложение Службы приложений](https://docs.microsoft.com/azure/app-service/).
-   [Сопоставьте настраиваемое DNS-имя с веб-приложением](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-domain).
-   Получите SSL-сертификат из доверенного центра сертификации и подпишите запрос этим ключом.

### <a name="requirements-for-your-ssl-certificate"></a>Требования к SSL-сертификату

Чтобы сертификат можно было использовать в службе приложений, он:

-   должен быть подписан доверенным центром сертификации;

-   должен быть экспортирован в PFX-файл, защищенный паролем;

-   должен содержать закрытый ключ длиной не менее 2048 бит;

-   должен содержать все промежуточные сертификаты из цепочки сертификатов.

> [!Note]  
>  **Сертификаты с шифрованием на основе эллиптических кривых (ECC)** совместимы со Службой приложений, но не рассматриваются в этой статье. Обратитесь в центр сертификации за помощью в создании сертификата ECC. 

#### <a name="prepare-the-web-app"></a>Подготовка веб-приложения

Чтобы привязать SSL-сертификат к веб-приложению, ваш [план службы приложений](https://azure.microsoft.com/pricing/details/app-service/) должен относиться к категории **Базовый**, **Стандартный** или **Премиум**.

#### <a name="sign-in-to-azure"></a>Вход в Azure

1.  Войдите на [портал Azure](https://portal.azure.com/) и перейдите к своему веб-приложению.

2.  В меню слева выберите **Службы приложений** и щелкните имя нужного приложения Azure.

![Выбор веб-приложения](media/solution-deployment-guide-geo-distributed/image33.png)

#### <a name="check-the-pricing-tier"></a>Проверка ценовой категории

1.  В области навигации слева на странице веб-приложения перейдите к разделу **Параметры** и выберите **Увеличить масштаб (план службы приложений)** .

    ![Меню увеличения масштаба](media/solution-deployment-guide-geo-distributed/image34.png)

1.  Убедитесь, что веб-приложение не относится к ценовой категории **Бесплатный** или **Общий**. Текущая категория веб-приложения выделена синей рамкой.

    ![Проверка ценовой категории](media/solution-deployment-guide-geo-distributed/image35.png)

Настраиваемые SSL-сертификаты не поддерживаются в ценовых категориях **Бесплатный** и **Общий**. Чтобы повысить уровень, выполните инструкции, приведенные в следующем разделе или на странице **Выбор ценовой категории**, а затем перейдите к разделу [Отправка и привязка SSL-сертификата](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-ssl).

#### <a name="scale-up-your-app-service-plan"></a>Изменение уровня плана службы приложений

1.  Выберите одну из категорий: **Базовый**, **Стандартный** или **Премиум**.

2.  Щелкните **Выбрать**.

![Выбор ценовой категории](media/solution-deployment-guide-geo-distributed/image36.png)

Операция будет считаться завершенной, когда появится уведомление.

![Уведомление об увеличении масштаба](media/solution-deployment-guide-geo-distributed/image37.png)

#### <a name="bind-your-ssl-certificate-and-merge-intermediate-certificates"></a>Привязка сертификата SSL и объединение промежуточных сертификатов

Объедините нескольких сертификатов в цепочку.

1. **Откройте каждый полученный сертификат** в текстовом редакторе.

2. Создайте файл для объединенных сертификатов и присвойте ему имя *mergedcertificate.crt*. В текстовом редакторе скопируйте содержимое каждого сертификата в этот файл. Порядок сертификатов должен соответствовать порядку в цепочке сертификатов, начиная вашим сертификатом и заканчивая корневым сертификатом. Это должно выглядеть следующим образом:

    ```Text

    -----BEGIN CERTIFICATE-----

    <your entire Base64 encoded SSL certificate>

    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----

    <The entire Base64 encoded intermediate certificate 1>

    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----

    <The entire Base64 encoded intermediate certificate 2>

    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----

    <The entire Base64 encoded root certificate>

    -----END CERTIFICATE-----
    ```

#### <a name="export-certificate-to-pfx"></a>Экспорт сертификата в PFX-файл

Экспортируйте объединенный SSL-сертификат с закрытым ключом, созданным с помощью сертификата.

Файл закрытого ключа создается с помощью OpenSSL. Чтобы экспортировать сертификат в PFX-файл, выполните следующую команду, заменив заполнители *\<private-key-file>* и *\<merged-certificate-file>* путями закрытого ключа и файлом с объединенным сертификатом соответственно:

```powershell
openssl pkcs12 -export -out myserver.pfx -inkey <private-key-file> -in <merged-certificate-file>
```

Когда появится приглашение, определите пароль для последующей передачи SSL-сертификата в Службу приложений.

Если вы создали запрос на сертификат с помощью IIS или **Certreq.exe**, установите сертификат на локальный компьютер и [экспортируйте его в PFX-файл](https://technet.microsoft.com/library/cc754329(v=ws.11).aspx).

#### <a name="upload-the-ssl-certificate"></a>Отправка SSL-сертификата

1. На панели навигации слева выберите **Параметры SSL**.

2. Выберите **Отправить сертификат**.

3. В разделе **PFX-файл сертификата** выберите PFX-файл.

4. В поле **Пароль сертификата** введите пароль, созданный при экспорте PFX-файла.

5. Щелкните **Отправить**.

![Передача сертификата](media/solution-deployment-guide-geo-distributed/image38.png)

Когда Служба приложений завершит передачу сертификата, он появится на странице **Параметры SSL**.

![Параметры SSL](media/solution-deployment-guide-geo-distributed/image39.png)

#### <a name="bind-your-ssl-certificate"></a>Привязка SSL-сертификата

1.  В разделе **SSL-привязки** выберите **Добавить привязку**.

    > [!Note]  
    >  Если сертификат отправлен, но не появился в списке доменных имен в раскрывающемся списке **Имя узла**, попробуйте обновить страницу браузера.

1.  На странице **добавления привязки SSL** в раскрывающихся списках выберите доменное имя для защиты и используемый сертификат.

1.  В разделе **Тип SSL** можно выбрать SSL на основе [**указания имени сервера (SNI)** ](https://en.wikipedia.org/wiki/Server_Name_Indication) или IP-адреса.

    - **SSL на основе SNI**: вы можете добавить несколько привязок SSL на основе SNI. Этот параметр позволяет использовать несколько SSL-сертификатов для защиты нескольких доменов с одним IP-адресом. Большинство современных браузеров (включая Internet Explorer, Chrome, Firefox и Opera) поддерживает SNI (более подробную информацию о поддержки браузеров можно найти в статье [Server Name Indication](https://wikipedia.org/wiki/Server_Name_Indication) (Указание имени сервера)).

    - **SSL на основе IP-адреса**: вы можете добавить только одну привязку SSL на основе IP-адреса. Этот параметр позволяет использовать только один SSL-сертификат для защиты выделенного общедоступного IP-адреса. Чтобы защитить несколько доменов, используйте один и тот же SSL-сертификат. Это стандартный вариант привязки SSL.

1. Щелкните **Добавить привязку**.

    ![Добавление привязки SSL](media/solution-deployment-guide-geo-distributed/image40.png)

Когда служба приложений завершит передачу сертификата, он появится в разделах **SSL-привязки**.

![Привязки SSL](media/solution-deployment-guide-geo-distributed/image41.png)

#### <a name="remap-the-a-record-for-ip-ssl"></a>Переназначение записи A для SSL на основе IP-адреса

Если вы не используете в веб-приложении SSL на основе IP-адреса, перейдите к статье [Руководство по передаче и привязыванию SSL-сертификата в Службе приложений Azure](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-ssl).

По умолчанию веб-приложение использует общий общедоступный IP-адрес. После привязки сертификата с помощью SSL на основе IP-адреса Служба приложений создает выделенный IP-адрес для вашего веб-приложения.

Когда запись A будет сопоставлена с веб-приложением, следует внести в реестр домена новый выделенный IP-адрес.

Он появится на странице **Личный домен**. Скопируйте этот [IP-адрес](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-domain), а затем измените его в [записи A](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-domain).

#### <a name="test-https"></a>Тестирование HTTPS

В любом браузере перейдите по адресу https://<ваш.личный.домен> и убедитесь, что открывается нужное веб-приложение.

![Переход к веб-приложению](media/solution-deployment-guide-geo-distributed/image42.png)

> [!Note]  
> Если возникнет ошибка проверки сертификата, это может быть связано с использованием самозаверяющего сертификата или с пропуском промежуточного сертификата при экспорте в PFX-файл.

#### <a name="enforce-https"></a>Принудительное использование HTTPS

По умолчанию любой пользователь может получить доступ к вашему веб-приложению по HTTP. Вы можете перенаправлять все HTTP-запросы на HTTPS-порт.

На странице веб-приложения выберите **Параметры SL**. Затем в окне **Только HTTPS**выберите **ВКЛ**.

![Принудительное использование HTTPS](media/solution-deployment-guide-geo-distributed/image43.png)

По завершении операции перейдите по любому из URL-адресов HTTP, которые указывают на ваше приложение. Пример:

-   https://<app_name>.azurewebsites.net
-   https://northwindcloud.com
-   <https://www.northwindcloud.com>

#### <a name="enforce-tls-1112"></a>Принудительное применение TLS 1.1/1.2

Приложение по умолчанию разрешает применение [TLS](https://wikipedia.org/wiki/Transport_Layer_Security) версии 1.0, которая больше не считается безопасной в соответствии с отраслевыми стандартами, такими как [PCI DSS](https://wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard). Чтобы принудительно применить TLS более поздней версии, выполните следующие инструкции:

1.  На странице веб-приложения в области слева выберите **Параметры SSL**.

2.  Затем в разделе **Версия TLS** выберите минимальную требуемую версию TLS.

![Принудительное использование TLS 1.1 или 1.2](media/solution-deployment-guide-geo-distributed/image44.png)

### <a name="create-a-traffic-manager-profile"></a>Создание профиля диспетчера трафика

1.  Последовательно выберите **Создать ресурс** > **Сети** > **Профиль диспетчера трафика** > **Создать**.

2.  В области **Создание профиля диспетчера трафика** сделайте следующее:

    1.  В поле **Имя** укажите имя профиля. Оно должно быть уникальным в пределах зоны trafficmanager.net. В результате будет создано DNS-имя trafficmanager.net для доступа к профилю диспетчера трафика.

    2.  В списке **Метод маршрутизации** выберите **метод географической маршрутизации**.

    3.  В списке **Подписка** выберите подписку, в которой нужно создать профиль.

    4.  В разделе **Группа ресурсов** создайте группу ресурсов, в которую следует поместить этот профиль.

    5.  Из списка **Расположение группы ресурсов** выберите расположение группы ресурсов. Этот параметр задает расположение группы ресурсов и не влияет на профиль диспетчера трафика, который развернут глобально.

    6.  Нажмите кнопку **создания**.

    7.  Когда глобальное развертывание профиля диспетчера трафика завершится, он появится в соответствующей группе ресурсов как один из ресурсов.

    ![Профиль диспетчера трафика в группе ресурсов](media/solution-deployment-guide-geo-distributed/image45.png)

### <a name="add-traffic-manager-endpoints"></a>Добавление конечных точек диспетчера трафика

1. На панели поиска на портале выполните поиск по имени **профиля диспетчера трафика**, созданного в предыдущем разделе, и выберите нужный профиль в отображаемых результатах.

2. В колонке **Профиль диспетчера трафика** в разделе **Параметры** щелкните **Конечные точки**.

3. Выберите **Добавить**.

4. Добавьте конечную точку Azure Stack Hub.

5. В поле **Тип** выберите **Внешняя конечная точка**.

6. Укажите **имя** для этой конечной точки, желательно имя Azure Stack Hub.

7. В качестве полного доменного имени домена (**FQDN**) укажите внешний URL-адрес веб-приложения Azure Stack Hub.

8. В разделе "Географическое сопоставление" выберите регион или континент, где расположен ресурс (например, **Европа**).

9. В раскрывающемся списке "Страна/Регион" выберите страну, для которой будет применяться эта конечная точка (например, **Германия**).

10. Оставьте флажок **Добавить как отключенный** снятым.

11. Щелкните **ОК**.

12. Добавление конечной точки Azure.

    1.  В раскрывающемся списке **Тип** выберите **Конечная точка Azure**.

    2.  Укажите **имя** конечной точки.

    3.  В раскрывающемся списке **Тип целевого ресурса** выберите **Служба приложений**.

    4.  В разделе **Целевой ресурс** щелкните **Выберите службу приложений**, чтобы отобразился список веб-приложений, размещенных в этой подписке. В колонке **Ресурс** выберите службу приложений, которую вы хотите добавить в качестве первой конечной точки.

13. В разделе "Географическое сопоставление" выберите регион или континент, где расположен ресурс (например, **Северная Америка, Центральная Америка, Карибские о-ва**).

14. В раскрывающемся списке "Страна/Регион" оставьте пустое значение, чтобы выбрать полностью весь регион, указанный выше.

15. Оставьте флажок **Добавить как отключенный** снятым.

16. Щелкните **ОК**.

    > [!Note]  
    >  Создайте по меньшей мере одну конечную точку с географической областью All (World) (Все (мир)), которая будет конечной точкой по умолчанию для этого ресурса.

1. Добавленные конечные точки отобразятся в колонке **Профиль диспетчера трафика** с состоянием **В сети**.

    ![Состояние конечной точки в профиле диспетчера трафика](media/solution-deployment-guide-geo-distributed/image46.png)

**Предприятия мирового уровня используют возможности географического распределения Azure**

Направляя трафик в диспетчер трафика Azure и конечные точки с привязкой к географическим регионам, предприятия мирового уровня обеспечивают соблюдение требований регионального законодательства, соответствие политикам и обеспечивают безопасность данных. Все эти факторы очень важны для успешной работы локальных и зарубежных предприятий и филиалов.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о шаблонах для облака Azure см. в статье [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns).
