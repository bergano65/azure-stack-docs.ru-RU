---
title: Общие сведения о кворуме кластера и пула в Azure Stack HCI
description: Общие сведения о кворуме кластера и пула в Локальных дисковых пространствах в Azure Stack HCI с конкретными примерами сложностей.
author: khdownie
ms.author: v-kedow
ms.topic: article
ms.date: 02/28/2020
ms.openlocfilehash: 70f10bd8c2c2e5eb639229ba743090ba5e5ac79c
ms.sourcegitcommit: a77dea675af6500bdad529106f5782d86bec6a34
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2020
ms.locfileid: "79026106"
---
# <a name="understanding-cluster-and-pool-quorum-on-azure-stack-hci"></a>Общие сведения о кворуме кластера и пула в Azure Stack HCI

>Область применения: Windows Server 2019

[Кластер WSFC](/windows-server/failover-clustering/failover-clustering-overview) обеспечивает высокий уровень доступности для рабочих нагрузок. Эти ресурсы считаются высокодоступными, если работают узлы, в которых они размещены. Обычно требуется, чтобы в кластере в рабочем состоянии находилось более половины настроенных узлов. Такое состояние называется *кворум*.

Концепция кворума разработана, чтобы предотвратить сценарии *расщепления* кластера, то есть нарушения сети, при которых два или более подмножеств узлов не могут взаимодействовать друг с другом. Это может привести к тому, что оба подмножества узлов будут выполнять одну рабочую нагрузку и вести запись на один диск, что создаст многочисленные проблемы. Именно эта ситуация предотвращается концепцией кворума в отказоустойчивом кластере, так как только одна из этих групп узлов сможет продолжать работу и поддерживать сетевое взаимодействие.

Кворум ограничивает количество узлов, которые могут оказаться неработоспособными без прекращения работы кластера. Кворум нужен, чтобы в сценарии сетевых проблем, нарушающих связь между подмножествами узлов кластера, не происходило попыток разместить группу ресурсов и вести запись на один и тот же диск от нескольких серверов одновременно. Применяя такую концепцию кворума, кластер инициирует принудительную остановку работы службы кластера в одном из подмножеств узлов, чтобы у любой группы ресурсов всегда оставался только один полномочный владелец. После того как остановленные узлы восстановят подключение к основной группе узлов, они автоматически присоединятся к кластеру и поддержат работу службу кластеров.

В Windows Server 2019 есть два компонента системы с собственными механизмами кворума.

- **Кворум кластера.** Он работает на уровне кластера (т. е. вы можете потерять узлы, но сохранить работоспособность кластера).
- **Кворум пула.** Он работает на уровне пула, если включены Локальные дисковые пространства (т. е. вы можете потерять узлы и диски, но сохранить работоспособность пула). Пулы носителей разработаны таким образом, чтобы их можно было использовать как в кластеризованных, так и в некластеризованных сценариях. Поэтому у них есть отдельный механизм кворума.

## <a name="cluster-quorum-overview"></a>Общие сведения о кворуме кластера

В приведенной ниже таблице содержатся общие сведения о применении кворума кластера для каждого сценария.

| Узлы сервера | Может выдержать сбой одного узла сервера | Может выдержать сбой двух узлов сервера последовательно | Может выдержать сбой двух узлов сервера одновременно |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | 50/50                               | нет                                                | нет                                                 |
| 2 + свидетель  | Да                                 | нет                                                | нет                                                 |
| 3            | Да                                 | 50/50                                             | нет                                                 |
| 3 + свидетель  | Да                                 | Да                                               | нет                                                 |
| 4            | Да                                 | Да                                               | 50/50                                              |
| 4 + свидетель  | Да                                 | Да                                               | Да                                                |
| 5 и более  | Да                                 | Да                                               | Да                                                |

### <a name="cluster-quorum-recommendations"></a>Рекомендации по кворуму кластера

- При двух узлах свидетель является **обязательным**.
- При трех или четырех узлах использовать свидетель **настоятельно рекомендуется**.
- При наличии доступа к Интернету используйте **[облачный свидетель](/windows-server/failover-clustering/deploy-cloud-witness)** .
- Если в вашей ИТ-среде есть другие компьютеры и общие папки, используйте файловый ресурс-свидетель.

## <a name="how-cluster-quorum-works"></a>Как работает кворум кластера

Если происходит сбой узлов или определенное подмножество узлов теряет связь с другим подмножеством, сохранившимся в кластере узлам необходимо подтверждение того, что они составляют *большинство* от исходного числа узлов кластера, прежде чем продолжать работу. Если это невозможно гарантировать, все они переходят в автономный режим.

Но концепция *большинства* хорошо работает только при нечетном числе узлов в кластере (например, три работающих узла из пяти узлов кластера). Что же делать с теми кластерами, в которых число узлов четное (скажем, с кластером из четырех узлов)?

Есть два способа, которые позволяют кластеру получить нечетное *общее число голосов*:

1. Во-первых, его можно *увеличить*, добавив *свидетель* с дополнительным голосом. Это настраивается пользователем вручную.
2. Во-вторых, его можно *уменьшить*, обнулив один из голосов произвольного узла (выполняется автоматически по мере необходимости).

Во всех случаях, когда оставшиеся узлы успешно подтверждают наличие *большинства*, они переопределяют для себя концепцию *большинства* на основе числа и состава оставшихся узлов. Это позволяет кластеру терять поочередно по одному серверу длительное время. Концепция адаптации *общего числа голосов* после каждого отдельного сбоя называется ***динамическим кворумом***.  

### <a name="dynamic-witness"></a>Динамический свидетель

Динамический свидетель автоматически изменяет вес своего голоса таким образом, чтобы *общее число голосов* всегда оставалось нечетным. Если число голосов всех узлов нечетное, свидетель не имеет собственного голоса. Если число голосов всех узлов четное, свидетель получает голос. Динамический свидетель существенно снижает риск отключения сервера из-за сбоя свидетеля. Кластер решает, нужно ли применять голос свидетеля, исходя из общего числа узлов с голосами, доступных на текущий момент в кластере.

Динамический кворум с динамическим свидетелем работает, как описано ниже.

### <a name="dynamic-quorum-behavior"></a>Применение динамического кворума.

- Если в кластере работает **четное** число узлов и нет свидетеля, *один из голосов обнуляется*. Например, в голосовании участвуют только три узла из четырех, чтобы *общее число голосов* равнялось трем (нечетное число), и два оставшихся узла могли объявить себя большинством.
- Если в кластере работает **нечетное** число узлов и нет свидетеля, *все голоса учитываются*.
- Если в кластере работают **четное** число узлов и свидетель, *голос свидетеля учитывается*, чтобы общее число оставалось нечетным.
- Если в кластере работают **нечетное** число узлов и свидетель, *голос свидетеля не учитывается*.

Динамический кворум позволяет динамически присваивать узлам голоса, чтобы не потерять возможность установить большинство и позволить кластеру работать в конечном счете даже с одним узлом (последний оставшийся). Давайте рассмотрим пример кластера с четырьмя узлами. Предположим, что для кворума нужно три голоса. 

В этом случае кластер окажется неработоспособным при потере двух узлов.

![Схема с четырьмя узлами кластера, у каждого из которых есть один голос](media/quorum/dynamic-quorum-base.png)

Но динамический кворум позволяет избежать такой ситуации. *Общее число голосов* для кворума будет переопределено на основе числа доступных узлов. Таким образом, применение динамического кворума позволяет сохранить работоспособность кластера даже после потери трех узлов.

![На этой схеме отображается четыре узла кластера, где поочередно происходят сбои, и корректировка требуемых голосов после каждого сбоя.](media/quorum/dynamic-quorum-step-through.png)

Описанный выше сценарий применяется к обычному кластеру, для которого не включены Локальные дисковые пространства. Но при включении Локальных дисковых пространств кластер сможет выдержать только сбой двух узлов. Подробнее это описано в разделе о [кворуме пула](#pool-quorum-overview).

### <a name="examples"></a>Примеры

#### <a name="two-nodes-without-a-witness"></a>Два узла без свидетеля.
Голос одного из узлов обнуляется. Поэтому *большинство* определяется по результатам голосования **одного узла**. Если произойдет внезапный сбой на узле без права голоса, выживший получит один голос (при одном нужном) и кластер продолжит работу. Если произойдет внезапный сбой на узле с правом голоса, выживший получит 0 голосов (при одном нужном) и кластер прекратит работу. Если узел с правом голоса выключается корректно, его голос передается другому узлу и кластер продолжает работу. ***Поэтому так важно настроить для кластера свидетель.***

![Работа кворума на примере двух узлов без свидетеля](media/quorum/2-node-no-witness.png)

- Может выдержать сбой одного сервера: **С вероятностью пятьдесят процентов.**
- Может выдержать сбой двух серверов последовательно: **Нет.**
- Может выдержать сбой двух серверов одновременно: **Нет.**

#### <a name="two-nodes-with-a-witness"></a>Два узла со свидетелем.
Оба сервера и один свидетель участвуют в голосовании. Поэтому *большинство* определяется по результатам голосования **трех узлов**. Если произойдет сбой в любом из узлов, оставшиеся сохранят два голоса (из трех общих) и кластер продолжит работу.

![Работа кворума на примере двух узлов со свидетелем](media/quorum/2-node-witness.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Нет.**
- Может выдержать сбой двух серверов одновременно: **Нет.**

#### <a name="three-nodes-without-a-witness"></a>Три узла без свидетеля.
Оба сервера участвуют в голосовании. Поэтому *большинство* определяется по результатам голосования **трех узлов**. Если происходит сбой в любом из узлов, оставшиеся имеют два голоса (из трех общих) и кластер продолжает работу. Теперь у кластера только два узла без свидетеля. То есть мы вернулись к сценарию № 1.

![Работа кворума на примере трех узлов без свидетеля](media/quorum/3-node-no-witness.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **С вероятностью пятьдесят процентов.**
- Может выдержать сбой двух серверов одновременно: **Нет.**

#### <a name="three-nodes-with-a-witness"></a>Три узла со свидетелем.
Все узлы голосуют. Поэтому у свидетеля изначально нет голоса. *Большинство* определяется по результатам голосования **трех узлов**. После первого сбоя в кластере остаются два узла и свидетель. То есть мы вернулись к сценарию № 2. Теперь оба узла и свидетель участвуют в голосовании.

![Работа кворума на примере трех узлов со свидетелем](media/quorum/3-node-witness.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Да.**
- Может выдержать сбой двух серверов одновременно: **Нет.**

#### <a name="four-nodes-without-a-witness"></a>Четыре узла без свидетеля.
Голос одного из узлов обнуляется. Поэтому *большинство* определяется по **трем голосам**. После одного сбоя в кластере остаются три узла. То есть мы вернулись к сценарию № 3.

![Работа кворума на примере четырех узлов без свидетеля](media/quorum/4-node-no-witness.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Да.**
- Может выдержать сбой двух серверов одновременно: **С вероятностью пятьдесят процентов.**

#### <a name="four-nodes-with-a-witness"></a>Четыре узла со свидетелем.
Все узлы и один свидетель участвуют в голосовании, поэтому *большинство* определяется по **пяти голосам**. После одного сбоя возникает сценарий № 4. После двух одновременных сбоев возникает сценарий № 2.

![Работа кворума на примере четырех узлов со свидетелем](media/quorum/4-node-witness.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Да.**
- Может выдержать сбой двух серверов одновременно: **Да.** 

#### <a name="five-nodes-and-beyond"></a>Пять и более узлов.
В голосовании участвуют все узлы или все кроме одного, в зависимости от четности общего количества. Локальные дисковые пространства в любом случае не могут выдержать отказ более двух узлов. Поэтому на этом этапе свидетель не нужен и ничем не полезен.

![Работа кворума на примере пяти и более узлов](media/quorum/5-nodes.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Да.**
- Может выдержать сбой двух серверов одновременно: **Да.** 

Теперь, когда мы знаем, как работает кворум, перейдем к изучению типов свидетелей.

### <a name="quorum-witness-types"></a>Типы свидетелей кворума

Отказоустойчивая кластеризация поддерживает свидетели трех типов.

- **[Облачный свидетель](/windows-server/failover-clustering/deploy-cloud-witness)**  — хранилище BLOB-объектов в Azure, доступное всем узлам кластера. Поддерживает сведения о кластере в файле witness.log, но не хранит копии базы данных кластера.
- **Файловый ресурс-свидетель** — общая папка на файловом сервере под управлением Windows Server. Поддерживает сведения о кластере в файле witness.log, но не хранит копии базы данных кластера.
- **Дисковый свидетель** — небольшой кластеризованный диск, размещенный в группе службы хранилища, доступной для кластера. Это диск с высоким уровнем доступности и отработкой отказа между узлами. Он содержит копию базы данных кластера.  ***Локальные дисковые пространства не поддерживают дисковый свидетель.***

## <a name="pool-quorum-overview"></a>Общие сведения о кворуме пула

До сих пор мы обсуждали кворум кластера, который работает на уровне кластера. Теперь перейдем к кворуму пула, который работает на уровне пула (т. е. вы можете потерять узлы и диски, но сохранить работоспособность пула). Пулы носителей разработаны таким образом, чтобы их можно было использовать как в кластеризованных, так и в некластеризованных сценариях. Поэтому у них есть отдельный механизм кворума.

В приведенной ниже таблице содержатся общие сведения о применении кворума пула для каждого сценария.

| Узлы сервера | Может выдержать сбой одного узла сервера | Может выдержать сбой двух узлов сервера последовательно | Может выдержать сбой двух узлов сервера одновременно |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | нет                                  | нет                                                | нет                                                 |
| 2 + свидетель  | Да                                 | нет                                                | нет                                                 |
| 3            | Да                                 | нет                                                | нет                                                 |
| 3 + свидетель  | Да                                 | нет                                                | нет                                                 |
| 4            | Да                                 | нет                                                | нет                                                 |
| 4 + свидетель  | Да                                 | Да                                               | Да                                                |
| 5 и более  | Да                                 | Да                                               | Да                                                |

## <a name="how-pool-quorum-works"></a>Обзор кворума пула

Если происходит сбой дисков или определенное подмножество дисков теряет связь с другим подмножеством, сохранившимся в пуле дискам нужно подтверждение того, что они составляют *большинство* от исходного размера пула, прежде чем продолжать работу. Если это невозможно гарантировать, все они переходят в автономный режим. Пул как общая сущность сохраняет или теряет работоспособность в зависимости от того, достаточно ли в нем сохранилось дисков для кворума (50 % + 1). Владелец ресурса пула (активный узел кластера) может учитываться как решающий голос (+1).

Но кворум пула имеет следующие важные отличия от кворума кластера:

- пул использует один узел кластера в качестве свидетеля для разрешения спорных ситуаций при отключении ровно половины дисков (это узел, который является владельцем ресурса пула);
- пул НЕ поддерживает динамический кворум;
- пул НЕ поддерживает методику удаления одного голоса.

### <a name="examples"></a>Примеры

#### <a name="four-nodes-with-a-symmetrical-layout"></a>Четыре узла с симметричным расположением. 
Каждый из 16 дисков имеет один голос, и узел 2 тоже имеет один голос (на правах владельца ресурса). *Большинство* определяется по результатам **16 голосов**. Если, к примеру, узлы 3 и 4 будут отключены, у подмножества оставшихся сохраняются 8 дисков и среди них есть владелец ресурса пула, что дает им в общей сложности 9 из 16 голосов. Это означает, что пул продолжит работу.

![Кворум пула, пример 1](media/quorum/pool-1.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Да.**
- Может выдержать сбой двух серверов одновременно: **Да.** 

#### <a name="four-nodes-with-a-symmetrical-layout-and-drive-failure"></a>Четыре узла с симметричным расположением и сбоем диска. 
Каждый из 16 дисков имеет один голос, и узел 2 тоже имеет один голос (на правах владельца ресурса). *Большинство* определяется по результатам **16 голосов**. Сначала отключается диск 7. Если теперь узлы 3 и 4 будут отключены, у подмножества выживших сохраняются 7 дисков и среди них есть владелец ресурса пула, что дает им в общей сложности 8 из 16 голосов. Этот пул не сохраняет большинство и будет отключен.

![Кворум пула, пример 2](media/quorum/pool-2.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Нет.**
- Может выдержать сбой двух серверов одновременно: **Нет.** 

#### <a name="four-nodes-with-a-non-symmetrical-layout"></a>Четыре узла с несимметричным расположением. 
Каждый из 24 дисков имеет один голос, и узел 2 тоже имеет один голос (на правах владельца ресурса). *Большинство* определяется по результатам **24 голосов**. Если узлы 3 и 4 будут отключены, у подмножества оставшихся сохраняются 8 дисков и среди них есть владелец ресурса пула, что дает им в общей сложности 9 из 24 голосов. Этот пул не сохраняет большинство и будет отключен.

![Кворум пула, пример 3](media/quorum/pool-3.png)

- Может выдержать сбой одного сервера: **Да.**
- Может выдержать сбой двух серверов последовательно: **Неизвестно** (не сможет выдержать сбой узлов 3 и 4, но выдержит все другие сценарии).
- Может выдержать сбой двух серверов одновременно: **Неизвестно** (не сможет выдержать сбой узлов 3 и 4, но выдержит все другие сценарии).

### <a name="pool-quorum-recommendations"></a>Рекомендации по кворуму пула

- Убедитесь, что все узлы в кластере симметричны (имеют одинаковое число дисков).
- Реализуйте трехстороннее зеркальное отображение или двойной контроль четности, чтобы пул выдерживал сбои узлов и сохранял работоспособность виртуальных дисков. 
- Если будут отключены более двух узлов или два узла и диск на третьем узле, тома могут потерять доступ ко всем трем копиям данных и перейдут в автономный режим, то есть станут недоступны. Мы рекомендуем в такой ситуации быстро восстанавливать работоспособность узлов или заменять диски, чтобы сохранять устойчивость для всех данных тома.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих разделах:

- [Настройка кворума и управление им](/windows-server/failover-clustering/manage-cluster-quorum)
- [Развертывание облачного свидетеля](/windows-server/failover-clustering/deploy-cloud-witness)
