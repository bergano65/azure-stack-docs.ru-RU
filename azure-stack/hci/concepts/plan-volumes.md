---
title: Планирование томов в Azure Stack HCI
description: Сведения о том, как планировать тома в Azure Stack HCI.
author: khdownie
ms.author: v-kedow
ms.topic: article
ms.date: 03/06/2020
ms.openlocfilehash: c6410e4f0d60138ce773f7f0abfae1a5c1850bd2
ms.sourcegitcommit: 900332596d0bb473d82b1d1a28c3fe3aa6522add
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2020
ms.locfileid: "79095229"
---
# <a name="planning-volumes-in-storage-spaces-direct"></a>Планирование томов в Локальных дисковых пространствах

> Область применения: Windows Server 2019

В этой статье приводятся рекомендации по планированию томов в Локальных дисковых пространствах для удовлетворения потребностей рабочих нагрузок и производительности, включая выбор файловой системы, типа устойчивости и размера томов.

## <a name="review-what-are-volumes"></a>Обзор. Что такое тома

Тома — это место для размещения файлов, необходимых рабочим нагрузкам, таких как VHD или VHDX-файлы для виртуальных машин Hyper-V. Тома объединяют диски в пул хранения, чтобы обеспечить отказоустойчивость, масштабируемость и производительность локальных дисковых пространств.

   >[!NOTE]
   > В документации по Локальным дисковым пространствам мы используем термин "том" как совокупное обозначение тома и размещенного на нем виртуального диска, включая все компоненты других встроенных функций Windows, такие как общие тома кластера (CSV) и ReFS. Понимание этих различий на уровне реализации не требуется для успешного планирования и развертывания Локальных дисковых пространств.

![что такое тома](media/plan-volumes/what-are-volumes.png)

Все тома доступны для всех серверов в кластере одновременно. После создания они отображаются в папке **C:\ClusterStorage\\** на каждом сервере.

![снимок экрана с папкой csv](media/plan-volumes/csv-folder-screenshot.png)

## <a name="choosing-how-many-volumes-to-create"></a>Выбор количества создаваемых томов

Мы рекомендуем поддерживать количество томов, кратное количеству серверов в кластере. Например, если вы используете четыре сервера, производительность кластера с четырьмя томами будет более стабильной, чем с тремя или пятью. Такой подход позволяет кластеру распределять "владение" томами равномерно между серверами (для каждого тома должен быть назначен один сервер, который отвечает за согласование метаданных).

Мы рекомендуем создавать в общей сложности не более 64 томов на кластер в среде Windows Server 2019.

## <a name="choosing-the-filesystem"></a>Выбор файловой системы

Для Локальных дисковых пространств мы рекомендуем использовать новую [файловую систему ReFS](/en-us/windows-server/storage/refs/refs-overview) (устойчивая файловая система). Файловая система ReFS специально создана как идеальное решение для поддержки виртуализации. Она предоставляет много преимуществ, включая значительное ускорение производительности и встроенную защиту от повреждения данных. В среде Windows Server версии 1709 и более поздних версий она поддерживает почти все ключевые функции NTFS, включая дедупликацию данных. Дополнительные сведения см. в таблице [сравнения возможностей ReFS](/windows-server/storage/refs/refs-overview#feature-comparison).

Если для вашей рабочей нагрузки требуется функция, которая пока не поддерживается в ReFS, можно использовать NTFS.

   > [!TIP]
   > В одном кластере могут сосуществовать тома с разными файловыми системами.

## <a name="choosing-the-resiliency-type"></a>Выбор типа устойчивости

Тома в локальных дисковых пространствах обеспечивают отказоустойчивость для защиты от проблем с оборудованием, таких как сбои дисков или серверов, и для обеспечения постоянной доступности в течение всего времени обслуживания сервера, например во время обновления программного обеспечения.

   > [!NOTE]
   > Выбор типа устойчивости не зависит от типа используемых дисков.

### <a name="with-two-servers"></a>Система с двумя серверами

Если в кластере два сервера, можно использовать двустороннее зеркальное отображение. А если на этих серверах работает Windows Server 2019, можно использовать еще и вложенную устойчивость.

Двустороннее зеркальное отображение означает хранение двух копий всех данных, по одной копии на дисках каждого сервера. Эффективность такого хранилища составляет 50 %, то есть для хранения 1 ТБ данных потребуется не менее 2 ГБ физического места в пуле носителей. Двустороннее зеркальное отображение позволяет спокойно перенести один сбой оборудования (один сервер или один диск) за один раз.

![двустороннее зеркальное отображение](media/plan-volumes/two-way-mirror.png)

Вложенная устойчивость (доступно только для Windows Server 2019) обеспечивает устойчивость данных между серверами, организуя двустороннее зеркальное отображение, а затем добавляет дополнительный уровень устойчивости, создавая внутри сервера двустороннее зеркальное отображение или контроль четности с зеркальным ускорением. Такая вложенность поддерживает устойчивость даже в случае недоступности и на время перезагрузки одного сервера. Эффективность хранения в такой системе составляет 25 %, если используется двустороннее зеркальное отображение, или 35–40 % при контроле четности с зеркальным ускорением. Вложенная устойчивость позволяет спокойно перенести два одновременных сбоя оборудования (два диска или сервер и один диск на другом сервере). Учитывая такое повышение устойчивости данных, мы рекомендуем всегда использовать вложенную устойчивость в рабочих развертываниях кластеров с двумя серверами под управлением Windows Server 2019. Дополнительные сведения см. в статье [Вложенная устойчивость](/windows-server/storage/storage-spaces/nested-resiliency).

![Вложенный контроль четности с зеркальным ускорением](media/plan-volumes/nested-mirror-accelerated-parity.png)

### <a name="with-three-servers"></a>Система с тремя серверами

Для трех серверов следует использовать трехстороннее зеркальное отображение, чтобы повысить отказоустойчивость и производительность. Трехстороннее зеркальное отображение означает хранение трех копий всех данных, по одной копии на дисках каждого сервера. Эффективность такого хранилища составляет 33,3 %, то есть для хранения 1 ТБ данных потребуется не менее 3 ГБ физического места в пуле носителей. При трехстороннем зеркальном отображении можно безопасно перенести [по меньшей мере два сбоя оборудования (диска или сервера) одновременно](/windows-server/storage/storage-spaces/storage-spaces-fault-tolerance#examples). Если два узла одновременно станут недоступными, пул носителей теряет кворум из-за отсутствия 2/3 дисков, и виртуальные диски становятся недоступными. Однако работоспособность виртуальных дисков сохраняется в ситуации отказа одного узла и одного или более дисков на другом узле. Например, в случае перезагрузки одного сервера при внезапном сбое другого диска или сервера все данные остаются в целостности и постоянно доступными.

![трехстороннее зеркальное отображение](media/plan-volumes/three-way-mirror.png)

### <a name="with-four-or-more-servers"></a>Система с четырьмя или более серверами

Для четырех и более серверов вы можете для каждого тома отдельно выбрать трехстороннее зеркальное отображение, двойной контроль четности ("удаляющее кодирование") или сочетание этих технологий с контролем четности с зеркальным ускорением.

Двойной контроль четности дает такой же уровень устойчивости, как и трехстороннее зеркальное отображение, но повышает эффективность хранилища. При четырех серверах его эффективность составит 50,0 %, то есть для хранения 2 ТБ данных потребуется 4 ГБ физического места в пуле носителей. Эффективность повышается до 66,7 % при семи серверах, а при большем количестве может достигать 80,0 %. Недостаток заключается в том, что кодирование с контролем четности повышает нагрузку на вычислительные ресурсы, а это может ограничить производительность системы.

![двойной контроль четности](media/plan-volumes/dual-parity.png)

Выбор типа устойчивости зависит от потребностей конкретной рабочей нагрузки. В следующей таблице представлено краткое описание подходящих типов рабочих нагрузок для каждого типа устойчивости, а также данные о производительности и эффективности хранилища для каждого типа устойчивости.

| Тип устойчивости | Эффективность хранилища | Speed | Рабочие нагрузки |
| ------------------- | ----------------------  | --------- | ------------- |
| **Зеркальное отображение**         | ![Эффективность хранилища на уровне 33 %](media/plan-volumes/3-way-mirror-storage-efficiency.png)<br>Трехстороннее зеркальное отображение: 33 % <br>Двустороннее зеркальное отображение: 50%     |![Производительность на уровне 100 %](media/plan-volumes/three-way-mirror-perf.png)<br> Наивысшая производительность  | Виртуализированные рабочие нагрузки<br> Базы данных<br>Другие рабочие нагрузки, требующие высокой производительности |
| **Контроль четности с зеркальным ускорением** |![Эффективность хранилища на уровне 50 %](media/plan-volumes/mirror-accelerated-parity-storage-efficiency.png)<br> Зависит от распределения зеркального отображения и четности | ![Производительность на уровне 20 %](media/plan-volumes/mirror-accelerated-parity-perf.png)<br>Намного медленнее зеркального отображения, но в два раза быстрее двойного контроля четности<br> Оптимально для объемных последовательных операций записи и чтения | Архивация и резервное копирование<br> Инфраструктура виртуальных рабочих столов     |
| **Двойной контроль четности**               | ![Эффективность хранилища на уровне 80 %](media/plan-volumes/dual-parity-storage-efficiency.png)<br>При четырех серверах: 50% <br>При 16 серверах: до 80 % | ![Производительность на уровне 10 %](media/plan-volumes/dual-parity-perf.png)<br>Наивысшая задержка чтения и записи, плюс высокая нагрузка на ЦП при записи<br> Оптимально для объемных последовательных операций записи и чтения | Архивация и резервное копирование<br> Инфраструктура виртуальных рабочих столов  |

#### <a name="when-performance-matters-most"></a>Когда производительность важнее всего

Рабочие нагрузки со строгими ограничениями по сетевой задержке или требующие большого количества операций ввода-вывода в секунду со случайным доступом, например базы данных SQL Server или требовательные к производительности виртуальные машины Hyper-V, должны работать на томах с зеркальным отображением, чтобы достичь максимальной производительности.

   >[!TIP]
   > Зеркальное отображение работает быстрее, чем любой другой тип устойчивости. Мы используем зеркальное отображение почти для всех примеров рабочих систем.

#### <a name="when-capacity-matters-most"></a>Когда емкость важнее всего

Рабочие нагрузки с малым объемом операций записи, например хранилища данных или хранилища "холодного" уровня, должны работать на томах с двойным контролем четности, чтобы достичь максимальной эффективности хранилища. Некоторые другие рабочие нагрузки, например традиционные файловые серверы или инфраструктуры виртуальных рабочих столов (VDI), которые не создают большого числа произвольных операций ввода-вывода и (или) не требуют высокой производительности, могут также использовать двойной контроль четности на усмотрение администратора. Контроль четности неизбежно повышает нагрузку на ЦП и задержку ввода-вывода по сравнению с зеркальным отображением, особенно для операций записи.

#### <a name="when-data-is-written-in-bulk"></a>Когда данные записываются в больших объемах

Рабочие нагрузки, в которых используются операции записи с последовательными проходами больших объемов, например хранилища архивов и резервных копий, могут использовать еще один вариант: сочетание зеркального отображения и двойного контроля четности на одном томе. В этом случае операции записи сохраняются сначала на одном из зеркальных сегментов, а затем постепенно перемещаются на другой. Это позволяет ускорить прием данных и снизить потребление ресурсов при больших операциях записи за счет распределения интенсивных вычислений для кодирования с контролем четности на более длительный период. При выборе размера таких сегментов учитывайте объем операций записи, выполняемых единовременно (например, объем одной ежедневной резервной копии), чтобы этот объем без проблем помещался в один сегмент. Например, если вы ежедневно принимаете около 100 ГБ данных, выберите для зеркального отображения диск размером от 150 до 200 ГБ, а для остального объема настройте двойной контроль четности.

Итоговая эффективность хранилища будет зависеть от выбранного соотношения этих объемов. Некоторые примеры можно изучить [здесь](https://www.youtube.com/watch?v=-LK2ViRGbWs&t=36m55s).

   > [!TIP]
   > Если вы заметите резкое снижение производительности записи в середине процесса приема данных, это может означать недостаточный размер сегмента с зеркальным отображением или плохую пригодность контроля четности с зеркальным ускорением для конкретного сценария использования. Например, если производительность записи снижается с 400 до 40 МБ/с, попробуйте увеличить сегмент с зеркальным отображением или перейти на трехстороннее зеркальное отображение.

### <a name="about-deployments-with-nvme-ssd-and-hdd"></a>Развертывания на основе NVMe, SSD и HDD

В развертываниях с дисками двух типов более быстрый диск используется в качестве кэширующего, а более медленный предоставляет больший объем. Это происходит автоматически. Подробные сведения см. в [статье о кэшировании в Локальных дисковых пространствах](/windows-server/storage/storage-spaces/understand-the-cache). В таких развертываниях все тома по сути размещаются на дисках только одного типа — на более емких.

В развертываниях с дисками всех трех типов кэширование выполняется только на самых быстрых (NVMe) дисках, а два других типа (SSD и HDD) предоставляют емкость хранилища. Для каждого тома вы можете выбрать, следует ли располагать его полностью на уровне SSD, полностью на уровне HDD или распределить между ними.

   > [!IMPORTANT]
   > Мы рекомендуем размещать наиболее чувствительные к производительности рабочие нагрузки только на дисках SSD.

## <a name="choosing-the-size-of-volumes"></a>Выбор размера томов

Мы рекомендуем использовать для Windows Server 2019 тома размером не более 64 ТБ.

   > [!TIP]
   > Если вы используете решение резервного копирования, в котором применяется служба теневого копирования томов (VSS) и поставщик программного обеспечения Volsnap (это распространенное сочетание для рабочих нагрузок файлового сервера), производительность и надежность системы можно повысить, ограничив тома размером около 10 ТБ. Решения резервного копирования на основе более новых технологий (API Hyper-V RCT, блочное клонирование ReFS, нативные API резервного копирования SQL) хорошо справляются с томами объемом до 32 ТБ и даже более.

### <a name="footprint"></a>Занимаемый объем

Размер каждого тома определяет его доступную емкость, то есть размер хранимых на нем данных. Этот размер выбирается параметром **-Size** в командлете **New-Volume**, а затем отображается в свойстве **Size** при выполнении командлета **Get-Volume**.

Размер тома не совпадает с *занимаемым объемом*, который определяется общим объемом физических носителей в пуле, которые занимает этот том. Занимаемый объем зависит еще и от типа устойчивости. Например, тома с трехсторонним зеркальным отображением занимают объем, в три раза превосходящий их размер.

Занимаемый объем тома не может превышать размер пула носителей.

![размер и занимаемый объем](media/plan-volumes/size-versus-footprint.png)

### <a name="reserve-capacity"></a>Резервная емкость

Сохраняя некоторый объем пула носителей нераспределенным, вы предоставите томам объем для локального восстановления в случае отказа дисков, что повысит безопасность данных и производительность. Если есть достаточная для этого емкость, немедленный процесс параллельного восстановления "на месте" позволяет восстановить тома до полного состояния устойчивости быстрее, чем удастся заменить проблемные диски. Этот процесс выполняется автоматически.

Мы рекомендуем резервировать на каждый сервер пространство, занимаемое одним диском емкости (не более четырех дисков в общей сложности). Вы можете по своему усмотрению предоставить и больше пространства, но соблюдение этой рекомендации гарантирует возможность немедленного параллельного восстановления "на месте" после сбоя любого диска.

![резерв](media/plan-volumes/reserve.png)

Например, если вы используете два сервера и диски емкости по 1 ТБ, оставьте в пуле резервное пространство 2×1=2 ТБ. Если вы используете три сервера и диски емкости по 1 ТБ, оставьте в пуле резервное пространство 3×1=3 ТБ. Если вы используете четыре сервера (или более) и диски емкости по 1 ТБ, оставьте в пуле резервное пространство 4×1=4 ТБ.

   >[!NOTE]
   > В кластерах с дисками всех трех типов (NVMe+SSD+HDD) мы рекомендуем оставлять резерв, эквивалентный размеру одного диска SSD и одного диска HDD на каждый сервер (не более четырех пар дисков в общей сложности).

## <a name="example-capacity-planning"></a>Пример Планирование ресурсов

Давайте рассмотрим в качестве примера один кластер с четырьмя серверами. Каждый сервер имеет несколько дисков кэша и 16 дисков емкости по 2 ТБ.

```
4 servers x 16 drives each x 2 TB each = 128 TB
```

Из этих 128 ТБ общего объема пула носителей мы резервируем объем четырех дисков (8 ТБ) на процессы восстановления "на месте", чтобы не спешить с заменой в случае сбоя дисков. Это оставляет нам 120 ТБ свободного физического пространства в пуле, которое мы можем разделить для создания томов.

```
128 TB – (4 x 2 TB) = 120 TB
```

Предположим, что для целей разработки нам нужно разместить несколько очень активных виртуальных машин Hyper-V, а кроме них нам нужно много "холодного" хранилища для старых файлов и резервных копий. У нас есть четыре сервера, значит лучше всего создать четыре тома.

Наши виртуальные машины мы поместим в первые два тома *Volume 1* и *Volume 2*. Для них мы выберем файловую систему ReFS (для повышения скорости и создания контрольных точек) и реализуем устойчивость через трехстороннее зеркальное отображение, чтобы добиться максимальной производительности. На других двух томах, *Volume 3* и *Volume 4*, мы разместим холодное хранилище. Здесь мы выберем файловую систему NTFS (для использования дедупликации данных) и контроль четности, чтобы добиться максимального объема.

Мы не обязаны делать все тома одинакового размера, но для простоты примера они у нас будут размером по 12 ТБ.

Каждый из томов *Volume 1* и *Volume 2* занимает 12 TB × 33,3 % (эффективность) = 36 ТБ объема физического хранилища.

Каждый из томов *Volume 3* и *Volume 4* занимает 12 TB × 50,0 % (эффективность) = 24 ТБ объема физического хранилища.

```
36 TB + 36 TB + 24 TB + 24 TB = 120 TB
```

Итак, эти четыре тома идеально размещаются в том объеме физического хранилища, который предоставляется нашим пулом. Готово!

![пример](media/plan-volumes/example.png)

   >[!TIP]
   > Но вы не обязаны создавать все тома сразу. Вы всегда сможете увеличить их объем или добавить новые тома.

Для простоты в этом примере используются десятичные значения (base-10) для единиц измерения, то есть 1 ТБ = 1 000 000 000 000 байт. Однако в ОС Windows объемы хранилища отображаются в двоичных (base-2) единицах измерения. В частности, каждый диск объемом 2 ТБ будет в Windows отображаться как диск объемом 1,82 ТиБ. Аналогичным образом, пул носителей 128 ТБ будет иметь объем 116,41 ТиБ. Это ожидаемое поведение.

## <a name="usage"></a>Использование

См. статью [Создание томов в Azure Stack HCI](../manage/create-volumes.md).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. также в следующих разделах:

- [Общие сведения об Azure Stack HCI](../overview.md)
- [Выбор дисков для Локальных дисковых пространств](choose-drives.md)
- [Отказоустойчивость и эффективность хранилища](fault-tolerance.md)