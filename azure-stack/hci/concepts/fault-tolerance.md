---
title: Отказоустойчивость и эффективность хранилища в Azure Stack HCI
description: Обсуждение вариантов обеспечения устойчивости в Локальных дисковых пространствах, в том числе зеркальное отображение и контроль четности.
author: khdownie
ms.author: v-kedow
ms.topic: article
ms.date: 02/28/2020
ms.openlocfilehash: 9ace3960b4c54461a4153c4997694e6d17ee4fd1
ms.sourcegitcommit: a77dea675af6500bdad529106f5782d86bec6a34
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2020
ms.locfileid: "79026118"
---
# <a name="fault-tolerance-and-storage-efficiency-in-azure-stack-hci"></a>Отказоустойчивость и эффективность хранилища в Azure Stack HCI

>Область применения: Windows Server 2019

В этой статье вы ознакомитесь с вариантами, доступными в Локальных дисковых пространствах, для обеспечения устойчивости и для каждого из них изучите требования к масштабированию, эффективность хранения, общие преимущества и недостатки. Здесь также представлены некоторые инструкции по использованию, которые помогут приступить к работе, и ссылки на полезные документы, блоги и другие материалы для получения дополнительных сведений.

Если вы уже знакомы с дисковыми пространствами, то можете сразу перейти к разделу [Сводка](#summary).

## <a name="overview"></a>Обзор

По своей сути дисковые пространства призваны поддерживать для ваших данных отказоустойчивость или "устойчивость". Эта служба аналогична системе RAID, только на уровне серверов и с программной реализацией.

Как и в случае с RAID, для дисковых пространств есть несколько вариантов использования, у каждого из которых свои соотношения между отказоустойчивостью, эффективностью хранилища и сложностью вычислений. Эти варианты можно грубо разделить на две категории: "зеркальное отображение" и "контроль четности" (второй иногда называется "удаляющее кодирование").

## <a name="mirroring"></a>Зеркальное отображение

Зеркальное отображение обеспечивает отказоустойчивость, сохраняя несколько копий всех данных. Это больше всего соответствует схеме RAID-1. Эти данные распределяются и размещаются неочевидным образом (подробные сведения см. в [этом блоге](https://blogs.technet.microsoft.com/filecab/2016/11/21/deep-dive-pool-in-spaces-direct/)), но мы можем точно сказать, что любые данные, хранящиеся с использованием зеркального отображения, полностью записываются несколько раз. Каждая копия записывается на разное физическое оборудование (разные диски на разных серверах), которые, как предполагается, выходят из строя независимо друг от друга.

Дисковые пространства поддерживают два типа зеркального отображения: двустороннее и трехстороннее.

### <a name="two-way-mirror"></a>Двухстороннее зеркальное отображение

При двухстороннем зеркальном отображении записываются две полные копии всех данных. Эффективность такого хранилища составляет 50 %, то есть для хранения 1 ТБ данных потребуется не менее 2 ТБ физического хранилища. Аналогичным образом, вам нужно по меньшей мере два [аппаратных домена сбоя](/windows-server/failover-clustering/fault-domains), что для Локальных дисковых пространств означает два сервера.

![двустороннее зеркальное отображение](media/fault-tolerance/two-way-mirror-180px.png)

   >[!WARNING]
   > Если у вас больше двух серверов, мы рекомендуем использовать трехстороннее зеркальное отображение.

### <a name="three-way-mirror"></a>Трехстороннее зеркальное отображение

При трехстороннем зеркальном отображении записываются три полные копии всех данных. Эффективность такого хранилища составляет 33,3 %, то есть для хранения 1 ТБ данных потребуется не менее 3 ТБ физического хранилища. Аналогичным образом, вам нужно по меньшей мере три аппаратных домена сбоя, что для Локальных дисковых пространств означает три сервера.

При трехстороннем зеркальном отображении можно безопасно перенести [по меньшей мере два сбоя оборудования (диска или сервера) одновременно](#examples). Например, в случае перезагрузки одного сервера при внезапном сбое другого диска или сервера все данные остаются в целостности и постоянно доступными.

![трехстороннее зеркальное отображение](media/fault-tolerance/three-way-mirror-180px.png)

## <a name="parity"></a>Parity

Кодирование с контролем четности, также именуемое "удаляющее кодирование", поддерживает отказоустойчивость с помощью побитовой арифметической операции, которая в некоторых случаях [невероятно сложна](https://www.microsoft.com/research/wp-content/uploads/2016/02/LRC12-cheng20webpage.pdf). Такой подход менее очевиден, чем зеркальное отображение, и для знакомства с ним следует изучить какой-либо из множества замечательных Интернет-ресурсов, например этот сторонний документ [Dummies Guide to Erasure Coding](http://smahesh.com/blog/2012/07/01/dummies-guide-to-erasure-coding/) (Руководство для чайников по удаляющему кодированию). Достаточно лишь сказать, что это обеспечивает более высокую эффективность хранилища без ущерба отказоустойчивости.

Дисковые пространства поддерживают два вида контроля четности — "одинарный" и "двойной", последний применяет в широком масштабе сложную технологию "кодов локального восстановления".

> [!IMPORTANT]
> Мы рекомендуем для наиболее чувствительных к производительности рабочих нагрузок применять зеркальное отображение. Дополнительные сведения о достижении компромисса между производительностью и емкостью с учетом характеристик рабочих нагрузок см. в статье [Планирование томов](/windows-server/storage/storage-spaces/plan-volumes#choosing-the-resiliency-type).

### <a name="single-parity"></a>Одинарный контроль четности
При одинарном контроле четности сохраняется только один символ битовой четности, что позволяет защитить данные только от одного сбоя единовременно. Это больше всего соответствует схеме RAID-5. Чтобы применить одинарный контроль четности, вам нужно по меньшей мере три аппаратных домена сбоя, что для Локальных дисковых пространств означает три сервера. Поскольку трехстороннее зеркальное отображение дает большую отказоустойчивость при тех же объемах, мы рекомендуем не применять одинарный контроль четности. Но он присутствует в системе и полностью поддерживается, если у вас будут причины выбрать этот вариант.

   >[!WARNING]
   > Мы советуем не использовать одинарный контроль четности из-за того, что он способен надежно выдерживать только один аппаратный сбой единовременно, и если во время непредвиденного сбоя диска или сервера вы перезагружали другой сервер, система окажется неработоспособна. Если у вас всего три сервера, лучше всего настроить трехстороннее зеркальное отображение. Рекомендации для четырех и более серверов приводятся в следующем разделе.

### <a name="dual-parity"></a>Двойной контроль четности

Двойной контроль четности реализует коды коррекции ошибок Рида-Соломона с двумя символами битовой четности, что обеспечивает отказоустойчивость на уровне трехстороннего зеркального отображения (то есть до двух сбоев единовременно) при более высокой эффективности хранилища. Это больше всего соответствует схеме RAID-6. Чтобы применить двойной контроль четности, вам нужно по меньшей мере четыре аппаратных домена сбоя, что для Локальных дисковых пространств означает четыре сервера. Эффективность хранилища на такой системе составляет 50 %, то есть для хранения 2 ТБ данных потребуется 4 ТБ физического места в хранилище.

![двойной контроль четности](media/fault-tolerance/dual-parity-180px.png)

Эффективность хранилища в схеме двойного контроля четности повышается с 50 до 80 % по мере увеличения числа доменов сбоя. Например, при семи узлах (семи серверах, если речь идет о Локальных дисковых пространствах) эффективность повышается до 66,7 %, то есть для хранения 4 ТБ данных вам будет достаточно 6 ТБ физического места в хранилище.

![двойной контроль четности, широкая схема](media/fault-tolerance/dual-parity-wide-180px.png)

В разделе [Сводка](#summary) приводятся данные об эффективности двойного контроля четности и кодов локального восстановления для каждого размера системы.

### <a name="local-reconstruction-codes"></a>Коды локального восстановления

Дисковые пространства предоставляют современную технологию, разработанную в Microsoft Research, которая именуется "коды локального восстановления" (LRC). При больших размерах системы в двойном контроле четности применяются коды LRC для распределения задач кодирования и декодирования на несколько небольших групп. Это позволяет снизить затраты на операции записи или восстановления после сбоев.

Для жестких дисков HDD размер группы составляет четыре символа, а для твердотельных накопителей — шесть символов. Например, так будет выглядеть схема системы с жесткими дисками и 12-ю аппаратными доменами сбоя (то есть 12-ю серверами), где используются две группы по четыре символа данных. Это позволяет достичь эффективности хранилища на уровне 72,7 %.

![коды локального восстановления](media/fault-tolerance/local-reconstruction-codes-180px.png)

Мы рекомендуем изучить это подробное, но легко читаемое пошаговое руководство [о применении кодов локального восстановления в разных сценариях сбоя и привлекательности этого подхода](https://blogs.technet.microsoft.com/filecab/2016/09/06/volume-resiliency-and-efficiency-in-storage-spaces-direct/), которое создал наш сотрудник [Клаус Йоргенсен](https://twitter.com/clausjor) (Claus Joergensen).

## <a name="mirror-accelerated-parity"></a>Контроль четности с зеркальным ускорением

Том Локальных дисковых пространств можно сделать частично зеркальным и частично с контролем четности. В этом случае операции записи сохраняются сначала на одном из зеркальных сегментов, а затем постепенно перемещаются на другой. По сути это означает, что [зеркальное отображение применяется для ускорения удаляющего кодирования](https://blogs.technet.microsoft.com/filecab/2016/09/06/volume-resiliency-and-efficiency-in-storage-spaces-direct/).

Чтобы совместить трехстороннее зеркальное отображение и двойной контроль четности, вам потребуется не менее четырех доменов сбоя, то есть четырех серверов.

Эффективность хранилища при контроле четности с зеркальным ускорением будет средней между теми значениями, которые можно получить при чистом зеркальном отображении и чистом контроле четности, и зависит от выбранных пропорций между ними. Например, на 37-й минуте этой презентации предлагается демонстрационный пример [с разными сочетаниями, которые обеспечивают эффективность хранилища на уровне 46 %, 54 % или 65 %](https://www.youtube.com/watch?v=-LK2ViRGbWs&t=36m55s) для системы с 12-ю серверами.

> [!IMPORTANT]
> Мы рекомендуем для наиболее чувствительных к производительности рабочих нагрузок применять зеркальное отображение. Дополнительные сведения о достижении компромисса между производительностью и емкостью с учетом характеристик рабочих нагрузок см. в статье [Планирование томов](/windows-server/storage/storage-spaces/plan-volumes#choosing-the-resiliency-type).

## <a name="summary"></a><a name="summary"></a>Сводка

В этом разделе перечислены типы устойчивости, доступные в Локальных дисковых пространствах, минимальные требования к размеру системы для каждого из этих типов, допустимое количество сбоев и соответствующая эффективность хранилища.

### <a name="resiliency-types"></a>Типы устойчивости

|    Устойчивость          |    Отказоустойчивость       |    Эффективность хранилища      |
|------------------------|----------------------------|----------------------------|
|    Двухстороннее зеркальное отображение      |    1                       |    50,0 %                   |
|    Трехстороннее зеркальное отображение    |    2                       |    33,3 %                   |
|    Двойной контроль четности         |    2                       |    от 50,0 % до 80,0 %           |
|    Смешанный               |    2                       |    от 33,3 % до 80,0 %           |

### <a name="minimum-scale-requirements"></a>Минимальные требования к размеру системы

|    Устойчивость          |    Минимально допустимое число доменов сбоя   |
|------------------------|-------------------------------------|
|    Двухстороннее зеркальное отображение      |    2                                |
|    Трехстороннее зеркальное отображение    |    3                                |
|    Двойной контроль четности         |    4                                |
|    Смешанный               |    4                                |

   >[!TIP]
   > Если вы не используете [отказоустойчивость на уровне корпуса или стойки](/windows-server/failover-clustering/fault-domains), число доменов сбоя всегда совпадает с числом серверов. Число дисков на каждом сервере не влияет на доступность типов устойчивости, если соблюдаются минимальные требования для Локальных дисковых пространств.

### <a name="dual-parity-efficiency-for-hybrid-deployments"></a>Двойной контроль четности в гибридных развертываниях

В этой таблице представлены уровни эффективности хранилища для двойного контроля четности и кодов локального восстановления при каждом возможном размере гибридного развертывания, в котором сочетаются жесткие диски (HDD) и твердотельные накопители (SSD).

|    Домены сбоя      |    Макет           |    Эффективность   |
|-----------------------|---------------------|-----------------|
|    2                  |    –                |    –            |
|    3                  |    –                |    –            |
|    4                  |    RS 2+2           |    50,0 %        |
|    5                  |    RS 2+2           |    50,0 %        |
|    6                  |    RS 2+2           |    50,0 %        |
|    7                  |    RS 4+2           |    66,7 %        |
|    8                  |    RS 4+2           |    66,7 %        |
|    9                  |    RS 4+2           |    66,7 %        |
|    10                 |    RS 4+2           |    66,7 %        |
|    11                 |    RS 4+2           |    66,7 %        |
|    12                 |    LRC (8, 2, 1)    |    72,7 %        |
|    13                 |    LRC (8, 2, 1)    |    72,7 %        |
|    14                 |    LRC (8, 2, 1)    |    72,7 %        |
|    15                 |    LRC (8, 2, 1)    |    72,7 %        |
|    16                 |    LRC (8, 2, 1)    |    72,7 %        |

### <a name="dual-parity-efficiency-for-all-flash-deployments"></a>Двойной контроль четности в развертываниях "только на флэш-дисках"

В этой таблице представлены уровни эффективности хранилища для двойного контроля четности и кодов локального восстановления при каждом возможном размере для развертываний "только на флэш-дисках", где используются только твердотельные накопители (SSD). Схема контроля четности позволяет применять более крупные группы и получить более высокую эффективность хранилища в конфигурациях "только на флэш-дисках".

|    Домены сбоя      |    Макет           |    Эффективность   |
|-----------------------|---------------------|-----------------|
|    2                  |    –                |    –            |
|    3                  |    –                |    –            |
|    4                  |    RS 2+2           |    50,0 %        |
|    5                  |    RS 2+2           |    50,0 %        |
|    6                  |    RS 2+2           |    50,0 %        |
|    7                  |    RS 4+2           |    66,7 %        |
|    8                  |    RS 4+2           |    66,7 %        |
|    9                  |    RS 6+2           |    75,0 %        |
|    10                 |    RS 6+2           |    75,0 %        |
|    11                 |    RS 6+2           |    75,0 %        |
|    12                 |    RS 6+2           |    75,0 %        |
|    13                 |    RS 6+2           |    75,0 %        |
|    14                 |    RS 6+2           |    75,0 %        |
|    15                 |    RS 6+2           |    75,0 %        |
|    16                 |    LRC (12, 2, 1)   |    80,0 %        |

## <a name="examples"></a><a name="examples"></a>Примеры

Мы рекомендуем во всех случаях, кроме системы с двумя серверами, применять трехстороннее зеркальное отображение и (или) двойной контроль четности, так как они обеспечивают более высокую отказоустойчивость. В частности, они позволяют гарантировать сохранность всех данных и постоянный доступ к ним даже при сбоях, затрагивающих одновременно два домена сбоя (два сервера в среде Локальных дисковых пространств).

### <a name="examples-where-everything-stays-online"></a>Примеры, в которых сохраняется работоспособность системы

В этих шести примерах показаны проблемы, с которыми **позволяют** справиться технологии трехстороннего зеркального отображения и (или) двойного контроля четности.

- **1.**    Потеря одного диска (в том числе диска кэша)
- **2.**    Потеря одного сервера

![примеры отказоустойчивости 1 и 2](media/fault-tolerance/Fault-Tolerance-Example-12.png)

- **3.**    Потеря одного сервера и еще одного диска
- **4.**    Потеря двух дисков на разных серверах

![примеры отказоустойчивости 3 и 4](media/fault-tolerance/Fault-Tolerance-Example-34.png)

- **5.**    Потеря более чем двух дисков, если они размещаются не более чем на двух серверах
- **6.**    Потеря двух серверов

![примеры отказоустойчивости 5 и 6](media/fault-tolerance/Fault-Tolerance-Example-56.png)

Во всех этих случаях все тома останутся доступными. (Следите за тем, чтобы в кластере соблюдался кворум.)

### <a name="examples-where-everything-goes-offline"></a>Примеры, в которых нарушается работоспособность системы

В долгосрочной перспективе дисковые пространства могут выдержать любое число сбоев, так как полная устойчивость эффективно восстанавливается после каждого сбоя, если на это будет достаточно времени. Но в любой конкретный момент сбой может затрагивать не более двух доменов сбоя. В следующих примерах показаны проблемы, с которыми технологии трехстороннего зеркального отображения и (или) двойного контроля четности **не смогут** справиться.

- **7.** Потеря дисков на трех и более серверах одновременно
- **8.** Потеря трех и более серверов одновременно

![примеры отказоустойчивости 7 и 8](media/fault-tolerance/Fault-Tolerance-Example-78.png)

## <a name="usage"></a>Использование

Изучите руководство [Создание томов в Локальных дисковых пространствах](/windows-server/storage/storage-spaces/create-volumes).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения по темам, которые упоминались в этой статье, вы можете получить в этих статьях:

- [Сведения Microsoft Research об удаляющем кодировании в Azure](https://www.microsoft.com/research/publication/erasure-coding-in-windows-azure-storage/)
- [Коды локального восстановления и тома с ускоренным контролем четности](https://blogs.technet.microsoft.com/filecab/2016/09/06/volume-resiliency-and-efficiency-in-storage-spaces-direct/)
- [Работа с томами через API управления хранилищем](https://blogs.technet.microsoft.com/filecab/2016/08/29/deep-dive-volumes-in-spaces-direct/)
- [Демонстрация эффективности хранилища на Microsoft Ignite 2016](https://www.youtube.com/watch?v=-LK2ViRGbWs&t=36m55s)
- [Предварительная версия калькулятора емкости для Локальных дисковых пространств](https://aka.ms/s2dcalc)
