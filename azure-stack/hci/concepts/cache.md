---
title: Основные сведения о кэше в Azure Stack HCI
description: Сведения о том, как работает запись в кэш и чтение из кэша в Локальных дисковых пространствах и Azure Stack HCI.
author: khdownie
ms.author: v-kedow
ms.topic: article
ms.date: 02/28/2020
ms.openlocfilehash: f1fc40a6475b8e51a063491cc120e2c4236cbeea
ms.sourcegitcommit: a77dea675af6500bdad529106f5782d86bec6a34
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2020
ms.locfileid: "79026100"
---
# <a name="understanding-the-cache-in-azure-stack-hci"></a>Основные сведения о кэше в Azure Stack HCI

>Область применения: Windows Server 2019

[Локальные дисковые пространства](/windows-server/storage/storage-spaces/storage-spaces-direct-overview) содержат встроенный серверный кэш, который позволяет увеличить производительность хранилища. Это большой и сохраняемый кэш для операций чтения *и* записи в режиме реального времени. Этот кэш настраивается автоматически, если включена функция "Локальные дисковые пространства". В большинстве случаев с ним ничего не нужно делать вручную.
Работа кэша зависит от типов существующих дисков.

В следующем видео подробно описаны принципы работы кэширования для Локальных дисковых пространств и некоторые аспекты проектирования.

<strong>Рекомендации по проектированию для Локальных дисковых пространств</strong><br>(20 минут)<br>
<iframe src="https://channel9.msdn.com/Blogs/windowsserver/Design-Considerations-for-Storage-Spaces-Direct/player" width="960" height="540" allowFullScreen frameBorder="0"></iframe>

## <a name="drive-types-and-deployment-options"></a>Типы дисков и варианты развертывания

В настоящее время функция "Локальные дисковые пространства" поддерживает три типа носителей:

<table>
    <tr style="border: 0;">
        <td style="padding: 10px; border: 0; width:70px">
            <img src="media/cache/NVMe-100px.png">
        </td>
        <td style="padding: 10px; border: 0;" valign="middle">
            NVMe (Non-Volatile Memory Express);
        </td>
    </tr>
    <tr style="border: 0;">
        <td style="padding: 10px; border: 0; width:70px">
            <img src="media/cache/SSD-100px.png">
        </td>
        <td style="padding: 10px; border: 0;" valign="middle">
            SATA или SAS SSD (твердотельный накопитель);
        </td>
    </tr>
    <tr style="border: 0;">
        <td style="padding: 10px; border: 0; width:70px">
            <img src="media/cache/HDD-100px.png">
        </td>
        <td style="padding: 10px; border: 0;" valign="middle">
            HDD (жесткий диск).
        </td>
    </tr>
</table>

Их можно сочетать шестью способами, которые мы условно делим на две категории: "только флэш-диски" и "гибридная".

### <a name="all-flash-deployment-possibilities"></a>Возможности развертывания для категории "только флэш-диски"

Развертывания на базе флэш-технологии ориентированны на максимальную производительность хранилища и не используют вращающиеся жесткие диски (HDD).

![Возможности развертывания только на флэш-дисках](media/cache/All-Flash-Deployment-Possibilities.png)

### <a name="hybrid-deployment-possibilities"></a>Возможности развертывания для категории "гибридная"

Гибридные развертывания предназначены для обеспечения баланса производительности и емкости или увеличения емкости и включают в себя вращающиеся жесткие диски (HDD).

![Возможности гибридного развертывания](media/cache/Hybrid-Deployment-Possibilities.png)

## <a name="cache-drives-are-selected-automatically"></a>Диски для кэша выбираются автоматически

В развертываниях с несколькими типами дисков функция "Локальные дисковые пространства" автоматически использует все диски самого "быстрого" типа для кэширования. Остальные диски используются для хранения.

Самый "быстрый" тип определяется в соответствии со следующей иерархией.

![Иерархия типов дисков](media/cache/Drive-Type-Hierarchy.png)

Например, если вы используете NVMe и SSD, диски NVMe будут выполнять роль кэша для SSD.

Если используются SSD и HDD, диски SSD будут выполнять роль кэша для HDD.

   >[!NOTE]
   > Диски кэша не увеличивают пригодный для использования объем хранилища. Все присутствующие в кэше данные хранятся еще где-то или будут сохранены после перемещения на накопительное устройство. Это означает, что общая чистая емкость хранилища, доступная для развертывания, определяется только суммой дисков емкости.

Если все диски имеют одинаковый тип, то кэш не настраивается автоматически. Вы можете вручную настроить диски с меньшим уровнем износа в качестве кэша для дисков того же типа с большим уровнем износа, как описано в разделе [Настройка вручную](#manual-configuration).

   >[!TIP]
   > В развертываниях "только NVMe" или "только SSD", особенно очень малых размеров, можно заметным образом повысить эффективность хранилища, не "тратя" дисковое пространство на кэш.

## <a name="cache-behavior-is-set-automatically"></a>Поведение кэша настраивается автоматически

Поведение кэша определяется автоматически на основе типов дисков, которые кэшируются. При кэшировании твердотельных накопителей (например, кэширование NVMe для дисков SSD) кэшируются только операции записи. При кэшировании жестких дисков (например, кэширование SSD для жестких дисков) кэшируются и операции чтения, и операции записи.

![Поведение кэша при чтении и записи](media/cache/Cache-Read-Write-Behavior.png)

### <a name="write-only-caching-for-all-flash-deployments"></a>Кэширование только для записи в развертываниях "только флэш-диски"

При кэшировании твердотельных накопителей (NVMe или SSD) кэшируются только операции записи. Это уменьшает износ дисков емкости, так как многие записи и повторные записи можно объединять в кэше и перемещать из кэша только по мере необходимости. Это сокращает трафик, передаваемый на диски емкости, и продлевает срок их службы. По этой причине мы рекомендуем выбрать для кэша [диски с высокой устойчивостью к износу и оптимизированные для записи](http://whatis.techtarget.com/definition/DWPD-device-drive-writes-per-day). Диски емкости могут иметь более низкую устойчивость к износу для операций записи, в разумных пределах.

Поскольку операции чтения не влияют существенным образом на срок службы устройств флэш-памяти и все твердотельные накопители обеспечивают низкую задержку чтения, операции чтения не кэшируется. Все они обслуживаются прямо с дисков емкости, кроме недавно записанных данных, которые еще не перемещены с кэша. Это позволяет полностью посвятить кэш обработке операций записи, повышая его эффективность.

Это означает, что характеристики операций записи, например задержка записи, определяются дисками кэша, а характеристики чтения определяются дисками емкости. Это значит, что оба типа операций выполняются согласованно, прогнозируемо и однородно.

### <a name="readwrite-caching-for-hybrid-deployments"></a>Кэширование чтения и записи для гибридных развертываний

При кэшировании жестких дисков (HDD) кэшируются и операции чтения, *и* операции записи, чтобы обеспечить низкую задержку (с улучшением до 10 крат) для обеих операций. Кэш чтения хранит недавно считанные и часто считываемые данные, чтобы ускорить доступ к ним и снизить количество обращений случайного доступа к дискам HDD. (Из-за задержки поиска и ротации, время задержки и потери при случайном доступе к жесткому диску очень велико.) Операции записи кэшируются для обработки пиковых нагрузок и, как и в предыдущем случае, для объединения операций записи и повторной записи для снижения общего количества обращений к дискам емкости.

Локальные дисковые пространства реализуют алгоритм, который дерандомизирует операции записи перед перемещением из кэша на диски емкости, чтобы запись на диск выполнялась последовательно даже при случайном характере операций ввода-вывода реальной рабочей нагрузки (например, трафика от виртуальной машины). Это позволяет повысить количество операций ввода-вывода в секунду и пропускную способность дисков HDD.

### <a name="caching-in-deployments-with-drives-of-all-three-types"></a>Кэширование в развертываниях, где используются все три типа дисков

Если в развертывании присутствуют диски всех трех типов, NVMe выполняют роль кэша одновременно для дисков SSD и дисков HDD. Поведение кэша здесь такое же, как описано выше: для SSD кэшируются только операции записи, а для HDD — операции чтения и записи. Вся нагрузка кэширования для дисков HDD равномерно распределяется между дисками кэша.

## <a name="summary"></a>Сводка

В этой таблице собраны сведения о дисках, которые могут использоваться для кэширования и в качестве дисков емкости, и о поведении кэша в каждом из вариантов развертывания.

| Развертывание     | Диски кэша                        | Диски емкости | Поведение кэша (по умолчанию)  |
| -------------- | ----------------------------------- | --------------- | ------------------------- |
| Все NVMe         | Нет (можно настроить вручную) | NVMe            | Только запись (если настроен)  |
| Все SSD          | Нет (можно настроить вручную) | SSD             | Только запись (если настроен)  |
| NVMe и SSD       | NVMe                                | SSD             | Только запись                  |
| NVMe и HDD       | NVMe                                | HDD             | Чтение и запись                |
| SSD и HDD        | SSD                                 | HDD             | Чтение и запись                |
| NVMe, SSD и HDD | NVMe                                | SSD и HDD       | Чтение и запись для HDD, только запись для SSD  |

## <a name="server-side-architecture"></a>Архитектура на стороне сервера

Кэш реализуется на уровне диска, то есть отдельные диски кэша на одном сервере привязываются к одному или нескольким дискам емкости на том же сервере.

Поскольку такой кэш размещается ниже всех остальных элементов программно-определяемого стека хранилища Windows, он не имеет и не должен иметь никакой информации о любых концепциях, таких как дисковые пространства или отказоустойчивость. Можно рассматривать эту систему как гибридный диск (состоящий из флэш-накопителя и жесткого диска), подключенный к системе Windows. Как и в случае с обычным гибридным диском, перемещение данных между горячим и холодным уровнями доступа, размещенных на быстрых и медленных разделах физического носителя, почти невозможно отследить снаружи этой системы.

Учитывая то, что устойчивость в Локальных дисковых пространствах реализуется не ниже уровня сервера (то есть копии данных всегда записываются на разные серверы, и не более одной копии на сервер), данные в кэше получают все преимущества используемой схемы устойчивости, как и отсутствующие в кэше данные.

![Архитектура кэша на стороне сервера](media/cache/Cache-Server-Side-Architecture.png)

Например, при использовании трехстороннего зеркального отображения три копии данных записываются на разные серверы, где они попадают в кэш. Независимо от того, будут ли они сохранены впоследствии на диски емкости, всегда существуют три копии данных.

## <a name="drive-bindings-are-dynamic"></a>Привязки дисков являются динамическими

Привязки между дисками кэша и емкости могут выполняться в любом соотношении, от "1 к 1" до "1 к 12" и даже более. Они корректируются динамически при любом добавлении и удалении дисков, например при масштабировании и после любых сбоев. Это позволяет вам в любое время на свое усмотрение добавлять любые диски кэша и емкости.

![Динамическая привязка](media/cache/Dynamic-Binding.gif)

Мы рекомендуем поддерживать количество дисков емкости, кратное количеству дисков кэша, чтобы соблюдать симметрию. Например, если вы используете 4 диска кэша, производительность с 8-ю дисками емкости (соотношение "1 к 2") будет более равномерной, чем с 7-ю или 9-ю.

## <a name="handling-cache-drive-failures"></a>Обработка сбоев дисков кэша

В случае сбоя диска кэша все операции записи, еще не переданные на диск емкости, утрачиваются *в контексте локального сервера*, то есть сохраняются только в других копиях на других серверах. Как и при любом другом сбое диска, дисковые пространства могут и будут выполнять автоматическое восстановление из сохранившихся копий.

На короткий период диски емкости, привязанные к утраченному диску кэша, будут отображаться как неработоспособные. Когда завершится автоматическая перепривязка кэша и автоматическое восстановление данных, для дисков емкости восстановится работоспособное состояние.

Именно для того, чтобы сохранить производительность в этом сценарии, нужно предоставить не менее двух дисков кэша на каждый сервер.

![Обработка сбоев](media/cache/Handling-Failure.gif)

После сбоя вы можете заменить пострадавший диск кэша, как при любой обычной замене диска.

   >[!NOTE]
   > Для безопасной замены дисков NVMe форм-фактора Add-In Card (AIC) или M.2 может потребоваться отключение питания.

## <a name="relationship-to-other-caches"></a>Связь с другими кэшами

В программно-определяемом стеке хранилища Windows существует еще несколько уровней кэширования, которые никак не связаны с рассматриваемым. Например, кэш обратной записи дисковых пространств и кэш чтения в памяти для общего тома кластера (CSV).

При использовании Локальных дисковых пространств не следует изменять настройки по умолчанию, заданные для кэша обратной записи дисковых пространств. Например, не следует использовать параметры типа **-WriteCacheSize** в командлете **New-Volume**.

Вы можете на свое усмотрение выбрать, использовать кэш CSV или нет. По умолчанию он отключен для Локальных дисковых пространств, но никак не помешает работе нового кэша, который обсуждается в этой статье. В некоторых сценариях он даже обеспечит заметное повышение производительности. Дополнительные сведения см. в статье [Включение кэша CSV](/windows-server/failover-clustering/failover-cluster-csvs#enable-the-csv-cache-for-read-intensive-workloads-optional).

## <a name="manual-configuration"></a>Настройка вручную

Для большинства развертываний вручную не требуется. Если у вас возникнет эта потребность, изучите следующие разделы. 

Если вам нужно изменить модель устройства для кэша после ее настройки, отредактируйте документ дополнительных компонентов службы работоспособности, как описано в [этом руководстве](/windows-server/failover-clustering/health-service-overview#supported-components-document).

### <a name="specify-cache-drive-model"></a>Выбор модели для диска кэша

Если в развертывании участвуют только диски одного типа (только NVMe или только SSD), кэш для них не настраивается, так как Windows не может автоматически оценить различия дисков одного типа по таким характеристикам, как устойчивость к износу.

Чтобы применить более устойчивые к износу диски для кэша, а менее устойчивые того же типа — для дисков емкости, выберите модель дисков с помощью параметра **-CacheDeviceModel** в командлете **Enable-ClusterS2D**. После включения Локальных дисковых пространств все диски указанной модели будут использоваться для кэширования.

   >[!TIP]
   > Убедитесь, что строка модели в точности соответствует той, которая возвращается командлетом **Get-PhysicalDisk**.

####  <a name="example"></a>Пример

Для начала получите список доступных физических дисков.

```PowerShell
Get-PhysicalDisk | Group Model -NoElement
```

Вот пример выходных данных этой команды:

```
Count Name
----- ----
    8 FABRIKAM NVME-1710
   16 CONTOSO NVME-1520
```

Затем введите следующую команду, чтобы указать модель устройства для кэша:

```PowerShell
Enable-ClusterS2D -CacheDeviceModel "FABRIKAM NVME-1710"
```

Вы можете убедиться, что все выбранные диски используются для кэша, выполнив командлет **Get-PhysicalDisk** в PowerShell, где для каждого из них свойство **Usage** (Использование) должно иметь значение **Journal** (Журнал).

### <a name="manual-deployment-possibilities"></a>Возможности развертывания вручную

Настройка вручную позволяет реализовать следующие возможности развертывания:

![Специфичные возможности развертывания](media/cache/Exotic-Deployment-Possibilities.png)

### <a name="set-cache-behavior"></a>Настройка поведения кэша

Вы можете переопределить поведение кэша, используемое по умолчанию. Например, настроить кэширование операций чтения даже при развертывании только на флэш-дисках. Мы рекомендуем не изменять поведение кэша, если у вас нет четкого понимания, почему вариант по умолчанию не подходит для вашей рабочей нагрузки.

Чтобы переопределить поведение по умолчанию, выполните командлет **Set-ClusterStorageSpacesDirect** с параметрами **-CacheModeSSD** и **-CacheModeHDD**. Параметр **CacheModeSSD** позволяет настроить поведение кэша при кэшировании твердотельных накопителей. Параметр **CacheModeHDD** настраивает поведение кэша при кэшировании жестких дисков. Это можно сделать в любой момент после включения функции "Локальные дисковые пространства".

Проверить текущие настройки поведения можно с помощью командлета **Get-ClusterStorageSpacesDirect**.

#### <a name="example"></a>Пример

Для начала получите параметры Локальных дисковых пространств:

```PowerShell
Get-ClusterStorageSpacesDirect
```

Вот пример выходных данных этой команды:

```
CacheModeHDD : ReadWrite
CacheModeSSD : WriteOnly
```

После этого выполните следующее:

```PowerShell
Set-ClusterStorageSpacesDirect -CacheModeSSD ReadWrite

Get-ClusterS2D
```

Вот пример выходных данных этой команды:

```
CacheModeHDD : ReadWrite
CacheModeSSD : ReadWrite
```

## <a name="sizing-the-cache"></a>Определение размера кэша

Размер кэша следует подбирать так, чтобы он соответствовал объема рабочего набора (объему активно считываемых или записываемых данных в любой конкретный момент) ваших приложений и рабочих нагрузок.

Это особенно важно для гибридных развертываний, содержащих жесткие диски. Если объем рабочих данных превышает размер кэша или его содержимое изменяется слишком быстро, операции чтения будут реже попадать в кэш и операции записи придется более агрессивно перемещать из кэша, что негативно отразится на общей производительности.

В ОС Windows вы можете применить встроенную служебную программу системного монитора PerfMon.exe, чтобы оценить долю промахов кэша. В частности, сравните параметр **Cache Miss Reads/sec** (Чтение без кэша/с) из набора счетчиков **Cluster Storage Hybrid Disk** (Гибридный диск кластерного хранилища) с общим числом операций ввода-вывода в секунду для используемого развертывания. Каждый "Гибридный диск" здесь обозначает один диск емкости.

Например, 2 диска кэша и 4 диска емкости будут отображаться как 4 экземпляра объекта "Гибридный диск" на каждом сервере.

![Системный монитор](media/cache/PerfMon.png)

Не существует универсальных правил, но если слишком много операций чтения не попадают в кэш, его размер может быть недостаточным. Попробуйте добавить диски кэша, чтобы увеличить его объем. Вы можете в любое время на свое усмотрение добавлять диски кэша и емкости.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о хранилище см. тут:

- [Отказоустойчивость и эффективность хранилища](fault-tolerance.md)
- [Кворум кластера и пула носителей](quorum.md)
