---
title: Развертывание службы приложений в автономной среде Azure Stack | Документация Майкрософт
description: Узнайте, как развертывать Службу приложений в автономной среде Azure Stack, защищенной с помощью AD FS.
services: azure-stack
documentationcenter: ''
author: BryanLa
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: app-service
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/29/2019
ms.author: anwestg
ms.reviewer: anwestg
ms.lastreviewed: 01/11/2019
ms.openlocfilehash: 25cb846b8e3a2200636dff0f2acfc25244a5e3d4
ms.sourcegitcommit: e8aa26b078a9bab09c8fafd888a96785cc7abb4d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/01/2019
ms.locfileid: "71709008"
---
# <a name="deploy-app-service-in-an-offline-environment-in-azure-stack"></a>Развертывание Службы приложений в автономной среде Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

> [!IMPORTANT]
> Прежде чем развернуть Службу приложений Azure 1.7, примените обновление 1907 к интегрированной системе Azure Stack или разверните последний Пакет средств разработки Azure Stack (ASDK).

В статье описано, как установить [поставщик ресурсов Службы приложений](azure-stack-app-service-overview.md) в среде Azure Stack, для которой характерно следующее:

- без подключения к Интернету;
- под защитой службы федерации Active Directory (AD FS).

> [!IMPORTANT]
> Перед запуском установщика поставщика ресурсов убедитесь, что выполнены [предварительные требования для развертывания Службы приложений в Azure Stack](azure-stack-app-service-before-you-get-started.md). Рекомендуется также ознакомиться с [заметками о выпуске версии 1.7](azure-stack-app-service-release-notes-update-seven.md), чтобы получить представление о новых функциях, исправлениях и известных проблемах, которые могут повлиять на развертывание.

Чтобы добавить поставщик ресурсов службы приложений в автономное развертывание Azure Stack, необходимо выполнить три задачи верхнего уровня.

1. Подготовьте все [предварительные условия](azure-stack-app-service-before-you-get-started.md) (например, приобретите сертификаты, получение которых может занять несколько дней).
2. [Скачайте файлы установки и вспомогательные файлы и извлеките их](azure-stack-app-service-before-you-get-started.md) на компьютере, который подключен к Интернету.
3. Создайте автономный пакет установки.
4. Запустите файл установщика appservice.exe.

## <a name="create-an-offline-installation-package"></a>Создание автономного пакета установки

Чтобы развернуть Службу приложений в автономной среде, сначала создайте автономный пакет установки на компьютере, подключенном к Интернету.

1. Запустите установщик AppService.exe на компьютере, подключенном к Интернету.

2. Выберите **Дополнительно** > **Создать автономный пакет установки**.

    ![Создание автономного пакета в установщике Службы приложений][1]

3. Установщик службы приложений создаст автономный пакет установки и отобразит путь к нему. Здесь можно выбрать **Открыть папку**, чтобы открыть этот путь в проводнике.

    ![Автономный пакет установки успешно создан в установщике Службы приложений](media/azure-stack-app-service-deploy-offline/image02.png)

4. Скопируйте установщик (файл AppService.exe) и автономный пакет установки на компьютер, где работает Azure Stack.

## <a name="complete-the-offline-installation-of-app-service-on-azure-stack"></a>Завершение автономной установки службы приложений в Azure Stack

1. Запустите файл AppService.exe от имени администратора с компьютера с доступом к конечной точке администратора Azure Resource Manager в Azure Stack.

1. Выберите **Дополнительно** > **Завершение автономной установки**.

    ![Завершение автономной установки в установщике Службы приложений][2]

1. Перейдите к папке с автономным пакетом установки, который вы создали ранее, и нажмите **Далее**.

    ![Определение пути к автономному пакету установки в установщике Службы приложений](media/azure-stack-app-service-deploy-offline/image04.png)

1. Просмотрите и примите условия лицензионного соглашения об использовании программного обеспечения Майкрософт, а затем нажмите **Далее**.

1. Просмотрите и примите условия лицензии сторонних поставщиков и нажмите **Далее**.

1. Убедитесь, что сведения о конфигурации облачной Службы приложений верны. Если во время развертывания Пакета средств разработки Azure Stack использовались настройки по умолчанию, их можно использовать и сейчас. Но если вы указали другие значения при развертывании Azure Stack или выполняете развертываете в интегрированной системе, в этом окне необходимо соответствующим образом изменить значения. Например, если используется суффикс домена mycloud.com, для конечной точки клиента Azure Resource Manager инфраструктуры Azure Stack нужно указать значение `management.<region>.mycloud.com`. Проверьте сведения и нажмите **Далее**.

    ![Настройка облака Службы приложений Azure в установщике Службы приложений][3]

1. На следующей странице:

   a. Нажмите кнопку **Подключить** рядом с полем **Azure Stack Subscriptions** (Подписки Azure Stack). 

   b. Предоставьте учетную запись администратора. Например, cloudadmin@azurestack.local. Введите пароль и затем нажмите **Войти**.

   c. В поле **Azure Stack Subscriptions** (Подписки Azure Stack) выберите **Default Provider Subscription** (Подписка поставщика по умолчанию).
   > [!NOTE]
   > Службу приложений можно развернуть только в **подписке поставщика по умолчанию**.

   d. В поле **Azure Stack Locations** (Расположения Azure Stack) выберите расположение, соответствующее региону, в который выполняется развертывание. Например, для развертывания в ASDK выберите **локальное расположение**.

   д. Щелкните **Далее**.

      ![Подписки и расположения Azure Stack в Установщике службы приложений][4]

1. Вы можете позволить установщику Службы приложений создать виртуальную сеть и связанные подсети. Вы также можете выполнить развертывание в существующей виртуальной сети, как описано в [этой процедуре](azure-stack-app-service-before-you-get-started.md#virtual-network).
   - Чтобы использовать метод с установщиком Службы приложений, выберите **Create VNet with default settings** (Создать виртуальную сеть с параметрами по умолчанию), примите параметры по умолчанию и нажмите **Далее**.
   - Чтобы выполнить развертывание в существующей сети, выберите **Use existing VNet and Subnets** (Использовать существующие виртуальные сети и подсети), а затем выполните следующие действия.
       1. Выберите **группу ресурсов**, которая содержит нужную виртуальную сеть.
       2. Выберите имя **виртуальной сети**, в которой вы хотите выполнить развертывание.
       3. Выберите правильные значения **подсети** для каждой из требуемых подсетей роли.
       4. Щелкните **Далее**.

      ![Сведения о виртуальной сети и подсети в установщике Службы приложений][5]

1. Введите данные для общего файлового ресурса и щелкните **Далее**. В качестве адреса общей папки нужно указать полное доменное имя (FQDN) или IP-адрес файлового сервера. Например, \\\appservicefileserver.local.cloudapp.azurestack.external\websites или \\\10.0.0.1\websites.  Если вы используете подключенный к домену файловый сервер, необходимо указать полное имя пользователя, включая домен. Например, `<myfileserverdomain>\<FileShareOwner>`.

    > [!NOTE]
    > Прежде чем продолжить, программа установки попытается проверить связь с общей папкой. Если же развертывание выполняется в существующей виртуальной сети, установщик, возможно, не сможет подключиться к общей папке и появится предупреждение с вопросом о том, хотите ли вы продолжать. Проверьте сведения об общей папке и продолжите работу, если они верны.

   ![Сведения об общей папке в установщике Службы приложений][8]

1. На следующей странице:
    1. В поле **Identity Application ID** (Идентификатор приложения идентификации) введите GUID приложения, которое вы используете для идентификации (из Azure AD).
    1. В поле **Identity Application certificate file** (Файл сертификата приложения идентификации) введите расположение файла сертификата или перейдите к нему.
    1. В поле **Identity Application certificate password** (Пароль сертификата приложения идентификации) введите пароль для сертификата. Это пароль, который вы сохранили при выполнении скрипта для создания сертификатов.
    1. В поле **Azure Resource Manager root certificate file** (Файл корневого сертификата Azure Resource Manager) введите расположение файла сертификата или перейдите к нему.
    1. Щелкните **Далее**.

    ![Определение идентификатора приложения и сведений о сертификате в установщике Службы приложений][10]

1. В каждом из трех полей файла сертификата нажмите **Обзор** и перейдите к нужному файлу сертификата. Необходимо указать пароль для каждого сертификата. Это те сертификаты, которые вы создали на шаге [создания требуемых сертификатов](azure-stack-app-service-before-you-get-started.md#get-certificates). Когда вы введете всю информацию, нажмите **Далее**.

    | Box | Пример имени файла сертификата |
    | --- | --- |
    | **Файл SSL-сертификата по умолчанию для службы приложений** | \_.appservice.local.AzureStack.external.pfx |
    | **Файл SSL-сертификата API для службы приложений** | api.appservice.local.AzureStack.external.pfx |
    | **Файл SSL-сертификата издателя для службы приложений** | ftp.appservice.local.AzureStack.external.pfx |

    Если при создании сертификатов использовался другой суффикс домена, имена файлов сертификатов не будут содержать *local.AzureStack.external*. Вместо этого используйте сведения о личном домене.

    ![Указание сведений о SSL-сертификате в установщике Службы приложений][11]

1. Введите сведения об SQL Server для экземпляра сервера, используемого для размещения баз данных поставщика ресурсов службы приложений, и нажмите **Далее**. Установщик проверит свойства подключения SQL. Вам **необходимо** указать либо внутренний IP-адрес, либо полное доменное имя сервера SQL Server.

    > [!NOTE]
    > Установщик попытается проверить связь с компьютером, на котором работает SQL Server, прежде чем продолжить. Если же развертывание выполняется в существующей виртуальной сети, установщик, возможно, не сможет подключиться к компьютеру, на котором работает сервер SQL Server, и появится предупреждение с вопросом о том, хотите ли вы продолжать. Проверьте сведения о SQL Server и продолжите работу, если они верны.
    >
    > Начиная с версии Службы приложений Azure в Azure Stack 1.3 установщик проверяет, включен ли параметр автономности базы данных на уровне SQL Server на компьютере, на котором работает SQL Server. Если это не так, появится сообщение со следующим исключением:
    > ```sql
    >    Enable contained database authentication for SQL server by running below command on SQL server (Ctrl+C to copy)
    >    ***********************************************************
    >    sp_configure 'contained database authentication', 1;
    >    GO
    >    RECONFIGURE;
    >    GO
    >    ***********************************************************
    > ```
    > Дополнительные сведения см. в статье [Заметки о выпуске обновления 3 для Службы приложений Azure в Azure Stack](azure-stack-app-service-release-notes-update-three.md).

    ![Ввод сведений о SQL Server в установщике Службы приложений][12]

1. Просмотрите параметры номера SKU и экземпляра роли. По умолчанию указываются минимальное число экземпляров и минимальный номер SKU для каждой роли в развертывании ASDK. Ниже приведена сводка требований к виртуальным ЦП и памяти, чтобы помочь вам спланировать развертывание. Выбрав необходимые значения, нажмите **Далее**.

     > [!NOTE]
     > При использовании рабочих развертываний следуйте инструкциям из руководства по [планированию емкости для ролей сервера службы приложений Azure в Azure Stack](azure-stack-app-service-capacity-planning.md).
     >
     >

    | Роль | Минимальное количество экземпляров | Минимальный номер SKU | Примечания |
    | --- | --- | --- | --- |
    | Controller | 1 | Standard_A2 (2 виртуальных ЦП, 3584 МБ) | Управляет состоянием работоспособности облачной службы приложений и поддерживает его. |
    | Управление | 1 | Standard_A2 (2 виртуальных ЦП, 3584 МБ) | Управляет конечными точками API и Azure Resource Manager для службы приложений и расширениями портала (порталы администратора, клиента и Функций), а также службой данных. Чтобы обеспечить поддержку отработки отказа, увеличьте число экземпляров до двух. |
    | ИЗДАТЕЛЬ | 1 | Standard_A1 (1 виртуальный ЦП, 1792 МБ) | Публикует содержимое через FTP и веб-развертывание. |
    | FrontEnd | 1 | Standard_A1 (1 виртуальный ЦП, 1792 МБ) | Направляет запросы в приложения Службы приложений. |
    | Общая рабочая роль | 1 | Standard_A1 (1 виртуальный ЦП, 1792 МБ) | Размещает веб-приложения или приложения API и приложения Функций Azure. Могут потребоваться дополнительные экземпляры. Оператор может по своему усмотрению сформировать предложение и выбрать любой уровень SKU. Уровни должны иметь как минимум один виртуальный ЦП. |

    ![Установка уровней ролей и параметров SKU в установщике Службы приложений][14]

    > [!NOTE]
    > Служба приложений Azure в Azure Stack *не* поддерживает образ платформы Windows Server 2016 Core.  Не используйте образы пробной версии для развертывания в рабочей среде. Для Службы приложений Azure в Azure Stack требуется, чтобы Microsoft.Net 3.5.1 с пакетом обновления 1 был активирован в образе, который используется для развертывания. Синдицированные в Marketplace образы Windows Server 2016 не поддерживают эту функцию. Поэтому вам придется создать и использовать свой образ Windows Server 2016 с поддержкой этой функции.

1. В поле **Select Platform Image** (Выбор образа платформы) выберите развертываемый образ виртуальной машины Windows Server 2016 из доступных в поставщике вычислительных ресурсов для облачной Службы приложений. Щелкните **Далее**.

1. На следующей странице:
     1. Введите имя пользователя и пароль администратора виртуальной машины с рабочей ролью.
     2. Введите имя пользователя и пароль администратора виртуальной машины с другими ролями.
     3. Щелкните **Далее**.

    ![Ввод учетных данных администратора виртуальной машины с ролями в установщике Службы приложений][16]

1. На странице "Сводка" выполните следующие действия.
    1. Проверьте выбранные параметры. Чтобы внести изменения, используйте кнопки **Назад** для перехода на предыдущие страницы.
    2. Если настройки указаны правильно, установите флажок.
    3. Чтобы начать развертывание, выберите **Далее**.

    ![Сводка параметров, заданных в установщике Службы приложений][17]

1. На следующей странице:
    1. Отслеживайте ход выполнения установки. Развертывание службы приложений в Azure Stack занимает около 60 минут, если выбраны значения по умолчанию.
    2. После завершения установки нажмите **Выйти**.

    ![Отслеживание процесса установки в установщике Службы приложений][18]

## <a name="post-deployment-steps"></a>Действия, выполняемые после развертывания

> [!IMPORTANT]
> Если вы предоставили поставщику ресурсов для Службы приложений экземпляр SQL AlwaysOn, *обязательно* [добавьте базы данных appservice_hosting и appservice_metering в группу доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/availability-group-add-a-database). Также необходимо синхронизировать базы данных, чтобы избежать недоступности службы при отработке отказа базы данных.

Если вы решили выполнить развертывание в существующей виртуальной сети с использованием внутреннего IP-адреса для подключения к файловому серверу, необходимо добавить правило безопасности для исходящего трафика, разрешающее передачу трафика SMB между подсетью рабочей роли и файловым сервером. На портале администрирования перейдите к группе безопасности сети WorkersNsg и добавьте правило безопасности для исходящего трафика со следующими свойствами:

- Источник: Любой
- Диапазон исходных портов: *.
- Назначение: IP-адреса
- Диапазон конечных IP-адресов: диапазон IP-адресов для файлового сервера
- Диапазон конечных портов: 445
- Протокол: TCP
- Действие: РАЗРЕШИТЬ
- Приоритет: 700
- Имя: Outbound_Allow_SMB445

## <a name="validate-the-app-service-on-azure-stack-installation"></a>Проверка установки службы приложений в Azure Stack

1. На портале администрирования Azure Stack выберите **Администрирование > Служба приложений**.

1. В общих сведениях в разделе **Состояние** должно отображаться **Все роли готовы**.

    ![Общие сведения о Службе приложений на портале администрирования](media/azure-stack-app-service-deploy/image12.png)

## <a name="test-drive-app-service-on-azure-stack"></a>Тестовая эксплуатация службы приложений в Azure Stack

После развертывания и регистрации поставщика ресурсов службы приложений проверьте его, чтобы убедиться в том, что пользователи могут развертывать веб-приложения и приложения API.

> [!NOTE]
> Необходимо создать в плане предложение с пространством имен Microsoft.Web. Также вам потребуется подписка клиента, основанная на этом предложении. См. сведения о [создании предложения](azure-stack-create-offer.md) и [создании плана](azure-stack-create-plan.md).
>
> Для создания приложений, использующих Службу приложений в Azure Stack, *нужна* подписка клиента. Операции, которые администратор службы может выполнить на портале администратора, связаны с администрированием поставщика ресурсов службы приложений. Сюда относятся добавление емкости, настройка источников развертывания и добавление уровней рабочей роли и номеров SKU.
>
> Начиная с третьей технической предварительной версии, для создания веб-приложения, приложения API и приложения Функций Azure необходимо использовать портал клиента и иметь подписку клиента.

1. На портале Azure Stack последовательно выберите **+Создать ресурс** > **Интернет и мобильные устройства** > **Веб-приложение**.

1. В колонке **Веб-приложение** введите имя в поле **Веб-приложение**.

1. В разделе **Группа ресурсов** выберите **Создать**. Введите имя в поле **Группа ресурсов**.

1. Выберите **Расположение или план службы приложений** > **Создать**.

1. В колонке **План службы приложений** введите имя в поле **План службы приложений**.

1. Выберите **Ценовая категория** > **Free-Shared** (бесплатный — общий) или **Shared-Shared** (общий — общий) > **Выбрать** > **OK** > **Создать**.

1. Через минуту на панели инструментов появится плитка нового веб-приложения. Выберите плитку.

1. В колонке **Веб-приложение** нажмите **Обзор**, чтобы просмотреть веб-сайт по умолчанию для этого приложения.

## <a name="deploy-a-wordpress-dnn-or-django-website-optional"></a>Развертывание веб-сайта WordPress, DNN или Django (необязательно)

1. На портале клиента Azure Stack нажмите **+** , перейдите к Azure Marketplace, разверните веб-сайт Django и дождитесь успешного завершения этой операции. Веб-платформа Django использует базу данных на основе файловой системы. Дополнительные поставщики ресурсов, такие как SQL или MySQL, не требуются.

1. Если вы уже развернули поставщика ресурсов MySQL, вы можете развернуть из Azure Marketplace веб-сайт WordPress. Когда появится запрос на ввод параметров базы данных, введите имя пользователя в формате *Пользователь1\@Сервер1*, указав имя пользователя и имя сервера по своему усмотрению.

1. Если вы уже развернули поставщика ресурсов SQL Server, вы можете развернуть из Azure Marketplace веб-сайт DNN. Когда появится запрос на ввод параметров базы данных, выберите базу данных на компьютере, где работает подключенный к поставщику ресурсов SQL Server.

## <a name="next-steps"></a>Дополнительная информация

Подготовьтесь к операциям администрирования для Службы приложений в Azure Stack:

- [Планирование ресурсов](azure-stack-app-service-capacity-planning.md)
- [Настройка источников развертывания](azure-stack-app-service-configure-deployment-sources.md)

<!--Image references-->
[1]: ./media/azure-stack-app-service-deploy-offline/app-service-exe-advanced-create-package.png
[2]: ./media/azure-stack-app-service-deploy-offline/app-service-exe-advanced-complete-offline.png
[3]: ./media/azure-stack-app-service-deploy-offline/app-service-azure-stack-arm-endpoints.png
[4]: ./media/azure-stack-app-service-deploy-offline/app-service-azure-stack-subscription-information.png
[5]: ./media/azure-stack-app-service-deploy-offline/app-service-default-VNET-config.png
[6]: ./media/azure-stack-app-service-deploy-offline/app-service-custom-VNET-config.png
[7]: ./media/azure-stack-app-service-deploy-offline/app-service-custom-VNET-config-with-values.png
[8]: ./media/azure-stack-app-service-deploy-offline/app-service-fileshare-configuration.png
[9]: ./media/azure-stack-app-service-deploy-offline/app-service-fileshare-configuration-error.png
[10]: ./media/azure-stack-app-service-deploy-offline/app-service-identity-app.png
[11]: ./media/azure-stack-app-service-deploy-offline/app-service-certificates.png
[12]: ./media/azure-stack-app-service-deploy-offline/app-service-sql-configuration.png
[13]: ./media/azure-stack-app-service-deploy-offline/app-service-sql-configuration-error.png
[14]: ./media/azure-stack-app-service-deploy-offline/app-service-cloud-quantities.png
[15]: ./media/azure-stack-app-service-deploy-offline/app-service-windows-image-selection.png
[16]: ./media/azure-stack-app-service-deploy-offline/app-service-role-credentials.png
[17]: ./media/azure-stack-app-service-deploy-offline/app-service-azure-stack-deployment-summary.png
[18]: ./media/azure-stack-app-service-deploy-offline/app-service-deployment-progress.png
