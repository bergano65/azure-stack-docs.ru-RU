---
title: Развертывание Службы приложений в Azure Stack с использованием конфигурации с высоким уровнем доступности | Документация Майкрософт
description: Сведения о развертывании Службы приложений в Azure Stack с использованием конфигурации с высоким уровнем доступности.
services: azure-stack
documentationcenter: ''
author: BryanLa
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/23/2019
ms.author: anwestg
ms.reviewer: anwestg
ms.lastreviewed: 03/23/2019
ms.openlocfilehash: 77ec512f5e2996aaec53ef77c000d0334bda456a
ms.sourcegitcommit: 245a4054a52e54d5989d6148fbbe386e1b2aa49c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/13/2019
ms.locfileid: "70975213"
---
# <a name="deploy-app-service-in-a-highly-available-configuration"></a>Развертывание Службы приложений в конфигурации с высоким уровнем доступности

В этой статье показано, как использовать элементы Azure Stack Marketplace для развертывания Службы приложений для Azure Stack в конфигурации с высоким уровнем доступности. В дополнение к доступным элементам Marketplace это решение также использует шаблон быстрого запуска Azure Stack [appservice-fileshare-sqlserver-ha](https://github.com/Azure/azurestack-quickstart-templates/tree/master/appservice-fileserver-sqlserver-ha). Этот шаблон автоматизирует создание инфраструктуры с высоким уровнем доступности для размещения поставщика ресурсов Службы приложений. Затем в этой инфраструктуре виртуальных машин с высоким уровнем доступности устанавливается Служба приложений. 

## <a name="deploy-the-highly-available-app-service-infrastructure-vms"></a>Развертывание виртуальных машин инфраструктуры Службы приложений с высоким уровнем доступности
Шаблон быстрого запуска Azure Stack [appservice-fileshare-sqlserver-ha](https://github.com/Azure/azurestack-quickstart-templates/tree/master/appservice-fileserver-sqlserver-ha) упрощает развертывание Службы приложений в конфигурации с высоким уровнем доступности. Службу необходимо развернуть в подписке поставщика по умолчанию. 

При создании настраиваемого ресурса в Azure Stack шаблон создает следующие элементы:
- виртуальную сеть и необходимые подсети;
- группы безопасности сети для подсетей файлового сервера, SQL Server и доменных служб Active Directory (AD DS);
- учетные записи хранения для дисков виртуальной машины и облака-свидетеля кластера;
- одну внешнюю подсистему балансировки нагрузки для виртуальных машин SQL с частным IP-адресом, привязанным к прослушивателю SQL AlwaysOn;
- три группы доступности для AD DS, кластера файлового сервера и кластера SQL;
- кластер SQL из двух узлов;
- кластер файлового сервера из двух узлов;
- два контроллера домена.

### <a name="required-azure-stack-marketplace-items"></a>Необходимые элементы Marketplace для Azure Stack
Перед использованием этого шаблона убедитесь, что в вашем экземпляре Azure Stack доступны следующие [элементы Marketplace для Azure Stack](azure-stack-marketplace-azure-items.md):

- образ основных компонентов Windows Server 2016 Datacenter (для виртуальных машин файлового сервера и AD DS);
- SQL Server 2016 с пакетом обновления 2 (SP2) на базе Windows Server 2016 (Enterprise);
- последняя версия расширения IaaS для SQL; 
- последняя версия расширения PowerShell Desired State Configuration. 

> [!TIP]
> Дополнительные сведения о требованиях к шаблону и значениях по умолчанию см. в [файле сведений о шаблоне](https://github.com/Azure/azurestack-quickstart-templates/tree/master/appservice-fileserver-sqlserver-ha), доступном на сайте GitHub. 

### <a name="deploy-the-app-service-infrastructure"></a>Развертывание инфраструктуры Службы приложений
Выполните действия, описанные в этом разделе, чтобы создать настраиваемое развертывание с помощью шаблона быстрого запуска Azure Stack **appservice-fileshare-sqlserver-ha**.

1. [!INCLUDE [azs-admin-portal](../includes/azs-admin-portal.md)]

2. Выберите **\+** **Создать ресурс** > **Custom** (Пользовательский), а затем **Развертывание шаблона**.

   ![Развертывание настраиваемого шаблона](media/app-service-deploy-ha/1.png)


3. В колонке **Настраиваемое развертывание** выберите **Изменить шаблон** > **Шаблон быстрого запуска**, а затем используйте раскрывающийся список доступных шаблонов, чтобы выбрать шаблон **appservice-fileshare-sqlserver-ha**. Нажмите кнопку **ОК**, а затем — **Сохранить**.

   ![Выбор шаблона быстрого запуска appservice-fileshare-sqlserver-ha](media/app-service-deploy-ha/2.png)

4. В колонке **Настраиваемое развертывание** выберите **Изменить параметры** и прокрутите вниз, чтобы просмотреть значения шаблона по умолчанию. При необходимости измените значения, чтобы предоставить все требуемые сведения о параметрах, а затем нажмите кнопку **ОК**.<br><br> Как минимум, укажите сложные пароли для параметров `ADMINPASSWORD`, `FILESHAREOWNERPASSWORD`, `FILESHAREUSERPASSWORD`, `SQLSERVERSERVICEACCOUNTPASSWORD` и `SQLLOGINPASSWORD`.
    
   ![Изменение параметров настраиваемого развертывания](media/app-service-deploy-ha/3.png)

5. В колонке **Настраиваемое развертывание** выберите значение **Default Provider Subscription** (Подписка поставщика по умолчанию) в качестве используемой подписки. Затем создайте группу ресурсов или выберите имеющуюся группу ресурсов для настраиваемого развертывания.<br><br> Затем выберите расположение группы ресурсов (**локальное** для установки ASDK) и нажмите кнопку **Создать**. Перед началом развертывания шаблона происходит проверка параметров настраиваемого развертывания.

    ![Создание настраиваемого развертывания](media/app-service-deploy-ha/4.png)

6. На портале администрирования выберите **Группы ресурсов**, а затем имя группы ресурсов, которую вы создали для настраиваемого развертывания (в этом примере это **app-service-ha**). Просмотрите состояние развертывания, чтобы убедиться, что все развертывания выполнены успешно.

   > [!NOTE]
   > Развертывание шаблона занимает около часа.

   [![](media/app-service-deploy-ha/5-sm.png "Просмотр состояния развертывания шаблона")](media/app-service-deploy-ha/5-lg.png#lightbox)


### <a name="record-template-outputs"></a>Запись выходных данных шаблона
После успешного развертывания шаблона запишите его выходные данные. Эти сведения нужны для запуска установщика Службы приложений.

Обязательно запишите следующие выходные значения:
- FileSharePath;
- FileShareOwner
- FileShareUser
- SQLserver;
- SQLuser.

Выполните следующие действия, чтобы получить значения выходных данных шаблона:

1. [!INCLUDE [azs-admin-portal](../includes/azs-admin-portal.md)]

2. На портале администрирования выберите **Группы ресурсов**, а затем имя группы ресурсов, которую вы создали для настраиваемого развертывания (в этом примере это **app-service-ha**). 

3. Щелкните **Развертывания** и выберите **Microsoft.Template**.

    ![Развертывание Microsoft.Template](media/app-service-deploy-ha/6.png)

4. После выбора развертывания **Microsoft.Template** щелкните **Выходные данные** и запишите выходные значения параметров шаблона. Эти сведения нужны для развертывания Службы приложений.

    ![Выходные значения параметров](media/app-service-deploy-ha/7.png)


## <a name="deploy-app-service-in-a-highly-available-configuration"></a>Развертывание Службы приложений в конфигурации с высоким уровнем доступности
Выполните действия, описанные в этом разделе, чтобы развернуть Службу приложений для Azure Stack в конфигурации с высоким уровнем доступности на основе шаблона быстрого запуска Azure Stack [appservice-fileshare-sqlserver-ha](https://github.com/Azure/azurestack-quickstart-templates/tree/master/appservice-fileserver-sqlserver-ha). 

Установив поставщик ресурсов службы приложений, можно включить его в свои предложения и планы. Затем пользователи смогут подписаться на службу и приступить к созданию приложений.

> [!IMPORTANT]
> Перед запуском установщика поставщика ресурсов обязательно ознакомьтесь с заметками о выпуске, которые прилагаются к каждому выпуску Службы приложений, чтобы узнать о новых функциях, исправлениях и любых известных проблемах, которые могут повлиять на развертывание.

### <a name="prerequisites"></a>Предварительные требования
Перед запуском установщика Службы приложений необходимо выполнить некоторые шаги, указанные в статье [Подготовка к работе со Службой приложений в Azure Stack](azure-stack-app-service-before-you-get-started.md).

> [!TIP]
> Не все шаги, описанные в статье [Подготовка к работе со службой приложений в Azure Stack](azure-stack-app-service-before-you-get-started.md), являются обязательными, так как при развертывании шаблона виртуальные машины инфраструктуры настраиваются с учетом ваших требований.

- [Скачайте установочный и вспомогательный скрипты для Службы приложений](azure-stack-app-service-before-you-get-started.md#download-the-installer-and-helper-scripts).
- [Скачивание элементов из Azure Stack Marketplace](azure-stack-app-service-before-you-get-started.md#download-items-from-the-azure-marketplace)
- [Создайте необходимые сертификаты](azure-stack-app-service-before-you-get-started.md#get-certificates).
- Создайте приложение удостоверений на основе поставщика удостоверений, выбранного для Azure Stack. Приложения удостоверений можно создать для [Azure AD](azure-stack-app-service-before-you-get-started.md#create-an-azure-active-directory-app) или [служб федерации Active Directory](azure-stack-app-service-before-you-get-started.md#create-an-active-directory-federation-services-app). После создания запишите идентификатор приложения.
- Убедитесь, что образ Windows Server 2016 Datacenter добавлен в Azure Stack Marketplace. Этот образ необходим для установки Службы приложений.

### <a name="steps-for-app-service-deployment"></a>Этапы развертывания Службы приложений
Установка поставщика ресурсов службы приложений занимает не менее часа. Необходимое время зависит от того, сколько экземпляров ролей нужно развернуть. Во время развертывания программа установки выполняет следующие задачи:

- создание контейнера больших двоичных объектов в определенной учетной записи хранения Azure Stack;
- создание зоны DNS и записей для службы приложений;
- регистрацию поставщика ресурсов службы приложений;
- регистрацию элементов коллекции службы приложений.

Чтобы развернуть поставщик ресурсов Службы приложений, выполните следующие действия.

1. Запустите ранее скачанный установщик Службы приложений (файл **appservice.exe**) от имени администратора с компьютера, который имеет доступ к конечной точке управления ресурсами Azure для администрирования Azure Stack.

2. Выберите **Развернуть службу приложений или провести обновление до последней версии**.

    ![Развертывание или обновление Службы приложений](media/app-service-deploy-ha/01.png)

3. Примите условия лицензирования корпорации Майкрософт и щелкните **Далее**.

    ![Условия лицензирования Службы приложений от корпорации Майкрософт](media/app-service-deploy-ha/02.png)

4. Примите условия лицензирования сторонних разработчиков и щелкните **Далее**.

    ![Условия лицензирования Службы приложений от стороннего поставщика](media/app-service-deploy-ha/03.png)

5. Укажите конфигурацию облачной конечной точки Службы приложений для среды Azure Stack.

    ![Конфигурация облачной конечной точки Службы приложений для Службы приложений](media/app-service-deploy-ha/04.png)

6. **Подключитесь** к подписке Azure Stack, которая будет использоваться для установки, и выберите расположение. 

    ![Подключение к подписке Azure Stack для Службы приложений](media/app-service-deploy-ha/05.png)

7. Установите переключатель **Использовать существующие виртуальные сети и подсети** и укажите **имя группы ресурсов**, используемой для развертывания шаблона с высоким уровнем доступности.<br><br>Затем выберите виртуальную сеть, созданную как часть развертывания шаблона, и соответствующие подсети ролей из вариантов в раскрывающихся списках. 

    ![Выбор виртуальной сети для Службы приложений](media/app-service-deploy-ha/06.png)

8. Предоставьте ранее записанные выходные данные шаблона, в частности путь к общей папке и параметры владельца общей папки. По завершении нажмите кнопку **Далее**.

    ![Выходные значения для общей папки для Службы приложений](media/app-service-deploy-ha/07.png)

9. Так как компьютер, на котором установлена Служба приложений, и файловый сервер, на котором размещена общая папка Службы приложений, находятся в разных виртуальных сетях, разрешить имя не удастся. **Это ожидаемая ошибка**.<br><br>Убедитесь, что UNC-путь к общей папке и учетные записи указаны правильно. Затем нажмите кнопку **Да** в диалоговом окне оповещения, чтобы продолжить установку Службы приложений.

    ![Диалоговое окно ожидаемой ошибки для Службы приложений](media/app-service-deploy-ha/08.png)

    Если вы решили выполнить развертывание в имеющуюся виртуальную сеть и использовать внутренний IP-адрес для подключения к файловому серверу, необходимо добавить правило безопасности для исходящего трафика. Это правило разрешает SMB-трафик между рабочей подсетью и файловым сервером. Для этого перейдите к группе безопасности сети WorkersNsg на портале администрирования и добавьте правило безопасности для исходящего трафика со следующими свойствами.
    - Источник: Любой
    - Диапазон исходных портов: *.
    - Назначение: IP-адреса
    - Диапазон конечных IP-адресов: диапазон IP-адресов для файлового сервера
    - Диапазон конечных портов: 445
    - Протокол: TCP
    - Действие: РАЗРЕШИТЬ
    - Приоритет: 700
    - Имя: Outbound_Allow_SMB445

10. Укажите идентификатор приложения удостоверений, а также пути и пароли для сертификатов удостоверений и щелкните **Далее**:
    - сертификат приложения удостоверений (в формате **sso.appservice.local.azurestack.external.pfx**);
    - корневой сертификат Azure Resource Manager (**AzureStackCertificationAuthority.cer**).

    ![Сертификат приложения удостоверений и корневой сертификат для Службы приложений](media/app-service-deploy-ha/008.png)

11. Затем предоставьте остальные необходимые сведения для следующих сертификатов и щелкните **Далее**:
    - SSL-сертификат Azure Stack по умолчанию (в формате **_.appservice.local.azurestack.external.pfx**);
    - SSL-сертификат API (в формате **api.appservice.local.azurestack.external.pfx**);
    - сертификат издателя (в формате **ftp.appservice.local.azurestack.external.pfx**). 

    ![Дополнительные сертификаты конфигурации для Службы приложений](media/app-service-deploy-ha/09.png)

12. Укажите сведения о подключении к SQL Server, используя сведения о подключении из выходных данных развертывания шаблона с высоким уровнем доступности.

    ![Сведения о подключении к SQL Server для Службы приложений](media/app-service-deploy-ha/10.png)

13. Так как компьютер, на котором установлена Служба приложений, и компьютер SQL Server, на котором размещены базы данных Службы приложений, находятся в разных виртуальных сетях, разрешить имя не удастся.  **Это ожидаемое поведение**.<br><br>Убедитесь, что значение, указанное в качестве имени SQL Server, и сведения об учетных записях верны, и нажмите кнопку **Да**, чтобы продолжить установку Службы приложений. Щелкните **Далее**.

    ![Сведения о подключении к SQL Server для Службы приложений](media/app-service-deploy-ha/11.png)

14. Примите значения конфигурации роли по умолчанию или измените их, а затем щелкните **Далее**.<br><br>Мы рекомендуем изменить значения по умолчанию для экземпляров роли инфраструктуры Службы приложений следующим образом:

    |Роль|значение по умолчанию|Рекомендации для конфигурации с высоким уровнем доступности|
    |-----|-----|-----|
    |Роль контроллера|2|2|
    |Роль управления|1|3|
    |Роль издателя|1|3|
    |Роль внешнего интерфейса|1|3|
    |Общая рабочая роль|1|10|
    |     |     |     |

    ![Значения экземпляра роли инфраструктуры для Службы приложений](media/app-service-deploy-ha/12.png)

    > [!NOTE]
    > Изменение значений по умолчанию на рекомендуемые в этом учебнике повысит требования к оборудованию для установки Службы приложений. Для поддержки рекомендованной 21 виртуальной машины требуется 26 ядер и 46 592 МБ ОЗУ вместо 18 ядер и 32 256 МБ ОЗУ по умолчанию, предназначенных для 15 виртуальных машин.

15. Выберите образ платформы, который будет использоваться для установки виртуальных машин инфраструктуры Службы приложений, и щелкните **Далее**:

    ![Выбор образа платформы для Службы приложений](media/app-service-deploy-ha/13.png)

16. Укажите учетные данные роли инфраструктуры Службы приложений и щелкните **Далее**.

    ![Учетные данные роли инфраструктуры для Службы приложений](media/app-service-deploy-ha/14.png)

17. Просмотрите сведения, которые будут использоваться для развертывания Службы приложений, и щелкните **Далее**, чтобы начать развертывание.

    ![Просмотр сводки установки для Службы приложений](media/app-service-deploy-ha/15.png)

18. Следите за ходом выполнения развертывания Службы приложений. Процесс развертывания может занять более часа в зависимости от конкретной конфигурации развертывания и оборудования. После успешной установки выберите **Выйти**.

    ![Установка Службы приложений завершена](media/app-service-deploy-ha/16.png)

## <a name="next-steps"></a>Дополнительная информация

[Добавьте базы данных appservice_hosting и appservice_metering в группу доступности](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/availability-group-add-a-database), если вы предоставили поставщику ресурсов для Службы приложений экземпляр SQL AlwaysOn. Синхронизируйте базы данных, чтобы избежать недоступности службы при отработке отказа базы данных.

[Масштабирование Службы приложений](azure-stack-app-service-add-worker-roles.md). Возможно, вам потребуется добавить дополнительные рабочие роли инфраструктуры в Службу приложений, чтобы удовлетворить ожидаемый спрос на приложения в вашей среде. По умолчанию Служба приложений в Azure Stack поддерживает бесплатные и общие рабочие уровни. Чтобы добавить другие рабочие уровни, вам потребуется больше рабочих ролей.

[Настройка источников развертывания](azure-stack-app-service-configure-deployment-sources.md). Для поддержки развертывания по запросу требуется дополнительная конфигурация от нескольких поставщиков системы управления версиями, таких как GitHub, BitBucket, OneDrive и DropBox.

[Создание резервной копии Службы приложений](app-service-back-up.md) После успешного развертывания и настройки Службы приложений следует создать резервную копию всех компонентов, необходимых для аварийного восстановления. Резервное копирование необходимых компонентов поможет предотвратить потерю данных и избежать простоев во время операций восстановления.
