---
title: Добавление клиентов для контроля потребления и выставления счетов в Azure Stack Hub
description: Узнайте, как добавить клиент для контроля потребления и выставления счетов в Azure Stack Hub.
author: sethmanheim
ms.topic: article
ms.date: 01/24/2020
ms.author: sethm
ms.reviewer: alfredop
ms.lastreviewed: 09/17/2019
ms.openlocfilehash: eb9cc45f3c8de162550cb7f882060a9506831d23
ms.sourcegitcommit: 4ac711ec37c6653c71b126d09c1f93ec4215a489
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2020
ms.locfileid: "77704834"
---
# <a name="add-tenant-for-usage-and-billing-to-azure-stack-hub"></a>Добавление клиентов для контроля потребления и выставления счетов в Azure Stack Hub

В этой статье показано, как добавить клиент в развертывание Azure Stack Hub, управляемое поставщиком облачных решений (CSP). Когда новый клиент потребляет ресурсы, Azure Stack Hub передает информацию об этом в соответствующую подписку CSP.

Поставщики облачных служб (CSP) часто предлагают службы из развертывания Azure Stack Hub сразу нескольким пользователям (клиентам). Чтобы информация о потреблении и выставлении счетов правильно передавалась в подписки CSP, соответствующих клиентов нужно добавить в регистрацию Azure Stack Hub. Если вы не выполните инструкции из этой статьи, плата за потребленные клиентом ресурсы будет взиматься с подписки, которую вы использовали при первоначальной регистрации Azure Stack Hub. Чтобы получить возможность добавлять пользователей в Azure Stack Hub для отслеживания потребления и управления клиентами, следует настроить для Azure Stack Hub роль CSP. Этот процесс и необходимые ресурсы описаны в статье [Управление потреблением и оплатой для Azure Stack в роли поставщика облачных решений](azure-stack-add-manage-billing-as-a-csp.md).

На изображении ниже показаны действия, которые позволяют CSP создать нового пользователя в Azure Stack Hub и настроить для него отслеживание потребления. Добавив пользователя, вы также сможете управлять для него ресурсами Azure Stack Hub. Для управления ресурсами доступны два варианта действий.

- Вы можете поддерживать пользователя и предоставить ему учетные данные для доступа к локальной подписке Azure Stack Hub.  
- Пользователь также может использовать подписку локально, добавив в своей среде гостевой доступ для CSP с правами владельца.

## <a name="add-an-end-customer"></a>Добавление клиента

Перед добавлением пользователя необходимо включить выставление счетов для нескольких клиентов при регистрации. Чтобы включить выставление счетов для нескольких клиентов, отправьте идентификатор подписки регистрации, имя группы ресурсов и имя регистрации по адресу `azstcsp@microsoft.com`. Для включения поддержки мультитенантности обычно требуется 1–2 рабочих дня.

Выполните следующие действия, чтобы добавить клиента, как показано на рисунке ниже.

![Настройка отслеживания потребления и управления учетной записью клиента для поставщика облачных решений](media/azure-stack-csp-enable-billing-usage-tracking/process-csp-enable-billing.png)

### <a name="create-a-new-customer-in-partner-center"></a>Создание клиента в Центре партнеров

В Центре партнеров создайте для клиента новую подписку Azure. Этот процесс описан в статье [Добавление нового клиента](/partner-center/add-a-new-customer).

### <a name="create-an-azure-subscription-for-the-end-customer"></a>Создание подписки Azure для клиента

Создав для клиента запись в Центре партнеров, вы сможете продавать ему подписки на продукты, включенные в каталог. Этот процесс описан в статье [Создание новой подписки](/partner-center/create-a-new-subscription).

### <a name="create-a-guest-user-in-the-end-customer-directory"></a>Создание гостевого пользователя в каталоге клиента

По умолчанию поставщик облачных служб не имеет доступа к подписке пользователя в Azure Stack Hub. Но если пользователь хочет, чтобы вы управляли его ресурсами, он может добавить в свою подписку Azure Stack Hub вашу учетную запись в качестве владельца или участника. Для этого пользователю нужно добавить вашу учетную запись к своему клиенту Azure AD как гостевую. Мы рекомендуем использовать другую учетную запись (отличную от учетной записи поставщика облачных служб Azure) для управления подпиской пользователя в Azure Stack Hub, чтобы вы не потеряли доступ к подписке Azure этого пользователя.

### <a name="update-the-registration-with-the-end-customer-subscription"></a>Добавление подписки клиента в регистрацию

Добавьте сведения о новой подписке пользователя в регистрацию. Теперь Azure будет передавать данные клиента о потреблении ресурсов, используя указанный в центре партнеров идентификатор клиента. Благодаря этому данные каждого пользователя о потреблении ресурсов будут относиться к его подписке CSP. Так будет проще отслеживать потребление и управлять выставлением счетов. Чтобы выполнить этот шаг, нужно [зарегистрировать Azure Stack Hub](azure-stack-registration.md).

1. Откройте Windows PowerShell из командной строки с повышенными привилегиями и выполните следующую команду:  

   ```powershell
   Add-AzureRmAccount
   ```

   >[!Note]
   > Если истек срок сеанса, изменен пароль или вы хотите переключиться на другую учетную запись, перед входом с помощью Add-AzureRmAccount выполните следующий командлет: `Remove-AzureRmAccount-Scope Process`

2. Введите учетные данные Azure.
3. В сеансе PowerShell выполните следующую команду:

   ```powershell
   New-AzureRmResource -ResourceId "subscriptions/{registrationSubscriptionId}/resourceGroups/{resourceGroup}/providers/Microsoft.AzureStack/registrations/{registrationName}/customerSubscriptions/{customerSubscriptionId}" -ApiVersion 2017-06-01
   ```

### <a name="new-azurermresource-powershell-parameters"></a>Параметры команды New-AzureRmResource в PowerShell

В следующем разделе описаны параметры командлета **New-AzureRmResource**:

| Параметр | Описание |
| --- | --- |
|registrationSubscriptionID | Подписка Azure, которая использовалась для первоначальной регистрации Azure Stack Hub.|
| customerSubscriptionID | Подписка Azure (не Azure Stack Hub), принадлежащая пользователю, для которого выполняется регистрация. Необходимо создать в предложении CSP. На практике это осуществляется через Центр партнеров. Если для пользователя создано несколько клиентов Azure Active Directory, подписку нужно создать в том из них, который будет использоваться для входа в Azure Stack Hub. Идентификатор подписки клиента должен состоять из строчных букв. |
| resourceGroup | Группа ресурсов Azure, в которой хранятся данные об этой регистрации. |
| registrationName | Имя регистрации Azure Stack Hub. Это объект, который хранится в Azure. 

> [!NOTE]  
> Клиенты должны быть зарегистрированы в каждом используемом ими экземпляре Azure Stack Hub. Если у вас два развертывания Azure Stack Hub и клиент будет использовать оба, сведения о подписке клиента нужно внести в начальные регистрации для обоих развертываний.

### <a name="onboard-tenant-to-azure-stack-hub"></a>Подключение клиента к Azure Stack Hub

Настройте в Azure Stack Hub поддержку пользователей из нескольких клиентов Azure AD, чтобы они могли использовать службы в Azure Stack Hub. Дополнительные сведения см. в статье [о поддержке мультитенантности в Azure Stack Hub](azure-stack-enable-multitenancy.md).

### <a name="create-a-local-resource-in-the-end-customer-tenant-in-azure-stack-hub"></a>Создание локального ресурса в клиенте Azure Stack Hub, принадлежащем пользователю

Когда вы добавите нового пользователя в Azure Stack Hub или клиентская организация пользователя предоставит вашей гостевой учетной записи права владельца, проверьте возможность создавать ресурсы для этого клиента. Например, можно [создать виртуальную машину Windows на портале Azure Stack Hub](../user/azure-stack-quick-windows-portal.md).

## <a name="next-steps"></a>Дальнейшие действия

- Если в процессе регистрации возникнут ошибки, изучите их с помощью этой [инструкции по ошибкам регистрации клиента](azure-stack-registration-errors.md).
- Дополнительные сведения см. в статье о [потреблении ресурсов и выставлении счетов в Azure Stack Hub](azure-stack-billing-and-chargeback.md).
- Чтобы помочь пользователю добавить вашу учетную запись (CSP) в клиент Azure Stack Hub с правами менеджера, используйте руководство по [предоставлению поставщику облачных решений возможности управлять подпиской Azure Stack Hub](../user/azure-stack-csp-enable-billing-usage-tracking.md).
