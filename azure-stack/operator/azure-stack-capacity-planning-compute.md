---
title: Вычислительные ресурсы Azure Stack Hub
description: Сведения о планировании вычислительной емкости для развертываний Azure Stack Hub.
author: IngridAtMicrosoft
ms.topic: conceptual
ms.date: 03/04/2020
ms.author: inhenkel
ms.reviewer: prchint
ms.lastreviewed: 06/13/2019
ms.openlocfilehash: 3ec8b0b3ac6f4687fd782dfc692f1c705c5ed733
ms.sourcegitcommit: 1fa0140481a483e5c27f602386fe1fae77ad29f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78366353"
---
# <a name="azure-stack-hub-compute-capacity"></a>Вычислительные ресурсы Azure Stack Hub

[Размеры виртуальных машин](https://docs.microsoft.com/azure-stack/user/azure-stack-vm-sizes), которые поддерживаются в Azure Stack Hub, поддерживаются и в Azure. В Azure используется несколько методов ограничения ресурсов. Это предотвращает их чрезмерное использование (на уровне локальных серверов и служб). Если не ограничить потребление ресурсов клиентом, его работа может ухудшиться при чрезмерном использовании ресурсов другими клиентами. Для исходящего трафика виртуальной машины в Azure Stack Hub применяются ограничения пропускной способности, соответствующие ограничениям в Azure. Для ресурсов хранилища в Azure Stack Hub предусмотрены ограничения на число операций ввода-вывода в секунду. Эти ограничения предотвращают чрезмерное использование основных ресурсов клиентами для доступа к хранилищу.

>[!IMPORTANT]
>[Планировщик ресурсов Azure Stack Hub](https://aka.ms/azstackcapacityplanner) не оценивает и не обеспечивает производительность операций ввода-вывода.

## <a name="vm-placement"></a>Размещение виртуальной машины

Подсистема размещения Azure Stack Hub размещает виртуальные машины клиентов на доступных узлах.

В Azure Stack Hub учитываются два фактора при размещении виртуальных машин. Первый — это наличие у узла достаточного объема памяти для такого типа виртуальной машины. Второй — принадлежность виртуальных машин к [группе доступности](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability) или [масштабируемым наборам виртуальных машин](https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview).

Чтобы добиться высокого уровня доступности рабочих систем с несколькими виртуальными машинами в Azure Stack Hub, эти виртуальные машины размещаются в группе доступности, которая распределяет их между несколькими доменами сбоя. Домен сбоя в группе доступности определяется как отдельный узел в единице масштабирования. Azure Stack Hub поддерживает группы доступности с максимально тремя доменами сбоя, что гарантирует согласованность с Azure. Виртуальные машины, размещенные в группе доступности, физически изолированы друг от друга и как можно более равномерно распределяются по нескольким доменам сбоя (узлам Azure Stack Hub). В случае сбоя оборудования виртуальные машины домена со сбоем будут перезапущены в других доменах со сбоем. Они будут храниться в доменах сбоя, отдельных от других виртуальных машин, но, по возможности, в той же группе доступности. Когда работоспособность узла восстанавливается, виртуальные машины перераспределяются, что обеспечивает высокий уровень доступности.  

Масштабируемые наборы виртуальных машин используют группы доступности в серверной части, чтобы каждый экземпляр масштабируемого набора виртуальных машин размещался в домене сбоя. Это означает, что они используют отдельные узлы инфраструктуры Azure Stack Hub. Например, в системе Azure Stack Hub из четырех узлов создание масштабируемого набора виртуальных машин, состоящего из трех экземпляров, может завершиться сбоем из-за того, что емкости четырех узлов будет недостаточно для размещения трех экземпляров масштабируемого набора виртуальных машин на трех отдельных узлах Azure Stack Hub. Кроме того, узлы Azure Stack Hub можно заполнять с разными уровнями нагрузки, прежде чем будет выполнена попытка размещения.

Azure Stack Hub не допускает чрезмерное выделение памяти. При этом допускается интенсивное использование определенного числа физических ядер.

Так как алгоритмы подготовки не учитывают избыточную подготовку виртуальных ядер относительно физических, это отношение в каждом узле может быть разным. Корпорация Майкрософт не предоставляет рекомендации по соотношению физических и виртуальных ядер из-за отличающихся рабочих нагрузок и требований к уровню обслуживания.

## <a name="consideration-for-total-number-of-vms"></a>Рекомендации по общему числу виртуальных машин

Существует новый подход для точного планирования ресурсов Azure Stack Hub. Ограничение на количество создаваемых виртуальных машин было введено в обновлении 1901 и будет действовать во всех последующих обновлениях. Данное ограничение является временным и предназначено для предотвращения сбоев в решении. Источник ошибок стабильности при большом количестве виртуальных машин обрабатывается, но точное время его устранения еще не установлено. Сейчас действует ограничение в 60 виртуальных машин на один сервер, а максимальное общее число виртуальных машин равно 700. Например, для восьми серверов ограничение составит 480 (8 * 60) виртуальных машин Azure Stack Hub. Для количества серверов от 12 до 16 в решении Azure Stack Hub это ограничение составит 700. Ограничение было создано, чтобы учесть все возможные вычислительные мощности, например, резерв для устойчивости и соотношение виртуальных и физических ресурсов ЦП, которое оператор хотел бы сохранить в единице масштабирования. Дополнительные сведения см. в разделе о новом выпуске планировщика ресурсов.

Если предел масштабирования виртуальной машины достигнут, будут возвращены следующие коды ошибок: `VMsPerScaleUnitLimitExceeded`, `VMsPerScaleUnitNodeLimitExceeded`.

## <a name="considerations-for-deallocation"></a>Рекомендации по освобождению

Если виртуальная машина находится в _освобожденном_ состоянии, ресурсы памяти не используются. Это позволяет разместить в системе другие виртуальные машины.

Если виртуальная машина, распределение которой было отменено, снова запускается, то она использует память или выделенные ресурсы как новая виртуальная машина в системе и потребляет доступную память.

Если доступной памяти нет, виртуальная машина не запустится.

## <a name="azure-stack-hub-memory"></a>Память для Azure Stack Hub

Azure Stack Hub поддерживает работу виртуальных машин, которые были успешно подготовлены. Например, если узел отключится из-за сбоя оборудования, Azure Stack Hub попытается перезапустить его виртуальную машину на другом узле. Второй пример — установка исправлений и обновлений программного обеспечения Azure Stack Hub. Если нужно перезагрузить физический узел, будет предпринята попытка переместить виртуальные машины, работающие на этом узле, на другой узел, доступный в решении.

Такое управление виртуальными машинами или их перемещение возможно только при наличии зарезервированного объема памяти для перезапуска или миграции. Часть всей памяти узла резервируется и становится недоступной для размещения виртуальной машины клиента.

Вы можете просмотреть на портале администрирования круговую диаграмму, на которой показана неиспользуемая и используемая в Azure Stack Hub память. На схеме ниже показан объем физической памяти в единице масштабирования Azure Stack Hub в системе Azure Stack Hub:

![Управление емкостью физической памяти в единице масштабирования Azure Stack Hub](media/azure-stack-capacity-planning/physical-memory-capacity.png)

Используемая память состоит из нескольких компонентов. Следующие компоненты используют память в соответствующем разделе круговой диаграммы:  

- **Использование или резервирование узла ОС.** Это объем памяти, используемый операционной системой (ОС) узла, таблицами страниц виртуальной памяти, процессами в ОС узла, а также кэшем памяти Локальных дисковых пространств. Так как это значение зависит от памяти, используемой другими работающими на узле процессами Hyper-V, оно может меняться.
- **Службы инфраструктуры.** Это виртуальные машины инфраструктуры, на которых основана система Azure Stack Hub. В выпуске Azure Stack Hub 1904 для нее выделяется примерно 31 виртуальная машина. Вместе они потребляют примерно 242 ГБ (4 ГБ x число узлов) памяти. Объем памяти, используемый компонентом служб инфраструктуры, может измениться, так как мы работаем над улучшением масштабируемости и устойчивости служб инфраструктуры.
- **Резерв для устойчивости.** Azure Stack Hub резервирует часть памяти для обеспечения доступности арендатора при сбое одного узла, а также во время установки исправлений и обновлений для успешной динамической миграции виртуальных машин.
- **Виртуальные машины арендатора.** Это виртуальные машины арендатора, созданные пользователями Azure Stack Hub. Наряду с работающими виртуальными машинами память также потребляют виртуальные машины, которые работают в структуре. Это означает, что виртуальные машины, которые находятся в состоянии "Создание" или "Сбой" либо работа которых завершена из гостевой ОС, также будут потреблять память. При этом виртуальные машины, распределение которых было отменено путем остановки с помощью портала, PowerShell или интерфейса командной строки, не потребляют память Azure Stack Hub.
- **Поставщики дополнительных ресурсов.** К ним относятся виртуальные машины, развернутые для поставщиков дополнительных ресурсов, например для SQL, MySQL, Службы приложений и т. д.

Лучший способ оценить потребление памяти на портале — воспользоваться [планировщиком ресурсов Azure Stack Hub](https://aka.ms/azstackcapacityplanner) и оценить влияние разных рабочих нагрузок. Следующие вычисления соответствуют расчетам планировщика.

Это вычисление позволяет рассчитать общий объем доступной памяти для размещения виртуальных машин арендатора. Этот объем памяти предназначен для всей единицы масштабирования Azure Stack Hub.

Доступный объем памяти для размещения виртуальных машин = общий объем памяти на узле – резерв для устойчивости – объем памяти, используемый работающими виртуальными машинами клиента – служебная память для инфраструктуры Azure Stack Hub <sup>1</sup>

Резерв устойчивости = H + R * ((N-1) * H) + V * (N-2)

> Где:
> -    H = размер памяти на одном сервере
> - N = размер единицы масштабирования (число серверов)
> -    R = резерв для нагрузки ОС, который составляет 0,15 в этой формуле <sup>2</sup>
> -    V = самая большая виртуальная машина в единице масштабирования

<sup>1</sup> Служебная память для инфраструктуры Azure Stack: примерно 242 ГБ (4 ГБ x число узлов). Для размещения инфраструктуры Azure Stack Hub используется приблизительно 31 виртуальная машина. Все они в совокупности потребляют примерно 242 ГБ памяти (4 ГБ х число узлов) и имеют 146 виртуальных ядер. Такое количество виртуальных машин обусловлено необходимостью в разделении служб с целью удовлетворить требованиям к безопасности, масштабируемости, обслуживанию и применению исправлений. Внутренняя структура служб позволяет вводить в будущем новые службы инфраструктуры по мере их разработки.

<sup>2</sup> Резерв для нагрузки ОС составляет 15 % (0,15) памяти узла. Значение резерва операционной системы является приблизительным и зависит от объема физической памяти на сервере и общих накладных расходов операционной системы.

Значение V (самая большая виртуальная машина в единице масштабирования) меняется динамически в зависимости от максимального размера памяти виртуальной машины в клиенте. Например, это значение может быть равно 7 ГБ, 112 ГБ или соответствовать другому размеру памяти виртуальной машины, поддерживаемому решением Azure Stack Hub. Изменение самой большой виртуальной машины в структуре Azure Stack приведет к увеличению резерва для устойчивости, а также увеличению объема памяти самой виртуальной машины.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

**Вопрос**. Мой арендатор развернул новую виртуальную машину. Сколько времени потребуется на то, чтобы на диаграмме возможностей на портале администрирования отобразилась оставшаяся емкость?

**Ответ**. Колонка емкости обновляется каждые 15 минут, поэтому учитывайте это при оценке доступной емкости.

**Вопрос**. Число развернутых виртуальных машин в Azure Stack Hub осталось прежним, но объем доступной емкости меняется. Почему?

**Ответ**. Объем доступной памяти для размещения виртуальных машин зависит от множества факторов, одним из которых является резерв ОС узла. Это значение зависит от памяти, используемой другими работающими на узле процессами Hyper-V, объем которой может меняться.

**Вопрос**. Какое состояние должны иметь виртуальные машины арендатора для потребления памяти?

**Ответ**. Наряду с работающими виртуальными машинами память также потребляют виртуальные машины, которые работают в структуре. Это означает, что виртуальные машины, которые находятся в состоянии "Создание" или "Сбой", будут потреблять память. Виртуальные машины, работа которых была завершена из гостевой ОС (а не путем отмены распределения с помощью портала, PowerShell или интерфейса командной строки), будут потреблять память.

**Вопрос**. У меня есть среда Azure Stack Hub с 4 узлами. У моего арендатора три виртуальные машины (D5_v2), которые используют по 56 ГБ ОЗУ. Размер одной из виртуальных машин был увеличен до 112 ГБ ОЗУ (D14_v2), а в колонке емкости на панели мониторинга значение доступной памяти уменьшилось на 168 ГБ. Последующее изменение размера двух других виртуальных машин D5_v2 до размера D14_v2 привело к увеличению потребления памяти всего на 56 ГБ ОЗУ для каждой из виртуальных машин. Чем это обусловлено?

**Ответ**. Объем доступной памяти определяется резервом для устойчивости Azure Stack Hub. Резерв для устойчивости в свою очередь определяется по размеру крупнейшей виртуальной машины в метке Azure Stack Hub. Изначально самая крупная виртуальная машина в метке занимала 56 ГБ. После изменения размера виртуальной машины до 112 ГБ увеличился не только объем памяти, используемый такой виртуальной машиной клиента, но и объем резерва для устойчивости. В итоге значение увеличилось на 56 ГБ (разница при изменении размера виртуальной машины клиента с 56 до 112 ГБ) плюс 112 ГБ резерва для устойчивости. При последующем изменении размера виртуальных машин объем памяти, используемой крупнейшей виртуальной машиной, не менялся, поэтому общий резерв для устойчивости также не увеличивался. Объем потребляемой памяти изменился только с учетом увеличения размера виртуальной машины клиента (56 ГБ).

> [!NOTE]
> Требования к планированию ресурсов для сети минимальны, так как настраивается только размер общедоступного виртуального IP-адреса. Ознакомьтесь с дополнительными сведениями о [добавлении общедоступных IP-адресов в Azure Stack Hub](azure-stack-add-ips.md).

## <a name="next-steps"></a>Дальнейшие действия
Изучите информацию [о хранилище Azure Stack Hub](azure-stack-capacity-planning-storage.md).
