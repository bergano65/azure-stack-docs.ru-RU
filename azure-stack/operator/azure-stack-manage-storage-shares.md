---
title: Управление емкостью хранилища в Azure Stack Hub
description: Узнайте, как отслеживать емкость и доступность хранилища и управлять ими в Azure Stack Hub.
author: mattbriggs
ms.topic: conceptual
ms.date: 1/22/2020
ms.author: mabrigg
ms.reviewer: xiaofmao
ms.lastreviewed: 03/19/2019
ms.openlocfilehash: 2d7db8ade21580af67c0a1b3f3783f694544f5e0
ms.sourcegitcommit: fd5d217d3a8adeec2f04b74d4728e709a4a95790
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2020
ms.locfileid: "76881998"
---
# <a name="manage-storage-capacity-for-azure-stack-hub"></a>Управление емкостью хранилища для Azure Stack Hub

Сведения в этой статье помогают оператору облака Azure Stack Hub отслеживать емкость хранилища развертывания Azure Stack Hub и управлять ею. Инфраструктура хранилища Azure Stack Hub выделяет для развертывания Azure Stack Hub часть от общей емкости хранилища для использования **службами хранения**. Службы хранения сохраняют данные клиента в общих ресурсах на томах, которые соответствуют узлам развертывания.

Как у оператора облака, у вас есть ограниченный объем хранилища для работы. Объем хранилища определяется реализуемым решением. Решение предоставляется поставщиком OEM при использовании решения с несколькими узлами или оборудованием, на котором устанавливается Пакет средств разработки Azure Stack (ASDK).

Так как Azure Stack Hub не поддерживает расширение емкости хранилища, для обеспечения эффективной работы важно [отслеживать](#monitor-shares) доступный объем хранилища.

Когда остается ограниченный объем емкости общего ресурса, запланируйте [управление пространством](#manage-available-space), чтобы предотвратить нехватку емкости в общих ресурсах.

Варианты управления емкостью включают:
- Освобождение емкости
- Перенос контейнера

Если общий ресурс используется полностью, служба хранения больше не функционирует для него. Чтобы получить помощь в восстановлении операций для общих ресурсов, обратитесь в службу поддержки Майкрософт.

## <a name="understand-volumes-and-shares-containers-and-disks"></a>Общие сведения о томах, общих ресурсах, контейнерах и дисках
### <a name="volumes-and-shares"></a>Тома и общие ресурсы
*Служба хранения* разделяет доступное хранилище на равнозначные тома, которые выделены для хранения данных клиента. Количество томов равно количеству узлов в развертывании Azure Stack Hub:

- В развертывании с четырьмя узлами есть четыре тома. Каждый том имеет один общий ресурс. В развертывании с несколькими узлами число общих ресурсов не уменьшается, если узел удален или неисправен.
- При использовании ASDK существует один том с одной общей папкой.

Так как общие ресурсы службы хранения предназначены для монопольного использования этими службами, не нужно напрямую изменять, добавлять или удалять какие-либо файлы в общих ресурсах. Только службы хранения должны работать с файлами, хранящимися в этих томах.

Общие ресурсы в томах хранят данные клиента. К данным клиента относятся страничные BLOB-объекты, блочные BLOB-объекты, добавочные большие двоичные объекты, таблицы, очереди, базы данных и связанные хранилища метаданных. Так как объекты хранилища (большие двоичные объекты и т. д.) по отдельности находятся в одном общем ресурсе, максимальный размер каждого объекта не может превышать размер общего ресурса. Максимальный размер новых объектов зависит от емкости, которая остается в общем ресурсе в качестве неиспользуемого пространства при создании нового объекта.

Если у общего ресурса недостаточно свободного места, а вы не пробовали или не можете [освободить](#reclaim-capacity) место, оператор облака Azure Stack Hub может переносить контейнеры больших двоичных объектов из одного общего ресурса в другой.

- См. дополнительные сведения о том, как пользователи клиента взаимодействуют с [хранилищем BLOB-объектов в Azure Stack Hub](/azure-stack/user/azure-stack-storage-overview#azure-stack-storage-services).


### <a name="containers"></a>Контейнеры
Пользователи клиента создают контейнеры, которые затем используются для хранения данных больших двоичных объектов. Пока пользователь решает, в каком контейнере размещать большие двоичные объекты, служба хранения использует алгоритм, чтобы определить, в каком томе разместить контейнер. Алгоритм обычно выбирает том с наибольшим количеством свободного места.  

Большой двоичный объект после размещения в контейнере может увеличиться и занимать больше места. По мере добавления новых больших двоичных объектов и увеличения имеющихся доступное пространство в томе, который содержит этот контейнер, уменьшается.  

Контейнеры не ограничены одним общим ресурсом. Когда объединенные данные большого двоичного объекта в контейнере растут и используют 80 % свободного места и более, контейнер переходит в режим *переполнения*. В режиме переполнения все большие двоичные объекты, созданные в этом контейнере, выделяются на другой том, где есть достаточно места. Со временем контейнер в режиме переполнения сможет иметь большие двоичные объекты, распределенные между несколькими томами.

Если 80 %, а затем 90 % доступного места в томе используется, система вызывает оповещения на портале администратора Azure Stack Hub. Операторам облака необходимо просмотреть доступную емкость хранилища и запланировать перераспределение содержимого. Служба хранения перестает работать, когда диск используется на 100 %. Никакие дополнительные оповещения не поступают.

### <a name="disks"></a>Диски
Диски виртуальных машин добавляются в контейнеры клиентами и включают в себя диск операционной системы. Виртуальные машины также могут иметь один или несколько дисков данных. Оба типа дисков хранятся в качестве страничных BLOB-объектов. Клиенты должны размещать каждый диск в отдельном контейнере для повышения производительности виртуальной машины.

- Каждый контейнер, хранящий диск виртуальной машины (страничный BLOB-объект), считается присоединенным контейнером к виртуальной машине, которой принадлежит диск.
- Контейнер, который не содержит дисков из виртуальной машины, считается свободным контейнером.

Варианты освобождения места в прикрепленном контейнере [ограничены](#move-vm-disks).

>[!TIP]  
> Операторы облака напрямую не управляют дисками, подключаемыми к виртуальным машинам, которые клиенты могут добавить в контейнер. Однако при планировании управления пространством в общих ресурсах хранения важно понимать, как диски относятся к контейнерам и общим ресурсам.

## <a name="monitor-shares"></a>Мониторинг общих ресурсов
Используйте PowerShell или портал администратора для мониторинга общих ресурсов, чтобы знать, когда свободное пространство ограничено. При использовании портала можно получать оповещения об общих ресурсах, в которых мало места.

### <a name="use-powershell"></a>Использование PowerShell
Оператор облака может отслеживать емкость хранения в общем ресурсе с помощью командлета PowerShell **Get-AzsStorageShare**. Командлет Get-AzsStorageShare возвращает общее, выделенное и свободное место в байтах для каждого общего ресурса.

![Пример Возвращение показателя свободного места для общих ресурсов](media/azure-stack-manage-storage-shares/free-space.png)

- **Общая емкость** — это общее место в байтах, доступное в общем ресурсе. Это пространство используется для данных и метаданных, обрабатываемых службами хранения.
- **Используемая емкость** — это объем данных в байтах, используемый всеми экстентами из файлов, в которых хранятся данные клиента и связанные метаданные.

### <a name="use-the-administrator-portal"></a>Использование портала администрирования
Облачный оператор может использовать портал администрирования для просмотра емкости всех общих ресурсов.

1. Войдите на [портал администрирования](https://adminportal.local.azurestack.external).
2. Выберите **Все службы** > **Хранилище** > **Общие папки**, чтобы открыть список общих папок, в котором можно просмотреть сведения об использовании.

    ![Пример Общие файловые ресурсы хранилища на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/storage-file-shares.png)

   - **Всего**. Это общее место в байтах, доступное в общем ресурсе. Это пространство используется для данных и метаданных, обрабатываемых службами хранения.
   - **Используется**. Это объем данных в байтах, используемый всеми экстентами из файлов, в которых хранятся данные клиента и связанные метаданные.

### <a name="storage-space-alerts"></a>Оповещения о дисковом пространстве
При использовании портала администрирования можно получать оповещения об общих ресурсах, в которых мало места.

> [!IMPORTANT]
> Как оператор облака предотвращайте полное использование общих ресурсов. Если общий ресурс используется полностью, служба хранения больше не функционирует для него. Чтобы освободить пространство и восстановить операции в общем ресурсе, который полностью используется, нужно обратиться в службу поддержки Майкрософт.

**Предупреждение!** Когда общий файловый ресурс используется на более чем 80 %, вы получите оповещение типа *Предупреждение* на портале администрирования.

![Пример Предупреждающее оповещение на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/alert-warning.png)

**Критический.** Когда общий файловый ресурс используется на более чем 90 %, вы получите оповещение типа *Критическое* на портале администрирования.

![Пример Критическое оповещение на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/alert-critical.png)

**Просмотр сведений**. На портале администрирования можно открыть область сведений для просмотра параметров устранения оповещения. ![Пример. Просмотр сведений об оповещении на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/alert-details.png)

## <a name="manage-available-space"></a>Управление доступным местом
Когда необходимо освободить место в общем ресурсе, сначала используйте наименее агрессивные методы. Например, попробуйте освободить место, прежде чем переносить контейнер.  

### <a name="reclaim-capacity"></a>Освобождение емкости
*Этот вариант применяется как для развертываний с несколькими узлами, так и к Пакету средств разработки Azure Stack.*

Можно освободить емкость, используемую учетными записями клиента, которые были удалены. Эта емкость автоматически освобождается при истечении [срока хранения данных](azure-stack-manage-storage-accounts.md#set-the-retention-period) (или же вы можете немедленно освободить ее).

Дополнительные сведения см. в разделе [Освобождение емкости](azure-stack-manage-storage-accounts.md#reclaim) в статье "Управление учетными записями хранения в Azure Stack".

### <a name="migrate-a-container-between-volumes"></a>Перенос контейнера между томами
*Этот параметр применяется только к интегрированным системам Azure Stack Hub.*

Из-за шаблонов использования клиентами некоторые клиентские общие ресурсы используют больше места, чем другие. В результате в общем ресурсе может заканчиваться свободное пространство, тогда как другие общие ресурсы практически не используются.

Можно попробовать освободить место в общих ресурсах с большой нагрузкой вручную, перенеся некоторые контейнеры больших двоичных объектов в другой общий ресурс. Несколько контейнеров меньшего размера можно перенести в один общий ресурс, где достаточно места, чтобы хранить их все. Используйте миграцию для перемещения *свободных* контейнеров. Свободные контейнеры — это контейнеры, которые не содержат диски виртуальных машин.

Миграция объединяет все большие двоичные объекты контейнера в новом общем ресурсе.

- Если контейнер перешел в режим переполнения и поместил большие двоичные объекты в дополнительные тома, в новом общем ресурсе должно быть достаточно емкости для хранения всех больших двоичных объектов контейнера, который нужно перенести. Сюда входят большие двоичные объекты, расположенные в дополнительных общих ресурсах.

- Командлет PowerShell *Get-AzsStorageContainer* определяет только пространство, используемое в изначальном томе контейнера. Он не определяет пространство, которое используется большими двоичными объектами, помещенными в дополнительные тома. Поэтому полный размер контейнера может быть не очевиден. Консолидация контейнера в новом общем ресурсе может вызвать состояние переполнения ресурса, и данные будут помещаться в дополнительные общие ресурсы. В результате может потребоваться повторно перераспределить общие ресурсы.

- Если разрешения на использование группы ресурсов отсутствуют и вы не можете использовать PowerShell для запроса дополнительных томов для избыточных данных, совместно с владельцем этих групп ресурсов и контейнеров оцените общий объем данных для переноса, прежде чем переносить их.  

> [!IMPORTANT]
> Перенос больших двоичных объектов для контейнера является автономной операцией, требующей использования PowerShell. До завершения переноса все большие двоичные объекты для переносимого контейнера остаются в автономном режиме и не могут использоваться. Также не следует обновлять Azure Stack Hub до завершения всей текущей миграции.

#### <a name="to-migrate-containers-using-powershell"></a>Перенос контейнеров с помощью PowerShell
1. Проверьте, [установлена и настроена ли среда Azure PowerShell](https://azure.microsoft.com/documentation/articles/powershell-install-configure/). Дополнительные сведения см. в статье [Использование Azure PowerShell с диспетчером ресурсов Azure](https://go.microsoft.com/fwlink/?LinkId=394767).
2. Изучите контейнер, чтобы понять, какие данные находятся в общем ресурсе, который планируется перенести. Чтобы определить наиболее подходящие для переноса контейнеры в томе, используйте командлет **Get-AzsStorageContainer**:

   ```powershell  
   $farm_name = (Get-AzsStorageFarm)[0].name
   $shares = Get-AzsStorageShare -FarmName $farm_name
   $containers = Get-AzsStorageContainer -ShareName $shares[0].ShareName -FarmName $farm_name
   ```
   Затем проверьте значение $containers:

   ```powershell
   $containers
   ```

   ![Пример. $Containers](media/azure-stack-manage-storage-shares/containers.png)

3. Определите наиболее подходящие общие ресурсы назначения для хранения контейнера, который переносится:

   ```powershell
   $destinationshare = ($shares | Sort-Object FreeCapacity -Descending)[0]
   ```

   Затем проверьте значение $destinationshares:

   ```powershell 
   $destinationshares
   ```

   ![Пример. $destination shares](media/azure-stack-manage-storage-shares/examine-destinationshares.png)

4. Запустите перенос контейнера. Перенос выполняется асинхронно. Если вы начнете миграцию дополнительных контейнеров до завершения первой миграции, используйте идентификатор задания, чтобы отслеживать состояние каждого задания.

   ```powershell
   $job_id = Start-AzsStorageContainerMigration -StorageAccountName $containers[0].Accountname -ContainerName $containers[0].Containername -ShareName $containers[0].Sharename -DestinationShareUncPath $destinationshares[0].UncPath -FarmName $farm_name
   ```

   Затем проверьте значение $jobId. В следующем примере замените *d62f8f7a-8b46-4f59-a8aa-5db96db4ebb0* идентификатором задания, которое нужно просмотреть:

   ```powershell
   $jobId
   d62f8f7a-8b46-4f59-a8aa-5db96db4ebb0
   ```

5. Используйте идентификатор задания, чтобы проверить состояние задания переноса. По завершении переноса параметру **MigrationStatus** присваивается значение **Complete**.

   ```powershell 
   Get-AzsStorageContainerMigrationStatus -JobId $job_id -FarmName $farm_name
   ```

   ![Пример Состояние миграции](media/azure-stack-manage-storage-shares/migration-status1.png)

6. Вы можете отменить выполняющиеся задания переноса. Отмененные задания переноса обрабатываются асинхронно. Отслеживать отмену можно с помощью $jobid:

   ```powershell
   Stop-AzsStorageContainerMigration -JobId $job_id -FarmName $farm_name
   ```

   ![Пример Состояние отката](media/azure-stack-manage-storage-shares/rollback.png)

7. Вы можете выполнить команду из шага 6 еще раз, пока состояние задания переноса не получит значение **Canceled**:  

    ![Пример Состояние "Canceled" (Отменено)](media/azure-stack-manage-storage-shares/cancelled.png)

### <a name="move-vm-disks"></a>Перемещение дисков виртуальной машины
*Этот параметр применяется только к интегрированным системам Azure Stack Hub.*

Перемещение дисков виртуальной машины применяется как метод управления пространством в крайнем случае. Так как перемещение вложенного контейнера (содержащего диск виртуальной машины) является сложной задачей, обратитесь в службу поддержки Майкрософт, чтобы выполнить это действие.

## <a name="next-steps"></a>Next Steps
Дополнительные сведения о [предложениях виртуальных машин для пользователей](azure-stack-tutorial-tenant-vm.md).
