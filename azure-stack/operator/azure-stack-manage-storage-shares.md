---
title: Управление емкостью хранилища в Azure Stack Hub
description: Узнайте, как отслеживать емкость и доступность хранилища и управлять ими в Azure Stack Hub.
author: mattbriggs
ms.topic: conceptual
ms.date: 1/22/2020
ms.author: mabrigg
ms.reviewer: xiaofmao
ms.lastreviewed: 03/19/2019
ms.openlocfilehash: b97d8e6dcb3069ec7d693f9dfc8677947de019fb
ms.sourcegitcommit: 0a3c8b0bf9c116a5caaeca453a2bbc6e7f7cbfb9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2020
ms.locfileid: "77147870"
---
# <a name="manage-storage-capacity-for-azure-stack-hub"></a>Управление емкостью хранилища для Azure Stack Hub

Эта статья поможет операторам облака Azure Stack Hub отслеживать емкость хранилища развертывания Azure Stack Hub и управлять ею. Инфраструктура хранилища Azure Stack Hub выделяет для развертывания Azure Stack Hub часть общей емкости хранилища в качестве *служб хранения*. Службы хранения сохраняют данные арендатора в общих ресурсах на томах, которые соответствуют узлам развертывания.

Как у оператора облака, у вас есть ограниченный объем хранилища для работы. Объем хранилища определяется реализуемым решением. Решение предоставляется поставщиком изготовителя оборудования при использовании решения с несколькими узлами или обеспечивается оборудованием, на котором устанавливается Пакет средств разработки Azure Stack (ASDK).

Так как Azure Stack Hub не поддерживает расширение емкости хранилища, для обеспечения эффективной работы важно [отслеживать](#monitor-shares) доступный объем хранилища.

Когда остается ограниченный объем емкости общего ресурса, запланируйте [управление доступным пространством](#manage-available-space), чтобы предотвратить нехватку емкости в общих ресурсах.

Ниже перечислены возможные варианты управления емкостью:
- освобождение емкости;
- перенос контейнера.

Если общий ресурс используется полностью, служба хранения для него больше не функционирует. Чтобы получить помощь в восстановлении операций для общих ресурсов, обратитесь в службу поддержки Майкрософт.

## <a name="understand-volumes-and-shares-containers-and-disks"></a>Общие сведения о томах, общих ресурсах, контейнерах и дисках
### <a name="volumes-and-shares"></a>Тома и общие ресурсы
*Служба хранения* разделяет доступное хранилище на равные тома, которые выделены для хранения данных арендатора. Количество томов равно количеству узлов в развертывании Azure Stack Hub:

- В развертывании с четырьмя узлами используются четыре тома. Каждый том имеет один общий ресурс. В развертывании с несколькими узлами число общих ресурсов не уменьшается, если узел удаляется или выходит из строя.
- При использовании ASDK существует один том с одной общей папкой.

Так как общие ресурсы службы хранения предназначены для монопольного использования этими службами, не нужно напрямую изменять, добавлять или удалять какие-либо файлы в общих ресурсах. Только службы хранения должны работать с файлами, хранящимися в этих томах.

Общие ресурсы в томах хранят данные клиента. К данным клиента относятся страничные BLOB-объекты, блочные BLOB-объекты, добавочные большие двоичные объекты, таблицы, очереди, базы данных и связанные хранилища метаданных. Так как объекты хранилища (большие двоичные объекты и т. д.) по отдельности находятся в одном общем ресурсе, максимальный размер каждого объекта не может превышать размер общего ресурса. Максимальный размер новых объектов зависит от емкости, которая остается в общем ресурсе в качестве неиспользуемого пространства при создании нового объекта.

Если у общего ресурса недостаточно свободного места, а вы не пробовали или не можете [освободить](#reclaim-capacity) место, оператор облака Azure Stack Hub может перенести контейнеры больших двоичных объектов из одного общего ресурса в другой.

См. дополнительные сведения о том, как пользователи клиента взаимодействуют с [хранилищем BLOB-объектов в Azure Stack Hub](/azure-stack/user/azure-stack-storage-overview).

### <a name="containers"></a>Контейнеры
Пользователи клиента создают контейнеры, которые затем используются для хранения данных больших двоичных объектов. Хотя пользователь решает, в каком контейнере размещать большие двоичные объекты, служба хранения использует специальный алгоритм, чтобы определить, в каком томе разместить контейнер. Алгоритм обычно выбирает том с наибольшим количеством свободного места.  

Большой двоичный объект после размещения в контейнере может увеличиться и занимать больше места. По мере добавления новых больших двоичных объектов и увеличения имеющихся доступное пространство в томе, который содержит этот контейнер, уменьшается.  

Контейнеры не ограничены одним общим ресурсом. Когда совокупный объем данных больших двоичных объектов в контейнере достигает 80 % свободного места и более, контейнер переходит в режим *переполнения*. В режиме переполнения все большие двоичные объекты, создаваемые в этом контейнере, выделяются на другой том, где есть достаточно места. Со временем контейнер в режиме переполнения сможет иметь большие двоичные объекты, распределенные между несколькими томами.

Если в томе используется 80 %, а затем 90 % доступного места, система отображает оповещения на портале администратора Azure Stack Hub. Операторам облака необходимо просмотреть доступную емкость хранилища и запланировать перераспределение содержимого. Служба хранения перестает работать, когда диск используется на 100 %. Никакие дополнительные оповещения не отображаются.

### <a name="disks"></a>Диски
Диски виртуальных машин добавляются в контейнеры арендаторами и включают в себя диск операционной системы. Виртуальные машины также могут иметь один или несколько дисков данных. Оба типа дисков хранятся в качестве страничных BLOB-объектов. Арендаторам следует размещать каждый диск в отдельном контейнере для повышения производительности виртуальной машины.

- Каждый контейнер, хранящий диск виртуальной машины (страничный BLOB-объект), считается контейнером, подключенным к виртуальной машине, которой принадлежит диск.
- Контейнер, который не содержит дисков виртуальных машин, считается свободным контейнером.

Варианты освобождения места в подключенном контейнере ограничены. Дополнительные сведения см. в разделе [Перемещение дисков виртуальной машины](#move-vm-disks).

>[!TIP]  
> Операторы облака напрямую не управляют дисками, подключаемыми к виртуальным машинам, которые клиенты могут добавить в контейнер. Однако при планировании управления пространством в общих ресурсах хранения важно понимать, как диски относятся к контейнерам и общим ресурсам.

## <a name="monitor-shares"></a>Мониторинг общих ресурсов
Используйте Azure PowerShell или портал администратора для отслеживания общих ресурсов, чтобы знать, когда свободное пространство ограничено. При использовании портала можно получать оповещения об общих ресурсах, в которых мало места.

### <a name="use-powershell"></a>Использование PowerShell
Оператор облака может отслеживать емкость хранилища в общем ресурсе с помощью командлета PowerShell `Get-AzsStorageShare`. Этот командлет возвращает общее, выделенное и свободное место в байтах для каждого общего ресурса.

![Пример Возвращение показателя свободного места для общих ресурсов](media/azure-stack-manage-storage-shares/free-space.png)

- **Общая емкость**. Это общая емкость в байтах, доступная в общем ресурсе. Это пространство используется для данных и метаданных, обрабатываемых службами хранения.
- **Используемая емкость**. Это объем данных в байтах, используемый всеми экстентами из файлов, в которых хранятся данные клиента и связанные метаданные.

### <a name="use-the-administrator-portal"></a>Использование портала администрирования
Облачный оператор может использовать портал администрирования для просмотра емкости всех общих ресурсов.

1. Войдите на [портал администрирования](https://adminportal.local.azurestack.external).
2. Выберите **Все службы** > **Хранилище** > **Общие папки**, чтобы открыть список общих папок, в котором можно просмотреть сведения об использовании.

    ![Пример Общие файловые ресурсы хранилища на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/storage-file-shares.png)

   - **Total**: Это общая емкость в байтах, доступная в общем ресурсе. Это пространство используется для данных и метаданных, обрабатываемых службами хранения.
   - **Используется**. Это объем данных в байтах, используемый всеми экстентами из файлов, в которых хранятся данные клиента и связанные метаданные.

### <a name="storage-space-alerts"></a>Оповещения о дисковом пространстве
При использовании портала администрирования можно получать оповещения об общих ресурсах, в которых мало места.

> [!IMPORTANT]
> Оператору облака следует предотвращать полное использование емкости общих ресурсов. Если общий ресурс используется полностью, служба хранения для него больше не функционирует. Чтобы освободить пространство и восстановить операции с общим ресурсом, который полностью используется, нужно обратиться в службу поддержки Майкрософт.

* **Предупреждение!** Когда общий файловый ресурс используется более чем на 80 %, вы увидите оповещение типа *Предупреждение* на портале администрирования.

  ![Пример Оповещение типа "Предупреждение" на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/alert-warning.png)

* **Критический.** Когда общий файловый ресурс используется более чем на 90 %, вы увидите оповещение типа *Критическое* на портале администрирования.

  ![Пример Критическое оповещение на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/alert-critical.png)

* **Просмотр сведений**. На портале администрирования можно открыть сведения об оповещении, чтобы просмотреть варианты устранения его причины.

  ![Пример Просмотр сведений об оповещении на портале администрирования Azure Stack Hub](media/azure-stack-manage-storage-shares/alert-details.png)

## <a name="manage-available-space"></a>Управление доступным местом
Когда необходимо освободить место в общем ресурсе, сначала используйте наименее агрессивные методы. Например, попробуйте освободить место, прежде чем переносить контейнер.  

### <a name="reclaim-capacity"></a>Освобождение емкости
*Этот вариант применяется как для развертываний с несколькими узлами, так и для развертываний Пакета средств разработки Azure Stack.*

Можно освободить емкость, используемую учетными записями арендатора, которые были удалены. Эта емкость автоматически освобождается при истечении [срока хранения данных](azure-stack-manage-storage-accounts.md#set-the-retention-period) (или же вы можете немедленно освободить ее).

Дополнительные сведения см. в подразделе "Освобождение емкости" раздела [Управление учетными записями хранения Azure Stack Hub](azure-stack-manage-storage-accounts.md#reclaim).

### <a name="migrate-a-container-between-volumes"></a>Перенос контейнера между томами
*Этот параметр применяется только к интегрированным системам Azure Stack Hub.*

Из-за шаблонов использования клиентами некоторые клиентские общие ресурсы используют больше места, чем другие. В результате в одних общих ресурсах может заканчиваться свободное пространство, тогда как другие общие ресурсы практически не используются.

Можно попробовать освободить место в общих ресурсах с большой нагрузкой вручную, перенеся некоторые контейнеры больших двоичных объектов в другой общий ресурс. Несколько контейнеров меньшего размера можно перенести в один общий ресурс, где достаточно места, чтобы хранить их все. Используйте миграцию для перемещения *свободных* контейнеров. Свободные контейнеры — это контейнеры, которые не содержат диски виртуальных машин.

Миграция объединяет все большие двоичные объекты контейнера в новом общем ресурсе.

- Если контейнер перешел в режим переполнения и поместил большие двоичные объекты в дополнительные тома, в новом общем ресурсе должно быть достаточно емкости для хранения всех больших двоичных объектов контейнера, который нужно перенести. Сюда входят большие двоичные объекты, расположенные в дополнительных общих ресурсах.

- Командлет PowerShell `Get-AzsStorageContainer` определяет только пространство, используемое в изначальном томе контейнера. Он не определяет пространство, которое используется большими двоичными объектами, помещенными в дополнительные тома. Поэтому полный размер контейнера может быть не очевиден. Консолидация контейнера в новом общем ресурсе может вызвать состояние переполнения ресурса, и данные будут помещаться в дополнительные общие ресурсы. В результате может потребоваться повторно перераспределить общие ресурсы.

- Если разрешения на использование определенных групп ресурсов отсутствуют и вы не можете использовать PowerShell, чтобы запросить дополнительные тома для избытка данных, обратитесь к владельцу этих групп ресурсов и контейнеров, чтобы оценить общий объем данных для переноса, прежде чем переносить их.  

> [!IMPORTANT]
> Перенос больших двоичных объектов для контейнера является автономной операцией, требующей использования PowerShell. До завершения переноса все большие двоичные объекты для переносимого контейнера остаются вне сети и не могут использоваться. Также не следует обновлять Azure Stack Hub до завершения всей текущей миграции.

#### <a name="migrate-containers-by-using-powershell"></a>Перенос контейнеров с помощью PowerShell
1. Проверьте, [установлена и настроена ли среда Azure PowerShell](https://azure.microsoft.com/documentation/articles/powershell-install-configure/). Дополнительные сведения см. в разделе [Управление ресурсами Azure с помощью Azure PowerShell](https://go.microsoft.com/fwlink/?LinkId=394767).
2. Изучите контейнер, чтобы понять, какие данные находятся в общем ресурсе, который планируется перенести. Чтобы определить наиболее подходящие для переноса контейнеры в томе, используйте командлет `Get-AzsStorageContainer`.

   ```powershell  
   $farm_name = (Get-AzsStorageFarm)[0].name
   $shares = Get-AzsStorageShare -FarmName $farm_name
   $containers = Get-AzsStorageContainer -ShareName $shares[0].ShareName -FarmName $farm_name
   ```
   Затем проверьте значение $containers:

   ```powershell
   $containers
   ```

   ![Пример. $Containers](media/azure-stack-manage-storage-shares/containers.png)

3. Определите наиболее подходящие общие ресурсы назначения для хранения контейнера, который переносится.

   ```powershell
   $destinationshare = ($shares | Sort-Object FreeCapacity -Descending)[0]
   ```

   Затем проверьте значение $destinationshares:

   ```powershell 
   $destinationshares
   ```

   ![Пример. $destination shares](media/azure-stack-manage-storage-shares/examine-destinationshares.png)

4. Запустите перенос контейнера. Перенос выполняется асинхронно. Если вы начинаете миграцию дополнительных контейнеров до завершения первой миграции, используйте идентификатор задания, чтобы отслеживать состояние каждого задания.

   ```powershell
   $job_id = Start-AzsStorageContainerMigration -StorageAccountName $containers[0].Accountname -ContainerName $containers[0].Containername -ShareName $containers[0].Sharename -DestinationShareUncPath $destinationshares[0].UncPath -FarmName $farm_name
   ```

   Затем проверьте значение $jobId. В следующем примере замените *d62f8f7a-8b46-4f59-a8aa-5db96db4ebb0* идентификатором задания, которое нужно просмотреть:

   ```powershell
   $jobId
   d62f8f7a-8b46-4f59-a8aa-5db96db4ebb0
   ```

5. Используйте идентификатор задания, чтобы проверить состояние задания переноса. По завершении переноса параметру **MigrationStatus** присваивается значение *Complete*.

   ```powershell 
   Get-AzsStorageContainerMigrationStatus -JobId $job_id -FarmName $farm_name
   ```

   ![Пример Состояние миграции](media/azure-stack-manage-storage-shares/migration-status1.png)

6. Вы можете отменить выполняющиеся задания переноса. Отмененные задания переноса обрабатываются асинхронно. Отслеживать отмену можно с помощью $jobid.

   ```powershell
   Stop-AzsStorageContainerMigration -JobId $job_id -FarmName $farm_name
   ```

   ![Пример Состояние отката](media/azure-stack-manage-storage-shares/rollback.png)

7. Вы можете выполнить команду из шага 6 еще раз, пока состояние задания переноса не получит значение *Canceled* (Отменено).  

    ![Пример Состояние "Canceled" (Отменено)](media/azure-stack-manage-storage-shares/cancelled.png)

### <a name="move-vm-disks"></a>Перемещение дисков виртуальной машины
*Этот параметр применяется только к интегрированным системам Azure Stack Hub.*

Самый крайний способ управления пространством заключается в перемещении дисков виртуальной машины. Так как перемещение вложенного контейнера (содержащего диск виртуальной машины) является сложной задачей, обратитесь в службу поддержки Майкрософт, чтобы выполнить это действие.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о предложениях виртуальных машин для пользователей см. в статье [Управление емкостью хранилища для Azure Stack Hub](azure-stack-tutorial-tenant-vm.md).
