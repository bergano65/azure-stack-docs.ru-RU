---
title: Требования к сертификатам инфраструктуры открытых ключей Azure Stack | Документация Майкрософт
description: В этой статье описываются требования к развертыванию сертификатов PKI Azure Stack для интегрированных систем Azure Stack.
services: azure-stack
documentationcenter: ''
author: justinha
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/16/2019
ms.author: justinha
ms.reviewer: ppacent
ms.lastreviewed: 12/16/2019
ms.openlocfilehash: e9276d67c767ec6a08549be830c52bbbe03230ec
ms.sourcegitcommit: 50b7974454e008724817cbb4416ce40368b31ef4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2019
ms.locfileid: "75035512"
---
# <a name="azure-stack-public-key-infrastructure-certificate-requirements"></a>Требования к сертификатам инфраструктуры открытых ключей Azure Stack

В Azure Stack есть открытая сеть инфраструктуры, которая использует общедоступные IP-адреса. Эти IP-адреса назначаются небольшому набору служб Azure Stack и по возможности виртуальным машинам клиента. Во время развертывания Azure Stack требуются сертификаты PKI с соответствующими DNS-именами для открытых конечных точек инфраструктуры Azure Stack. Эта статья описывает следующее:

- Сертификаты, необходимые для развертывания Azure Stack.
- Процесс получения сертификатов, соответствующих этим спецификациям.
- Процесс подготовки, проверки и использования этих сертификатов во время развертывания.

> [!NOTE]
> Azure Stack также по умолчанию использует сертификаты, выданные внутренним центром сертификации (ЦС), интегрированным с Active Directory, для проверки подлинности между узлами. Для проверки сертификата все виртуальные машины инфраструктуры Azure Stack устанавливают отношения доверия с корневым сертификатом внутреннего ЦС, добавляя этот сертификат в локальное хранилище сертификатов. В Azure Stack закрепление или внесение сертификатов в список разрешенных не поддерживается. SAN каждого сертификата сервера проверяется по полному доменному имени целевого объекта. Также проверяется вся цепочка доверия вместе с датой истечения срока действия сертификата (стандартная проверка подлинности сервера TLS без закрепления сертификата).

## <a name="certificate-requirements"></a>Требования к сертификатам
Ниже приводятся требования к сертификатам, которые необходимы для развертывания Azure Stack.

- Сертификаты должны быть выданы внутренним или общедоступным центром сертификации. При использовании общедоступного центра сертификации он должен быть включен в базовый образ операционной системы как часть программы "Доверенный корневой центр сертификации Майкрософт". Вы можете ознакомиться с полным списком здесь: [Microsoft Trusted Root Certificate Program: Participants](https://gallery.technet.microsoft.com/Trusted-Root-Certificate-123665ca).
- У инфраструктуры Azure Stack должен быть сетевой доступ к расположению списка отзыва сертификатов (CRL) центра сертификации, опубликованного в сертификате. Этот список отзыва сертификатов должен быть конечной точкой HTTP.
- При смене сертификатов в сборках, предшествующих сборке 1903, их должен выдавать либо тот же внутренний центр сертификации, который используется для подписывания сертификатов, предъявляемых при развертывании, либо любой общедоступный центра сертификации из указанного выше списка. В сборке 1903 и более поздних сборках сертификаты могут выдаваться любым корпоративным или общедоступным центром сертификации.
- Использование самозаверяющих сертификатов не поддерживается.
- Для развертывания и смены сертификатов вы можете использовать один сертификат, охватывающий все пространства имен в полях сертификата "Имя субъекта" и "Альтернативное имя субъекта" (SAN), ИЛИ использовать отдельные сертификаты для каждого из приведенных ниже пространств имен, которые необходимы для использования требуемых служб Azure Stack. Оба подхода требуют использования подстановочных знаков для конечных точек (в случаях, когда они необходимы), таких как **KeyVault** и **KeyVaultInternal**.
- В сертификате должен использоваться алгоритм шифрования PFX 3DES.
- В сертификате не должен использоваться алгоритм подписи SHA1.
- Сертификат должен быть PFX-файлом, так как и открытый, и закрытый ключи являются обязательными для установки Azure Stack. Для закрытого ключа должен быть установлен атрибут ключа локального компьютера.
- Для шифрования PFX нужно использовать 3DES (это шифрование по умолчанию при экспорте из клиента Windows 10 или хранилища сертификатов Windows Server 2016).
- PFX-файлы сертификатов должны иметь значение Digital Signature и KeyEncipherment в поле Key Usage.
- PFX-файлы сертификатов должны иметь значения "Проверка подлинности сервера (1.3.6.1.5.5.7.3.1)" и "Проверка подлинности клиента (1.3.6.1.5.5.7.3.2)" в поле "Улучшенное использование ключа".
- Значение в поле сертификата "Issued to:" должно отличаться от значения в поле "Issued by:".
- Пароли для всех PFX-файлов сертификатов должны быть одинаковыми во время развертывания.
- Пароль для PFX-файла сертификата должен быть сложным. Запишите этот пароль, так как он будет использоваться в качестве параметра развертывания. Пароль должен соответствовать следующим требованиям к сложности.
    - Минимальная длина — 8 знаков.
    - По крайней мере три из следующих символов: прописная буква, строчная буква, цифры 0–9, специальные символы, алфавитный символ, не являющийся прописным или строчным.
- Убедитесь, что имена субъекта и альтернативные имена субъектов в расширении альтернативного имени субъекта (x509v3_config) совпадают. В поле альтернативного имени субъекта можно указать дополнительные имена узлов (веб-сайты, IP-адреса, общие имена), которые необходимо защитить одним сертификатом SSL.

> [!NOTE]  
> Самозаверяющие сертификаты не поддерживаются.  
> При развертывании Azure Stack Hub в отключенном режиме рекомендуем использовать сертификаты, выданные корпоративным центром сертификации. Это важно, так как клиенты, осуществляющие доступ к конечным точкам Azure Stack, должны иметь возможность обратиться к списку отзыва сертификатов (CRL).

> [!NOTE]  
> Наличие промежуточных центров сертификации в цепочках доверия сертификата *поддерживается*.

## <a name="mandatory-certificates"></a>Обязательные сертификаты
Таблица в этом разделе описывает сертификаты PKI общедоступных конечных точек Azure Stack, необходимых для развертываний Azure Stack (Azure AD и AD FS). Требования к сертификатам группируются по области, используемым пространствам имен и сертификатам, необходимых для каждого пространства имен. В таблице также описаны папки, в которые поставщик решений копирует разные сертификаты для каждой общедоступной конечной точки.

Требуются сертификаты с соответствующими DNS-именами для открытой конечной точки инфраструктуры Azure Stack. DNS-имя для каждой конечной точки имеет такой формат: *&lt;префикс>.&lt;регион>.&lt;полное доменное имя>* .

Значения [регион] и [внешнее полное доменное имя] в вашем развертывании должны совпадать с регионом и внешними доменными именами, выбранными для вашей системы Azure Stack. Например, если имя региона *Redmond*, а имя внешнего домена — *contoso.com*, DNS-имена будет иметь формат *&lt;префикс>.redmond.contoso.com*. Значения *&lt;префикс>* предварительно определяет корпорация Майкрософт для описания конечной точки, защищенной с помощью сертификата. Кроме того значения *&lt;префикс >* внешних конечных точек инфраструктуры зависят от инфраструктуры Azure Stack, которая использует конкретную конечную точку.

Для рабочих сред мы рекомендуем создавать отдельные сертификаты для каждой конечной точки и копировать их в соответствующий каталог. Для сред разработки сертификаты можно указать как один шаблон сертификата, охватывающий все пространства имен в полях субъекта и альтернативного имени субъекта (SAN), который копируется во все каталоги. Отдельный сертификат, охватывающий все конечные точки и службы, является небезопасным и поэтому подходит только для разработки. Обратите внимание, что в обоих вариантах необходимо использовать шаблоны сертификатов для конечных точек, таких как **ACS** и хранилище ключей, где они необходимы.

> [!Note]  
> Во время развертывания необходимо скопировать сертификаты в папку развертывания, соответствующую поставщику удостоверений, в котором выполняется развертывание (Azure AD или AD FS). Если вы используете один сертификат для всех конечных точек, необходимо скопировать этот файл сертификата в каждую папку развертывания, как описано в следующих таблицах. Структура папок предварительно создана на виртуальной машине развертывания: C:\CloudDeployment\Setup\Certificates.

| Папка развертывания | Требуемый субъект сертификата и альтернативное имя субъекта | Область (для каждого региона) | Пространство имен поддомена |
|-------------------------------|------------------------------------------------------------------|----------------------------------|-----------------------------|
| Общедоступный портал | portal.&lt;регион>.&lt;полное доменное имя> | Порталы | &lt;регион>.&lt;полное доменное имя> |
| Портал администрирования | adminportal.&lt;регион>.&lt;полное доменное имя> | Порталы | &lt;регион>.&lt;полное доменное имя> |
| Общедоступный Azure Resource Manager | management.&lt;регион>.&lt;полное доменное имя> | Azure Resource Manager | &lt;регион>.&lt;полное доменное имя> |
| Администратор Azure Resource Manager | adminmanagement.&lt;регион>.&lt;полное доменное имя> | Azure Resource Manager | &lt;регион>.&lt;полное доменное имя> |
| ACSBlob | *blob.&lt;регион>.&lt;полное доменное имя><br>Групповой SSL-сертификат | Хранилище BLOB-объектов | blob.&lt;регион>.&lt;полное доменное имя> |
| ACSTable | *table.&lt;регион>.&lt;полное доменное имя><br>Групповой SSL-сертификат | Хранилище таблиц | table.&lt;регион>.&lt;полное доменное имя> |
| ACSQueue | *queue.&lt;регион>.&lt;полное доменное имя><br>Групповой SSL-сертификат | Хранилище очередей | queue.&lt;регион>.&lt;полное доменное имя> |
| Хранилище ключей | *vault.&lt;регион>.&lt;полное доменное имя><br>Групповой SSL-сертификат | Key Vault | vault.&lt;регион>.&lt;полное доменное имя> |
| Внутреннее хранилище Key Vault | *adminvault.&lt;регион>.&lt;полное доменное имя><br>Групповой SSL-сертификат |  Внутреннее хранилище Key Vault |  adminvault.&lt;регион>.&lt;полное доменное имя> |
| Хост-процесс для расширений администратора | *.adminhosting.\<регион>.\<FQDN> (групповые SSL-сертификаты) | Хост-процесс для расширений администратора | adminhosting.\<регион>.\<FQDN> |
| Общедоступный хост-процесс для расширений | *.hosting.\<регион>.\<FQDN> (групповые SSL-сертификаты) | Общедоступный хост-процесс для расширений | hosting.\<регион>.\<FQDN> |

При развертывании Azure Stack в режиме Azure Active Directory необходимо запросить только сертификаты, перечисленные в предыдущей таблице. При развертывании Azure Stack в режиме AD FS также необходимо запросить сертификаты, описанные в следующей таблице:

|Папка развертывания|Требуемый субъект сертификата и альтернативное имя субъекта|Область (для каждого региона)|Пространство имен поддомена|
|-----|-----|-----|-----|
|ADFS|adfs. *&lt;регион>.&lt;полное доменное имя>*<br>(SSL-сертификат)|ADFS|*&lt;регион>.&lt;полное доменное имя>*|
|График|graph. *&lt;регион>.&lt;полное доменное имя>*<br>(SSL-сертификат)|График|*&lt;регион>.&lt;полное доменное имя>*|
|

> [!IMPORTANT]
> Все сертификаты, перечисленные в этом разделе, должны иметь один и тот же пароль.

## <a name="optional-paas-certificates"></a>Необязательные сертификаты PaaS
Если вы планируете развертывать дополнительные службы PaaS Azure Stack (SQL, MySQL и служба приложений), после развертывания и настройки Azure Stack необходимо запросить дополнительные сертификаты для охвата конечных точек служб PaaS.

> [!IMPORTANT]
> Сертификаты, используемые для поставщиков ресурсов службы приложений, SQL и MySQL, должны иметь один корневой центр, так как они используются для глобальных конечных точек Azure Stack.

В следующей таблице описаны конечные точки и сертификаты, необходимые для адаптеров SQL и MySQL, а также для службы приложений. Вам не нужно копировать эти сертификаты в папку развертывания Azure Stack. Вместо этого следует предоставить эти сертификаты при установке дополнительных поставщиков ресурсов.

|Область (для каждого региона)|Сертификат|Требуемый субъект сертификата и альтернативное имя субъекта|Пространство имен поддомена|
|-----|-----|-----|-----|
|SQL, MySQL|SQL и MySQL|&#42;.dbadapter. *&lt;регион>.&lt;полное доменное имя>*<br>Групповой SSL-сертификат|dbadapter. *&lt;регион>.&lt;полное_доменное_имя>*|
|Служба приложений|SSL-сертификат по умолчанию для веб-трафика|&#42;.appservice. *&lt;регион>.&lt;полное доменное имя>*<br>&#42;.scm.appservice. *&lt;регион>.&lt;полное доменное имя>*<br>&#42;.sso.appservice. *&lt;регион>.&lt;полное доменное имя>*<br>(Групповой SSL-сертификат для нескольких доменов<sup>1</sup>)|appservice. *&lt;регион>.&lt;полное доменное имя>*<br>scm.appservice. *&lt;регион>.&lt;полное доменное имя>*|
|Служба приложений|API|api.appservice. *&lt;регион>.&lt;полное доменное имя>*<br>(SSL-сертификат<sup>2</sup>)|appservice. *&lt;регион>.&lt;полное доменное имя>*<br>scm.appservice. *&lt;регион>.&lt;полное доменное имя>*|
|Служба приложений|FTP|ftp.appservice. *&lt;регион>.&lt;полное_доменное_имя>*<br>(SSL-сертификат<sup>2</sup>)|appservice. *&lt;регион>.&lt;полное доменное имя>*<br>scm.appservice. *&lt;регион>.&lt;полное доменное имя>*|
|Служба приложений|Единый вход|sso.appservice. *&lt;регион>.&lt;полное доменное имя>*<br>(SSL-сертификат<sup>2</sup>)|appservice. *&lt;регион>.&lt;полное доменное имя>*<br>scm.appservice. *&lt;регион>.&lt;полное доменное имя>*|

<sup>1</sup> Требует один сертификат с несколькими шаблонами SAN-сертификата. Не все общедоступные центры сертификации поддерживают применение нескольких шаблонов SAN-сертификата на один сертификат.

<sup>2</sup> A &#42;групповой сертификат .appservice. *&lt;регион>.&lt;полное доменное имя>* нельзя использовать вместо этих трех сертификатов: api.appservice. *&lt;регион>.&lt;полное доменное имя>* , ftp.appservice. *&lt;регион>.&lt;полное доменное имя>* и sso.appservice. *&lt;регион>.&lt;полное доменное имя>* . Служба приложений явно требует использовать отдельные сертификаты для этих конечных точек.

## <a name="learn-more"></a>Подробнее
Узнайте, как [создать сертификаты PKI для развертывания Azure Stack](azure-stack-get-pki-certs.md).

## <a name="next-steps"></a>Дополнительная информация
[Интеграция удостоверения AD FS с центром обработки данных Azure Stack](azure-stack-integrate-identity.md).