---
title: Общие сведения о поставщиках удостоверений для Azure Stack Hub
description: Сведения о поставщиках удостоверений, которые можно использовать с Azure Stack Hub.
author: ihenkel
ms.topic: conceptual
ms.date: 06/03/2019
ms.author: inhenkel
ms.reviewer: fiseraci
ms.lastreviewed: 01/14/2019
ms.openlocfilehash: b6db553b2c129b1179adde2f53b98dc705077294
ms.sourcegitcommit: 959513ec9cbf9d41e757d6ab706939415bd10c38
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2020
ms.locfileid: "76890295"
---
# <a name="overview-of-identity-providers-for-azure-stack-hub"></a>Общие сведения о поставщиках удостоверений для Azure Stack Hub

Для работы Azure Stack Hub требуется Azure Active Directory (Azure AD) или службы федерации Active Directory (AD FS) на базе Active Directory в качестве поставщика удостоверений. Решение о выборе поставщика принимается один раз во время развертывания Azure Stack Hub. Основные понятия и сведения об авторизации из этой статьи могут помочь вам выбрать поставщика удостоверений.

Выбор между Azure AD или AD FS определяется режимом, в котором вы развертываете Azure Stack Hub.

- Если вы выполнили развертывание в режиме с подключением, можно использовать Azure AD или AD FS.
- Если вы выполнили развертывание в отключенном режиме без подключения к Интернету, поддерживается только AD FS.

В зависимости от среды Azure Stack Hub изучите дополнительные сведения о доступных вариантах в следующих статьях:

- Комплект для развертывания Azure Stack Hub. [Вопросы относительно удостоверений](azure-stack-datacenter-integration.md#identity-considerations).
- Интегрированные системы Azure Stack Hub. [Модели подключения интегрированных систем Azure Stack](azure-stack-connection-models.md).

## <a name="common-concepts-for-identity-providers"></a>Общие понятия о поставщиках удостоверений

В следующих разделах рассматриваются основные понятия, связанные с поставщиками удостоверений, и сведения об их использовании в Azure Stack Hub.

![Терминология для поставщиков удостоверений](media/azure-stack-identity-overview/terminology.png)

### <a name="directory-tenants-and-organizations"></a>Организации и клиенты каталога

Каталог — это контейнер, который содержит информацию о *пользователях*, *приложениях*, *группах* и *субъектах-служб*.

Клиент каталога — это *организация*, например, корпорация Майкрософт или ваша компания.

- Azure AD поддерживает нескольких клиентов и может поддерживать несколько организаций (каждую в собственном каталоге). Если вы используете Azure AD и имеете несколько клиентов, можно предоставить приложениям и пользователям из одного клиента доступ к другим клиентам того же каталога.
- AD FS поддерживает только один клиент, и, следовательно, только одну организацию.

### <a name="users-and-groups"></a>Пользователи и группы

Учетные записи пользователей (удостоверения) — это стандартные учетные записи, выполняющие проверку подлинности отдельных пользователей с помощью идентификатора и пароля пользователя. Группы могут содержать пользователей или другие группы.

Способ создания пользователей и групп и управление ими зависит от используемого вами решения для идентификации.

В Azure Stack Hub учетные записи пользователей имеют следующие свойства.

- Создаются в формате *имя_пользователя\@домен*. Хотя AD FS сопоставляет учетные записи пользователей с экземпляром Active Directory, это решение не поддерживает использование формата *\\\<домен>\\\<псевдоним>* .
- Настраиваются для использования многофакторной проверки подлинности.
- Ограничены каталогом, в котором они были впервые зарегистрированы. Это каталог организации.
- Их можно импортировать из локальных каталогов. Дополнительные сведения см. в статье [Интеграция локальных каталогов с Azure Active Directory](/azure/active-directory/connect/active-directory-aadconnect).

Для входа на пользовательский портал организации используется URL-адрес *https:\//portal.local.azurestack.external*. При входе на портал Azure Stack Hub из других доменов, кроме указанного при регистрации Azure Stack Hub, необходимо добавить к URL-адресу портала имя домена, которое использовалось для регистрации Azure Stack Hub. Например, если экземпляр Azure Stack Hub зарегистрирован с доменом fabrikam.onmicrosoft.com, а для входа используется учетная запись admin@contoso.com, URL-адрес для входа на пользовательский портал будет таким: https:\//portal.local.azurestack.external/fabrikam.onmicrosoft.com.

### <a name="guest-users"></a>Гостевые пользователи

Гостевые пользователи — это учетные записи пользователей из других клиентов каталога, которым предоставили доступ к ресурсам в вашем каталоге. Для поддержки гостевых пользователей используйте Azure AD и включите поддержку мультитенантного режима. Если поддержка включена, вы можете предоставить гостевому пользователю доступ к ресурсам в вашем клиенте каталога. Это в свою очередь позволяет активировать совместную работу за пределами организации.

Чтобы пригласить гостевых пользователей, операторы и пользователи облака могут использовать [службу совместной работы Azure AD B2B](/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b). Приглашенные пользователи получают доступ к документам, ресурсам и приложениям из вашего каталога, сохраняя при этом контроль над собственными ресурсами и данными.

В качестве гостевого пользователя вы можете войти в другой клиент каталога организации. Для этого добавьте имя каталога организации в URL-адрес портала. Например, если вы принадлежите к организации Contoso, но хотите войти в каталог Fabrikam, используйте этот URL-адрес для входа: https:\//portal.local.azurestack.external/fabrikam.onmicrosoft.com.

### <a name="apps"></a>Приложения

Вы можете зарегистрировать приложения в Azure AD или AD FS, а затем предложить их пользователям в организации.

В число приложений входят:

- **Веб-приложения**. В качестве примера можно привести портал Azure и Azure Resource Manager. Они поддерживают вызовы веб-API.
- **Собственный клиент**. В качестве примера можно привести Azure PowerShell, Visual Studio и Azure CLI.

Приложения могут поддерживать два типа клиентской модели:

- **Один клиент**. Поддерживает пользователей и службы только из того же каталога, в котором зарегистрировано приложение.

  > [!NOTE]
  > Так как AD FS поддерживает только один каталог, приложения, созданные в топологии AD FS, являются по своей природе приложениями с одним клиентом.

- **Несколько клиентов**. Поддерживает использование приложения пользователями и службами из каталога, в котором зарегистрировано приложение, и из дополнительных каталогов клиента. С помощью мультитенантных приложений пользователи из другого каталога клиента (другого клиента Azure AD) могут войти в ваше приложение.

  Дополнительные сведения о мультитенантности см. в статье [Поддержка мультитенантности в Azure Stack](azure-stack-enable-multitenancy.md).

  Дополнительные сведения о разработке мультитенантного приложения см. в статье [Как реализовать вход любого пользователя Azure Active Directory (AD) с помощью шаблона мультитенантного приложения](/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview).

При регистрации приложения создаются два объекта:

- **Объект приложения**. Это глобальное представление приложения во всех клиентах. С программным приложением устанавливается отношение "один к одному", которое существует только в каталоге, в котором оно было впервые зарегистрировано.

- **Объект субъекта-службы**. Подтверждение компетенции, созданное для приложения в каталоге, в котором впервые зарегистрировано приложение. Субъект-служба также создается в каталоге каждого дополнительного клиента, в которых используется это приложение. С программным приложением может устанавливаться отношение "один ко многим".

Дополнительные сведения об объектах приложения и субъектах-службы см. в статье [Объекты приложения и субъекта-службы в Azure Active Directory](/azure/active-directory/develop/active-directory-application-objects).

### <a name="service-principals"></a>Субъекты-службы

Субъект-служба — это набор *учетных данных* для приложения или службы, которые предоставляют доступ к ресурсам в Azure Stack Hub. Использование субъекта-службы разделяет разрешения приложения от разрешений пользователя приложения.

Субъект-служба создается в каждом клиенте, в котором используется приложение. Она создает удостоверения для входа и доступа к ресурсам (например, пользователям), защищенных этим клиентом.

- Приложение с одним клиентом имеет только один субъект-службу в каталоге, в котором оно впервые создано. Субъект-служба создается и дает согласие быть использованной во время регистрации приложения.
- Для мультитенантного веб-приложения или API есть субъект-служба, которая будет создана в каждом клиенте, пользователь которого даст согласие на его использование.

В качестве учетных данных для субъектов-служб могут использоваться ключ, который был создан на портале Azure, или сертификат. Использование сертификата хорошо подходит для автоматизации, так как сертификаты считаются более безопасными, чем ключи.

> [!NOTE]
> При использовании AD FS с Azure Stack Hub только администраторы могут создавать субъекты-службы. При использовании AD FS для субъектов-служб требуются сертификаты. В таком случае субъекты-службы создаются с помощью привилегированной конечной точки. Инструкции см. в статье [Использование удостоверения приложения для доступа к ресурсам](azure-stack-create-service-principals.md).

Дополнительные сведения о субъектах-службах для Azure Stack Hub см. в [этой статье](azure-stack-create-service-principals.md).

### <a name="services"></a>Службы

Службы в Azure Stack Hub, которые взаимодействуют с поставщиками удостоверений, регистрируются как приложения с поставщиком удостоверений. Как и в случае с приложениями, регистрация позволяет службе выполнить проверку подлинности с помощью системы идентификации.

Все службы Azure используют протоколы [OpenID Connect](/azure/active-directory/develop/active-directory-protocols-openid-connect-code) и [JSON Web Tokens](/azure/active-directory/develop/active-directory-token-and-claims) для идентификации. Благодаря согласованному использованию протоколов службами Azure AD и AD FS вы можете использовать [библиотеку проверки подлинности Azure Active Directory](/azure/active-directory/develop/active-directory-authentication-libraries) ADAL, чтобы выполнить проверку подлинности в локальной среде или в Azure (с подключением к Интернету). С помощью ADAL также можно использовать такие средства, как Azure PowerShell и Azure CLI, для управления ресурсами в локальной среде и в нескольких облаках.

### <a name="identities-and-your-identity-system"></a>Удостоверения и система идентификации

К удостоверениям для Azure Stack Hub относятся учетные записи пользователей, группы и субъекты-службы.

При установке Azure Stack Hub несколько встроенных приложений и служб автоматически регистрируются в поставщике удостоверений в клиенте каталога. Некоторые регистрируемые службы используются для администрирования. Другие службы доступны для пользователей. При стандартной регистрации основные службы получают удостоверения, которые могут взаимодействовать между собой и с удостоверениями, которые будут добавлены позже.

Если вы настроили Azure AD с поддержкой мультитенантности, некоторые приложения распространяются в новые каталоги.

## <a name="authentication-and-authorization"></a>Аутентификация и авторизация

### <a name="authentication-by-apps-and-users"></a>Проверка подлинности, выполняемая приложениями и пользователями

![Удостоверения между слоями Azure Stack Hub](media/azure-stack-identity-overview/identity-layers.png)

Для приложений и пользователей архитектура Azure Stack Hub описывается с помощью четырех слоев. При взаимодействии между каждым из этих слоев могут использоваться разные типы проверки подлинности.

|Уровень    |Проверка подлинности между слоями  |
|---------|---------|
|Средства и клиенты, например портал администрирования     | Чтобы использовать или изменять ресурсы в Azure Stack Hub, средства и клиенты указывают [JSON Web Token](/azure/active-directory/develop/active-directory-token-and-claims) при вызове Azure Resource Manager. <br>Azure Resource Manager проверяет JSON Web Token и просматривает *утверждения* в выданном маркере, чтобы оценить уровень авторизации пользователя или субъекта-службы в Azure Stack Hub. |
|Платформа Azure Resource Manager и ее основные службы     |Azure Resource Manager взаимодействует с поставщиками ресурсов для передачи данных от пользователей. <br> Для передачи данных используются *прямые императивные* вызовы или *декларативные* вызовы через [шаблоны Azure Resource Manager](/azure-stack/user/azure-stack-arm-templates).|
|Поставщики ресурсов     |Вызовы, передаваемые поставщикам удостоверений, защищены проверкой подлинности на основе сертификатов. <br>Azure Resource Manager и поставщик удостоверений затем взаимодействуют с помощью API. Каждый вызов, полученный из Azure Resource Manager, поставщик удостоверений проверяет с помощью сертификата.|
|Инфраструктура и бизнес-логика     |Поставщики ресурсов взаимодействуют с бизнес-логикой и инфраструктурой с помощью режима проверки подлинности на свой выбор. Стандартные поставщики удостоверений, которые поставляются с Azure Stack Hub, используют проверку подлинности Windows для защиты этой связи.|

![Сведения, необходимые для проверки подлинности](media/azure-stack-identity-overview/authentication.png)

### <a name="authenticate-to-azure-resource-manager"></a>Проверка подлинности в Azure Resource Manager

Чтобы выполнить проверку подлинности с помощью поставщика удостоверений и получить JSON Web Token, необходимо иметь следующие сведения:

1. **URL-адрес для системы идентификации (Центр)** . URL-адрес, по которому можно связаться с поставщиком удостоверений. Например, *https:\//login.windows.net*.
2. **URI идентификатора приложения для Azure Resource Manager**: уникальный идентификатор для Azure Resource Manager, зарегистрированный с помощью поставщика удостоверений. Он уникален для каждой установки Azure Stack Hub.
3. **Учетные данные**: подтверждение компетенции, которое вы используете для выполнения проверки подлинности с помощью поставщика удостоверений.
4. **URL-адрес для Azure Resource Manager**: URL-адрес — это расположение службы Azure Resource Manager. Например, *https:\//management.azure.com* или *https:\//management.local.azurestack.external*.

Когда субъект (клиент, приложение или пользователь) выполняет запрос на проверку подлинности для доступа к ресурсу, запрос должен содержать следующие данные:

- Учетные данные субъекта.
- URI идентификатора приложения для ресурса, к которому субъект хочет получить доступ.

Учетные данные проверяются поставщиком удостоверений. Поставщик удостоверений также проверяет, чтобы URI идентификатора приложения использовался для зарегистрированного приложения и чтобы субъект имел правильные разрешения для получения маркера для ресурса. Если запрос допустимый, предоставляется JSON Web Token.

Затем маркер передается в заголовке запроса к Azure Resource Manager. Azure Resource Manager в любом порядке выполняет следующее:

- Проверяет утверждение *издателя*, чтобы убедиться, что маркер получен из правильного поставщика удостоверений.
- Проверяет утверждение *аудитории*, чтобы убедиться, что маркер был выдан Azure Resource Manager.
- Проверяет, что JSON Web Token подписан с помощью сертификата, настроенного через OpenID, известного для Azure Resource Manager.
- Просматривает утверждения *времени выдачи* и *окончания срока действия*, чтобы убедиться, что маркер активный и может быть принят.

После выполнения всех проверок, Azure Resource Manager использует утверждения *идентификатора объекта* (oid) и *групп* для создания списка ресурсов, к которым субъект может получить доступ.

![Схема протокола обмена маркерами](media/azure-stack-identity-overview/token-exchange.png)

> [!NOTE]
> После развертывания разрешение глобального администратора Azure Active Directory не требуется. Однако для некоторых операций могут потребоваться учетные данные глобального администратора (например, сценарий установщика поставщика ресурсов или новая функция, требующая предоставления разрешения). Можно временно восстановить разрешения глобального администратора или использовать отдельную глобальную учетную запись администратора, которая является владельцем *подписки поставщика по умолчанию*.

### <a name="use-role-based-access-control"></a>Использование контроля доступа на основе ролей

Управление доступом на основе ролей (RBAC) в Azure Stack Hub реализовано так же, как и в Microsoft Azure. Вы можете управлять доступом к ресурсам путем назначения соответствующей роли RBAC пользователям, группам и приложениям. Для получения дополнительных сведений об использовании RBAC в Azure Stack Hub ознакомьтесь со следующими статьями:

- [Начало работы с управлением доступом на основе ролей на портале Azure](/azure/role-based-access-control/overview).
- [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](/azure/role-based-access-control/role-assignments-portal).
- [Создание пользовательских ролей для управления доступом на основе ролей в Azure](/azure/role-based-access-control/custom-roles).
- [Управление доступом на основе ролей](azure-stack-manage-permissions.md) в Azure Stack Hub.

### <a name="authenticate-with-azure-powershell"></a>Проверка подлинности с помощью Azure PowerShell

Сведения об использовании Azure PowerShell для проверки подлинности в Azure Stack Hub см. в статье [Подключение к Azure Stack в роли пользователя с помощью PowerShell](../user/azure-stack-powershell-configure-user.md).

### <a name="authenticate-with-azure-cli"></a>Проверка подлинности с помощью Azure CLI

Сведения об использовании Azure CLI для проверки подлинности в Azure Stack Hub см. в статье [Развертывание и администрирование ресурсов в Azure Stack с помощью Azure CLI](/azure-stack/user/azure-stack-version-profiles-azurecli2).

## <a name="next-steps"></a>Дальнейшие действия

- [Архитектура удостоверения Azure Stack](azure-stack-identity-architecture.md)
- [Интеграция центра обработки данных Azure Stack: идентификация](azure-stack-integrate-identity.md)
