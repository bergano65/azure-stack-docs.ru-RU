---
title: Добавление пользовательского образа виртуальной машины в Azure Stack Hub
description: Сведения о добавлении и удалении пользовательского образа виртуальной машины в Azure Stack Hub.
author: sethmanheim
ms.topic: conceptual
ms.date: 10/16/2019
ms.author: sethm
ms.reviewer: kivenkat
ms.lastreviewed: 06/08/2018
ms.openlocfilehash: 359adfbe9083bd21368934426a54c887af2f9f2a
ms.sourcegitcommit: 959513ec9cbf9d41e757d6ab706939415bd10c38
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2020
ms.locfileid: "76889972"
---
# <a name="add-a-custom-vm-image-to-azure-stack-hub"></a>Добавление пользовательского образа виртуальной машины в Azure Stack Hub

Azure Stack Hub позволяет добавить пользовательский образ виртуальной машины в Marketplace и сделать его доступным для пользователей. Образы виртуальной машины можно также добавить в Azure Stack Hub Marketplace через портал администрирования или Windows PowerShell. Используйте образ из глобального магазина Azure Marketplace в качестве основы для пользовательского образа или создайте его с нуля с помощью Hyper-V.

## <a name="step-1-create-the-custom-vm-image"></a>Шаг 1. Создание пользовательского образа виртуальной машины

### <a name="windows"></a>Windows

Создайте обобщенный пользовательский VHD. 

**Если этот виртуальный жесткий диск находится не в Azure**, выполните действия из статьи [Отправка универсального диска VHD и создание виртуальных машин с его помощью в Azure](/azure/virtual-machines/windows/upload-generalized-managed), чтобы правильно подготовить VHD с помощью **Sysprep** и сделать его обобщенным.

**Если виртуальный жесткий диск находится в Azure**, перед обобщением виртуальной машины сделайте следующее:
1) При подготовке виртуальной машины в Azure используйте PowerShell и не указывайте флаг `-ProvisionVMAgent`. 
2) Прежде чем выполнять обобщение виртуальной машины в Azure, удалите все ее расширения, выполнив командлет **Remove-AzureRmVMExtension** на этой виртуальной машине. Чтобы узнать, какие расширения виртуальной машины установлены, перейдите по пути "Windows (C:) > WindowsAzure > Журналы > Подключаемые модули".

```Powershell
Remove-AzureRmVMExtension -ResourceGroupName winvmrg1 -VMName windowsvm -Name "CustomScriptExtension"
```                       
Выполните вышеуказанное, выполните инструкции из [этого документа](/azure/virtual-machines/windows/download-vhd), чтобы подготовить и скачать виртуальный жесткий диск перед его переносом в Azure Stack Hub.

### <a name="linux"></a>Linux

**Если виртуальный жесткий диск находится за пределами Azure**, выполните соответствующе инструкции по обобщению виртуального жесткого диска.

- [Подготовка виртуальной машины на основе CentOS для Azure](/azure/virtual-machines/linux/create-upload-centos?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
- [Подготовка виртуального жесткого диска Debian для Azure](/azure/virtual-machines/linux/debian-create-upload-vhd?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
- [Red Hat Enterprise Linux](/azure/azure-stack/azure-stack-redhat-create-upload-vhd)
- [SLES и OpenSUSE](/azure/virtual-machines/linux/suse-create-upload-vhd?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)
- [Сервер Ubuntu](/azure/virtual-machines/linux/create-upload-ubuntu?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

**Если виртуальный жесткий диск находится в Azure**, выполните приведенные здесь инструкции по подготовке и скачиванию виртуального жесткого диска.

1. Остановите службу **waagent**:

   ```bash
   sudo waagent -force -deprovision
   export HISTSIZE=0
   logout
   ```

   Возьмите себе на заметку версии агента Linux для Azure, которые работают с Azure Stack Hub [как описано здесь](azure-stack-linux.md#azure-linux-agent). Убедитесь, что образ, обработанный командой Sysprep, имеет версию агента Linux для Azure, совместимую с Azure Stack Hub.

2. Остановите виртуальную машину и отмените ее выделение.

3. Скачайте виртуальный жесткий диск.

   1. Чтобы скачать VHD-файл, необходимо создать подписанный URL-адрес (SAS). Когда этот URL-адрес создан, ему назначается срок действия.

   1. В колонке виртуальной машины в меню выберите пункт **Диски**.

   1. Выберите диск операционной системы для виртуальной машины и щелкните **Экспорт диска**.

   1. Задайте для URL-адреса срок действия 36000.

   1. Щелкните **Создать URL-адрес**.

   1. Создайте URL-адрес.
   
   1. Под созданным URL-адресом щелкните ссылку **Скачать VHD-файл**.

   1. Чтобы начать скачивание, возможно, потребуется нажать кнопку **Сохранить** в браузере. По умолчанию VHD-файлу присваивается имя _abcd_.

### <a name="considerations"></a>Рекомендации

Перед отправкой образа необходимо принять во внимание следующие факторы.

- Azure Stack Hub поддерживает только виртуальные машины первого поколения на дисках фиксированного размера в формате VHD. Фиксированный формат структурирует логический диск в файле линейно, то есть смещение *X* на диске соответствует смещению *X* в BLOB-объекте. Небольшой колонтитул в конце BLOB-объекта описывает свойства VHD-файла. Чтобы убедиться, что вы используете диск фиксированного размера, выполните командлет PowerShell **Get-VHD**.

- Azure Stack Hub не поддерживает динамические диски VHD. 

## <a name="step-2-upload-the-vm-image-to-a-storage-account"></a>Шаг 2. Отправка образа виртуальной машины в учетную запись хранения

1. [Установка PowerShell для Azure Stack Hub](azure-stack-powershell-install.md).  

2. Войдите в Azure Stack Hub с правами оператора. Этот процесс описан в статье [Подключение к Azure Stack Hub с помощью PowerShell](azure-stack-powershell-configure-admin.md).

3. Нужно предоставить возможность ссылаться на образы через URI хранилища BLOB-объектов. Подготовьте образ операционной системы Windows или Linux в формате VHD (не VHDX), а затем отправьте образ в учетную запись хранения в Azure Stack Hub.

   - Если виртуальный жесткий диск находится в Azure и вы используете подключенную среду Azure Stack Hub, вы можете использовать средство [Azcopy](/azure/storage/common/storage-use-azcopy) или его аналоги, чтобы напрямую передать виртуальный жесткий диск из Azure в учетную запись хранения Azure Stack Hub.

   - Если виртуальный жесткий диск находится в Azure и вы используете автономную среду Azure Stack Hub, придется скачать VHD на компьютер, который подключен одновременно к Azure и Azure Stack Hub. Скопируйте VHD-файл из Azure на этот компьютер, а затем переносите его в Azure Stack Hub с помощью любого стандартного [средства передачи данных в хранилище](../user/azure-stack-storage-transfer.md), которое поддерживает работу с Azure и Azure Stack Hub.

     Например, виртуальный жесткий диск в учетную запись хранения можно передать с помощью команды Add-AzureRmVHD на портале администрирования Azure Stack.  

     ```powershell
     Add-AzureRmVhd -Destination "https://bash.blob.redmond.azurestack.com/sample/vhdtestingmgd.vhd" -LocalFilePath "C:\vhd\vhdtestingmgd.vhd" 
     ```

3. При передаче образа в хранилище BLOB-объектов запишите созданный для него URI. URI в хранилище BLOB-объектов имеет следующий формат: *&lt;учетная_запись_хранения&gt;/&lt;контейнер_BLOB-объектов&gt;/&lt;имя_целевого_виртуального_диска&gt;* .vhd.

4. Чтобы настроить для большого двоичного объекта анонимный доступ, перейдите в контейнер больших двоичных объектов учетной записи хранения, в который был отправлен VHD образа виртуальной машины. Выберите **Большой двоичный объект**, а затем — **Политика доступа**. Если требуется, можно создать подписанный URL-адрес для контейнера и включить его как часть URI большого двоичного объекта. Это сделает большой двоичный объект доступным для использования. Если для большого двоичного объекта не включен анонимный доступ, образ виртуальной машины будет создан с состоянием сбоя.

   ![Переход к большим двоичным объектам учетной записи хранения](./media/azure-stack-add-vm-image/tca1.png)

   ![Установка общего доступа к большим двоичным объектам](./media/azure-stack-add-vm-image/tca2.png)

   ![Установка общего доступа к большим двоичным объектам](./media/azure-stack-add-vm-image/tca3.png)
   

## <a name="step-3-option-1-add-the-vm-image-as-an-azure-stack-hub-operator-using-the-portal"></a>Шаг 3, вариант 1. Добавление образа виртуальной машины от имени оператора Azure Stack Hub с помощью портала

1. Войдите в Azure Stack Hub с правами оператора. Выберите **Все службы** > **Вычисления** в разделе меню **Образы виртуальных машин** > **Добавить**.

   ![Пользовательский интерфейс для загрузки неопубликованных пользовательских образов](./media/azure-stack-add-vm-image/tca4.png)

2. В разделе **Создание образа** введите сведения об издателе, предложении, номере SKU, версии и URI BLOB-объекта c диском ОС. Затем щелкните **Создать**, чтобы создать образ виртуальной машины.
   
   ![Пользовательский интерфейс для загрузки неопубликованных пользовательских образов](./media/azure-stack-add-vm-image/tca5.png)

   При успешном создании образа состояние образа виртуальной машины изменяется на **Успешно**.
   
3. Добавленный образ будет доступен только для шаблонов на базе Azure Resource Manager и развертываний PowerShell. Чтобы обеспечить пользователям доступ к образу в Marketplace, опубликуйте его в качестве элемента Marketplace, как описывается в статье [Создание и публикация элемента Marketplace](azure-stack-create-and-publish-marketplace-item.md) Запишите значения **Издатель**, **Предложение**, **Номер SKU** и **Версия**. Они понадобятся при редактировании шаблона Resource Manager и Manifest.json в пользовательском AZPKG-файле.

## <a name="step-3-option-2-add-a-vm-image-as-an-azure-stack-hub-operator-using-powershell"></a>Шаг 3, вариант 2. Добавление образа виртуальной машины от имени оператора Azure Stack Hub с помощью PowerShell

1. [Установка PowerShell для Azure Stack Hub](azure-stack-powershell-install.md).  

2. Войдите в Azure Stack Hub с правами оператора. Этот процесс описан в статье [Подключение к Azure Stack Hub с помощью PowerShell](azure-stack-powershell-configure-admin.md).

3. Откройте PowerShell с помощью командной строки с повышенными привилегиями и выполните следующую команду:

   ```powershell
    Add-AzsPlatformimage -publisher "<publisher>" `
      -offer "<Offer>" `
      -sku "<SKU>" `
      -version "<#.#.#>" `
      -OSType "<OS type>" `
      -OSUri "<OS URI>"
   ```

   Командлет **Add-AzsPlatformimage** позволяет задать значения, которые используются в шаблонах Azure Resource Manager для ссылки на образ виртуальной машины. Допустимые значения:
   - **publisher**  
     Например: `Canonical`  
     Сегмент **издателя** в имени образа виртуальной машины, который применяется пользователями при развертывании образа. Не используйте в этом поле пробел или другие специальные символы.  
   - **offer**  
     Например: `UbuntuServer`  
     Сегмент **предложения** в имени образа виртуальной машины, который применяется пользователями при развертывании образа виртуальной машины. Не используйте в этом поле пробел или другие специальные символы.  
   - **sku**  
     Например: `14.04.3-LTS`  
     Сегмент **номера SKU** в имени образа виртуальной машины, который применяется пользователями при развертывании образа виртуальной машины. Не используйте в этом поле пробел или другие специальные символы.  
   - **version**  
     Например: `1.0.0`  
     Версия виртуальной машины, которая применяется пользователями при развертывании образа виртуальной машины. Эта версия имеет формат *\#.\#.\#* . Не используйте в этом поле пробел или другие специальные символы.  
   - **osType**  
     Например: `Linux`  
     Параметр **osType** (Тип ОС) для образа должен иметь значение **Windows** или **Linux**.  
   - **OSUri**  
     Например: `https://storageaccount.blob.core.windows.net/vhds/Ubuntu1404.vhd`  
     В качестве значения `osDisk` вы можете указать URI хранилища BLOB-объектов.  

     Дополнительные сведения см. в справочнике PowerShell в разделе о командлете [Add-AzsPlatformimage](/powershell/module/azs.compute.admin/add-azsplatformimage).
     
4. Добавленный образ будет доступен только для шаблонов на базе Azure Resource Manager и развертываний PowerShell. Чтобы обеспечить пользователям доступ к образу в Marketplace, опубликуйте его в качестве элемента Marketplace, как описывается в статье [Создание и публикация элемента Marketplace](azure-stack-create-and-publish-marketplace-item.md) Запишите значения **Издатель**, **Предложение**, **Номер SKU** и **Версия**. Они понадобятся при редактировании шаблона Resource Manager и Manifest.json в пользовательском AZPKG-файле.

## <a name="remove-the-vm-image-as-an-azure-stack-hub-operator-using-the-portal"></a>Удаление образа виртуальной машины от имени оператора Azure Stack Hub с помощью портала

1. Откройте [портал администрирования](https://adminportal.local.azurestack.external) Azure Stack Hub.

2. Если образ виртуальной машины имеет связанный элемент Marketplace, щелкните **Управление Marketplace** и выберите элемент Marketplace, который требуется удалить.

3. Если образ виртуальной машины не связан с элементом Marketplace, перейдите в раздел **Все службы > Вычислительная среда > Образы виртуальных машин** и щелкните там символ многоточия ( **...** ) рядом с образом виртуальной машины.

4. Выберите команду **Удалить**.

## <a name="remove-a-vm-image-as-an-azure-stack-hub-operator-using-powershell"></a>Удаление образа виртуальной машины от имени оператора Azure Stack Hub с помощью PowerShell

Если отправленный образ виртуальной машины больше не требуется, вы можете удалить его из Marketplace с помощью следующего командлета:

1. [Установка PowerShell для Azure Stack Hub](azure-stack-powershell-install.md).

2. Войдите в Azure Stack Hub с правами оператора.

3. Откройте PowerShell с помощью командной строки с повышенными привилегиями и выполните следующую команду:

   ```powershell  
   Remove-AzsPlatformImage `
    -publisher "<Publisher>" `
    -offer "<Offer>" `
    -sku "<SKU>" `
    -version "<Version>" `
   ```

   Командлет **Remove-AzsPlatformimage** позволяет задать значения, которые используются в шаблонах Azure Resource Manager для ссылки на образ виртуальной машины. Допустимые значения:
   - **publisher**  
     Например: `Canonical`  
     Сегмент **издателя** в имени образа виртуальной машины, который применяется пользователями при развертывании образа. Не используйте в этом поле пробел или другие специальные символы.  
   - **offer**  
     Например: `UbuntuServer`  
     Сегмент **предложения** в имени образа виртуальной машины, который применяется пользователями при развертывании образа виртуальной машины. Не используйте в этом поле пробел или другие специальные символы.  
   - **sku**  
     Например: `14.04.3-LTS`  
     Сегмент **номера SKU** в имени образа виртуальной машины, который применяется пользователями при развертывании образа виртуальной машины. Не используйте в этом поле пробел или другие специальные символы.  
   - **version**  
     Например: `1.0.0`  
     Версия виртуальной машины, которая применяется пользователями при развертывании образа виртуальной машины. Эта версия имеет формат *\#.\#.\#* . Не используйте в этом поле пробел или другие специальные символы.  

     Дополнительные сведения о командлете **Remove-AzsPlatformImage** см. в [документации по модулю оператора Azure Stack Hub](/powershell/module/) для Microsoft PowerShell.

## <a name="next-steps"></a>Дальнейшие действия

- [Создание и публикация пользовательского элемента Azure Stack Hub Marketplace](azure-stack-create-and-publish-marketplace-item.md)
- [Подготовка виртуальной машины](../user/azure-stack-create-vm-template.md)
