---
title: Использование привилегированной конечной точки в Azure Stack | Документация Майкрософт
description: Описано использование привилегированной конечной точки (PEP) в Azure Stack (для оператора Azure Stack).
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/16/2019
ms.author: mabrigg
ms.reviewer: fiseraci
ms.lastreviewed: 01/25/2019
ms.openlocfilehash: 850d99232b408aa9264caf0d928231ed229e5c23
ms.sourcegitcommit: 889fd09e0ab51ad0e43552a800bbe39dc9429579
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2019
ms.locfileid: "65782418"
---
# <a name="using-the-privileged-endpoint-in-azure-stack"></a>Использование привилегированной конечной точки в Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Для повседневных задач управления оператору Azure Stack следует использовать портал администрирования, PowerShell или API-интерфейсы Azure Resource Manager. Но для выполнения некоторых менее распространенных операций понадобится использовать *привилегированную конечную точку*. Эта конечная точка является предварительно настроенной удаленной консолью PowerShell, которая предоставляет достаточно возможностей для выполнения требуемой задачи. Конечная точка использует [PowerShell JEA (Just Enough Administration)](https://docs.microsoft.com/powershell/jea/overview) для предоставления ограниченного набора командлетов. Для доступа к привилегированной конечной точке и вызова ограниченного набора командлетов используется учетная запись с низким уровнем привилегий. Учетные записи администратора не требуются. Написание скриптов для обеспечения дополнительной безопасности не допускается.

Привилегированную конечную точку можно использовать для следующего:

- выполнение задач низкого уровня, таких как [сбор журналов диагностики](azure-stack-diagnostics.md#log-collection-tool);
- выполнение многих задач по интеграции центра обработки данных после развертывания для интегрированных систем, например добавление DNS-серверов после развертывания, настройка интеграции Microsoft Graph, интеграции служб федерации Active Directory (AD FS), смена сертификатов и т. д.;
- работа со службой поддержки для получения временного доступа высокого уровня для проведения глубокой диагностики интегрированной системы.

В привилегированной конечной точке регистрируется каждое действие (и его соответствующие выходные данные), выполняемое в сеансе PowerShell. Это обеспечивает полную прозрачность и аудит операций. Эти файлы журналов можно сохранить для проведения аудита в дальнейшем.

> [!NOTE]
> В Пакете средств разработки Azure Stack (ASDK) некоторые команды, доступные в привилегированной конечной точке, можно выполнять непосредственно из сеанса PowerShell на узле пакета разработки. Тем не менее вы можете проверить некоторые операции с использованием привилегированной конечной точки, например сбор данных журналов, так как это единственный доступный метод для выполнения определенных операций в среде интегрированных систем.

## <a name="access-the-privileged-endpoint"></a>Доступ к привилегированной конечной точке

Доступ к привилегированной конечной точке осуществляется через удаленный сеанс PowerShell на виртуальной машине, на которой размещается привилегированная конечная точка. В ASDK эта виртуальная машина называется **AzS-ERCS01**. Если вы используете интегрированную систему, на разных узлах виртуальной машины запущены три экземпляра привилегированной конечной точки (*префикс*-ERCS01, *префикс*-ERCS02 или *префикс*-ERCS03) для обеспечения устойчивости. 

Перед началом этой процедуры для интегрированной системы убедитесь в наличии доступа к привилегированной конечной точке по IP-адресу или через DNS. После первоначального развертывания Azure Stack доступ к привилегированной конечной точке можно получить только по IP-адресу, так как интеграция DNS еще не настроена. Поставщик OEM предоставит вам JSON-файл с именем **AzureStackStampDeploymentInfo**, содержащий IP-адреса привилегированных конечных точек.


> [!NOTE]
> В целях безопасности подключаться к привилегированной конечной точке следует только с защищенной виртуальной машины, работающей на узле жизненного цикла оборудования, или с выделенного защищенного компьютера, например [рабочей станции с привилегированным доступом](https://docs.microsoft.com/windows-server/identity/securing-privileged-access/privileged-access-workstations). Нельзя изменять исходную конфигурацию узла жизненного цикла оборудования (включая установку нового программного обеспечения), а также использовать ее для подключения к привилегированной конечной точке.

1. Установите доверие.

    - В интегрированной системе выполните указанную ниже команду из сеанса Windows PowerShell с повышенными правами, чтобы добавить PEP в качестве доверенного узла на защищенную виртуальную машину, работающую на узле жизненного цикла оборудования, или на рабочую станцию с привилегированным доступом.

      ```powershell
        winrm s winrm/config/client '@{TrustedHosts="<IP Address of Privileged Endpoint>"}'
      ```
    - Если вы используете ASDK, войдите на узел комплекта разработки.

2. Откройте сеанс Windows PowerShell на защищенной виртуальной машине, работающей на узле жизненного цикла оборудования, или на рабочей станции с привилегированным доступом. Выполните следующие команды для создания удаленного сеанса на виртуальной машине, на которой размещается привилегированная конечная точка.
 
   - В интегрированной системе:
     ```powershell
       $cred = Get-Credential

       Enter-PSSession -ComputerName <IP_address_of_ERCS> `
         -ConfigurationName PrivilegedEndpoint -Credential $cred
     ```
     Параметр `ComputerName` может быть IP-адресом или DNS-именем одной из виртуальных машин, на которой размещена привилегированная конечная точка. 
   - При использовании ASDK:
     
     ```powershell
       $cred = Get-Credential

       Enter-PSSession -ComputerName azs-ercs01 `
         -ConfigurationName PrivilegedEndpoint -Credential $cred
     ``` 
     При появлении запроса используйте следующие учетные данные:

     - **Имя пользователя**. Укажите учетную запись CloudAdmin в формате **&lt;*домен Azure Stack*&gt;\cloudadmin**. (При использовании ASDK имя пользователя — **azurestack\cloudadmin**.)
     - **Пароль**. Введите пароль, который использовался во время установки учетной записи администратора домена AzureStackAdmin.

     > [!NOTE]
     > Если не удается подключиться к конечной точке ERCS, попробуйте повторить шаги 1 и 2, указав IP-адрес виртуальной машины ERCS, к которой вы еще не пытались подключиться.

3. После подключения запрос изменится на **[*IP-адрес или имя виртуальной машины ERCS*]: PS>** или на **[azs-ercs01]: PS>** (в зависимости от среды). Теперь запустите командлет `Get-Command`, чтобы просмотреть список доступных командлетов.

   Многие из этих командлетов предназначены только для сред интегрированных систем (например, командлеты, относящиеся к интеграции центра обработки данных). В ASDK проверены следующие командлеты:

   - Clear-Host;
   - Close-PrivilegedEndpoint;
   - Exit-PSSession;
   - Get-AzureStackLog;
   - Get-AzureStackStampInformation;
   - Get-Command;
   - Get-FormatData;
   - Get-Help
   - Get-ThirdPartyNotices;
   - Measure-Object;
   - New-CloudAdminUser;
   - Out-Default;
   - Remove-CloudAdminUser;
   - Select-Object;
   - Set-CloudAdminUserPassword;
   - Test-AzureStack
   - Stop-AzureStack;
   - Get-ClusterLog.

## <a name="tips-for-using-the-privileged-endpoint"></a>Советы по использованию привилегированной конечной точки 

Как упоминалось выше, привилегированная конечная точка — это конечная точка [PowerShell JEA](https://docs.microsoft.com/powershell/jea/overview). Обеспечивая надежный уровень защиты, конечная точка JEA сокращает некоторые основные возможности PowerShell, например использование сценариев или выполнение нажатием клавиши TAB. При попытке выполнить операцию скрипта любого типа она завершается с ошибкой **ScriptsNotAllowed**. Это ожидаемое поведение.

Например, чтобы получить список параметров для определенного командлета, следует выполнить приведенную ниже команду.

```powershell
    Get-Command <cmdlet_name> -Syntax
```

Кроме того, можно использовать командлет [Import-PSSession](https://docs.microsoft.com/powershell/module/Microsoft.PowerShell.Utility/Import-PSSession?view=powershell-5.1), чтобы импортировать все командлеты привилегированной конечной точки в текущий сеанс на локальном компьютере. В этом случае все командлеты и функции привилегированной конечной точки будут доступны на локальном компьютере, включая выполнение нажатием клавиши TAB и, в самых общих чертах, использование сценариев. 

Чтобы импортировать сеанс привилегированной конечной точки на локальный компьютер, выполните следующие действия.

1. Установите доверие.

    – В интегрированной системе выполните указанную ниже команду из сеанса Windows PowerShell с повышенными правами, чтобы добавить PEP в качестве доверенного узла на защищенную виртуальную машину, работающую на узле жизненного цикла оборудования, или на рабочую станцию с привилегированным доступом.

      ```powershell
        winrm s winrm/config/client '@{TrustedHosts="<IP Address of Privileged Endpoint>"}'
      ```
    - Если вы используете ASDK, войдите на узел комплекта разработки.

2. Откройте сеанс Windows PowerShell на защищенной виртуальной машине, работающей на узле жизненного цикла оборудования, или на рабочей станции с привилегированным доступом. Выполните следующие команды для создания удаленного сеанса на виртуальной машине, на которой размещается привилегированная конечная точка.
 
   - В интегрированной системе:
     ```powershell
       $cred = Get-Credential

       $session = New-PSSession -ComputerName <IP_address_of_ERCS> `
         -ConfigurationName PrivilegedEndpoint -Credential $cred
     ```
     Параметр `ComputerName` может быть IP-адресом или DNS-именем одной из виртуальных машин, на которой размещена привилегированная конечная точка. 
   - При использовании ASDK:
     
     ```powershell
      $cred = Get-Credential

      $session = New-PSSession -ComputerName azs-ercs01 `
         -ConfigurationName PrivilegedEndpoint -Credential $cred
     ``` 
     При появлении запроса используйте следующие учетные данные:

     - **Имя пользователя**. Укажите учетную запись CloudAdmin в формате **&lt;*домен Azure Stack*&gt;\cloudadmin**. (При использовании ASDK имя пользователя — **azurestack\cloudadmin**.)
     - **Пароль**. Введите пароль, который использовался во время установки учетной записи администратора домена AzureStackAdmin.

3. Импорт сеанса привилегированной конечной точки на локальный компьютер
    ```powershell 
        Import-PSSession $session
    ```
4. Теперь можно использовать выполнение нажатием клавиши TAB и запускать сценарии обычным образом в локальным сеансе PowerShell, располагая всеми функциями и командлетами привилегированной конечной точки и не снижая уровень безопасности Azure Stack. Вот и все!


## <a name="close-the-privileged-endpoint-session"></a>Закрытие сеанса привилегированной конечной точки

 Как упоминалось ранее, в привилегированной конечной точке регистрируется каждое действие (и его соответствующие выходные данные), выполняемое в сеансе PowerShell. Сеанс следует закрыть с помощью командлета `Close-PrivilegedEndpoint`. Этот командлет закрывает конечную точку надлежащим образом, а также передает файлы журнала во внешнюю общую папку для хранения.

Чтобы закрыть сеанс конечной точки:

1. Создайте внешний файловый ресурс, доступный для привилегированной конечной точки. В среде комплекта разработки можно просто создать общую папку на узле комплекта разработки.
2. Запустите командлет `Close-PrivilegedEndpoint`. 
3. Будет предложено ввести путь для хранения файла журнала расшифровки. Укажите созданную ранее общую папку в формате &#92;&#92;*имя_сервера*&#92;*имя_общей_папки*. Если не указать путь, командлет завершится сбоем и сеанс останется открытым. 

    ![Выходные данные командлета Close-PrivilegedEndpoint с указанием целевого пути к файлу расшифровки](media/azure-stack-privileged-endpoint/closeendpoint.png)

После того как файлы журнала расшифровки успешно переданы в общую папку, они автоматически удаляются из привилегированной конечной точки. 

> [!NOTE]
> Если завершить сеанс привилегированной конечной точки, используя командлеты `Exit-PSSession` либо `Exit`, или просто закрыть консоль PowerShell, журналы расшифровки не будут перенесены в файловый ресурс. Они останутся в привилегированной конечной точке. При следующем запуске командлета `Close-PrivilegedEndpoint` и добавлении общей папки журналы расшифровки из предыдущих сеансов будут также перенесены. Для закрытия сеанса PEP не следует использовать `Exit-PSSession` или `Exit`. Используйте `Close-PrivilegedEndpoint`.


## <a name="next-steps"></a>Дополнительная информация

[Azure Stack diagnostic tools](azure-stack-diagnostics.md) (Средства диагностики Azure Stack)
