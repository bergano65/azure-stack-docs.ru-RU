---
title: Устранение распространенных проблем с сертификатами PKI
titleSuffix: Azure Stack Hub
description: Устраните распространенные проблемы с сертификатами PKI Azure Stack Hub с помощью средства проверки готовности Azure Stack Hub.
author: IngridAtMicrosoft
ms.topic: conceptual
ms.date: 10/03/2019
ms.author: inhenkel
ms.reviewer: unknown
ms.lastreviewed: 11/19/2018
ms.openlocfilehash: 1adf2bdef69549393717fd5705858376447cd710
ms.sourcegitcommit: 97806b43314d306e0ddb15847c86be2c92ae001e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2020
ms.locfileid: "77509642"
---
# <a name="fix-common-issues-with-azure-stack-hub-pki-certificates"></a>Устранение распространенных проблем с сертификатами PKI Azure Stack Hub

Сведения в этой статье помогут вам определить и устранить распространенные проблемы с сертификатами PKI Azure Stack Hub. Вы можете выявлять проблемы, [проверяя PKI-сертификаты Azure Stack Hub](azure-stack-validate-pki-certs.md) с помощью средства проверки готовности Azure Stack Hub. Это средство проверяет, соответствуют ли сертификаты требованиям PKI к развертыванию и смене секретов Azure Stack Hub, и записывает результаты в файл [report.json](azure-stack-validation-report.md).  

## <a name="pfx-encryption"></a>Шифрование PFX-файлов

**Проблема**. Алгоритм шифрования PFX-файлов не соответствует TripleDES-SHA1.

**Исправление**. Экспортируйте PFX-файлы, используя шифрование **TripleDES-SHA1**. Это стандартный вариант шифрования для всех клиентов Windows 10 при экспорте из оснастки сертификатов или при использовании командлета `Export-PFXCertificate`.

## <a name="read-pfx"></a>Чтение PFX-файла

**Предупреждение.** Пароль защищает только конфиденциальные сведения в сертификате.  

**Исправление.** Экспортируйте PFX-файлы с необязательным параметром **Включить конфиденциальность сертификата**.  

**Проблема**. Недопустимый PFX-файл.  

**Исправление.** Повторно экспортируйте сертификат, выполнив действия, описанные в статье [Подготовка сертификатов PKI Azure Stack Hub для развертывания или смены секретов](azure-stack-prepare-pki-certs.md).

## <a name="signature-algorithm"></a>Алгоритм подписи

**Проблема**. Алгоритм подписи — SHA1.

**Исправление.** Выполните шаги, описанные в статье о создании запроса на подписывание сертификатов (CSR) Azure Stack Hub, чтобы повторно создать такой запрос с использованием алгоритма подписи SHA256. Затем отправьте CSR в центр сертификации, чтобы он повторно выдал сертификат.

## <a name="private-key"></a>Закрытый ключ

**Проблема**. Закрытый ключ отсутствует или не содержит атрибут локального компьютера.  

**Исправление.** Повторно экспортируйте сертификат из компьютера, создавшего CSR, выполнив инструкции из раздела [Подготовка сертификатов к развертыванию](azure-stack-prepare-pki-certs.md#prepare-certificates-for-deployment). Эти действия включают экспорт из хранилища сертификатов на локальном компьютере.

## <a name="certificate-chain"></a>Цепочка сертификатов

**Проблема**. Цепочка сертификатов не полная.  

**Исправление.** Сертификаты должны содержать завершенную цепочку сертификатов. Повторно экспортируйте сертификат, выполнив действия, описанные в статье о [подготовке PKI-сертификатов Azure Stack Hub к развертыванию](azure-stack-prepare-pki-certs.md#prepare-certificates-for-deployment), и выберите параметр **Включить по возможности все сертификаты в путь сертификации**.

## <a name="dns-names"></a>DNS-имена

**Проблема.** Параметр сертификата **DNSNameList** не содержит имя конечной точки службы Azure Stack Hub или допустимое совпадение подстановочных знаков. Совпадения подстановочных знаков допустимы только для крайнего левого пространства имен DNS-имени. Например, `*.region.domain.com` допустим только для `portal.region.domain.com`, но не для `*.table.region.domain.com`.

**Исправление.** Выполните шаги, описанные в статье о создании запроса на подпись сертификатов Azure Stack Hub, чтобы повторно создать CSR с правильным DNS-именем для поддержки конечных точек Azure Stack Hub. Повторно отправьте CSR в центр сертификации. Затем экспортируйте сертификат с компьютера, создавшего CSR, выполнив инструкции, описанные в статье о [подготовке PKI-сертификатов Azure Stack Hub к развертыванию](azure-stack-prepare-pki-certs.md#prepare-certificates-for-deployment).  

## <a name="key-usage"></a>Использование ключа

**Проблема.** В свойстве "Использование ключа" отсутствует атрибут цифровой подписи или шифрования ключей, либо в свойстве "расширенное использование ключа" отсутствует атрибут проверки подлинности сервера или проверки подлинности клиента.  

**Исправление.** Выполните инструкции, приведенные в статье о [создании запроса на подписывание сертификатов Azure Stack Hub](azure-stack-get-pki-certs.md), чтобы повторно создать CSR с правильными атрибутами использования ключа. Повторно отправьте запрос CSR в центр сертификации и убедитесь, что шаблон сертификата не перезаписывает свойство "Использование ключа" в запросе.

## <a name="key-size"></a>Размер ключа

**Проблема.** Размер ключа меньше 2048.

**Исправление.** Выполните действия, описанные в статье о [создании запроса на подписывание сертификатов Azure Stack Hub](azure-stack-get-pki-certs.md), чтобы повторно создать CSR с ключом правильной длины (2048), а затем снова отправьте CSR в центр сертификации.

## <a name="chain-order"></a>Порядок в цепочке

**Проблема.** Неверный порядок в цепочке сертификатов.  

**Исправление.** Повторно экспортируйте сертификат, выполнив действия, описанные в статье о [подготовке PKI-сертификатов Azure Stack Hub к развертыванию](azure-stack-prepare-pki-certs.md#prepare-certificates-for-deployment), и выберите параметр **Включить по возможности все сертификаты в путь сертификации**. Убедитесь, что для экспорта выбран только конечный сертификат.

## <a name="other-certificates"></a>Другие сертификаты

**Проблема.** Пакет PFX содержит сертификаты, не являющиеся конечными или частью цепочки сертификатов.  

**Исправление.** Повторно экспортируйте сертификат, выполнив действия, описанные в статье о [подготовке PKI-сертификатов Azure Stack Hub к развертыванию](azure-stack-prepare-pki-certs.md#prepare-certificates-for-deployment), и выберите параметр **Включить по возможности все сертификаты в путь сертификации**. Убедитесь, что для экспорта выбран только конечный сертификат.

## <a name="fix-common-packaging-issues"></a>Устранение распространенных неполадок с упаковкой

**AzsReadinessChecker** содержит вспомогательный командлет **Repair-AzsPfxCertificate**, который может импортировать и экспортировать PFX-файл для исправления распространенных проблем с созданием пакетов, включая следующие:

- **Алгоритм шифрования PFX-файлов** не соответствует TripleDES-SHA1.
- Отсутствие атрибута локального компьютера в **закрытом ключе**.
- Незавершенная или неправильная **цепочка сертификатов**. Локальный компьютер должен содержать цепочки сертификатов, если их нет в пакете PFX.
- **Другие сертификаты**.

**Repair-AzsPfxCertificate** не подходит для случаев, когда нужно создать новый запрос CSR и повторно выпустить сертификат.

### <a name="prerequisites"></a>Предварительные требования

На компьютере, на котором запущено средство, должны быть установлены следующие обязательные компоненты:

- Необходимо установить Windows 10 или Windows Server 2016 и обеспечить подключение к Интернету.
- Необходимо установить PowerShell 5.1 или более поздней версии. Чтобы проверить используемую версию, выполните следующий командлет PowerShell и проверьте значения **Major** (основной номер версии) и **Minor** (дополнительный номер версии):

   ```powershell
   $PSVersionTable.PSVersion
   ```

- Необходимо настроить [PowerShell для использования с Azure Stack Hub](azure-stack-powershell-install.md).
- Скачайте последнюю версию [средства проверки готовности Azure Stack Hub](https://aka.ms/AzsReadinessChecker).

### <a name="import-and-export-an-existing-pfx-file"></a>Импорт и экспорт имеющегося PFX-файла

1. На компьютере, который соответствует всем предварительным требованиям, откройте командную строку PowerShell с повышенными правами и выполните следующую команду, чтобы установить средство проверки готовности Azure Stack Hub:

   ```powershell
   Install-Module Microsoft.AzureStack.ReadinessChecker -Force
   ```

2. В командной строке PowerShell выполните указанный ниже командлет, чтобы задать пароль PFX-файла. Замените значение `PFXpassword` фактическим паролем.

   ```powershell
   $password = Read-Host -Prompt PFXpassword -AsSecureString
   ```

3. В командной строке PowerShell выполните следующую команду, чтобы экспортировать новый PFX-файл:

   - Для `-PfxPath` укажите путь к PFX-файлу, с которым вы работаете. В следующем примере используется путь `.\certificates\ssl.pfx`.
   - Для `-ExportPFXPath` укажите расположение и имя PFX-файла для экспорта. В следующем примере используется путь `.\certificates\ssl_new.pfx`.

   ```powershell
   Repair-AzsPfxCertificate -PfxPassword $password -PfxPath .\certificates\ssl.pfx -ExportPFXPath .\certificates\ssl_new.pfx
   ```  

4. После завершения работы средства проверьте выходные данные, чтобы убедиться в успешном выполнении:

   ```shell
   Repair-AzsPfxCertificate v1.1809.1005.1 started.
   Starting Azure Stack Hub Certificate Import/Export
   Importing PFX .\certificates\ssl.pfx into Local Machine Store
   Exporting certificate to .\certificates\ssl_new.pfx
   Export complete. Removing certificate from the local machine store.
   Removal complete.
   Log location (contains PII): C:\Users\username\AppData\Local\Temp\AzsReadinessChecker\AzsReadinessChecker.log
   Repair-AzsPfxCertificate Completed
   ```

## <a name="next-steps"></a>Дальнейшие действия

- [Дополнительные сведения о системе безопасности Azure Stack Hub](azure-stack-rotate-secrets.md)
