---
title: Создание VPN-подключения типа "сеть — сеть" между двумя виртуальными сетями в разных средах ASDK
description: Учебник для операторов облака по созданию VPN-подключения типа "сеть — сеть" между двумя средами Пакета средств разработки Azure Stack (ASDK) с одним узлом.
author: justinha
ms.topic: conceptual
ms.date: 01/22/2020
ms.author: justinha
ms.reviewer: misainat
ms.lastreviewed: 01/22/2020
ms.openlocfilehash: fcfd453cf6ccbbbc8f5e65b9db475ab4fdad33b0
ms.sourcegitcommit: 390eac7abc94cea1405178e8d6a9358f6488f5d9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2020
ms.locfileid: "78231610"
---
# <a name="create-a-site-to-site-vpn-connection-between-two-virtual-networks-in-different-asdk-environments"></a>Создание VPN-подключения типа "сеть — сеть" между двумя виртуальными сетями в разных средах ASDK

## <a name="overview"></a>Обзор

В этой статье объясняется, как создать VPN-подключение типа "сеть — сеть" между двумя виртуальными сетями в двух отдельных средах Пакета средств разработки Azure Stack (ASDK). Во время настройки подключений вы узнаете, как работают VPN-шлюзы Azure Stack Hub.

### <a name="connection"></a>Соединение

На следующем рисунке показано, как должна в итоге выглядеть конфигурация подключения.

![Конфигурация подключения VPN типа "сеть — сеть"](media/azure-stack-create-vpn-connection-one-node-tp2/OneNodeS2SVPN.png)

### <a name="before-you-begin"></a>Перед началом

Чтобы выполнить конфигурацию подключения, перед началом работы убедитесь в наличии следующих компонентов:

* Два сервера и другое требуемое оборудование для ASDK, как описано в статье [ Как скачать Пакет средств разработки Azure Stack (ASDK)](../asdk/asdk-download.md).
* Пакет развертывания [ASDK](https://azure.microsoft.com/overview/azure-stack/try/).

## <a name="deploy-the-azure-stack-development-kit-environments"></a>Развертывание сред Пакета средств разработки Azure Stack

Чтобы настроить подключение, необходимо развернуть две среды ASDK.

> [!NOTE]
> Выполните [инструкции по развертыванию](../asdk/asdk-install.md) для каждой среды ASDK. В этой статье среды ASDK называются **POC1** и **POC2**.

## <a name="prepare-an-offer-on-poc1-and-poc2"></a>Подготовка предложения в POC1 и POC2

Подготовьте предложение в средах POC1 и POC2. Это позволит пользователю подписаться на него и развернуть виртуальные машины. Сведения о создании предложения см. в статье [о предоставлении виртуальных машин пользователям Azure Stack Hub](azure-stack-tutorial-tenant-vm.md).

## <a name="review-and-complete-the-network-configuration-table"></a>Просмотр таблицы конфигурации сети и настройка

В таблице ниже перечислены параметры сети обеих сред ASDK. Выполните процедуру, приведенную после таблицы, чтобы добавить адрес EBGPNAT, соответствующий вашей сети.

### <a name="network-configuration-table"></a>Таблица конфигурации сети

|   |POC1|POC2|
|---------|---------|---------|
|Имя виртуальной сети     |VNET-01|VNET-02 |
|Адресное пространство виртуальной сети |10.0.10.0/23|10.0.20.0/23|
|Имя подсети     |Subnet-01|Subnet-02|
|Диапазон адресов подсети|10.0.10.0/24 |10.0.20.0/24 |
|Подсеть шлюза     |10.0.11.0/24|10.0.21.0/24|
|Адрес EBGP     |         |         |

> [!NOTE]
> В примере среды используются следующие IP-адреса EBGP: 10.16.167.195 (POC1) и 10.16.169.131 (POC2). Выполните описанную далее процедуру, чтобы определить IP-адреса BGPNAT для узлов ASDK, а затем добавьте IP-адреса в приведенную выше таблицу конфигурации сети.

### <a name="get-the-ip-address-of-the-external-adapter-of-the-nat-vm"></a>Получение IP-адреса внешнего адаптера виртуальной машины NAT

1. Войдите в систему физического компьютера Azure Stack Hub для POC1.
2. Запустите PowerShell с правами администратора и выполните следующий командлет:

   ```powershell
   Get-NetNatExternalAddress
   ```

3. Добавьте IP-адрес в таблицу конфигурации сети из предыдущего раздела.
4. Повторите эту процедуру в среде POC2.

## <a name="create-the-network-resources-in-poc1"></a>Создание сетевых ресурсов в POC1

Теперь вы можете создать сетевые ресурсы среды POC1, используемые при настройке шлюзов. Ниже показано, как это сделать на пользовательском портале Azure Stack Hub. Ресурсы можно также создать с помощью кода PowerShell.

![Рабочий процесс для создания ресурсов](media/azure-stack-create-vpn-connection-one-node-tp2/image2.png)

### <a name="sign-in-as-a-tenant"></a>Вход в качестве клиента

Администратор служб может войти в систему как клиент, чтобы протестировать планы, предложения и подписки, которые могут использовать их клиенты. Если вы еще не [создали учетную запись клиента](azure-stack-add-new-user-aad.md), сделайте это перед входом в систему.

### <a name="create-the-virtual-network-and-vm-subnet"></a>Создание виртуальной сети и подсети виртуальной машины

1. Войдите на пользовательский портал с помощью учетной записи клиента.
2. Выберите **+ Create a resource** (+ Создать ресурс) на пользовательском портале POC2.
3. Щелкните **Marketplace**, а затем выберите **Сети**.
4. Щелкните **Виртуальная сеть**.
5. Определите **имя**, **адресное пространство**, **имя подсети** и **диапазон адресов подсети** на основе значений из таблицы конфигурации сети выше.
6. В поле **Подписка** отображается созданная ранее подписка.
7. Создайте **группу ресурсов** или используйте имеющуюся, щелкнув **Использовать существующий**.
8. Проверьте значение расположения по умолчанию.
9. Кроме того, установите флажок **Закрепить на панели мониторинга**.
10. Нажмите кнопку **создания**.

### <a name="create-the-gateway-subnet"></a>Создание подсети шлюза

1. На панели мониторинга откройте созданный ранее ресурс виртуальной сети VNET-01.
2. В колонке **Параметры** выберите **Подсети**.
3. Чтобы добавить подсеть шлюза в виртуальную сеть, щелкните **Подсеть шлюза**.

    ![Добавление подсети шлюза](media/azure-stack-create-vpn-connection-one-node-tp2/image4.png)

4. По умолчанию подсети присвоено имя **GatewaySubnet**. Подсети шлюза имеют специальное назначение. Чтобы функционировать должным образом, они должны использовать имя **GatewaySubnet**.
5. Проверьте, задано ли в поле **Диапазон адресов** значение **10.0.11.0/24**.
6. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.

### <a name="create-the-virtual-network-gateway"></a>Создание шлюза виртуальной сети

1. Выберите **+ Создать ресурс** на портале Azure.
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке сетевых ресурсов выберите **Шлюз виртуальной сети**.
4. В поле **Имя** введите **GW1**.
5. Выберите пункт **Виртуальная сеть**, чтобы выбрать виртуальную сеть. В списке выберите **VNET-01**.
6. Выберите пункт меню **Общедоступный IP-адрес**. Когда откроется окно **Выбрать общедоступный IP-адрес**, щелкните **Создать**.
7. В поле **Имя** введите **GW1-PiP**, а затем нажмите кнопку **ОК**.
8. По умолчанию для параметра **VPN type** (Тип VPN) установлено значение **Route-based** (На основе маршрута). **Не изменяйте** это значение.
9. Убедитесь, что для параметров **Подписка** и **Расположение** выбраны правильные значения. Ресурс можно закрепить на панели мониторинга. Нажмите кнопку **создания**.

### <a name="create-the-local-network-gateway"></a>Создание шлюза локальной сети

Реализация *шлюза локальной сети* в оценочном развертывании Azure Stack Hub немного отличается от реализации в фактическом развертывании Azure.

В развертывании Azure шлюз локальной сети представляет локальное физическое устройство (в клиенте), с помощью которого выполняется подключение к шлюзу виртуальной сети в Azure. В этом оценочном развертывании Azure Stack Hub оба конца подключения являются шлюзами виртуальной сети.

Проще говоря, ресурс шлюза локальной сети предназначен для указания удаленного шлюза на другом конце подключения. Архитектура ASDK предусматривает ввод IP-адреса внешнего сетевого адаптера на виртуальной машине преобразования сетевых адресов (NAT) другой среды ASDK в качестве общедоступного IP-адреса шлюза локальной сети. Затем на виртуальной машине NAT необходимо создать сопоставления NAT, чтобы убедиться в том, что оба конца подключены правильно.

### <a name="create-the-local-network-gateway-resource"></a>Создание ресурса шлюза локальной сети

1. Войдите в систему физического компьютера Azure Stack Hub для POC1.
2. Выберите **+ Create a resource** (+ Создать ресурс) на пользовательском портале POC2.
3. Щелкните **Marketplace**, а затем выберите **Сети**.
4. В списке сетевых ресурсов выберите **Local network gateway** (Шлюз локальной сети).
5. В поле **Имя** введите **POC2-GW**.
6. В поле **IP-адрес** введите адрес EBGP среды POC2. Этот адрес приведен в таблице конфигурации сети.
7. В поле **Адресное пространство** созданной ранее виртуальной сети POC2 введите **10.0.20.0/23**.
8. Проверьте, выбраны ли правильные значения полей **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **Создать**.

### <a name="create-the-connection"></a>Создание подключения

1. Выберите **+ Create a resource** (+ Создать ресурс) на пользовательском портале POC2.
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке ресурсов выберите **Подключение**.
4. В колонке **основных** параметров установите в поле **Тип соединения** значение **Site-to-site (IPSec)** (Сеть — сеть (IPSec)).
5. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
6. В колонке **Параметры** выберите **Шлюз виртуальной сети**, а затем щелкните **GW1**.
7. Выберите **Local network gateway** (Шлюз локальной сети), а затем щелкните **POC2-GW**.
8. В поле **Имя подключения** введите **POC1-POC2**.
9. В поле **Shared Key (PSK)** (Общий ключ (PSK)) введите **12345**, а затем нажмите кнопку **ОК**.
10. В колонке **Сводка** нажмите кнопку **ОК**.

### <a name="create-a-virtual-machine"></a>Создание виртуальной машины

Чтобы проверить передачу данных через VPN-подключение, в каждой среде ASDK должны существовать виртуальные машины, отправляющие и получающие данные. Создайте виртуальную машину в POC1, а затем поместите ее в подсеть виртуальной машины в виртуальной сети.

1. Выберите **+ Создать ресурс** на портале Azure.
2. Щелкните **Marketplace**, а затем выберите **Вычисление**.
3. В списке образов виртуальных машин выберите образ **Windows Server 2016 Datacenter Eval**.
4. В колонке **Основные сведения** в поле **Имя** введите **VM01**.
5. Введите допустимое имя пользователя и пароль. С помощью этой учетной записи вы войдете на виртуальную машину после ее создания.
6. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
7. В колонке **Размер** выберите размер этого экземпляра виртуальной машины и нажмите **Выбрать**.
8. В колонке **Параметры** примите значения по умолчанию. Проверьте, выбрана ли виртуальная сеть **VNET-01** и задано ли для подсети значение **10.0.10.0/24**. Нажмите кнопку **ОК**.
9. Просмотрите параметры в колонке **Сводка**, а затем нажмите кнопку **ОК**.

## <a name="create-the-network-resources-in-poc2"></a>Создание сетевых ресурсов в POC2

Далее необходимо создать сетевые ресурсы среды POC2. Ниже показано, как это сделать на пользовательском портале.

### <a name="sign-in-as-a-tenant-again"></a>Повторный вход в качестве клиента

Администратор служб может войти в систему как клиент, чтобы протестировать планы, предложения и подписки, которые могут использовать их клиенты. Если вы еще не [создали учетную запись клиента](azure-stack-add-new-user-aad.md), сделайте это перед входом в систему.

### <a name="create-virtual-network-and-vm-subnet"></a>Создание виртуальной сети и подсети виртуальной машины

1. Войдите с помощью учетной записи клиента.
2. Выберите **+ Create a resource** (+ Создать ресурс) на пользовательском портале POC2.
3. Щелкните **Marketplace**, а затем выберите **Сети**.
4. Щелкните **Виртуальная сеть**.
5. На основе значений из приведенной выше таблицы конфигурации сети определите **имя**, **адресное пространство**, **имя подсети** и **диапазон адресов подсети** среды POC2.
6. В поле **Подписка** отображается созданная ранее подписка.
7. Создайте **группу ресурсов** или используйте имеющуюся, выбрав **Использовать существующий**.
8. Проверьте значение **расположения** по умолчанию.
9. Кроме того, установите флажок **Закрепить на панели мониторинга**.
10. Нажмите кнопку **создания**.

### <a name="create-gateway-subnet"></a>Создание подсети шлюза

1. На панели мониторинга откройте созданный ресурс виртуальной сети (**VNET-02**).
2. В колонке **Параметры** выберите **Подсети**.
3. Щелкните **Подсеть шлюза**, чтобы добавить подсеть шлюза в виртуальную сеть.
4. Подсети присвоено имя **GatewaySubnet** по умолчанию. Подсети шлюза являются специальными, и для правильной работы им должно быть присвоено конкретное имя.
5. Проверьте, указан ли в поле **Диапазон адресов** адрес **10.0.21.0/24**.
6. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.

### <a name="create-virtual-network-gateway"></a>Создание шлюза виртуальной сети

1. Выберите **+ Создать ресурс** на портале Azure.  
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке сетевых ресурсов выберите **Шлюз виртуальной сети**.
4. В поле **Имя** введите **GW2**.
5. Чтобы выбрать виртуальную сеть, щелкните **Виртуальная сеть**. В списке выберите **VNET-02**.
6. Выберите **Общедоступный IP-адрес**. Когда откроется колонка **Выбрать общедоступный IP-адрес**, щелкните **Создать**.
7. В поле **Имя** введите **GW2-PiP**, а затем нажмите кнопку **ОК**.
8. По умолчанию для параметра **Тип VPN** установлено значение **На основе маршрута**. **Не изменяйте** это значение.
9. Убедитесь, что для параметров **Подписка** и **Расположение** выбраны правильные значения. Ресурс можно закрепить на панели мониторинга. Нажмите кнопку **создания**.

### <a name="create-local-network-gateway-resource"></a>Создание ресурса шлюза локальной сети

1. Выберите **+ Create a resource** (+ Создать ресурс) на пользовательском портале POC2.
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке сетевых ресурсов выберите **Local network gateway** (Шлюз локальной сети).
4. В поле **Имя** введите **POC1-GW**.
5. В поле **IP-адрес** введите адрес EBGPNAT для среды POC1, приведенный выше в таблице конфигурации сети.
6. В поле **Адресное пространство** (из POC1) для сети **VNET-01** введите **10.0.10.0/23**.
7. Проверьте, выбраны ли правильные значения полей **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **Создать**.

## <a name="create-connection"></a>Создание подключения

1. Выберите **+ Create a resource** (+ Создать ресурс) на пользовательском портале POC2.
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке ресурсов выберите **Подключение**.
4. В колонке **основных** параметров установите в поле **Тип соединения** значение **Site-to-site (IPSec)** (Сеть — сеть (IPSec)).
5. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
6. В колонке **Параметры** выберите **Шлюз виртуальной сети**, а затем щелкните **GW2**.
7. Выберите **Local network gateway** (Шлюз локальной сети), а затем щелкните **POC1-GW**.
8. В поле **Имя подключения** введите **POC2-POC1**.
9. В поле **Shared Key (PSK)** (Общий ключ (PSK)) введите **12345**. Если вы хотите использовать другое значение, помните, что оно должно совпадать со значением общего ключа, созданного в POC1. Щелкните **ОК**.
10. Просмотрите колонку **Сводка**, а затем нажмите кнопку **ОК**.

## <a name="create-a-virtual-machine"></a>Создание виртуальной машины

Теперь создайте виртуальную машину в POC2 и поместите ее в подсеть виртуальной машины в виртуальной сети.

1. Выберите **+ Создать ресурс** на портале Azure.
2. Щелкните **Marketplace**, а затем выберите **Вычисление**.
3. В списке образов виртуальных машин выберите образ **Windows Server 2016 Datacenter Eval**.
4. В колонке **Основные сведения** в поле **Имя** введите **VM02**.
5. Введите допустимое имя пользователя и пароль. С помощью этой учетной записи вы войдете на виртуальную машину после ее создания.
6. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
7. В колонке **Размер** выберите размер виртуальной машины для этого экземпляра и нажмите **Выбрать**.
8. В колонке **Параметры** можно принять значения по умолчанию. Проверьте, выбрана ли виртуальная сеть **VNET-02** и задано ли для подсети значение **10.0.20.0/24**. Щелкните **ОК**.
9. Просмотрите параметры в колонке **Сводка**, а затем нажмите кнопку **ОК**.

## <a name="configure-the-nat-vm-on-each-asdk-for-gateway-traversal"></a>Настройка виртуальной машины NAT в каждой ASDK для обхода шлюза

Среда ASDK работает автономно и изолирована от сети, в которой развернут физический узел. Это означает, что *внешняя* сеть VIP, к которой подключены шлюзы, фактически не является внешней. Вместо этого сеть VIP скрыта за маршрутизатором, выполняющим преобразование сетевых адресов.

В качестве маршрутизатора используется виртуальная машина Windows Server с именем **AzS-bgpnat01**, на которой выполняется роль служб маршрутизации и удаленного доступа в инфраструктуре ASDK. На виртуальной машине AzS-bgpnat01 необходимо настроить NAT, чтобы обеспечить установление VPN-подключения типа "сеть — сеть" на обоих концах.

Чтобы настроить VPN-подключение, необходимо создать статический маршрут NAT, который сопоставляет внешний интерфейс виртуальной машины BGPNAT с виртуальным IP-адресом пула пограничных шлюзов. Маршрут статического сопоставления NAT следует настроить в каждом порте VPN-подключения.

> [!NOTE]
> Эта конфигурация необходима только для сред ASDK.

### <a name="configure-the-nat"></a>Настройка NAT

> [!IMPORTANT]
> Эту процедуру следует выполнить в обеих средах ASDK.

1. Определите **внутренний IP-адрес**, который будет использоваться в сценарии PowerShell ниже. Откройте шлюз виртуальной сети (GW1 и GW2). В колонке **Обзор** сохраните значение **общедоступного IP-адреса**, которое потребуется далее.

   ![Внутренний IP-адрес](media/azure-stack-create-vpn-connection-one-node-tp2/InternalIP.PNG)

2. Войдите в систему физического компьютера Azure Stack Hub для POC1.
3. Вставьте и измените приведенный ниже сценарий PowerShell. Чтобы настроить NAT в каждой ASDK, выполните приведенный ниже скрипт в интегрированной среде сценариев Windows PowerShell с повышенными привилегиями. В скрипте добавьте значения в заполнители `External BGPNAT address` и `Internal IP address`:

   ```powershell
   # Designate the external NAT address for the ports that use the IKE authentication.
   Invoke-Command `
    -ComputerName AzS-bgpnat01 `
     {Add-NetNatExternalAddress `
      -NatName BGPNAT `
      -IPAddress <External BGPNAT address> `
      -PortStart 499 `
      -PortEnd 501}
   Invoke-Command `
    -ComputerName AzS-bgpnat01 `
     {Add-NetNatExternalAddress `
      -NatName BGPNAT `
      -IPAddress <External BGPNAT address> `
      -PortStart 4499 `
      -PortEnd 4501}
   # create a static NAT mapping to map the external address to the Gateway
   # Public IP Address to map the ISAKMP port 500 for PHASE 1 of the IPSEC tunnel
   Invoke-Command `
    -ComputerName AzS-bgpnat01 `
     {Add-NetNatStaticMapping `
      -NatName BGPNAT `
      -Protocol UDP `
      -ExternalIPAddress <External BGPNAT address> `
      -InternalIPAddress <Internal IP address> `
      -ExternalPort 500 `
      -InternalPort 500}
   # Finally, configure NAT traversal which uses port 4500 to
   # successfully establish the complete IPSEC tunnel over NAT devices
   Invoke-Command `
    -ComputerName AzS-bgpnat01 `
     {Add-NetNatStaticMapping `
      -NatName BGPNAT `
      -Protocol UDP `
      -ExternalIPAddress <External BGPNAT address> `
      -InternalIPAddress <Internal IP address> `
      -ExternalPort 4500 `
      -InternalPort 4500}
   ```

4. Повторите эту процедуру в среде POC2.

## <a name="test-the-connection"></a>Проверка подключения

Теперь, когда подключение типа "сеть —сеть" установлено, необходимо проверить, может ли трафик проходить через него. Чтобы выполнить эту проверку, войдите на одну из виртуальных машин, созданных в любой из сред ASDK. Затем проверьте связь с виртуальной машиной, созданной в другой среде.

Чтобы убедиться, что трафик передается через подключение типа "сеть — сеть", проверьте связь с прямым IP-адресом (DIP) виртуальной машины в удаленной подсети, а не с виртуальным IP-адресом. Чтобы сделать это, найдите прямой IP-адрес на другом конце подключения. Сохраните этот адрес для последующего использования.

### <a name="sign-in-to-the-tenant-vm-in-poc1"></a>Вход на виртуальную машину клиента в POC1

1. Войдите в систему физического компьютера Azure Stack Hub среды POC1, а затем войдите на пользовательский портал с помощью учетной записи клиента.
2. На панели навигации слева выберите **Вычисление**.
3. В списке виртуальных машин найдите созданную ранее виртуальную машину **VM01** и выберите ее.
4. В колонке этой виртуальной машины нажмите кнопку **Подключение**, а затем откройте файл VM01.rdp.

     ![Кнопка "Подключение"](media/azure-stack-create-vpn-connection-one-node-tp2/image17.png)

5. Войдите в систему с помощью учетной записи, настроенной при создании виртуальной машины.
6. Откройте окно **Windows PowerShell** с повышенными привилегиями.
7. Введите **ipconfig /all**.
8. В выходных данных найдите **IPv4-адрес** и сохраните его для дальнейшего использования. Это адрес, с которым вы будете проверять связь из POC2. В примере среды этот адрес — **10.0.10.4**, но в вашей среде он может быть другим. Он должен находиться в пределах созданной ранее подсети **10.0.10.0/24**.
9. Чтобы создать правило брандмауэра, позволяющее виртуальной машине реагировать на запросы проверки связи, выполните следующую команду PowerShell:

   ```powershell
   New-NetFirewallRule `
    -DisplayName "Allow ICMPv4-In" `
    -Protocol ICMPv4
   ```

### <a name="sign-in-to-the-tenant-vm-in-poc2"></a>Вход на виртуальную машину клиента в POC2

1. Войдите в систему физического компьютера Azure Stack Hub среды POC2, а затем войдите на пользовательский портал с помощью учетной записи клиента.
2. На панели навигации слева выберите **Вычисление**.
3. В списке виртуальных машин найдите созданную ранее виртуальную машину **VM02** и выберите ее.
4. В колонке виртуальной машины нажмите **Подключить**.
5. Войдите в систему с помощью учетной записи, настроенной при создании виртуальной машины.
6. Откройте окно **Windows PowerShell** с повышенными привилегиями.
7. Введите **ipconfig /all**.
8. Должен отобразиться IPv4-адрес, находящийся в диапазоне **10.0.20.0/24**. В примере среды этот адрес — **10.0.20.4**, но вы можете использовать другой адрес.
9. Чтобы создать правило брандмауэра, позволяющее виртуальной машине реагировать на запросы проверки связи, выполните следующую команду PowerShell:

   ```powershell
   New-NetFirewallRule `
    -DisplayName "Allow ICMPv4-In" `
    -Protocol ICMPv4
   ```

10. Теперь из виртуальной машины в POC2 проверьте связь с виртуальной машиной в POC1 через туннель. Для этого проверьте связь с прямым IP-адресом, записанным из виртуальной машины VM01. В примере среды этот адрес — **10.0.10.4**, но вам следует использовать адрес, записанный в лаборатории. Должен отобразится результат, как в этом примере:

    ![Успешная проверка связи](media/azure-stack-create-vpn-connection-one-node-tp2/image19b.png)
11. Ответ из удаленной виртуальной машины указывает, что проверка выполнена успешно. Окно виртуальной машины можно закрыть. Чтобы проверить подключение, вы можете выполнить другие операции передачи данных, например копирование файлов.

### <a name="viewing-data-transfer-statistics-through-the-gateway-connection"></a>Просмотр статистики передачи данных через подключение шлюза

Если вы хотите узнать, какой объем данных передается через подключение типа "сеть — сеть", просмотрите колонку **Подключение**. Эта проверка также позволяет убедиться в том, что проверка связи действительно прошла через VPN-подключение.

1. В сеансе связи с виртуальной машиной клиента в POC2 войдите на пользовательский портал с учетной записью клиента.
2. Щелкните **Все ресурсы**, а затем выберите подключение **POC2-POC1**. После этого отобразятся **подключения**.
3. В окне **Подключение** в полях **Входящие данные** и **Исходящие данные** отобразится статистика. На снимке экрана ниже указаны большие числа, что обеспечивает дополнительную передачу файлов. Там будут отображаться ненулевые значения.

    ![Входящие и исходящие данные](media/azure-stack-create-vpn-connection-one-node-tp2/image20.png)
